<!DOCTYPE html>
<html lang="{{ lang }}" data-theme="{{ theme|default('dark') }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DOCSight</title>
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg">
    <link rel="icon" type="image/png" href="/static/icon.png">
    <link rel="apple-touch-icon" href="/static/icon.png">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#a855f7">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/main.css">
    {% for mod in modules if mod.has_css %}
    <link rel="stylesheet" href="/modules/{{ mod.id }}/static/style.css">
    {% endfor %}
    {% if active_theme_data %}
    <style id="theme-module-vars">
    :root, [data-theme="dark"] {
        {% for key, value in active_theme_data.get('dark', {}).items() %}
        {{ key }}: {{ value }};
        {% endfor %}
    }
    [data-theme="light"] {
        {% for key, value in active_theme_data.get('light', {}).items() %}
        {{ key }}: {{ value }};
        {% endfor %}
    }
    </style>
    {% endif %}
    <!-- Icon Library (Lucide) -->
    <script src="https://unpkg.com/lucide@0.575.0/dist/umd/lucide.min.js"
            integrity="sha384-GzE8qT1LzDfRNjtvLN/dXDLPlJOB3BBom3Twb9/RwHkXCgNl6OU1pBxM9397HWGU"
            crossorigin="anonymous"></script>
</head>
<body>
<div class="app-layout">

<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <img src="/static/logo.svg" alt="DOCSight" style="width:36px;height:36px;vertical-align:middle;margin-right:8px;">
        <span>DOCSight</span>
        <button class="sidebar-toggle" id="sidebar-collapse" title="Collapse"></button>
    </div>
    <div class="sidebar-content">
        <div class="sidebar-section-label">{{ t.sidebar_monitoring }}</div>
        <a class="sidebar-link active" data-view="live" data-tooltip="{{ t.live_dashboard }}">
            <span class="icon"><i data-lucide="radio"></i></span> {{ t.live_dashboard }}
        </a>
        <a class="sidebar-link" data-view="events" data-tooltip="{{ t.event_log }}">
            <span class="icon"><i data-lucide="bell"></i></span> {{ t.event_log }}
            <span class="event-badge" id="event-badge" style="display:none;"></span>
        </a>
        <a class="sidebar-link" data-view="trends" data-tooltip="{{ t.signal_trends }}">
            <span class="icon"><i data-lucide="trending-up"></i></span> {{ t.signal_trends }}
        </a>
        <a class="sidebar-link" data-view="channels" data-tooltip="{{ t.channels }}">
            <span class="icon"><i data-lucide="clock"></i></span> {{ t.channels }}
        </a>
        {% if speedtest_configured or bqm_configured %}
        <a class="sidebar-link" data-view="correlation" data-tooltip="{{ t.correlation_analysis }}">
            <span class="icon"><i data-lucide="bar-chart-3"></i></span> {{ t.correlation_analysis }}
        </a>
        {% endif %}
        {% if gaming_quality_enabled %}
        <a class="sidebar-link" data-view="gaming" data-tooltip="{{ t.gaming_quality_label }}">
            <span class="icon"><i data-lucide="gamepad-2"></i></span> {{ t.gaming_quality_label }}
        </a>
        {% endif %}
        <div class="sidebar-section-label">{{ t.sidebar_external }}</div>
        {% if modules|selectattr('id', 'equalto', 'docsight.speedtest')|list %}
        {% if speedtest_configured %}
        <a class="sidebar-link" data-view="speedtest" data-tooltip="{{ t.speedtest }}">
            <span class="icon"><i data-lucide="rabbit"></i></span> {{ t.speedtest }}
        </a>
        {% else %}
        <a class="sidebar-link" onclick="openSpeedtestSetupModal()" data-tooltip="{{ t.speedtest_setup }}">
            <span class="icon"><i data-lucide="settings"></i></span> {{ t.speedtest_setup }}
        </a>
        {% endif %}
        {% endif %}
        {% if modules|selectattr('id', 'equalto', 'docsight.bqm')|list %}
        {% if bqm_configured %}
        <a class="sidebar-link" data-view="bqm" data-tooltip="{{ t.bqm_title }}">
            <span class="icon"><i data-lucide="activity"></i></span> {{ t.bqm_title }}
        </a>
        {% else %}
        <a class="sidebar-link" onclick="openBqmSetupModal()" data-tooltip="{{ t.bqm_setup }}">
            <span class="icon"><i data-lucide="settings"></i></span> {{ t.bqm_setup }}
        </a>
        {% endif %}
        {% endif %}
        {% if modules|selectattr('id', 'equalto', 'docsight.smokeping')|list %}
        {% if smokeping_configured %}
        <a class="sidebar-link" data-view="smokeping" data-tooltip="{{ t.smokeping_title }}">
            <span class="icon"><i data-lucide="radar"></i></span> {{ t.smokeping_title }}
        </a>
        {% else %}
        <a class="sidebar-link" onclick="openSmokepingSetupModal()" data-tooltip="{{ t.smokeping_setup }}">
            <span class="icon"><i data-lucide="settings"></i></span> {{ t.smokeping_setup }}
        </a>
        {% endif %}
        {% endif %}
        {% if bnetz_enabled and modules|selectattr('id', 'equalto', 'docsight.bnetz')|list %}
        <a class="sidebar-link" data-view="bnetz" data-tooltip="{{ t.bnetz_title }}">
            <span class="icon"><i data-lucide="file-check"></i></span> {{ t.bnetz_title }}
        </a>
        {% endif %}
        <div class="sidebar-section-label">{{ t.sidebar_documentation }}</div>
        {% if modules|selectattr('id', 'equalto', 'docsight.journal')|list %}
        <a class="sidebar-link" data-view="journal" data-tooltip="{{ t.incident_journal }}">
            <span class="icon"><i data-lucide="clipboard-list"></i></span> {{ t.incident_journal }}
        </a>
        {% endif %}
        <a class="sidebar-link" id="export-link" href="javascript:void(0)" onclick="exportForLLM()" data-tooltip="{{ t.export_llm }}">
            <span class="icon"><i data-lucide="file-output"></i></span> {{ t.export_llm }}
        </a>
        {% if modules|selectattr('id', 'equalto', 'docsight.reports')|list %}
        <a class="sidebar-link" id="report-link" href="javascript:void(0)" onclick="openReportModal()" data-tooltip="{{ t.incident_report }}">
            <span class="icon"><i data-lucide="file-text"></i></span> {{ t.incident_report }}
        </a>
        {% endif %}
        {% set tab_modules = [] %}
        {% for mod in modules if mod.template_paths.get('tab') %}
            {% if tab_modules.append(mod) %}{% endif %}
        {% endfor %}
        {% if tab_modules %}
        <div class="sidebar-section-label">{{ t.sidebar_extensions }}</div>
        {% for mod in tab_modules|sort(attribute='menu.order') %}
        <a class="sidebar-link" data-view="mod-{{ mod.id|replace('.', '-') }}" data-tooltip="{{ t.get(mod.menu.label_key, mod.name) }}">
            <span class="icon"><i data-lucide="{{ mod.menu.get('icon', 'puzzle') }}"></i></span>
            {{ t.get(mod.menu.label_key, mod.name) }}
        </a>
        {% endfor %}
        {% endif %}
        <div style="flex:1;"></div>
        <div class="sidebar-divider"></div>
        <a class="sidebar-link" href="/settings" data-tooltip="{{ t.settings }}">
            <span class="icon"><i data-lucide="settings"></i></span> {{ t.settings }}
        </a>
        {% if auth_enabled %}
        <a class="sidebar-link" href="/logout">
            <span class="icon"><i data-lucide="log-out"></i></span> {{ t.logout }}
        </a>
        {% endif %}
        <div class="sidebar-footer">
            <div class="dark-mode-toggle">
                <span class="dark-mode-label"><i data-lucide="moon"></i> {{ t.dark_mode or 'Dark mode' }}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="theme-toggle-sidebar">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="sidebar-version-row">
                <a href="https://github.com/itsDNNS/docsight/releases" target="_blank" class="version-link">
                    {{ version }}
                    {% if update_available %}
                    <span class="update-badge" title="{{ update_available }}">Update</span>
                    {% endif %}
                </a>
                <div class="sidebar-links-row">
                    <a href="https://github.com/itsDNNS/docsight/issues" target="_blank" rel="noopener noreferrer" class="sponsor-link" title="Report a bug">
                        <i data-lucide="bug" style="width:14px;height:14px;"></i>
                    </a>
                    <a href="https://paypal.me/itsDNNS" target="_blank" rel="noopener noreferrer" class="sponsor-link" title="Donate via PayPal">
                        <i data-lucide="wallet" style="width:14px;height:14px;"></i>
                    </a>
                    <a href="https://ko-fi.com/itsdnns" target="_blank" rel="noopener noreferrer" class="sponsor-link" title="Support on Ko-fi">
                        <i data-lucide="coffee" style="width:14px;height:14px;"></i>
                    </a>
                    <a href="https://github.com/sponsors/itsDNNS" target="_blank" rel="noopener noreferrer" class="sponsor-link" title="Support on GitHub Sponsors">
                        <i data-lucide="heart" style="width:14px;height:14px;"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</nav>
<div class="sidebar-backdrop" id="sidebar-backdrop"></div>

<!-- Main Area -->
<div class="app-main">

<!-- Topbar -->
<div class="topbar">
    <div class="topbar-left">
        <button class="hamburger-btn" id="hamburger" title="Menu">&#9776;</button>
    </div>
    <div class="topbar-right">
        <span class="topbar-meta" id="topbar-meta">
            {% if last_update %}{{ t.last_update }}: {{ last_update }}{% endif %}
        </span>
        <span class="topbar-countdown" id="topbar-countdown"></span>
        <button class="refresh-btn" id="refresh-btn" title="{{ t.refresh }}">&#x1F504;</button>
    </div>
</div>


<!-- ═══ View: Dashboard ═══ -->
<div class="main-content">
<div id="view-dashboard" class="view active">


{% if error %}
<div class="error-box">{{ t.error_label }}: {{ error }}</div>
{% endif %}

{% if analysis %}
    {% set s = analysis.summary %}
    {% set ds = analysis.ds_channels %}
    {% set us = analysis.us_channels %}

    {% set health_map = {"good": t.health_good, "marginal": t.health_marginal, "poor": t.health_poor} %}
    {% set health_label = health_map.get(s.health, s.health) %}
    {% set health_msgs = {"good": t.health_good_msg, "marginal": t.health_marginal_msg, "poor": t.health_poor_msg} %}
    {% set issue_labels = {
        "ds_power_critical": t.issue_ds_power_critical,
        "us_power_critical_low": t.issue_us_power_critical_low,
        "us_power_critical_high": t.issue_us_power_critical_high,
        "us_power_warn_low": t.issue_us_power_warn_low,
        "us_power_warn_high": t.issue_us_power_warn_high,
        "us_modulation_warn": t.issue_us_modulation_warn,
        "us_modulation_critical": t.issue_us_modulation_critical,
        "snr_critical": t.issue_snr_critical,
        "snr_warn": t.issue_snr_warn,
        "uncorr_errors_high": t.issue_uncorr_errors_high,
    } %}
    {% set issue_descs = {
        "ds_power_critical": t.issue_ds_power_critical_desc,
        "us_power_critical_low": t.issue_us_power_critical_low_desc,
        "us_power_critical_high": t.issue_us_power_critical_high_desc,
        "us_power_warn_low": t.issue_us_power_warn_low_desc,
        "us_power_warn_high": t.issue_us_power_warn_high_desc,
        "us_modulation_warn": t.issue_us_modulation_warn_desc,
        "us_modulation_critical": t.issue_us_modulation_critical_desc,
        "snr_critical": t.issue_snr_critical_desc,
        "snr_warn": t.issue_snr_warn_desc,
        "uncorr_errors_high": t.issue_uncorr_errors_high_desc,
    } %}

    {# ══════════════════════════════════════════════════════════════════════════
       HERO CARD - Phase 3 Task 3.1
       Health status + inline trend chart (SNR/Power, 24h)
       ══════════════════════════════════════════════════════════════════════════ #}
    <div class="hero-card health-{{ 'good' if s.health == 'good' else ('crit' if s.health == 'poor' else 'warn') }}">
        <div class="hero-header">
            <div class="hero-status">
                <i data-lucide="activity" class="hero-icon"></i>
                <div class="hero-status-text">
                    <h1 class="hero-title">{{ health_label }}{% if demo_mode %}<span class="demo-badge">{{ t.demo_mode|default('DEMO') }}</span>{% endif %}</h1>
                    <p class="hero-subtitle">{{ health_msgs.get(s.health, '') }}</p>
                </div>
            </div>
            <div class="hero-meta">
                {# 1. Provider #}
                {% if isp_name %}
                <span class="hero-isp">
                    {% set isp_lower = isp_name.lower() %}
                    {% if 'vodafone' in isp_lower %}
                    <img src="/static/img/providers/vodafone.svg" alt="{{ isp_name }}" style="width:14px;height:14px;margin-right:4px;">
                    {% elif 'telekom' in isp_lower %}
                    <img src="/static/img/providers/telekom.svg" alt="{{ isp_name }}" style="width:14px;height:14px;margin-right:4px;">
                    {% elif 'o2' in isp_lower %}
                    <img src="/static/img/providers/o2.svg" alt="{{ isp_name }}" style="width:14px;height:14px;margin-right:4px;">
                    {% else %}
                    <img src="/static/img/providers/generic.svg" alt="{{ isp_name }}" style="width:14px;height:14px;margin-right:4px;opacity:0.7;">
                    {% endif %}
                    {{ isp_name }}
                </span>
                {% endif %}
                
                {# 2. Speed #}
                {% if connection_info and connection_info.max_downstream_kbps %}
                <span class="hero-speed">
                    {{ connection_info.max_downstream_kbps // 1000 }}/{{ connection_info.max_upstream_kbps // 1000 }} MBit/s
                    <span class="info-icon" data-tooltip="Auto-detected from modem" style="margin-left:3px;">
                        <i data-lucide="info" style="width:12px;height:12px;opacity:0.5;"></i>
                    </span>
                </span>
                {% elif booked_download and booked_download > 0 %}
                <span class="hero-speed">
                    {{ booked_download|int }}/{{ booked_upload|int }} MBit/s
                    <span class="info-icon" data-tooltip="Configured in Settings" style="margin-left:3px;">
                        <i data-lucide="settings" style="width:12px;height:12px;opacity:0.5;"></i>
                    </span>
                </span>
                {% else %}
                <a href="/settings" style="color:var(--text-secondary);text-decoration:none;font-size:12px;opacity:0.7;transition:opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
                    <i data-lucide="settings" style="width:11px;height:11px;margin-right:4px;"></i>
                    <span>Set speed in Settings</span>
                </a>
                {% endif %}
                
                {# 3. Channels #}
                <span class="hero-channels">
                    {{ s.ds_total }} DS / {{ s.us_total }} US {{ t.channel if (s.ds_total + s.us_total) == 1 else t.channels }}
                    <span class="info-icon" data-tooltip="Auto-detected from modem" style="margin-left:3px;">
                        <i data-lucide="info" style="width:12px;height:12px;opacity:0.5;"></i>
                    </span>
                </span>

                {# 4. Gaming Quality Index #}
                {% if gaming_quality_enabled and gaming_index %}
                <span class="hero-gaming gaming-{{ gaming_index.grade|lower }}"
                      data-tooltip="{{ gaming_index.score }}/100 — {{ t['gaming_tooltip_' ~ gaming_index.grade|lower] }}{% if not gaming_index.has_speedtest %} ({{ t.gaming_no_speedtest }}){% endif %}">
                    <i data-lucide="gamepad-2" style="width:14px;height:14px;"></i>
                    <span class="gaming-grade">{{ gaming_index.grade }}</span>
                    <span class="gaming-label">Gaming</span>
                </span>
                {% endif %}
            </div>
        </div>
        
        {% if s.health_issues %}
        <div class="hero-issues">
            {% for issue in s.health_issues %}
            <span class="issue-badge" title="{{ issue_descs.get(issue, '') }}">{{ issue_labels.get(issue, issue) }}</span>
            {% endfor %}
        </div>
        {% endif %}
        
        <div class="hero-chart-container">
            <canvas id="hero-trend-chart"></canvas>
        </div>
    </div>

    {# ── OLD Health Banner (DEPRECATED, replaced by Hero Card) ── #}
    {# <div class="health-banner health-{{ 'good' if s.health == 'good' else ('crit' if s.health == 'poor' else 'warn') }}">
        <div class="health-status">
            <span class="health-icon">{% if s.health == 'good' %}&#10004;{% elif s.health == 'poor' %}&#10006;{% else %}&#9888;{% endif %}</span>
            <span class="health-title">{{ health_label }}</span>
        </div>
        <div class="health-msg">{{ health_msgs.get(s.health, '') }}</div>
        {% if s.health_issues %}
        <div class="health-issues">
            {% for issue in s.health_issues %}
            <div class="health-issue">
                <span class="health-issue-name">{{ issue_labels.get(issue, issue) }}<span class="info-tip"><i class="tip-icon" tabindex="0">&#9432;</i><span class="tip-text">{{ issue_descs.get(issue, '') }}</span></span></span>
                <span class="health-issue-desc">{{ issue_descs.get(issue, '') }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div> #}

    {# ── OLD Connection Info Bar (DEPRECATED, moved into Hero Card meta) ── #}
    {# {% if isp_name or (connection_info and connection_info.max_downstream_kbps) %}
    <div class="conn-info-bar">
        {% if isp_name %}{{ isp_name }}{% endif %}
        {% if connection_info and connection_info.max_downstream_kbps %}
            {% if isp_name %}<span class="conn-sep">&middot;</span>{% endif %}
            {{ connection_info.max_downstream_kbps // 1000 }}/{{ connection_info.max_upstream_kbps // 1000 }} Mbit/s
        {% endif %}
        <span class="conn-sep">|</span>
        {{ s.ds_total }} DS <span class="conn-sep">/</span> {{ s.us_total }} US {{ t.channels|lower }}
    </div>
    {% endif %} #}

    {# ── Per-card health ── #}
    {% set signal_health = 'crit' if 'ds_power_critical' in s.health_issues or 'snr_critical' in s.health_issues
       else ('warn' if 'ds_power_warn' in s.health_issues or 'snr_warn' in s.health_issues else 'good') %}
    {% set us_health = 'crit' if 'us_power_critical_low' in s.health_issues or 'us_power_critical_high' in s.health_issues
       else ('warn' if 'us_power_warn_low' in s.health_issues or 'us_power_warn_high' in s.health_issues else 'good') %}
    {% set error_health = 'crit' if 'uncorr_errors_high' in s.health_issues else 'good' %}

    {# ── DS Power health ── #}
    {% set ds_pwr_health = 'crit' if 'ds_power_critical' in s.health_issues else ('warn' if 'ds_power_warn' in s.health_issues else 'good') %}
    {# ── SNR health ── #}
    {% set snr_health = 'crit' if 'snr_critical' in s.health_issues else ('warn' if 'snr_warn' in s.health_issues else 'good') %}

    {# ── Speedtest health (for new Metric Summary Row) ── #}
    {% if speedtest_configured and speedtest_latest %}
        {% set eff_booked_dl = booked_download if (booked_download and booked_download > 0) else ((connection_info.max_downstream_kbps // 1000) if connection_info and connection_info.max_downstream_kbps else 0) %}
        {% set eff_booked_ul = booked_upload if (booked_upload and booked_upload > 0) else ((connection_info.max_upstream_kbps // 1000) if connection_info and connection_info.max_upstream_kbps else 0) %}
        {% if eff_booked_dl > 0 %}
            {% set dl_ratio = speedtest_latest.download_mbps / eff_booked_dl %}
            {% if dl_ratio >= 0.8 %}
                {% set speed_health = 'health-good' %}
                {% set dl_val_class = 'val-good' %}
            {% elif dl_ratio >= 0.5 %}
                {% set speed_health = 'health-warn' %}
                {% set dl_val_class = 'val-warn' %}
            {% else %}
                {% set speed_health = 'health-crit' %}
                {% set dl_val_class = 'val-bad' %}
            {% endif %}
        {% else %}
            {% set speed_health = 'health-good' %}
            {% set dl_val_class = 'val-good' %}
        {% endif %}
        {% if eff_booked_ul > 0 %}
            {% set ul_ratio = speedtest_latest.upload_mbps / eff_booked_ul %}
            {% if ul_ratio >= 0.8 %}
                {% set ul_val_class = 'val-good' %}
            {% elif ul_ratio >= 0.5 %}
                {% set ul_val_class = 'val-warn' %}
            {% else %}
                {% set ul_val_class = 'val-bad' %}
            {% endif %}
        {% else %}
            {% set ul_val_class = 'val-good' %}
        {% endif %}
    {% endif %}

    {# ══════════════════════════════════════════════════════════════════════════
       METRIC SUMMARY ROW - Phase 3 Task 3.2
       Compact metric cards: DS, US, Errors, Speed (no expandable details)
       ══════════════════════════════════════════════════════════════════════════ #}
    <div class="metric-summary-row">
        {# Card 1: Downstream Signal #}
        <div class="metric-summary-card health-{{ signal_health }}">
            <div class="metric-summary-header">
                <i data-lucide="radio" class="metric-icon"></i>
                <span class="metric-label">{{ t.downstream }}</span>
            </div>
            <div class="metric-summary-values">
                <div class="metric-value-item">
                    <span class="value val-{{ ds_pwr_health }}">{{ s.ds_power_avg }}</span>
                    <span class="unit">dBmV</span>
                    <span class="sublabel">Ø {{ t.card_ds_power }}</span>
                </div>
                <div class="metric-value-divider"></div>
                <div class="metric-value-item">
                    <span class="value val-{{ snr_health }}">{{ s.ds_snr_avg }}</span>
                    <span class="unit">dB</span>
                    <span class="sublabel">Ø {{ t.card_snr }}</span>
                </div>
            </div>
        </div>

        {# Card 2: Upstream Signal #}
        <div class="metric-summary-card health-{{ us_health }}">
            <div class="metric-summary-header">
                <i data-lucide="radio" class="metric-icon"></i>
                <span class="metric-label">{{ t.upstream }}</span>
            </div>
            <div class="metric-summary-values">
                <div class="metric-value-item">
                    <span class="value val-{{ us_health }}">{{ s.us_power_avg }}</span>
                    <span class="unit">dBmV</span>
                    <span class="sublabel">Ø {{ t.card_transmit_power }}</span>
                </div>
                {% if s.us_capacity_mbps is not none %}
                <div class="metric-value-divider"></div>
                <div class="metric-value-item">
                    <span class="value val-{{ us_health }}">{{ s.us_capacity_mbps }}</span>
                    <span class="unit">Mbit/s</span>
                    <span class="sublabel">{{ t.card_us_capacity or 'Capacity' }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        {# Card 3: Errors #}
        <div class="metric-summary-card health-{{ error_health }}">
            <div class="metric-summary-header">
                <i data-lucide="alert-triangle" class="metric-icon"></i>
                <span class="metric-label">{{ t.card_errors }}</span>
            </div>
            <div class="metric-summary-values">
                <div class="metric-value-item">
                    <span class="value val-{{ error_health }}">{{ s.ds_uncorrectable_errors|fmt_k }}</span>
                    <span class="unit">{{ t.card_uncorr_label }}</span>
                    <span class="sublabel">{{ s.ds_correctable_errors|fmt_k }} {{ t.card_corr_label }}</span>
                </div>
            </div>
        </div>

        {# Card 4: Speedtest (conditional) #}
        {% if speedtest_configured and speedtest_latest %}
        <div class="metric-summary-card {{ speed_health }}">
            <div class="metric-summary-header">
                <i data-lucide="zap" class="metric-icon"></i>
                <span class="metric-label">{{ t.speed }}</span>
            </div>
            <div class="metric-summary-values" style="display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;">
                <div class="metric-value-item">
                    <span class="value {{ dl_val_class }}">{{ speedtest_latest.download_mbps|fmt_speed_value }}</span>
                    <span class="unit">{{ speedtest_latest.download_mbps|fmt_speed_unit }}</span>
                    <span class="sublabel">{{ t.download }}</span>
                </div>
                <div class="metric-value-divider"></div>
                <div class="metric-value-item">
                    <span class="value {{ ul_val_class }}">{{ speedtest_latest.upload_mbps|fmt_speed_value }}</span>
                    <span class="unit">{{ speedtest_latest.upload_mbps|fmt_speed_unit }}</span>
                    <span class="sublabel">{{ t.upload }}</span>
                </div>
                <div class="metric-value-item secondary" style="grid-column:1;">
                    <span class="value">{{ speedtest_latest.ping_ms|round(0)|int }}</span>
                    <span class="unit">ms</span>
                    <span class="sublabel">Ping</span>
                </div>
                <div class="metric-value-divider"></div>
                <div class="metric-value-item secondary" style="grid-column:3;">
                    <span class="value">{{ speedtest_latest.jitter_ms|round(1) }}</span>
                    <span class="unit">ms</span>
                    <span class="sublabel">Jitter</span>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    {# ══════════════════════════════════════════════════════════════════════════
       BREITBANDMESSUNG (BNetzA) - Conditional card, only shown when data exists
       ══════════════════════════════════════════════════════════════════════════ #}
    {% if bnetz_enabled and bnetz_latest %}
    {% set bnetz_dl_pct = ((bnetz_latest.download_measured_avg / bnetz_latest.download_max_tariff * 100)|round(0)|int) if bnetz_latest.download_max_tariff else 0 %}
    {% set bnetz_ul_pct = ((bnetz_latest.upload_measured_avg / bnetz_latest.upload_max_tariff * 100)|round(0)|int) if bnetz_latest.upload_max_tariff else 0 %}
    {% set bnetz_has_deviation = bnetz_latest.verdict_download == 'deviation' or bnetz_latest.verdict_upload == 'deviation' %}
    <div class="metric-summary-row">
        <div class="metric-summary-card {{ 'health-crit' if bnetz_has_deviation else 'health-good' }}" style="flex:1;">
            <div class="metric-summary-header">
                <i data-lucide="file-check" class="metric-icon"></i>
                <span class="metric-label">{{ t.bnetz_title }}</span>
            </div>
            <div class="metric-summary-values" style="display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;">
                <div class="metric-value-item">
                    <span class="value">{{ bnetz_latest.download_measured_avg|round(0)|int }}</span>
                    <span class="unit">/ {{ bnetz_latest.download_max_tariff|round(0)|int }} Mbit/s ({{ bnetz_dl_pct }}%)</span>
                    <span class="sublabel">{{ t.download }}</span>
                </div>
                <div class="metric-value-divider"></div>
                <div class="metric-value-item">
                    <span class="value">{{ bnetz_latest.upload_measured_avg|round(0)|int }}</span>
                    <span class="unit">/ {{ bnetz_latest.upload_max_tariff|round(0)|int }} Mbit/s ({{ bnetz_ul_pct }}%)</span>
                    <span class="sublabel">{{ t.upload }}</span>
                </div>
                <div class="metric-value-item secondary" style="grid-column:1/-1;text-align:center;">
                    <span class="value" style="font-size:0.8em;color:{{ 'var(--crit)' if bnetz_has_deviation else 'var(--good)' }};">
                        {{ t.bnetz_verdict_deviation if bnetz_has_deviation else t.bnetz_verdict_ok }}
                    </span>
                    <span class="sublabel">{{ bnetz_latest.date }} &middot; {{ bnetz_latest.provider }}</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {# ══════════════════════════════════════════════════════════════════════════
       CHANNEL HEALTH OVERVIEW - Phase 3 Task 3.4
       Donut charts showing health distribution for DS/US channels
       ══════════════════════════════════════════════════════════════════════════ #}
    <div class="channel-health-card">
        <div class="channel-health-header">
            <i data-lucide="pie-chart" class="channel-health-icon"></i>
            <h3 class="channel-health-title">{{ t.get('channel_health_overview', 'Channel Health Overview') }}</h3>
        </div>
        
        <div class="channel-health-charts">
            <!-- Downstream Donut -->
            <div class="health-chart-container" 
                 data-good="{{ ds|selectattr('health', 'equalto', 'good')|list|length }}"
                 data-warn="{{ ds|rejectattr('health', 'equalto', 'good')|rejectattr('health', 'equalto', 'critical')|list|length }}"
                 data-crit="{{ ds|selectattr('health', 'equalto', 'critical')|list|length }}">
                <canvas id="ds-health-donut"></canvas>
                <div class="chart-label">{{ t.downstream }}</div>
            </div>
            
            <!-- Upstream Donut -->
            <div class="health-chart-container"
                 data-good="{{ us|selectattr('health', 'equalto', 'good')|list|length }}"
                 data-warn="{{ us|rejectattr('health', 'equalto', 'good')|rejectattr('health', 'equalto', 'critical')|list|length }}"
                 data-crit="{{ us|selectattr('health', 'equalto', 'critical')|list|length }}">
                <canvas id="us-health-donut"></canvas>
                <div class="chart-label">{{ t.upstream }}</div>
            </div>
        </div>
        
        <div class="channel-health-legend">
            <div class="legend-item">
                <span class="legend-dot legend-good"></span>
                <span class="legend-label">{{ t.health_good }}</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot legend-warn"></span>
                <span class="legend-label">{{ t.health_warning }}</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot legend-crit"></span>
                <span class="legend-label">{{ t.health_critical }}</span>
            </div>
        </div>
    </div>

    {# ── Module Cards (mixed with core, sorted by order) ── #}
    {% for mod in modules|sort(attribute='menu.order') if mod.template_paths.get('card') %}
    {% include mod.template_paths['card'] %}
    {% endfor %}

    {# ══════════════════════════════════════════════════════════════════════════
       DOWNSTREAM CHANNELS - Phase 3 Task 3.5
       Modern card containers for channel tables
       ══════════════════════════════════════════════════════════════════════════ #}
    <div class="channel-section">
        <div class="channel-section-header">
            <i data-lucide="radio-tower" class="section-icon"></i>
            <h2 class="section-title">{{ t.downstream }}</h2>
            <span class="section-badge">{{ ds|length }} {{ t.channel if ds|length == 1 else t.channels }}</span>
        </div>

        {% for group in ds|groupby('docsis_version')|reverse %}
        {% set g_crit = group.list|selectattr('health', 'equalto', 'critical')|list|length %}
        {% set g_warn = group.list|rejectattr('health', 'equalto', 'good')|rejectattr('health', 'equalto', 'critical')|list|length %}
        <div class="channel-card">
            <details class="channel-group" open>
                <summary>
                    <div class="channel-group-summary">
                        <span class="channel-group-label">DOCSIS {{ group.grouper }}</span>
                        <span class="channel-group-count">({{ group.list|length }} {{ t.channel if group.list|length == 1 else t.channels }})</span>
                        <div class="channel-group-badges">
                            {% if g_crit %}<span class="badge badge-crit">{{ g_crit }} {{ t.health_critical|lower }}</span>{% endif %}
                            {% if g_warn %}<span class="badge badge-warn">{{ g_warn }} {{ t.health_warning|lower }}</span>{% endif %}
                            {% if not g_crit and not g_warn %}<span class="badge badge-good">&#10003;</span>{% endif %}
                        </div>
                    </div>
                </summary>
                <div class="channel-table-wrapper">
                    <table class="sortable">
            <thead><tr>
                <th>{{ t.status }}</th><th>{{ t.channel }}</th><th>{{ t.frequency }}</th><th>{{ t.power_dbmv }}</th>
                <th>{{ t.snr_db }}</th><th>{{ t.modulation }}</th><th>{{ t.corr }}</th><th>{{ t.uncorr }}</th>
            </tr></thead>
            <tbody>
            {% for ch in group.list %}
            <tr>
                {% set ch_tips = {"power critical": t.ch_power_critical, "power warning": t.ch_power_warning, "snr critical": t.ch_snr_critical, "snr warning": t.ch_snr_warning} %}
                {% set ch_tip_parts = [] %}
                {% for key, label in ch_tips.items() %}{% if key in ch.health_detail %}{% if ch_tip_parts.append(label) %}{% endif %}{% endif %}{% endfor %}
                <td data-sort="{{ 0 if ch.health == 'good' else (2 if ch.health == 'critical' else 1) }}">
                    {% if ch.health == "good" %}<span class="badge badge-good">{{ t.health_good }}</span>
                    {% elif ch.health == "critical" %}<span class="badge badge-crit" title="{{ ch_tip_parts|join(', ') }}">{{ t.health_critical }}</span>
                    {% else %}<span class="badge badge-warn" title="{{ ch_tip_parts|join(', ') }}">{{ t.health_warning }}</span>{% endif %}
                </td>
                <td data-sort="{{ ch.channel_id }}">{{ ch.channel_id }}</td>
                <td>{{ ch.frequency }}</td>
                <td data-sort="{{ ch.power if ch.power is not none else 0 }}" class="{% if ch.power is not none %}{% if 'power critical' in ch.health_detail %}val-crit{% elif 'power warning' in ch.health_detail %}val-warn{% else %}val-good{% endif %}{% endif %}">{{ ch.power if ch.power is not none else "—" }}</td>
                <td data-sort="{{ ch.snr if ch.snr is not none else 0 }}" class="{% if ch.snr is not none %}{% if 'snr critical' in ch.health_detail %}val-crit{% elif 'snr warning' in ch.health_detail %}val-warn{% else %}val-good{% endif %}{% endif %}">{{ ch.snr if ch.snr is not none else "-" }}</td>
                <td>{{ ch.modulation }}</td>
                <td data-sort="{{ ch.correctable_errors }}">{{ ch.correctable_errors|fmt_k }}</td>
                <td data-sort="{{ ch.uncorrectable_errors }}">{{ ch.uncorrectable_errors|fmt_k }}</td>
            </tr>
            {% endfor %}
            </tbody>
                    </table>
                </div>
            </details>
        </div>
        {% endfor %}
    </div>

    {# ══════════════════════════════════════════════════════════════════════════
       UPSTREAM CHANNELS - Phase 3 Task 3.5
       Modern card containers for channel tables
       ══════════════════════════════════════════════════════════════════════════ #}
    <div class="channel-section">
        <div class="channel-section-header">
            <i data-lucide="radio-tower" class="section-icon"></i>
            <h2 class="section-title">{{ t.upstream }}</h2>
            <span class="section-badge">{{ us|length }} {{ t.channel if us|length == 1 else t.channels }}</span>
        </div>

        {% for group in us|groupby('docsis_version')|reverse %}
        {% set g_crit = group.list|selectattr('health', 'equalto', 'critical')|list|length %}
        {% set g_warn = group.list|rejectattr('health', 'equalto', 'good')|rejectattr('health', 'equalto', 'critical')|list|length %}
        <div class="channel-card">
            <details class="channel-group" open>
                <summary>
                    <div class="channel-group-summary">
                        <span class="channel-group-label">DOCSIS {{ group.grouper }}</span>
                        <span class="channel-group-count">({{ group.list|length }} {{ t.channel if group.list|length == 1 else t.channels }})</span>
                        <div class="channel-group-badges">
                            {% if g_crit %}<span class="badge badge-crit">{{ g_crit }} {{ t.health_critical|lower }}</span>{% endif %}
                            {% if g_warn %}<span class="badge badge-warn">{{ g_warn }} {{ t.health_warning|lower }}</span>{% endif %}
                            {% if not g_crit and not g_warn %}<span class="badge badge-good">&#10003;</span>{% endif %}
                        </div>
                    </div>
                </summary>
                <div class="channel-table-wrapper">
                    <table class="sortable">
            <thead><tr>
                <th>{{ t.status }}</th><th>{{ t.channel }}</th><th>{{ t.frequency }}</th><th>{{ t.power_dbmv }}</th>
                <th>{{ t.modulation }}</th><th>{{ t.bitrate or 'Bitrate' }}</th><th>{{ t.multiplex }}</th>
            </tr></thead>
            <tbody>
            {% for ch in group.list %}
            {% set ch_tips = [] %}
            {% if 'power critical low' in ch.health_detail %}{% set _ = ch_tips.append(t.ch_power_critical_low) %}{% elif 'power critical high' in ch.health_detail %}{% set _ = ch_tips.append(t.ch_power_critical_high) %}{% elif 'power warning low' in ch.health_detail %}{% set _ = ch_tips.append(t.ch_power_warning_low) %}{% elif 'power warning high' in ch.health_detail %}{% set _ = ch_tips.append(t.ch_power_warning_high) %}{% endif %}
            {% if 'modulation critical' in ch.health_detail %}{% set _ = ch_tips.append(t.ch_modulation_critical) %}{% elif 'modulation warning' in ch.health_detail %}{% set _ = ch_tips.append(t.ch_modulation_warning) %}{% endif %}
            {% set ch_tip = ch_tips|join(', ') %}
            <tr>
                <td data-sort="{{ 0 if ch.health == 'good' else (2 if ch.health == 'critical' else 1) }}">
                    {% if ch.health == "good" %}<span class="badge badge-good">{{ t.health_good }}</span>
                    {% elif ch.health == "critical" %}<span class="badge badge-crit" title="{{ ch_tip }}">{{ t.health_critical }}</span>
                    {% else %}<span class="badge badge-warn" title="{{ ch_tip }}">{{ t.health_warning }}</span>{% endif %}
                </td>
                <td data-sort="{{ ch.channel_id }}">{{ ch.channel_id }}</td>
                <td>{{ ch.frequency }}</td>
                <td data-sort="{{ ch.power if ch.power is not none else 0 }}" class="{% if ch.power is not none %}{% if 'power critical' in ch.health_detail %}val-crit{% elif 'power warning' in ch.health_detail %}val-warn{% else %}val-good{% endif %}{% endif %}">{{ ch.power if ch.power is not none else "—" }}</td>
                <td class="{% if 'modulation critical' in ch.health_detail %}val-crit{% elif 'modulation warning' in ch.health_detail %}val-warn{% else %}val-good{% endif %}">{{ ch.modulation }}</td>
                <td class="{% if 'modulation critical' in ch.health_detail %}val-crit{% elif 'modulation warning' in ch.health_detail %}val-warn{% endif %}">{% if ch.theoretical_bitrate %}{{ ch.theoretical_bitrate }} Mbit/s{% else %}—{% endif %}</td>
                <td>{{ ch.multiplex }}</td>
            </tr>
            {% endfor %}
            </tbody>
                    </table>
                </div>
            </details>
        </div>
        {% endfor %}
    </div>
    
    {% if not has_us_ofdma %}
    <div class="card-notice card-notice-warn" style="margin-top:8px;">
        <span>&#9888;</span> {{ t.card_no_docsis31 }}
    </div>
    {% endif %}

{% elif not error %}
    <div class="waiting">
        <div class="spinner"></div>
        <p>{{ t.waiting_msg }}</p>
    </div>
{% endif %}
</div>

<!-- ═══ View: Trends ═══ -->
<div id="view-trends" class="view">
    <div class="trend-header">
        <span class="trend-title" id="trend-title"></span>
        <div style="display:flex; align-items:center; gap:8px;">
            <button class="trend-tab temp-toggle" id="temp-toggle-btn" style="display:none;" title="{{ t.temp_overlay_show }}">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;">
                    <path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/>
                </svg>
            </button>
            <div class="trend-tabs" id="trend-tabs">
                <button class="trend-tab active" data-range="day">{{ t.day }}</button>
                <button class="trend-tab" data-range="week">{{ t.week }}</button>
                <button class="trend-tab" data-range="month">{{ t.month }}</button>
            </div>
        </div>
    </div>
    <div id="trend-no-data" class="no-data-msg" style="display:none"></div>
    <div class="charts-grid" id="charts-grid">
        <!-- DS Power Chart -->
        <div class="chart-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                    <div class="chart-label">{{ t.ds_power_avg }}</div>
                </div>
                <button class="chart-expand-btn" data-chart="chart-ds-power" title="Expand">&#x26F6;</button>
            </div>
            <canvas id="chart-ds-power"></canvas>
        </div>
        
        <!-- DS SNR Chart -->
        <div class="chart-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v20M2 12l10-10 10 10M2 12l10 10 10-10"/>
                    </svg>
                    <div class="chart-label">{{ t.ds_snr_avg }}</div>
                </div>
                <button class="chart-expand-btn" data-chart="chart-ds-snr" title="Expand">&#x26F6;</button>
            </div>
            <canvas id="chart-ds-snr"></canvas>
        </div>
        
        <!-- US Power Chart -->
        <div class="chart-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v20M17 7l-5-5-5 5M7 17l5 5 5-5"/>
                    </svg>
                    <div class="chart-label">{{ t.us_power_avg }}</div>
                </div>
                <button class="chart-expand-btn" data-chart="chart-us-power" title="Expand">&#x26F6;</button>
            </div>
            <canvas id="chart-us-power"></canvas>
        </div>
        
        <!-- Errors Chart -->
        <div class="chart-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <div class="chart-label">{{ t.errors }}</div>
                </div>
                <button class="chart-expand-btn" data-chart="chart-errors" title="Expand">&#x26F6;</button>
            </div>
            <canvas id="chart-errors"></canvas>
        </div>
    </div>
</div>

<!-- ═══ View: BQM Graphs ═══ -->
{% if bqm_configured %}
<div id="view-bqm" class="view">
    <div class="trend-header">
        <span class="trend-title">{{ t.bqm_title }}</span>
    </div>
    <!-- BQM Toolbar: quick-jump + month nav -->
    <div id="bqm-toolbar" class="bqm-toolbar">
        <button class="trend-tab bqm-quick" id="bqm-today-btn">{{ t.bqm_today }}</button>
        <button class="trend-tab bqm-quick" id="bqm-yesterday-btn">{{ t.bqm_yesterday }}</button>
        <div class="bqm-month-nav">
            <button id="bqm-month-prev" class="bqm-nav-btn">&#8249;</button>
            <span id="bqm-month-label" class="bqm-month-label"></span>
            <button id="bqm-month-next" class="bqm-nav-btn">&#8250;</button>
        </div>
        <button class="bqm-nav-btn bqm-import-btn" onclick="openBqmImportModal()" title="{{ t.bqm_import_title }}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" style="display:block;">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
        </button>
        <button class="bqm-nav-btn bqm-import-btn bqm-delete-btn" onclick="deleteBqmImages()" title="{{ t.bqm_delete }}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" style="display:block;">
                <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
            </svg>
        </button>
    </div>
    <!-- Calendar grid -->
    <div id="bqm-calendar" class="bqm-calendar">
        <div class="bqm-weekday-header">
            <span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span><span>Su</span>
        </div>
        <div id="bqm-calendar-grid" class="bqm-calendar-grid"></div>
    </div>
    <!-- Slideshow controls -->
    <div id="bqm-slideshow-controls" class="bqm-slideshow-controls">
        <button id="bqm-play-btn" class="bqm-ctrl-btn" title="{{ t.bqm_play }}">
            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><polygon points="6,4 20,12 6,20"/></svg>
        </button>
        <button id="bqm-stop-btn" class="bqm-ctrl-btn" title="{{ t.bqm_stop }}" style="display:none;">
            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><rect x="5" y="5" width="14" height="14" rx="2"/></svg>
        </button>
        <div class="bqm-speed-tabs" id="bqm-speed-tabs">
            <span class="bqm-speed-label">{{ t.bqm_speed }}:</span>
            <button class="trend-tab" data-speed="1000">1s</button>
            <button class="trend-tab active" data-speed="2000">2s</button>
            <button class="trend-tab" data-speed="5000">5s</button>
        </div>
        <span id="bqm-range-label" class="bqm-range-label"></span>
    </div>
    <div id="bqm-content">
        <div id="bqm-card" class="bqm-card" style="display:none;">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18"/>
                        <path d="M7 12l4-4 4 4 4-4"/>
                    </svg>
                    <div class="chart-label">{{ t.bqm_title }}</div>
                    <span id="bqm-live-badge" class="bqm-live-badge" style="display:none;">{{ t.bqm_live }}</span>
                    <span id="bqm-last-updated" class="bqm-last-updated" style="display:none;"></span>
                </div>
            </div>
            <div id="bqm-image-wrap" style="text-align:center;">
                <img id="bqm-image" style="max-width:100%; border-radius:8px;" alt="BQM Graph">
            </div>
        </div>
        <div id="bqm-no-data" class="no-data-msg" style="display:none;"></div>
    </div>
</div>
{% endif %}

<!-- ═══ BQM Import Modal ═══ -->
<div class="modal-overlay" id="bqm-import-modal" onclick="if(event.target===this)closeBqmImportModal()">
    <div class="modal" style="max-width:800px;">
        <div class="modal-header">
            <h2>{{ t.bqm_import_title }}</h2>
            <button class="modal-close" onclick="closeBqmImportModal()">&times;</button>
        </div>
        <div class="modal-body" style="overflow-y:auto;">
            <!-- Drop zone -->
            <div id="bqm-import-dropzone" class="import-upload-zone bqm-import-dropzone">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:48px;height:48px;color:var(--muted);">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <p>{{ t.bqm_import_drop }}</p>
                <p style="font-size:0.8em;color:var(--muted);">{{ t.bqm_import_formats }}</p>
                <input type="file" id="bqm-import-file-input" style="display:none;" accept="image/png,image/jpeg,.png,.jpg,.jpeg" multiple>
            </div>
            <!-- Options: overwrite + date offset -->
            <div id="bqm-import-options" style="display:none; margin:10px 0;">
                <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;">
                    <label style="display:flex;align-items:center;gap:8px;font-size:0.9em;cursor:pointer;">
                        <input type="checkbox" id="bqm-import-overwrite">
                        {{ t.bqm_import_overwrite }}
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;font-size:0.9em;">
                        {{ t.bqm_import_offset }}:
                        <input type="number" id="bqm-import-offset" class="bqm-offset-input" min="-30" max="30" value="0" step="1">
                    </label>
                </div>
            </div>
            <!-- Status line -->
            <div id="bqm-import-status" class="import-info" style="display:none;"></div>
            <!-- Preview table -->
            <div id="bqm-import-preview" style="display:none;">
                <div class="import-table-wrap">
                    <table class="bqm-import-table">
                        <thead><tr>
                            <th style="width:70px;"></th>
                            <th>{{ t.incident_title }}</th>
                            <th style="width:160px;">{{ t.incident_date }}</th>
                            <th style="width:36px;"></th>
                        </tr></thead>
                        <tbody id="bqm-import-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="incident-modal-footer" id="bqm-import-footer" style="display:none;">
            <div class="modal-footer-left"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-muted" onclick="closeBqmImportModal()">{{ t.cancel }}</button>
                <button class="btn btn-accent" id="bqm-import-confirm-btn" onclick="executeBqmImport()" disabled>{{ t.bqm_import }}</button>
            </div>
        </div>
    </div>
</div>

<!-- ═══ View: Smokeping Graphs ═══ -->
{% if modules|selectattr('id', 'equalto', 'docsight.smokeping')|list and smokeping_configured %}
<div id="view-smokeping" class="view">
    <div style="text-align:center; margin-bottom:24px;">
        <span class="trend-title">{{ t.smokeping_title }}</span>
        <div class="trend-tabs" id="smokeping-tabs" style="display:inline-flex; margin-top:12px;">
            <button class="trend-tab active" data-span="3h">3h</button>
            <button class="trend-tab" data-span="30h">30h</button>
            <button class="trend-tab" data-span="10d">10d</button>
            <button class="trend-tab" data-span="1y">1y</button>
        </div>
    </div>
    <div id="smokeping-content" class="bqm-card-grid">
    </div>
    <div id="smokeping-no-data" class="no-data-msg" style="display:none;"></div>
</div>
{% endif %}

<!-- ═══ View: Correlation Analysis ═══ -->
{% if speedtest_configured or bqm_configured %}
<div id="view-correlation" class="view">
    <div class="trend-header">
        <span class="trend-title">{{ t.correlation_title }}</span>
        <div class="trend-tabs" id="correlation-tabs">
            <button class="trend-tab active" data-value="24" onclick="selectPill(this, loadCorrelationData)">{{ t.correlation_hours_24 }}</button>
            <button class="trend-tab" data-value="48" onclick="selectPill(this, loadCorrelationData)">{{ t.correlation_hours_48 }}</button>
            <button class="trend-tab" data-value="168" onclick="selectPill(this, loadCorrelationData)">{{ t.correlation_hours_168 }}</button>
        </div>
    </div>
    <p class="correlation-desc" style="color:var(--muted); font-size:0.85em; margin:0 0 16px;">{{ t.correlation_desc }}</p>

    <div id="correlation-loading" class="waiting" style="display:none;">
        <div class="spinner"></div>
    </div>
    <div id="correlation-no-data" class="no-data-msg" style="display:none;"></div>

    <!-- Signal Health Timeline Chart -->
    <div id="correlation-chart-container" style="display:none;">
        <!-- Phase 4.4: Modern card wrapper for correlation chart -->
        <div class="correlation-chart-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18"/>
                        <path d="M18 17V9"/>
                        <path d="M13 17V5"/>
                        <path d="M8 17v-3"/>
                    </svg>
                    <div class="chart-label">{{ t.correlation_chart_title }}</div>
                </div>
                <div class="chart-export-buttons">
                    <button class="chart-export-btn" onclick="_corrExportPNG()" title="Export as PNG">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        PNG
                    </button>
                    <button class="chart-export-btn" onclick="_corrExportCSV()" title="Export as CSV">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        CSV
                    </button>
                </div>
            </div>
            <div class="correlation-chart-wrap">
                <canvas id="correlation-chart"></canvas>
                <canvas id="correlation-overlay" class="correlation-overlay"></canvas>
                <div class="correlation-tooltip" id="correlation-tooltip"></div>
                <div class="correlation-zoom-reset" id="correlation-zoom-reset" style="display:none;" onclick="_corrResetZoom()">Reset Zoom</div>
                <div class="correlation-chart-legend" id="correlation-legend"></div>
            </div>
        </div>
    </div>

    <!-- Unified Timeline Table -->
    <div id="correlation-table-card" class="table-card" style="display:none;">
        <div class="table-card-header">
            <div class="table-card-title">
                <svg class="table-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                <span>{{ t.correlation_timeline }}</span>
            </div>
        </div>
        <div id="correlation-table-wrap">
            <table id="correlation-table">
                <thead><tr>
                    <th>{{ t.timestamp }}</th>
                    <th style="width:90px;">Source</th>
                    <th>{{ t.event_message }}</th>
                    <th>{{ t.event_details }}</th>
                </tr></thead>
                <tbody id="correlation-tbody"></tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- ═══ View: Incident Journal ═══ -->
<div id="view-journal" class="view">
    <div class="journal-header">
        <span class="trend-title">{{ t.incident_journal }}</span>
        <div class="journal-header-actions">
            <button class="btn-new-entry" onclick="openEntryModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                    <path d="M12 5v14m-7-7h14"/>
                </svg>
                {{ t.new_entry }}
            </button>
            <button class="btn-new-entry btn-import" onclick="openImportModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                {{ t.import }}
            </button>
            <div class="journal-export-wrapper" style="position:relative;display:inline-block;">
                <button class="btn-new-entry btn-import" onclick="toggleExportDropdown(event)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    {{ t.export_journal }}
                </button>
                <div class="journal-export-dropdown" id="journal-export-dropdown">
                    <button onclick="exportJournal('csv')">CSV</button>
                    <button onclick="exportJournal('json')">JSON</button>
                    <button onclick="exportJournal('md')">Markdown</button>
                </div>
            </div>
            <button class="btn-danger btn-delete-all" id="btn-delete-all-entries" onclick="deleteAllEntries()" style="display:none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
                {{ t.delete_all }}
            </button>
        </div>
    </div>
    <div class="incident-filter-bar" id="incident-filter-bar" style="display:none;"></div>
    <div class="incident-summary" id="incident-summary" style="display:none;"></div>
    <div class="journal-bulk-bar" id="journal-bulk-bar" style="display:none;">
        <span class="journal-bulk-count" id="journal-bulk-count"></span>
        <select id="journal-bulk-incident-select" class="journal-bulk-select">
            <option value="" disabled selected>{{ t.incident_assign }}…</option>
        </select>
        <button class="btn-small btn-accent" onclick="bulkAssign()">{{ t.bulk_assign }}</button>
        <button class="btn-small btn-muted" onclick="bulkUnassign()">{{ t.bulk_unassign }}</button>
        <span class="journal-bulk-sep"></span>
        <button class="btn-small btn-ghost" onclick="clearBulkSelection()">{{ t.bulk_deselect }}</button>
    </div>
    <div class="journal-search-wrap" id="journal-search-wrap" style="display:none;">
        <div class="journal-search-box">
            <svg class="journal-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input type="text" id="journal-search-input" placeholder="{{ t.search_placeholder }}" autocomplete="off" spellcheck="false">
            <button class="journal-search-clear" id="journal-search-clear" onclick="clearJournalSearch()" style="display:none;">&times;</button>
        </div>
        <span class="journal-search-count" id="journal-search-count"></span>
    </div>
    <div id="journal-loading" class="waiting" style="display:none;">
        <div class="spinner"></div>
    </div>
    <div id="journal-empty" class="journal-empty" style="display:none;"></div>
    
    <!-- Phase 4.5: Card wrapper for journal table -->
    <div id="journal-table-card" class="table-card" style="display:none;">
        <div class="table-card-header">
            <div class="table-card-title">
                <svg class="table-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V5a2 2 0 00-2-2z"/>
                    <path d="M16 2v4M8 2v4M3 10h18"/>
                </svg>
                <span>{{ t.incident_journal }}</span>
            </div>
            <button class="btn-bulk-toggle" id="btn-bulk-toggle" onclick="toggleBulkMode()" style="display:none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;">
                    <polyline points="9 11 12 14 22 4"/>
                    <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                </svg>
                <span id="btn-bulk-toggle-label">{{ t.bulk_select }}</span>
            </button>
        </div>
        <table id="journal-table">
            <thead><tr id="journal-thead-row">
                <th style="width:36px;"></th>
                <th data-col="date">{{ t.incident_date }}<span class="sort-indicator"></span></th>
                <th data-col="title">{{ t.incident_title }}<span class="sort-indicator"></span></th>
                <th data-col="description" class="journal-hide-mobile">{{ t.incident_description }}<span class="sort-indicator"></span></th>
                <th>&#128206;</th>
            </tr></thead>
            <tbody id="journal-tbody"></tbody>
        </table>
    </div>

    <!-- ═══ Incident Timeline View (replaces journal table) ═══ -->
    <div id="incident-timeline-view" style="display:none;">
        <button class="incident-timeline-back" onclick="closeIncidentTimeline()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;">
                <polyline points="15 18 9 12 15 6"/>
            </svg>
            <span data-i18n="incident_back_journal">{{ t.incident_back_journal }}</span>
        </button>
        <div id="incident-timeline-header" class="incident-timeline-card"></div>
        <div id="incident-timeline-entries" class="incident-timeline-card"></div>
        <div id="incident-timeline-chart-card" class="incident-timeline-card">
            <div class="incident-timeline-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                <span data-i18n="incident_signal_timeline">{{ t.incident_signal_timeline }}</span>
            </div>
            <div class="incident-timeline-chart-wrap">
                <canvas id="incident-timeline-canvas"></canvas>
            </div>
        </div>
        <div id="incident-timeline-signals" class="incident-timeline-card"></div>
        <div id="incident-timeline-bnetz" class="incident-timeline-card" style="display:none;"></div>
    </div>
</div>

<!-- ═══ View: Event Log ═══ -->
<div id="view-events" class="view">
    <div class="events-header">
        <span class="trend-title">{{ t.event_log }}</span>
    </div>
    
    <!-- Phase 4.3: Pill filter toggles for severity -->
    <div class="events-filter-section">
        <div class="events-filter-label">{{ t.event_severity }}:</div>
        <div class="events-severity-pills">
            <button class="severity-pill active" data-severity="" onclick="filterEventsBySeverity('')">{{ t.event_all_severities }}</button>
            <button class="severity-pill" data-severity="info" onclick="filterEventsBySeverity('info')">{{ t.event_severity_info }}</button>
            <button class="severity-pill" data-severity="warning" onclick="filterEventsBySeverity('warning')">{{ t.event_severity_warning }}</button>
            <button class="severity-pill" data-severity="critical" onclick="filterEventsBySeverity('critical')">{{ t.event_severity_critical }}</button>
            <span style="border-left:1px solid var(--card-border, rgba(255,255,255,0.08)); height:20px; margin:0 8px;"></span>
            <button class="severity-pill active" id="hide-operational-btn" onclick="toggleHideOperational()">{{ t.event_hide_operational or 'Hide Operational' }}</button>
        </div>
    </div>
    
    <div id="events-loading" class="waiting" style="display:none;">
        <div class="spinner"></div>
    </div>
    <div id="events-empty" class="events-empty" style="display:none;"></div>
    
    <!-- Phase 4.3: Card wrapper for events table -->
    <div id="events-table-card" class="table-card" style="display:none;">
        <div class="table-card-header">
            <div class="table-card-title">
                <svg class="table-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>{{ t.event_log }}</span>
            </div>
            <button class="btn-ack-all" id="btn-ack-all" onclick="acknowledgeAllEvents()" style="display:none;">&#10003; {{ t.event_acknowledge_all }}</button>
        </div>
        <table id="events-table">
            <thead><tr>
                <th>{{ t.timestamp }}</th>
                <th>{{ t.event_severity }}</th>
                <th>{{ t.event_type }}</th>
                <th>{{ t.event_message }}</th>
                <th></th>
            </tr></thead>
            <tbody id="events-tbody"></tbody>
        </table>
    </div>
    
    <div id="events-show-more" style="text-align:center; padding:16px; display:none;">
        <button class="btn-show-more" onclick="loadMoreEvents()">{{ t.show_more }}</button>
    </div>
</div>

<!-- ═══ View: Channel Timeline ═══ -->
<div id="view-channels" class="view">
    <div class="trend-header" style="margin-bottom:12px;">
        <span class="trend-title">{{ t.channels }}</span>
        <div class="trend-tabs" id="channel-mode-tabs" style="margin-left:auto;">
            <button class="trend-tab active" data-value="timeline" onclick="selectPill(this, switchChannelMode)">{{ t.channel_timeline }}</button>
            <button class="trend-tab" data-value="compare" onclick="selectPill(this, switchChannelMode)">{{ t.channel_compare }}</button>
        </div>
    </div>

    <!-- ── Timeline Sub-View ── -->
    <div id="channel-panel-timeline">
        <div class="channel-filters" style="display:flex; gap:12px; margin-bottom:20px; flex-wrap:wrap; align-items:center;">
            <select id="channel-select" class="channel-select-styled" onchange="loadChannelTimeline()">
                <option value="">{{ t.select_channel }}</option>
            </select>
            <div class="trend-tabs" id="channel-time-tabs">
                <button class="trend-tab" data-value="1" onclick="selectPill(this, loadChannelTimeline)">1d</button>
                <button class="trend-tab" data-value="3" onclick="selectPill(this, loadChannelTimeline)">3d</button>
                <button class="trend-tab active" data-value="7" onclick="selectPill(this, loadChannelTimeline)">7d</button>
                <button class="trend-tab" data-value="30" onclick="selectPill(this, loadChannelTimeline)">30d</button>
            </div>
        </div>
        <div id="channel-loading" class="waiting" style="display:none;">
            <div class="spinner"></div>
        </div>
        <div id="channel-empty" class="events-empty" style="display:none;"></div>
        <div id="channel-charts" class="charts-grid" style="display:none;">
            <div class="chart-card">
                <div class="chart-card-header">
                    <div class="chart-header-content">
                        <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                        </svg>
                        <div class="chart-label">{{ t.power_history }}</div>
                    </div>
                    <button class="chart-expand-btn" data-chart="chart-ch-power" title="Expand">&#x26F6;</button>
                </div>
                <canvas id="chart-ch-power"></canvas>
            </div>
            <div class="chart-card" id="channel-errors-card">
                <div class="chart-card-header">
                    <div class="chart-header-content">
                        <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <div class="chart-label">{{ t.error_history }}</div>
                    </div>
                    <button class="chart-expand-btn" data-chart="chart-ch-errors" title="Expand">&#x26F6;</button>
                </div>
                <canvas id="chart-ch-errors"></canvas>
            </div>
            <div class="chart-card" id="channel-modulation-card">
                <div class="chart-card-header">
                    <div class="chart-header-content">
                        <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3v18h18"/>
                            <path d="M7 12l4-4 4 4 4-4"/>
                        </svg>
                        <div class="chart-label">{{ t.modulation }}</div>
                    </div>
                    <button class="chart-expand-btn" data-chart="chart-ch-modulation" title="Expand">&#x26F6;</button>
                </div>
                <canvas id="chart-ch-modulation"></canvas>
            </div>
        </div>
    </div>

    <!-- ── Compare Sub-View ── -->
    <div id="channel-panel-compare" style="display:none;">
        <div class="compare-controls">
            <div class="trend-tabs" id="compare-dir-tabs">
                <button class="trend-tab active" data-value="ds" onclick="selectPill(this, onCompareDirectionChange)">{{ t.downstream }}</button>
                <button class="trend-tab" data-value="us" onclick="selectPill(this, onCompareDirectionChange)">{{ t.upstream }}</button>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
                <select id="compare-channel-select"><option value="">{{ t.select_channel }}</option></select>
                <button class="compare-add-btn" onclick="addCompareChannel()">+ {{ t.add_channel }}</button>
            </div>
            <div class="trend-tabs" id="compare-time-tabs">
                <button class="trend-tab" data-value="1" onclick="selectPill(this, loadCompareCharts)">1d</button>
                <button class="trend-tab" data-value="3" onclick="selectPill(this, loadCompareCharts)">3d</button>
                <button class="trend-tab active" data-value="7" onclick="selectPill(this, loadCompareCharts)">7d</button>
                <button class="trend-tab" data-value="30" onclick="selectPill(this, loadCompareCharts)">30d</button>
            </div>
        </div>
        <div id="compare-chips" class="compare-chips"></div>
        <div id="compare-empty" class="events-empty" style="display:none;"></div>
        <div id="compare-loading" class="waiting" style="display:none;">
            <div class="spinner"></div>
        </div>
        <div id="compare-charts" class="charts-grid" style="display:none;">
            <div class="chart-card">
                <div class="chart-card-header">
                    <div class="chart-header-content">
                        <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                        </svg>
                        <div class="chart-label">{{ t.power_history }}</div>
                    </div>
                    <button class="chart-expand-btn" data-chart="chart-cmp-power" title="Expand">&#x26F6;</button>
                </div>
                <canvas id="chart-cmp-power"></canvas>
            </div>
            <div class="chart-card" id="compare-snr-card">
                <div class="chart-card-header">
                    <div class="chart-header-content">
                        <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                        </svg>
                        <div class="chart-label">{{ t.snr_history }}</div>
                    </div>
                    <button class="chart-expand-btn" data-chart="chart-cmp-snr" title="Expand">&#x26F6;</button>
                </div>
                <canvas id="chart-cmp-snr"></canvas>
            </div>
            <div class="chart-card" id="compare-errors-card">
                <div class="chart-card-header">
                    <div class="chart-header-content">
                        <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <div class="chart-label">{{ t.error_history }}</div>
                    </div>
                    <button class="chart-expand-btn" data-chart="chart-cmp-errors" title="Expand">&#x26F6;</button>
                </div>
                <canvas id="chart-cmp-errors"></canvas>
            </div>
            <div class="chart-card" id="compare-modulation-card">
                <div class="chart-card-header">
                    <div class="chart-header-content">
                        <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3v18h18"/>
                            <path d="M7 12l4-4 4 4 4-4"/>
                        </svg>
                        <div class="chart-label">{{ t.modulation }}</div>
                    </div>
                    <button class="chart-expand-btn" data-chart="chart-cmp-modulation" title="Expand">&#x26F6;</button>
                </div>
                <canvas id="chart-cmp-modulation"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- ═══ Entry Modal ═══ -->
<div class="modal-overlay" id="entry-modal" onclick="if(event.target===this)closeEntryModal()">
    <div class="modal" style="max-width:640px;">
        <div class="modal-header">
            <div style="display:flex;align-items:center;gap:10px;">
                <span id="entry-modal-icon" class="incident-modal-icon"></span>
                <h2 id="entry-modal-title"></h2>
            </div>
            <button class="modal-close" onclick="closeEntryModal()">&times;</button>
        </div>
        <div class="modal-body" style="overflow-y:auto;">
            <input type="hidden" id="entry-id">
            <div class="incident-form-group">
                <label for="entry-date">{{ t.incident_date }}</label>
                <input type="date" id="entry-date">
            </div>
            <div class="incident-form-group">
                <label for="entry-title-input">{{ t.incident_title }}</label>
                <input type="text" id="entry-title-input" maxlength="200" placeholder="{{ t.incident_title }}">
            </div>
            <div class="incident-form-group">
                <label>{{ t.icon }}</label>
                <input type="hidden" id="entry-icon-value">
                <div class="icon-picker" id="entry-icon-picker"></div>
            </div>
            <div class="incident-form-group">
                <label for="entry-desc">{{ t.incident_description }}</label>
                <textarea id="entry-desc" maxlength="10000" placeholder="{{ t.incident_description }}"></textarea>
            </div>
            <div class="incident-form-group">
                <label for="entry-incident-select">{{ t.incident_assign }}</label>
                <select id="entry-incident-select" class="entry-incident-select">
                    <option value="">{{ t.incident_none }}</option>
                </select>
            </div>
            <div class="incident-form-group" id="entry-attachments-section">
                <label>{{ t.attachments }}</label>
                <div class="attachment-list" id="entry-attachment-list"></div>
                <button class="btn-upload" id="entry-upload-btn" onclick="document.getElementById('entry-file-input').click()">
                    &#128206; {{ t.upload_file }}
                </button>
                <span id="entry-upload-spinner" style="display:none;"><span class="upload-spinner"></span></span>
                <input type="file" id="entry-file-input" style="display:none;" multiple
                       accept="image/png,image/jpeg,image/gif,image/webp,application/pdf,text/plain"
                       onchange="handleEntryFileUpload(this)">
            </div>
        </div>
        <div class="incident-modal-footer">
            <div class="modal-footer-left">
                <button class="btn-danger" id="entry-delete-btn" onclick="deleteEntry()" style="display:none;">{{ t.delete_incident }}</button>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-muted" onclick="closeEntryModal()">{{ t.cancel }}</button>
                <button class="btn btn-accent" onclick="saveEntry()">{{ t.save }}</button>
            </div>
        </div>
    </div>
</div>

<!-- ═══ Incident Container Modal ═══ -->
<div class="modal-overlay" id="incident-container-modal" onclick="if(event.target===this)closeIncidentModal()">
    <div class="modal incident-container-modal" style="max-width:560px;">
        <div class="modal-header">
            <h2 id="incident-container-modal-title"></h2>
            <button class="modal-close" onclick="closeIncidentModal()">&times;</button>
        </div>
        <div class="modal-body" style="overflow-y:auto;">
            <input type="hidden" id="incident-container-id">
            <div class="incident-form-group">
                <label for="incident-container-name">{{ t.incident_name }}</label>
                <input type="text" id="incident-container-name" maxlength="200" placeholder="{{ t.incident_name }}">
            </div>
            <div class="incident-form-group">
                <label for="incident-container-status">{{ t.incident_status }}</label>
                <select id="incident-container-status">
                    <option value="open">{{ t.incident_status_open }}</option>
                    <option value="resolved">{{ t.incident_status_resolved }}</option>
                    <option value="escalated">{{ t.incident_status_escalated }}</option>
                </select>
            </div>
            <div class="incident-form-group" style="display:flex;gap:12px;">
                <div style="flex:1;">
                    <label for="incident-container-start">{{ t.incident_start_date }}</label>
                    <input type="date" id="incident-container-start">
                </div>
                <div style="flex:1;">
                    <label for="incident-container-end">{{ t.incident_end_date }}</label>
                    <input type="date" id="incident-container-end">
                </div>
            </div>
            <div class="incident-form-group">
                <label>{{ t.icon }}</label>
                <input type="hidden" id="incident-container-icon-value">
                <div class="icon-picker" id="incident-container-icon-picker"></div>
            </div>
            <div class="incident-form-group">
                <label for="incident-container-desc">{{ t.incident_description }}</label>
                <textarea id="incident-container-desc" maxlength="5000" placeholder="{{ t.incident_description }}"></textarea>
            </div>
            <div class="incident-form-group" id="incident-container-entry-count-section" style="display:none;">
                <label>{{ t.incident_entry_count }}</label>
                <span id="incident-container-entry-count" style="font-weight:600;"></span>
            </div>
        </div>
        <div class="incident-modal-footer">
            <div class="modal-footer-left">
                <button class="btn-danger" id="incident-container-delete-btn" onclick="deleteIncident()" style="display:none;">{{ t.delete }}</button>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-muted" onclick="closeIncidentModal()">{{ t.cancel }}</button>
                <button class="btn btn-accent" onclick="saveIncident()">{{ t.save }}</button>
            </div>
        </div>
    </div>
</div>

<!-- ═══ Import Modal ═══ -->
<div class="modal-overlay" id="import-modal" onclick="if(event.target===this)closeImportModal()">
    <div class="modal" style="max-width:900px;">
        <div class="modal-header">
            <h2>{{ t.import_incidents }}</h2>
            <button class="modal-close" onclick="closeImportModal()">&times;</button>
        </div>
        <div class="modal-body" style="overflow-y:auto;">
            <!-- Upload zone -->
            <div id="import-upload-zone" class="import-upload-zone">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:48px;height:48px;color:var(--muted);">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <p>{{ t.import_upload_hint }}</p>
                <p style="font-size:0.8em;color:var(--muted);">{{ t.import_file_types }}</p>
                <input type="file" id="import-file-input" style="display:none;" accept=".xlsx,.csv" onchange="handleImportFile(this)">
            </div>
            <!-- Loading -->
            <div id="import-loading" style="display:none;text-align:center;padding:20px;">
                <div class="spinner"></div>
                <p style="margin-top:10px;color:var(--muted);">{{ t.import_parsing }}</p>
            </div>
            <!-- Preview -->
            <div id="import-preview" style="display:none;">
                <div class="import-info" id="import-info"></div>
                <div class="import-controls">
                    <label class="import-select-all">
                        <input type="checkbox" id="import-select-all" checked onchange="toggleImportAll(this.checked)">
                        {{ t.import_select_all }}
                    </label>
                </div>
                <div class="import-table-wrap">
                    <table class="import-table" id="import-table">
                        <thead><tr>
                            <th style="width:40px;"></th>
                            <th style="width:36px;"></th>
                            <th>{{ t.incident_date }}</th>
                            <th>{{ t.incident_title }}</th>
                            <th class="journal-hide-mobile">{{ t.incident_description }}</th>
                        </tr></thead>
                        <tbody id="import-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="incident-modal-footer" id="import-footer" style="display:none;">
            <div class="modal-footer-left"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-muted" onclick="closeImportModal()">{{ t.cancel }}</button>
                <button class="btn btn-accent" id="import-confirm-btn" onclick="confirmImport()">{{ t.import_selected }}</button>
            </div>
        </div>
    </div>
</div>

<!-- ═══ View: Speedtest ═══ -->
{% if speedtest_configured %}
<div id="view-speedtest" class="view">
    <div class="trend-header">
        <span class="trend-title">{{ t.speedtest_tracker }}</span>
        <div style="display:flex; gap:8px; align-items:center;">
            <div class="trend-tabs" id="speedtest-tabs">
                <button class="trend-tab" data-value="1" onclick="selectPill(this, filterSpeedtestData)">1d</button>
                <button class="trend-tab active" data-value="7" onclick="selectPill(this, filterSpeedtestData)">7d</button>
                <button class="trend-tab" data-value="14" onclick="selectPill(this, filterSpeedtestData)">14d</button>
                <button class="trend-tab" data-value="30" onclick="selectPill(this, filterSpeedtestData)">30d</button>
                <button class="trend-tab" data-value="90" onclick="selectPill(this, filterSpeedtestData)">90d</button>
                <button class="trend-tab" data-value="all" onclick="selectPill(this, filterSpeedtestData)">{{ t.fetch_all }}</button>
            </div>
            <button class="refresh-btn" id="speedtest-refresh-btn" title="{{ t.refresh }}" onclick="loadSpeedtestHistory()">&#x1F504;</button>
        </div>
    </div>
    <div id="speedtest-loading" class="waiting" style="display:none;">
        <div class="spinner"></div>
        <p>{{ t.fetching }}</p>
    </div>
    <div id="speedtest-no-data" class="no-data-msg" style="display:none;"></div>
    <div id="speedtest-chart-container" style="display:none;">
        <!-- Phase 4.2: Modern card wrapper for speedtest chart -->
        <div class="speedtest-chart-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    <div class="chart-label">Speedtest History</div>
                </div>
            </div>
            <div class="speedtest-chart-wrap">
                <canvas id="speedtest-chart"></canvas>
                <div class="speedtest-chart-tooltip" id="speedtest-chart-tooltip"></div>
                <div class="speedtest-chart-legend">
                    <span class="legend-dl">Download (Mbps)</span>
                    <span class="legend-ul">Upload (Mbps)</span>
                    <span class="legend-ping">Ping (ms)</span>
                    <span class="legend-thresh">80% Median DL</span>
                </div>
            </div>
        </div>
    </div>
    <!-- Phase 4.2: Table card wrapper -->
    <div id="speedtest-table-wrap" class="table-card">
        <table id="speedtest-table" class="sortable" style="display:none;">
            <thead><tr>
                <th class="st-expand-col"></th>
                <th data-col="timestamp">{{ t.timestamp }}<span class="sort-indicator">▼</span></th>
                <th data-col="server_id">{{ t.server or 'Server' }}<span class="sort-indicator"></span></th>
                <th data-col="download_mbps">{{ t.download }}<span class="sort-indicator"></span></th>
                <th data-col="upload_mbps">{{ t.upload }}<span class="sort-indicator"></span></th>
                <th data-col="ping_ms">{{ t.ping }}<span class="sort-indicator"></span></th>
                <th data-col="jitter_ms">{{ t.jitter }}<span class="sort-indicator"></span></th>
                <th data-col="packet_loss_pct">{{ t.packet_loss }}<span class="sort-indicator"></span></th>
            </tr></thead>
            <tbody id="speedtest-tbody"></tbody>
        </table>
        <div id="speedtest-show-more" style="text-align:center; padding:12px; display:none;">
            <button class="btn btn-muted" id="speedtest-more-btn" onclick="showMoreSpeedtest()"></button>
        </div>
    </div>
</div>
{% endif %}

{% if gaming_quality_enabled %}
<div id="view-gaming" class="view">
    <div class="trend-header">
        <span class="trend-title">{{ t.gaming_quality_label }}</span>
    </div>
    {% if gaming_index %}
    <div class="gaming-overview">
        <div class="gaming-gauge">
            {% set s = gaming_index.score %}
            <div class="gaming-gauge-band">
                <div class="gaming-gauge-segment gauge-f"><span>F</span></div>
                <div class="gaming-gauge-segment gauge-d"><span>D</span></div>
                <div class="gaming-gauge-segment gauge-c"><span>C</span></div>
                <div class="gaming-gauge-segment gauge-b"><span>B</span></div>
                <div class="gaming-gauge-segment gauge-a"><span>A</span></div>
            </div>
            <div class="gaming-gauge-track">
                <div class="gaming-gauge-marker" style="left:{{ s }}%;">
                    <div class="gaming-gauge-needle"></div>
                    <div class="gaming-gauge-score">{{ s }}</div>
                </div>
            </div>
            {% if not gaming_index.has_speedtest %}
            <p class="gaming-no-speedtest-hint"><i data-lucide="info" style="width:14px;height:14px;vertical-align:-2px;"></i> {{ t.gaming_no_speedtest_detail }}</p>
            {% endif %}
        </div>
        <div class="gaming-grade-big gaming-{{ gaming_index.grade|lower }}">
            <span class="gaming-grade-letter">{{ gaming_index.grade }}</span>
            <span class="gaming-grade-text">{{ t['gaming_grade_' ~ gaming_index.grade|lower] }}</span>
        </div>
    </div>
    <div class="gaming-components">
        <h3 class="gaming-section-title">{{ t.gaming_components_title }}</h3>
        {% for key, comp in gaming_index.components.items()|sort(attribute='1.weight', reverse=true) %}
        <div class="gaming-component-card">
            <div class="gaming-comp-header">
                <span class="gaming-comp-icon">
                    {% if key == 'latency' %}<i data-lucide="timer" style="width:16px;height:16px;"></i>
                    {% elif key == 'jitter' %}<i data-lucide="waves" style="width:16px;height:16px;"></i>
                    {% elif key == 'packet_loss' %}<i data-lucide="package-x" style="width:16px;height:16px;"></i>
                    {% elif key == 'docsis_health' %}<i data-lucide="heart-pulse" style="width:16px;height:16px;"></i>
                    {% elif key == 'snr_headroom' %}<i data-lucide="signal" style="width:16px;height:16px;"></i>
                    {% endif %}
                </span>
                <span class="gaming-comp-name">{{ t['gaming_comp_' ~ key] }}</span>
                <span class="gaming-comp-weight">{{ comp.weight }}%</span>
                <span class="gaming-comp-score {% if comp.score >= 80 %}score-good{% elif comp.score >= 50 %}score-warn{% else %}score-crit{% endif %}">{{ comp.score }}</span>
            </div>
            <div class="gaming-comp-bar">
                <div class="gaming-comp-fill {% if comp.score >= 80 %}fill-good{% elif comp.score >= 50 %}fill-warn{% else %}fill-crit{% endif %}" style="width:{{ comp.score }}%;"></div>
            </div>
            <p class="gaming-comp-detail">{{ t['gaming_comp_' ~ key ~ '_detail'] }}</p>
        </div>
        {% endfor %}
    </div>
    <div class="gaming-genres">
        <h3 class="gaming-section-title">{{ t.gaming_genres_title }}</h3>
        {% set g = gaming_index.grade|lower %}
        <div class="gaming-genre-cards">
            <div class="gaming-genre-card {% if g in ['a'] %}genre-ok{% elif g in ['b'] %}genre-ok{% elif g in ['c'] %}genre-warn{% else %}genre-bad{% endif %}">
                <span class="gaming-genre-icon"><i data-lucide="crosshair" style="width:18px;height:18px;"></i></span>
                <span class="gaming-genre-name">{{ t.gaming_genre_fps }}</span>
                <span class="gaming-genre-examples">CS2, Valorant, Fortnite</span>
                <span class="gaming-genre-verdict">{{ t['gaming_genre_fps_' ~ g] }}</span>
            </div>
            <div class="gaming-genre-card {% if g in ['a', 'b'] %}genre-ok{% elif g in ['c'] %}genre-ok{% else %}genre-bad{% endif %}">
                <span class="gaming-genre-icon"><i data-lucide="swords" style="width:18px;height:18px;"></i></span>
                <span class="gaming-genre-name">{{ t.gaming_genre_moba }}</span>
                <span class="gaming-genre-examples">LoL, Dota 2, HotS</span>
                <span class="gaming-genre-verdict">{{ t['gaming_genre_moba_' ~ g] }}</span>
            </div>
            <div class="gaming-genre-card {% if g in ['a', 'b'] %}genre-ok{% elif g in ['c', 'd'] %}genre-ok{% else %}genre-bad{% endif %}">
                <span class="gaming-genre-icon"><i data-lucide="globe" style="width:18px;height:18px;"></i></span>
                <span class="gaming-genre-name">{{ t.gaming_genre_mmo }}</span>
                <span class="gaming-genre-examples">WoW, FFXIV, GW2</span>
                <span class="gaming-genre-verdict">{{ t['gaming_genre_mmo_' ~ g] }}</span>
            </div>
            <div class="gaming-genre-card {% if g in ['a', 'b', 'c'] %}genre-ok{% elif g in ['d'] %}genre-warn{% else %}genre-bad{% endif %}">
                <span class="gaming-genre-icon"><i data-lucide="crown" style="width:18px;height:18px;"></i></span>
                <span class="gaming-genre-name">{{ t.gaming_genre_strategy }}</span>
                <span class="gaming-genre-examples">Civilization, AoE, Chess</span>
                <span class="gaming-genre-verdict">{{ t['gaming_genre_strategy_' ~ g] }}</span>
            </div>
        </div>
    </div>
    {% else %}
    <div class="no-data-msg">{{ t.gaming_no_data }}</div>
    {% endif %}
</div>
{% endif %}

<!-- ═══ View: Breitbandmessung (BNetzA) ═══ -->
{% if bnetz_enabled %}
<div id="view-bnetz" class="view">
    <div class="trend-header">
        <span class="trend-title">{{ t.bnetz_title }}</span>
        <div style="display:flex;gap:8px;align-items:center;">
            <label class="btn btn-muted" style="cursor:pointer;">
                <i data-lucide="upload" style="width:14px;height:14px;vertical-align:-2px;"></i> {{ t.bnetz_upload }}
                <input type="file" accept=".pdf,.csv" id="bnetz-file-input" style="display:none;" onchange="uploadBnetzFromView(this)">
            </label>
            <button class="refresh-btn" title="{{ t.refresh }}" onclick="loadBnetzData()">&#x1F504;</button>
        </div>
    </div>
    <div id="bnetz-watcher-status" style="display:none;padding:8px 14px;margin-bottom:10px;border-radius:8px;background:var(--card-bg);border:1px solid var(--input-border);font-size:0.85em;color:var(--text-muted);align-items:center;gap:8px;">
        <i data-lucide="eye" style="width:14px;height:14px;flex-shrink:0;"></i>
        <span id="bnetz-watcher-text"></span>
    </div>
    <div id="bnetz-loading" class="waiting" style="display:none;">
        <div class="spinner"></div>
    </div>
    <div id="bnetz-empty" class="no-data-msg" style="display:none;">
        {{ t.bnetz_no_measurements }}
    </div>
    <div id="bnetz-table-card" class="table-card" style="display:none;">
        <table id="bnetz-table">
            <thead><tr>
                <th>{{ t.bnetz_date }}</th>
                <th>{{ t.bnetz_provider }}</th>
                <th>{{ t.bnetz_download_target }}</th>
                <th>{{ t.bnetz_download_actual }}</th>
                <th>{{ t.bnetz_upload_target }}</th>
                <th>{{ t.bnetz_upload_actual }}</th>
                <th>{{ t.bnetz_verdict }}</th>
                <th></th>
            </tr></thead>
            <tbody id="bnetz-tbody"></tbody>
        </table>
    </div>
</div>
{% endif %}

{# ══════════════════════════════════════════════════════════════════════════
   MODULE VIEWS - Dynamically rendered from enabled modules with tab template
   ══════════════════════════════════════════════════════════════════════════ #}
{% for mod in modules if mod.template_paths.get('tab') %}
<div id="view-mod-{{ mod.id|replace('.', '-') }}" class="view">
    {% include mod.template_paths['tab'] %}
</div>
{% endfor %}

</div><!-- /main-content -->
</div><!-- /app-main -->
</div><!-- /app-layout -->

<!-- Speedtest Setup Modal -->
<div class="modal-overlay" id="speedtest-setup-modal" onclick="if(event.target===this)closeSpeedtestSetupModal()">
    <div class="modal">
        <div class="modal-header">
            <h2>&#9889; {{ t.speedtest_setup_title }}</h2>
            <button class="modal-close" onclick="closeSpeedtestSetupModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 10px 0; font-size: 0.9em; line-height: 1.6;">
            <p style="margin-bottom:12px;">{{ t.speedtest_setup_intro }}</p>
            <div style="background:var(--bg); border-radius:8px; padding:14px; margin-bottom:14px;">
                <p style="font-weight:bold; margin-bottom:8px; color:var(--accent);">{{ t.speedtest_setup_benefits_title }}</p>
                <ul style="list-style:none; padding:0;">
                    <li style="margin-bottom:6px;">&#10003; {{ t.speedtest_setup_benefit_1 }}</li>
                    <li style="margin-bottom:6px;">&#10003; {{ t.speedtest_setup_benefit_2 }}</li>
                    <li style="margin-bottom:6px;">&#10003; {{ t.speedtest_setup_benefit_3 }}</li>
                </ul>
            </div>
            <div style="background:var(--bg); border-radius:8px; padding:14px;">
                <p style="font-weight:bold; margin-bottom:8px; color:var(--accent);">{{ t.speedtest_setup_howto_title }}</p>
                <ol style="padding-left:20px;">
                    <li style="margin-bottom:6px;">{{ t.speedtest_setup_step_1|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.speedtest_setup_step_2|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.speedtest_setup_step_3|safe_html }}</li>
                </ol>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-muted" onclick="closeSpeedtestSetupModal()">{{ t.close }}</button>
            <a class="btn btn-accent" href="/settings" style="text-decoration:none;">&#9881; {{ t.settings }}</a>
        </div>
    </div>
</div>

<!-- BQM Setup Modal -->
<div class="modal-overlay" id="bqm-setup-modal" onclick="if(event.target===this)closeBqmSetupModal()">
    <div class="modal">
        <div class="modal-header">
            <h2>&#128200; {{ t.bqm_setup_title }}</h2>
            <button class="modal-close" onclick="closeBqmSetupModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 10px 0; font-size: 0.9em; line-height: 1.6;">
            <p style="margin-bottom:12px;">{{ t.bqm_setup_intro }}</p>
            <div style="background:var(--bg); border-radius:8px; padding:14px; margin-bottom:14px;">
                <p style="font-weight:bold; margin-bottom:8px; color:var(--accent);">{{ t.bqm_setup_benefits_title }}</p>
                <ul style="list-style:none; padding:0;">
                    <li style="margin-bottom:6px;">✅ {{ t.bqm_setup_benefit_1 }}</li>
                    <li style="margin-bottom:6px;">✅ {{ t.bqm_setup_benefit_2 }}</li>
                    <li style="margin-bottom:6px;">✅ {{ t.bqm_setup_benefit_3 }}</li>
                </ul>
            </div>
            <div style="background:var(--bg); border-radius:8px; padding:14px;">
                <p style="font-weight:bold; margin-bottom:8px; color:var(--accent);">{{ t.bqm_setup_howto_title }}</p>
                <ol style="padding-left:20px;">
                    <li style="margin-bottom:6px;">{{ t.bqm_setup_step_1|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.bqm_setup_step_2|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.bqm_setup_step_3|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.bqm_setup_step_4|safe_html }}</li>
                </ol>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-muted" onclick="closeBqmSetupModal()">{{ t.close }}</button>
            <a class="btn btn-accent" href="/settings" style="text-decoration:none;">&#9881; {{ t.settings }}</a>
        </div>
    </div>
</div>

<!-- Smokeping Setup Modal -->
{% if modules|selectattr('id', 'equalto', 'docsight.smokeping')|list %}
<div class="modal-overlay" id="smokeping-setup-modal" onclick="if(event.target===this)closeSmokepingSetupModal()">
    <div class="modal">
        <div class="modal-header">
            <h2>&#128225; {{ t.smokeping_setup_title }}</h2>
            <button class="modal-close" onclick="closeSmokepingSetupModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 10px 0; font-size: 0.9em; line-height: 1.6;">
            <p style="margin-bottom:12px;">{{ t.smokeping_setup_intro }}</p>
            <div style="background:var(--bg); border-radius:8px; padding:14px;">
                <p style="font-weight:bold; margin-bottom:8px; color:var(--accent);">{{ t.bqm_setup_howto_title }}</p>
                <ol style="padding-left:20px;">
                    <li style="margin-bottom:6px;">{{ t.smokeping_setup_step_1|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.smokeping_setup_step_2|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.smokeping_setup_step_3|safe_html }}</li>
                </ol>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-muted" onclick="closeSmokepingSetupModal()">{{ t.close }}</button>
            <a class="btn btn-accent" href="/settings#integrations" style="text-decoration:none;">&#9881; {{ t.settings }}</a>
        </div>
    </div>
</div>
{% endif %}

<!-- Report Modal -->
<div class="modal-overlay" id="report-modal" onclick="if(event.target===this)closeReportModal()">
    <div class="modal" style="max-width:800px;">
        <div class="modal-header">
            <h2>{{ t.incident_report }}</h2>
            <button class="modal-close" onclick="closeReportModal()">&times;</button>
        </div>
        <p class="modal-hint">{{ t.report_description }}</p>
        <div class="modal-body" style="padding: 10px 0;">
            <!-- Step 1: Settings & Customer Info -->
            <div id="report-step1">
                <div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom:14px;">
                    <div>
                        <label style="font-size:13px; color:var(--muted);">{{ t.report_days }}</label><br>
                        <select id="report-days" style="margin-top:4px; padding:6px 10px; border-radius:6px; border:1px solid var(--border); background:var(--bg); color:var(--text);">
                            <option value="1">1</option><option value="3">3</option>
                            <option value="7" selected>7</option><option value="14">14</option>
                            <option value="30">30</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:13px; color:var(--muted);">{{ t.report_language }}</label><br>
                        <select id="report-lang" style="margin-top:4px; padding:6px 10px; border-radius:6px; border:1px solid var(--border); background:var(--bg); color:var(--text);">
                            {% for code, name in languages.items() %}
                            <option value="{{ code }}" {% if code == lang %}selected{% endif %}>{{ lang_flags.get(code, '') }} {{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div style="background:var(--bg); border-radius:8px; padding:14px; margin-bottom:10px;">
                    <p style="font-size:13px; color:var(--muted); margin-bottom:10px;">{{ t.report_customer_hint }}</p>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <input id="report-name" type="text" placeholder="{{ t.report_name }}" style="padding:8px 12px; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-family:inherit;">
                        <input id="report-number" type="text" placeholder="{{ t.report_customer_number }}" style="padding:8px 12px; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-family:inherit;">
                        <input id="report-address" type="text" placeholder="{{ t.report_address }}" style="padding:8px 12px; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-family:inherit;">
                    </div>
                </div>
                {% if bnetz_enabled %}
                <div style="margin-top:10px;">
                    <label style="display:flex; align-items:center; gap:8px; font-size:13px; color:var(--text);">
                        <input type="checkbox" id="report-include-bnetz" checked>
                        {{ t.report_include_bnetz }}
                    </label>
                </div>
                {% endif %}
                <input type="hidden" id="report-bnetz-id" value="">
            </div>
            <!-- Step 2: Generated complaint text (hidden initially) -->
            <div id="report-step2" style="display:none;">
                <p style="font-size:13px; color:var(--muted); margin-bottom:8px;">{{ t.report_edit_hint }}</p>
                <textarea id="report-complaint-text" style="width:100%; min-height:320px; background:var(--bg); color:var(--text); border:1px solid var(--border); border-radius:6px; padding:12px; font-size:0.85em; font-family:'Consolas','Monaco',monospace; resize:vertical; line-height:1.5;"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-muted" onclick="closeReportModal()">{{ t.close }}</button>
            <button class="btn btn-accent" id="report-generate-btn" onclick="generateComplaint()">&#9998; {{ t.report_generate_letter }}</button>
            <button class="btn btn-accent" id="report-copy-btn" style="display:none;" onclick="copyComplaint()">&#128203; {{ t.report_copy_letter }}</button>
            <button class="btn btn-accent" id="report-pdf-btn" style="display:none;" onclick="downloadReport()">&#128196; {{ t.report_download_pdf }}</button>
        </div>
    </div>
</div>

<!-- Chart Zoom Modal -->
<div class="chart-zoom-overlay" id="chart-zoom-overlay" onclick="if(event.target===this)closeChartZoom()">
    <div class="chart-zoom-modal">
        <div class="modal-header">
            <h2 id="chart-zoom-title"></h2>
            <button class="modal-close" onclick="closeChartZoom()">&times;</button>
        </div>
        <canvas id="chart-zoom-canvas"></canvas>
    </div>
</div>

<!-- Export Modal -->
<div class="modal-overlay" id="export-modal">
    <div class="modal">
        <div class="modal-header">
            <h2>{{ t.export_title }}</h2>
            <button class="modal-close" onclick="closeExportModal()">&times;</button>
        </div>
        <p class="modal-hint">{{ t.export_hint }}</p>
        <div class="export-mode-selector" style="padding:0 1.5rem;display:flex;gap:1.2rem;margin-bottom:0.5rem;">
            <label style="display:flex;align-items:center;gap:0.4rem;cursor:pointer;">
                <input type="radio" name="export-mode" value="full" checked onchange="exportForLLM()">
                &#128202; {{ t.export_full }}
            </label>
            <label style="display:flex;align-items:center;gap:0.4rem;cursor:pointer;">
                <input type="radio" name="export-mode" value="update" onchange="exportForLLM()">
                &#9200; {{ t.export_update }}
            </label>
        </div>
        <div class="modal-body">
            <textarea id="export-text" readonly></textarea>
        </div>
        <div class="modal-footer">
            <button class="btn btn-muted" onclick="closeExportModal()">{{ t.close }}</button>
            <button class="btn btn-accent" id="export-copy-btn" onclick="copyExport()">{{ t.copy_clipboard }}</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js"
        integrity="sha384-jb8JQMbMoBUzgWatfe6COACi2ljcDdZQ2OxczGA3bGNeWe+6DChMTBJemed7ZnvJ"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"
        integrity="sha384-cVMg8E3QFwTvGCDuK+ET4PD341jF3W8nO1auiXfuZNQkzbUUiBGLsIQUE+b1mxws"
        crossorigin="anonymous"></script>
<script src="{{ url_for('static', filename='js/hero-chart.js') }}"></script>

{# ── Channel Health Donut Charts - Phase 3 Task 3.4 ── #}
<script>
(function() {
    'use strict';
    
    // Store chart instances globally to prevent memory leaks on refresh
    window.donutCharts = window.donutCharts || {};
    
    function renderDonut(canvasId) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) {
            console.warn('[ChannelHealth] Canvas element #' + canvasId + ' not found');
            return;
        }
        
        // Read health counts from data-attributes (updated on refresh)
        const container = ctx.parentElement;
        if (!container) {
            console.warn('[ChannelHealth] Container not found for #' + canvasId);
            return;
        }
        
        const counts = {
            good: parseInt(container.getAttribute('data-good') || '0', 10),
            warn: parseInt(container.getAttribute('data-warn') || '0', 10),
            crit: parseInt(container.getAttribute('data-crit') || '0', 10)
        };
        
        // Destroy existing chart instance to prevent rendering issues
        if (window.donutCharts[canvasId]) {
            window.donutCharts[canvasId].destroy();
            delete window.donutCharts[canvasId];
        }
        
        const total = counts.good + counts.warn + counts.crit;
        if (total === 0) {
            console.warn('[ChannelHealth] No data for ' + canvasId);
            return;
        }
        
        var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
        window.donutCharts[canvasId] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Good', 'Warning', 'Critical'],
                datasets: [{
                    data: [counts.good, counts.warn, counts.crit],
                    backgroundColor: [
                        'rgba(76, 175, 80, 0.8)',
                        'rgba(255, 152, 0, 0.8)',
                        'rgba(244, 67, 54, 0.8)'
                    ],
                    borderColor: [
                        'rgba(76, 175, 80, 1)',
                        'rgba(255, 152, 0, 1)',
                        'rgba(244, 67, 54, 1)'
                    ],
                    borderWidth: 2,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                cutout: '65%',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: isDark ? 'rgba(15,20,25,0.95)' : 'rgba(255,255,255,0.95)',
                        titleColor: isDark ? 'rgba(224,224,224,0.9)' : 'rgba(30,30,30,0.9)',
                        bodyColor: isDark ? 'rgba(224,224,224,0.8)' : 'rgba(30,30,30,0.8)',
                        borderColor: isDark ? 'rgba(168,85,247,0.3)' : 'rgba(168,85,247,0.4)',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return label + ': ' + value + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
    
    function initDonuts() {
        renderDonut('ds-health-donut');
        renderDonut('us-health-donut');
    }
    
    // Expose refresh function globally for manual updates (refreshData after innerHTML replace)
    window.refreshDonuts = initDonuts;
    
    // Wait for DOM to be fully loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDonuts);
    } else {
        // DOM already loaded (script deferred or loaded late)
        initDonuts();
    }
})();
</script>

<script src="/static/js/chart-engine.js"></script>
<script>
var T = {{ t|tojson }};

(function() {
    'use strict';

    /* ── Theme ── */
    var saved = localStorage.getItem('docsis-theme');
    if (saved) document.documentElement.setAttribute('data-theme', saved);

    var themeToggle = document.getElementById('theme-toggle-sidebar');
    function updateThemeState() {
        var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
        themeToggle.checked = isDark;
    }
    updateThemeState();
    themeToggle.addEventListener('change', function() {
        var next = this.checked ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('docsis-theme', next);
        // Re-render charts with updated theme colors
        if (typeof window.refreshDonuts === 'function') {
            setTimeout(window.refreshDonuts, 50);
        }
    });

    /* ── State ── */
    /* currentView is global — defined in chart-engine.js */
    /* charts registry is global — defined in chart-engine.js */
    /* _trendRange → trends.js */
    /* BQM state variables → bqm.js */
    /* todayStr, pad, formatDateDE → chart-engine.js */

    /* ── Sortable Tables ── */
    function initSortableTables() {
        document.querySelectorAll('table.sortable').forEach(function(table) {
            var headers = table.querySelectorAll('th');
            headers.forEach(function(th, colIdx) {
                th.addEventListener('click', function() {
                    sortTable(table, colIdx, th);
                });
            });
        });
    }
    initSortableTables();

    function sortTable(table, colIdx, th) {
        var tbody = table.querySelector('tbody');
        var rows = Array.from(tbody.querySelectorAll('tr'));
        var asc = th.getAttribute('data-sort-dir') !== 'asc';

        table.querySelectorAll('th').forEach(function(h) {
            h.removeAttribute('data-sort-dir');
            h.classList.remove('sort-asc', 'sort-desc');
        });
        th.setAttribute('data-sort-dir', asc ? 'asc' : 'desc');
        th.classList.add(asc ? 'sort-asc' : 'sort-desc');

        rows.sort(function(a, b) {
            var cellA = a.cells[colIdx];
            var cellB = b.cells[colIdx];
            var valA = cellA.getAttribute('data-sort') || cellA.textContent.trim();
            var valB = cellB.getAttribute('data-sort') || cellB.textContent.trim();
            var numA = parseFloat(valA);
            var numB = parseFloat(valB);
            if (!isNaN(numA) && !isNaN(numB)) {
                return asc ? numA - numB : numB - numA;
            }
            return asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
        });
        rows.forEach(function(row) { tbody.appendChild(row); });
    }

    /* ── Sidebar ── */
    var sidebar = document.getElementById('sidebar');
    var sidebarBackdrop = document.getElementById('sidebar-backdrop');

    function isMobile() { return window.matchMedia('(max-width: 900px)').matches; }

    function closeMobileSidebar() {
        sidebar.classList.remove('mobile-open');
        sidebarBackdrop.classList.remove('active');
    }

    function collapseSidebar() {
        if (isMobile()) {
            closeMobileSidebar();
        } else {
            sidebar.classList.add('collapsed');
            sidebar.classList.remove('mobile-open');
            sidebarBackdrop.classList.remove('active');
            var btn = document.getElementById('sidebar-collapse');
            btn.innerHTML = '&#10095;'; // Right arrow >
            btn.title = 'Expand';
        }
    }
    function expandSidebar() {
        sidebar.classList.remove('collapsed');
        var btn = document.getElementById('sidebar-collapse');
        btn.innerHTML = '&#10094;'; // Left arrow <
        btn.title = 'Collapse';
    }
    function toggleSidebar() {
        if (sidebar.classList.contains('collapsed')) {
            expandSidebar();
        } else {
            collapseSidebar();
        }
    }

    document.getElementById('sidebar-collapse').addEventListener('click', toggleSidebar);
    document.getElementById('hamburger').addEventListener('click', function() {
        if (isMobile()) {
            // On mobile, NEVER use .collapsed - always use .mobile-open
            sidebar.classList.remove('collapsed');
            var opening = !sidebar.classList.contains('mobile-open');
            sidebar.classList.toggle('mobile-open', opening);
            sidebarBackdrop.classList.toggle('active', opening);
        } else {
            sidebar.classList.toggle('collapsed');
        }
    });
    sidebarBackdrop.addEventListener('click', closeMobileSidebar);

    var sidebarLinks = document.querySelectorAll('.sidebar-link[data-view]');
    sidebarLinks.forEach(function(link) {
        link.addEventListener('click', function() {
            if (isMobile()) { closeMobileSidebar(); }
            switchView(this.getAttribute('data-view'));
        });
    });

    /* ── Pill tab helpers ── */
    window.selectPill = function(btn, callback) {
        btn.parentElement.querySelectorAll('.trend-tab').forEach(function(t) { t.classList.remove('active'); });
        btn.classList.add('active');
        if (callback) callback();
    };
    window.getPillValue = function(containerId) {
        var active = document.querySelector('#' + containerId + ' .trend-tab.active');
        return active ? active.dataset.value : null;
    };

    function switchView(view, skipHash) {
        currentView = view;
        if (!skipHash) location.hash = view === 'live' ? '' : view;
        sidebarLinks.forEach(function(l) {
            l.classList.toggle('active', l.getAttribute('data-view') === view);
        });
        // Generic: remove active from all views, add to target
        document.querySelectorAll('.main-content > .view').forEach(function(v) {
            v.classList.remove('active');
        });
        var targetId = view === 'live' ? 'view-dashboard' : 'view-' + view;
        var target = document.getElementById(targetId);
        if (target) target.classList.add('active');

        stopAutoRefresh();
        if (typeof stopBqmLiveRefresh === 'function') stopBqmLiveRefresh();
        if (typeof stopBqmSlideshow === 'function') stopBqmSlideshow();

        // View-specific init callbacks
        if (view === 'live') {
            startAutoRefresh();
        } else if (view === 'bqm') {
            if (typeof initBqmView === 'function') initBqmView();
        } else if (view === 'smokeping') {
            if (typeof loadSmokepingGraphs === 'function') loadSmokepingGraphs();
        } else if (view === 'speedtest') {
            loadSpeedtestHistory();
        } else if (view === 'journal') {
            if (typeof _timelineActive !== 'undefined' && _timelineActive && typeof closeIncidentTimeline === 'function') closeIncidentTimeline();
            if (typeof loadIncidents === 'function') loadIncidents();
            if (typeof loadJournal === 'function') loadJournal();
        } else if (view === 'events') {
            loadEvents();
        } else if (view === 'channels') {
            if (typeof loadChannelList === 'function') loadChannelList();
            var mode = getPillValue('channel-mode-tabs') || 'timeline';
            if (mode === 'compare' && typeof loadCompareChannelList === 'function') loadCompareChannelList();
        } else if (view === 'correlation') {
            loadCorrelationData();
        } else if (view === 'bnetz') {
            if (typeof loadBnetzData === 'function') loadBnetzData();
        } else if (view === 'trends') {
            if (typeof updateTrendTabs === 'function') updateTrendTabs();
            if (typeof loadTrends === 'function') loadTrends(_trendRange);
        }

        // Re-initialize Lucide icons after view switch
        lucide.createIcons();
    }

    /* Trend Tabs → trends.js */

    /* ── Hash-based view routing ── */
    function viewFromHash() {
        var h = location.hash.replace('#', '');
        if (!h) return null;
        // Accept any view that exists in DOM (supports module views)
        var el = document.getElementById('view-' + h) || (h === 'live' && document.getElementById('view-dashboard'));
        return el ? h : null;
    }
    window.addEventListener('hashchange', function() {
        var v = viewFromHash();
        if (v && v !== currentView) switchView(v, true);
    });

    /* BNetzA Breitbandmessung → integrations.js */

    /* BQM Calendar, Live, Slideshow → bqm.js */

    /* ── Auto Refresh with Countdown ── */
    var refreshTimer = null;
    var countdownTimer = null;
    var countdownSeconds = 60;
    var REFRESH_INTERVAL = 60;
    var countdownEl = document.getElementById('topbar-countdown');

    function updateCountdown() {
        if (countdownEl) countdownEl.textContent = countdownSeconds + 's';
    }

    function startAutoRefresh() {
        stopAutoRefresh();
        countdownSeconds = REFRESH_INTERVAL;
        updateCountdown();
        countdownTimer = setInterval(function() {
            if (currentView !== 'live' || document.hidden) return;
            countdownSeconds--;
            if (countdownSeconds <= 0) {
                countdownSeconds = REFRESH_INTERVAL;
                refreshData();
            }
            updateCountdown();
        }, 1000);
    }
    function stopAutoRefresh() {
        if (countdownTimer) { clearInterval(countdownTimer); countdownTimer = null; }
        if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; }
    }

    function refreshData() {
        fetch(window.location.href)
            .then(function(r) { return r.text(); })
            .then(function(html) {
                var doc = new DOMParser().parseFromString(html, 'text/html');

                // Save expanded metric cards by index
                var openCardIndices = [];
                document.querySelectorAll('.metric-card').forEach(function(el, i) {
                    if (el.classList.contains('open')) openCardIndices.push(i);
                });

                // Save expanded channel groups by label text
                var openGroupLabels = [];
                document.querySelectorAll('details.channel-group[open]').forEach(function(el) {
                    var s = el.querySelector('summary');
                    if (s) openGroupLabels.push(s.textContent.trim());
                });

                // Replace dashboard content
                var freshDash = doc.querySelector('#view-dashboard');
                var currentDash = document.querySelector('#view-dashboard');
                if (freshDash && currentDash) {
                    currentDash.innerHTML = freshDash.innerHTML;
                }

                // Update topbar timestamp
                var freshMeta = doc.querySelector('#topbar-meta');
                var currentMeta = document.querySelector('#topbar-meta');
                if (freshMeta && currentMeta) {
                    currentMeta.innerHTML = freshMeta.innerHTML;
                }

                // Reset countdown after refresh
                countdownSeconds = REFRESH_INTERVAL;
                updateCountdown();

                // Restore expanded metric cards
                document.querySelectorAll('.metric-card').forEach(function(el, i) {
                    if (openCardIndices.indexOf(i) !== -1) el.classList.add('open');
                });

                // Restore expanded channel groups
                document.querySelectorAll('details.channel-group').forEach(function(el) {
                    var s = el.querySelector('summary');
                    if (s && openGroupLabels.indexOf(s.textContent.trim()) !== -1) {
                        el.setAttribute('open', '');
                    }
                });

                // Re-init sortable tables (event listeners lost on innerHTML replace)
                initSortableTables();

                // Re-init hero chart (Chart.js instance lost on innerHTML replace)
                if (typeof window.refreshHeroChart === 'function') {
                    window.refreshHeroChart();
                }

                // Re-init channel health donuts (Chart.js instances lost on innerHTML replace)
                if (typeof window.refreshDonuts === 'function') {
                    window.refreshDonuts();
                }

                // Re-init Lucide icons (lost on innerHTML replace)
                lucide.createIcons();

                // Refresh event badge count
                fetch('/api/events/count')
                    .then(function(r) { return r.json(); })
                    .then(function(d) { updateEventBadge(d.count || 0); })
                    .catch(function() {});
            })
            .catch(function(err) {
                console.warn('Auto-refresh failed:', err);
            });
    }

    if (currentView === 'live') startAutoRefresh();

    /* ── Manual Poll (Refresh Button) ── */
    var refreshBtn = document.getElementById('refresh-btn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            if (refreshBtn.disabled) return;
            refreshBtn.disabled = true;
            refreshBtn.classList.add('spinning');
            fetch('/api/poll', {method: 'POST'})
                .then(function(r) { return r.json().then(function(d) { return {status: r.status, data: d}; }); })
                .then(function(res) {
                    if (res.data.success) {
                        showToast(T.refresh_success || 'Data updated', 'success');
                        refreshData();
                    } else {
                        showToast(res.data.error || 'Error', res.status === 429 ? 'error' : 'error');
                    }
                })
                .catch(function() { showToast(T.network_error || 'Error', 'error'); })
                .finally(function() {
                    refreshBtn.classList.remove('spinning');
                    setTimeout(function() { refreshBtn.disabled = false; }, 10000);
                });
        });
    }

    function showToast(msg, type) {
        var toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.className = 'toast toast-' + (type || 'success') + ' show';
        setTimeout(function() { toast.classList.remove('show'); }, 3000);
    }
    window.showToast = showToast;

    /* Trend Charts, expand buttons, zoom shortcuts → trends.js */

    /* BQM keyboard shortcuts → bqm.js */

    /* BQM Graph + Import → bqm.js */

    /* Smokeping Graphs → integrations.js */

    /* ── Init ── */
    // Apply hash-based view routing (must be inside IIFE to access switchView)
    var _initHash = viewFromHash();
    if (_initHash && _initHash !== 'live') {
        switchView(_initHash, true);
    }


    /* ── Incident Journal, Incidents, Timeline, Import, Bulk, Search → journal.js ── */


    // Sidebar resize handler (clean up state on viewport change)
    window.addEventListener('resize', function() {
        if (isMobile()) {
            sidebar.classList.remove('collapsed');
            closeMobileSidebar();
        } else {
            sidebar.classList.remove('mobile-open');
            sidebarBackdrop.classList.remove('active');
        }
    });

})();

</script>
<script src="/static/js/journal.js"></script>
<script src="/static/js/bqm.js"></script>
<script src="/static/js/trends.js"></script>
<script src="/static/js/channels.js"></script>
<script src="/static/js/integrations.js"></script>
<script src="/static/js/events.js"></script>
<script src="/static/js/utils.js"></script>
<script src="/static/js/speedtest.js"></script>
<script src="/static/js/correlation.js"></script>

<script>
  // Initialize Lucide icons after DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();
  });
</script>
{% for mod in modules if mod.has_js %}
<script src="/modules/{{ mod.id }}/static/main.js"></script>
{% endfor %}
</body>
</html>
