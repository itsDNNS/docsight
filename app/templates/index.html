<!DOCTYPE html>
<html lang="{{ lang }}" data-theme="{{ theme|default('dark') }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DOCSight</title>
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg">
    <link rel="icon" type="image/png" href="/static/icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/main.css">
    <!-- Icon Library (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
<div class="app-layout">

<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <img src="/static/logo.svg" alt="DOCSight" style="width:36px;height:36px;vertical-align:middle;margin-right:8px;">
        <span>DOCSight</span>
        <button class="sidebar-toggle" id="sidebar-collapse" title="Collapse"></button>
    </div>
    <div class="sidebar-content">
        <div class="sidebar-section-label">{{ t.sidebar_monitoring }}</div>
        <a class="sidebar-link active" data-view="live" data-tooltip="{{ t.live_dashboard }}">
            <span class="icon"><i data-lucide="radio"></i></span> {{ t.live_dashboard }}
        </a>
        <a class="sidebar-link" data-view="events" data-tooltip="{{ t.event_log }}">
            <span class="icon"><i data-lucide="bell"></i></span> {{ t.event_log }}
            <span class="event-badge" id="event-badge" style="display:none;"></span>
        </a>
        <a class="sidebar-link" data-view="trends" data-tooltip="{{ t.signal_trends }}">
            <span class="icon"><i data-lucide="trending-up"></i></span> {{ t.signal_trends }}
        </a>
        <a class="sidebar-link" data-view="channels" data-tooltip="{{ t.channel_timeline }}">
            <span class="icon"><i data-lucide="clock"></i></span> {{ t.channel_timeline }}
        </a>
        {% if speedtest_configured or bqm_configured %}
        <a class="sidebar-link" data-view="correlation" data-tooltip="{{ t.correlation_analysis }}">
            <span class="icon"><i data-lucide="bar-chart-3"></i></span> {{ t.correlation_analysis }}
        </a>
        {% endif %}
        {% if gaming_quality_enabled %}
        <a class="sidebar-link" data-view="gaming" data-tooltip="{{ t.gaming_quality_label }}">
            <span class="icon"><i data-lucide="gamepad-2"></i></span> {{ t.gaming_quality_label }}
        </a>
        {% endif %}
        <div class="sidebar-section-label">{{ t.sidebar_external }}</div>
        {% if speedtest_configured %}
        <a class="sidebar-link" data-view="speedtest" data-tooltip="{{ t.speedtest }}">
            <span class="icon"><i data-lucide="rabbit"></i></span> {{ t.speedtest }}
        </a>
        {% endif %}
        {% if not speedtest_configured %}
        <a class="sidebar-link" onclick="openSpeedtestSetupModal()" data-tooltip="{{ t.speedtest_setup }}">
            <span class="icon"><i data-lucide="settings"></i></span> {{ t.speedtest_setup }}
        </a>
        {% endif %}
        {% if bqm_configured %}
        <a class="sidebar-link" data-view="bqm" data-tooltip="{{ t.bqm_title }}">
            <span class="icon"><i data-lucide="activity"></i></span> {{ t.bqm_title }}
        </a>
        {% endif %}
        {% if not bqm_configured %}
        <a class="sidebar-link" onclick="openBqmSetupModal()" data-tooltip="{{ t.bqm_setup }}">
            <span class="icon"><i data-lucide="settings"></i></span> {{ t.bqm_setup }}
        </a>
        {% endif %}
        {% if smokeping_configured %}
        <a class="sidebar-link" data-view="smokeping" data-tooltip="{{ t.smokeping_title }}">
            <span class="icon"><i data-lucide="radar"></i></span> {{ t.smokeping_title }}
        </a>
        {% endif %}
        {% if not smokeping_configured %}
        <a class="sidebar-link" onclick="openSmokepingSetupModal()" data-tooltip="{{ t.smokeping_setup }}">
            <span class="icon"><i data-lucide="settings"></i></span> {{ t.smokeping_setup }}
        </a>
        {% endif %}
        <div class="sidebar-section-label">{{ t.sidebar_documentation }}</div>
        <a class="sidebar-link" data-view="journal" data-tooltip="{{ t.incident_journal }}">
            <span class="icon"><i data-lucide="clipboard-list"></i></span> {{ t.incident_journal }}
        </a>
        <a class="sidebar-link" id="export-link" href="javascript:void(0)" onclick="exportForLLM()" data-tooltip="{{ t.export_llm }}">
            <span class="icon"><i data-lucide="file-output"></i></span> {{ t.export_llm }}
        </a>
        <a class="sidebar-link" id="report-link" href="javascript:void(0)" onclick="openReportModal()" data-tooltip="{{ t.incident_report }}">
            <span class="icon"><i data-lucide="file-text"></i></span> {{ t.incident_report }}
        </a>
        <div style="flex:1;"></div>
        <div class="sidebar-divider"></div>
        <a class="sidebar-link" href="/settings" data-tooltip="{{ t.settings }}">
            <span class="icon"><i data-lucide="settings"></i></span> {{ t.settings }}
        </a>
        {% if auth_enabled %}
        <a class="sidebar-link" href="/logout">
            <span class="icon">&#128682;</span> {{ t.logout }}
        </a>
        {% endif %}
        <div class="sidebar-footer">
            <div class="dark-mode-toggle">
                <span class="dark-mode-label"><i data-lucide="moon"></i> {{ t.dark_mode or 'Dark mode' }}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="theme-toggle-sidebar">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="sidebar-version-row">
                <a href="https://github.com/itsDNNS/docsight/releases" target="_blank" class="version-link">
                    {{ version }}
                    {% if update_available %}
                    <span class="update-badge" title="{{ update_available }}">Update</span>
                    {% endif %}
                </a>
                <a href="https://github.com/sponsors/itsDNNS" target="_blank" class="sponsor-link" title="Sponsor">
                    <i data-lucide="heart" style="width:14px;height:14px;"></i>
                </a>
            </div>
        </div>
    </div>
</nav>
<div class="sidebar-backdrop" id="sidebar-backdrop"></div>

<!-- Main Area -->
<div class="app-main">

<!-- Topbar -->
<div class="topbar">
    <div class="topbar-left">
        <button class="hamburger-btn" id="hamburger" title="Menu">&#9776;</button>
    </div>
    <div class="topbar-right">
        <span class="topbar-meta" id="topbar-meta">
            {% if last_update %}{{ t.last_update }}: {{ last_update }}{% endif %}
        </span>
        <span class="topbar-countdown" id="topbar-countdown"></span>
        <button class="refresh-btn" id="refresh-btn" title="{{ t.refresh }}">&#x1F504;</button>
    </div>
</div>


<!-- ═══ View: Dashboard ═══ -->
<div class="main-content">
<div id="view-dashboard" class="view active">


{% if error %}
<div class="error-box">{{ t.error_label }}: {{ error }}</div>
{% endif %}

{% if analysis %}
    {% set s = analysis.summary %}
    {% set ds = analysis.ds_channels %}
    {% set us = analysis.us_channels %}

    {% set health_map = {"good": t.health_good, "marginal": t.health_marginal, "poor": t.health_poor} %}
    {% set health_label = health_map.get(s.health, s.health) %}
    {% set health_msgs = {"good": t.health_good_msg, "marginal": t.health_marginal_msg, "poor": t.health_poor_msg} %}
    {% set issue_labels = {
        "ds_power_critical": t.issue_ds_power_critical,
        "us_power_critical": t.issue_us_power_critical,
        "us_power_warn": t.issue_us_power_warn,
        "snr_critical": t.issue_snr_critical,
        "snr_warn": t.issue_snr_warn,
        "uncorr_errors_high": t.issue_uncorr_errors_high,
    } %}
    {% set issue_descs = {
        "ds_power_critical": t.issue_ds_power_critical_desc,
        "us_power_critical": t.issue_us_power_critical_desc,
        "us_power_warn": t.issue_us_power_warn_desc,
        "snr_critical": t.issue_snr_critical_desc,
        "snr_warn": t.issue_snr_warn_desc,
        "uncorr_errors_high": t.issue_uncorr_errors_high_desc,
    } %}

    {# ══════════════════════════════════════════════════════════════════════════
       HERO CARD - Phase 3 Task 3.1
       Health status + inline trend chart (SNR/Power, 24h)
       ══════════════════════════════════════════════════════════════════════════ #}
    <div class="hero-card health-{{ 'good' if s.health == 'good' else ('crit' if s.health == 'poor' else 'warn') }}">
        <div class="hero-header">
            <div class="hero-status">
                <i data-lucide="activity" class="hero-icon"></i>
                <div class="hero-status-text">
                    <h1 class="hero-title">{{ health_label }}{% if demo_mode %}<span class="demo-badge">{{ t.demo_mode|default('DEMO') }}</span>{% endif %}</h1>
                    <p class="hero-subtitle">{{ health_msgs.get(s.health, '') }}</p>
                </div>
            </div>
            <div class="hero-meta">
                {# 1. Provider #}
                {% if isp_name %}
                <span class="hero-isp">
                    {% set isp_lower = isp_name.lower() %}
                    {% if 'vodafone' in isp_lower %}
                    <img src="/static/img/providers/vodafone.svg" alt="{{ isp_name }}" style="width:14px;height:14px;margin-right:4px;">
                    {% elif 'telekom' in isp_lower %}
                    <img src="/static/img/providers/telekom.svg" alt="{{ isp_name }}" style="width:14px;height:14px;margin-right:4px;">
                    {% elif 'o2' in isp_lower %}
                    <img src="/static/img/providers/o2.svg" alt="{{ isp_name }}" style="width:14px;height:14px;margin-right:4px;">
                    {% else %}
                    <img src="/static/img/providers/generic.svg" alt="{{ isp_name }}" style="width:14px;height:14px;margin-right:4px;opacity:0.7;">
                    {% endif %}
                    {{ isp_name }}
                </span>
                {% endif %}
                
                {# 2. Speed #}
                {% if connection_info and connection_info.max_downstream_kbps %}
                <span class="hero-speed">
                    {{ connection_info.max_downstream_kbps // 1000 }}/{{ connection_info.max_upstream_kbps // 1000 }} MBit/s
                    <span class="info-icon" data-tooltip="Auto-detected from modem" style="margin-left:3px;">
                        <i data-lucide="info" style="width:12px;height:12px;opacity:0.5;"></i>
                    </span>
                </span>
                {% elif booked_download and booked_download > 0 %}
                <span class="hero-speed">
                    {{ booked_download|int }}/{{ booked_upload|int }} MBit/s
                    <span class="info-icon" data-tooltip="Configured in Settings" style="margin-left:3px;">
                        <i data-lucide="settings" style="width:12px;height:12px;opacity:0.5;"></i>
                    </span>
                </span>
                {% else %}
                <a href="/settings" style="color:var(--text-secondary);text-decoration:none;font-size:12px;opacity:0.7;transition:opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
                    <i data-lucide="settings" style="width:11px;height:11px;margin-right:4px;"></i>
                    <span>Set speed in Settings</span>
                </a>
                {% endif %}
                
                {# 3. Channels #}
                <span class="hero-channels">
                    {{ s.ds_total }} DS / {{ s.us_total }} US {{ t.channel if (s.ds_total + s.us_total) == 1 else t.channels }}
                    <span class="info-icon" data-tooltip="Auto-detected from modem" style="margin-left:3px;">
                        <i data-lucide="info" style="width:12px;height:12px;opacity:0.5;"></i>
                    </span>
                </span>

                {# 4. Gaming Quality Index #}
                {% if gaming_quality_enabled and gaming_index %}
                <span class="hero-gaming gaming-{{ gaming_index.grade|lower }}"
                      data-tooltip="{{ gaming_index.score }}/100 — {{ t['gaming_tooltip_' ~ gaming_index.grade|lower] }}{% if not gaming_index.has_speedtest %} ({{ t.gaming_no_speedtest }}){% endif %}">
                    <i data-lucide="gamepad-2" style="width:14px;height:14px;"></i>
                    <span class="gaming-grade">{{ gaming_index.grade }}</span>
                    <span class="gaming-label">Gaming</span>
                </span>
                {% endif %}
            </div>
        </div>
        
        {% if s.health_issues %}
        <div class="hero-issues">
            {% for issue in s.health_issues %}
            <span class="issue-badge" title="{{ issue_descs.get(issue, '') }}">{{ issue_labels.get(issue, issue) }}</span>
            {% endfor %}
        </div>
        {% endif %}
        
        <div class="hero-chart-container">
            <canvas id="hero-trend-chart"></canvas>
        </div>
    </div>

    {# ── OLD Health Banner (DEPRECATED, replaced by Hero Card) ── #}
    {# <div class="health-banner health-{{ 'good' if s.health == 'good' else ('crit' if s.health == 'poor' else 'warn') }}">
        <div class="health-status">
            <span class="health-icon">{% if s.health == 'good' %}&#10004;{% elif s.health == 'poor' %}&#10006;{% else %}&#9888;{% endif %}</span>
            <span class="health-title">{{ health_label }}</span>
        </div>
        <div class="health-msg">{{ health_msgs.get(s.health, '') }}</div>
        {% if s.health_issues %}
        <div class="health-issues">
            {% for issue in s.health_issues %}
            <div class="health-issue">
                <span class="health-issue-name">{{ issue_labels.get(issue, issue) }}<span class="info-tip"><i class="tip-icon" tabindex="0">&#9432;</i><span class="tip-text">{{ issue_descs.get(issue, '') }}</span></span></span>
                <span class="health-issue-desc">{{ issue_descs.get(issue, '') }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div> #}

    {# ── OLD Connection Info Bar (DEPRECATED, moved into Hero Card meta) ── #}
    {# {% if isp_name or (connection_info and connection_info.max_downstream_kbps) %}
    <div class="conn-info-bar">
        {% if isp_name %}{{ isp_name }}{% endif %}
        {% if connection_info and connection_info.max_downstream_kbps %}
            {% if isp_name %}<span class="conn-sep">&middot;</span>{% endif %}
            {{ connection_info.max_downstream_kbps // 1000 }}/{{ connection_info.max_upstream_kbps // 1000 }} Mbit/s
        {% endif %}
        <span class="conn-sep">|</span>
        {{ s.ds_total }} DS <span class="conn-sep">/</span> {{ s.us_total }} US {{ t.channels|lower }}
    </div>
    {% endif %} #}

    {# ── Per-card health ── #}
    {% set signal_health = 'crit' if 'ds_power_critical' in s.health_issues or 'snr_critical' in s.health_issues
       else ('warn' if 'ds_power_warn' in s.health_issues or 'snr_warn' in s.health_issues else 'good') %}
    {% set us_health = 'crit' if 'us_power_critical' in s.health_issues
       else ('warn' if 'us_power_warn' in s.health_issues else 'good') %}
    {% set error_health = 'crit' if 'uncorr_errors_high' in s.health_issues else 'good' %}

    {# ── DS Power health ── #}
    {% set ds_pwr_health = 'crit' if 'ds_power_critical' in s.health_issues else ('warn' if 'ds_power_warn' in s.health_issues else 'good') %}
    {# ── SNR health ── #}
    {% set snr_health = 'crit' if 'snr_critical' in s.health_issues else ('warn' if 'snr_warn' in s.health_issues else 'good') %}

    {# ── Speedtest health (for new Metric Summary Row) ── #}
    {% if speedtest_configured and speedtest_latest %}
        {% set eff_booked_dl = booked_download if (booked_download and booked_download > 0) else ((connection_info.max_downstream_kbps // 1000) if connection_info and connection_info.max_downstream_kbps else 0) %}
        {% set eff_booked_ul = booked_upload if (booked_upload and booked_upload > 0) else ((connection_info.max_upstream_kbps // 1000) if connection_info and connection_info.max_upstream_kbps else 0) %}
        {% if eff_booked_dl > 0 %}
            {% set dl_ratio = speedtest_latest.download_mbps / eff_booked_dl %}
            {% if dl_ratio >= 0.8 %}
                {% set speed_health = 'health-good' %}
                {% set dl_val_class = 'val-good' %}
            {% elif dl_ratio >= 0.5 %}
                {% set speed_health = 'health-warn' %}
                {% set dl_val_class = 'val-warn' %}
            {% else %}
                {% set speed_health = 'health-crit' %}
                {% set dl_val_class = 'val-bad' %}
            {% endif %}
        {% else %}
            {% set speed_health = 'health-good' %}
            {% set dl_val_class = 'val-good' %}
        {% endif %}
        {% if eff_booked_ul > 0 %}
            {% set ul_ratio = speedtest_latest.upload_mbps / eff_booked_ul %}
            {% if ul_ratio >= 0.8 %}
                {% set ul_val_class = 'val-good' %}
            {% elif ul_ratio >= 0.5 %}
                {% set ul_val_class = 'val-warn' %}
            {% else %}
                {% set ul_val_class = 'val-bad' %}
            {% endif %}
        {% else %}
            {% set ul_val_class = 'val-good' %}
        {% endif %}
    {% endif %}

    {# ══════════════════════════════════════════════════════════════════════════
       METRIC SUMMARY ROW - Phase 3 Task 3.2
       Compact metric cards: DS, US, Errors, Speed (no expandable details)
       ══════════════════════════════════════════════════════════════════════════ #}
    <div class="metric-summary-row">
        {# Card 1: Downstream Signal #}
        <div class="metric-summary-card health-{{ signal_health }}">
            <div class="metric-summary-header">
                <i data-lucide="radio" class="metric-icon"></i>
                <span class="metric-label">{{ t.downstream }}</span>
            </div>
            <div class="metric-summary-values">
                <div class="metric-value-item">
                    <span class="value val-{{ ds_pwr_health }}">{{ s.ds_power_avg }}</span>
                    <span class="unit">dBmV</span>
                    <span class="sublabel">Ø {{ t.card_ds_power }}</span>
                </div>
                <div class="metric-value-divider"></div>
                <div class="metric-value-item">
                    <span class="value val-{{ snr_health }}">{{ s.ds_snr_avg }}</span>
                    <span class="unit">dB</span>
                    <span class="sublabel">Ø {{ t.card_snr }}</span>
                </div>
            </div>
        </div>

        {# Card 2: Upstream Signal #}
        <div class="metric-summary-card health-{{ us_health }}">
            <div class="metric-summary-header">
                <i data-lucide="radio" class="metric-icon"></i>
                <span class="metric-label">{{ t.upstream }}</span>
            </div>
            <div class="metric-summary-values">
                <div class="metric-value-item">
                    <span class="value val-{{ us_health }}">{{ s.us_power_avg }}</span>
                    <span class="unit">dBmV</span>
                    <span class="sublabel">Ø {{ t.card_transmit_power }}</span>
                </div>
            </div>
        </div>

        {# Card 3: Errors #}
        <div class="metric-summary-card health-{{ error_health }}">
            <div class="metric-summary-header">
                <i data-lucide="alert-triangle" class="metric-icon"></i>
                <span class="metric-label">{{ t.card_errors }}</span>
            </div>
            <div class="metric-summary-values">
                <div class="metric-value-item">
                    <span class="value val-{{ error_health }}">{{ s.ds_uncorrectable_errors|fmt_k }}</span>
                    <span class="unit">{{ t.card_uncorr_label }}</span>
                    <span class="sublabel">{{ s.ds_correctable_errors|fmt_k }} {{ t.card_corr_label }}</span>
                </div>
            </div>
        </div>

        {# Card 4: Speedtest (conditional) #}
        {% if speedtest_configured and speedtest_latest %}
        <div class="metric-summary-card {{ speed_health }}">
            <div class="metric-summary-header">
                <i data-lucide="zap" class="metric-icon"></i>
                <span class="metric-label">{{ t.speed }}</span>
            </div>
            <div class="metric-summary-values" style="display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;">
                <div class="metric-value-item">
                    <span class="value {{ dl_val_class }}">{{ speedtest_latest.download_mbps|fmt_speed_value }}</span>
                    <span class="unit">{{ speedtest_latest.download_mbps|fmt_speed_unit }}</span>
                    <span class="sublabel">{{ t.download }}</span>
                </div>
                <div class="metric-value-divider"></div>
                <div class="metric-value-item">
                    <span class="value {{ ul_val_class }}">{{ speedtest_latest.upload_mbps|fmt_speed_value }}</span>
                    <span class="unit">{{ speedtest_latest.upload_mbps|fmt_speed_unit }}</span>
                    <span class="sublabel">{{ t.upload }}</span>
                </div>
                <div class="metric-value-item secondary" style="grid-column:1;">
                    <span class="value">{{ speedtest_latest.ping_ms|round(0)|int }}</span>
                    <span class="unit">ms</span>
                    <span class="sublabel">Ping</span>
                </div>
                <div class="metric-value-divider"></div>
                <div class="metric-value-item secondary" style="grid-column:3;">
                    <span class="value">{{ speedtest_latest.jitter_ms|round(1) }}</span>
                    <span class="unit">ms</span>
                    <span class="sublabel">Jitter</span>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    {# ══════════════════════════════════════════════════════════════════════════
       CHANNEL HEALTH OVERVIEW - Phase 3 Task 3.4
       Donut charts showing health distribution for DS/US channels
       ══════════════════════════════════════════════════════════════════════════ #}
    <div class="channel-health-card">
        <div class="channel-health-header">
            <i data-lucide="pie-chart" class="channel-health-icon"></i>
            <h3 class="channel-health-title">{{ t.get('channel_health_overview', 'Channel Health Overview') }}</h3>
        </div>
        
        <div class="channel-health-charts">
            <!-- Downstream Donut -->
            <div class="health-chart-container" 
                 data-good="{{ ds|selectattr('health', 'equalto', 'good')|list|length }}"
                 data-warn="{{ ds|rejectattr('health', 'equalto', 'good')|rejectattr('health', 'equalto', 'critical')|list|length }}"
                 data-crit="{{ ds|selectattr('health', 'equalto', 'critical')|list|length }}">
                <canvas id="ds-health-donut"></canvas>
                <div class="chart-label">{{ t.downstream }}</div>
            </div>
            
            <!-- Upstream Donut -->
            <div class="health-chart-container"
                 data-good="{{ us|selectattr('health', 'equalto', 'good')|list|length }}"
                 data-warn="{{ us|rejectattr('health', 'equalto', 'good')|rejectattr('health', 'equalto', 'critical')|list|length }}"
                 data-crit="{{ us|selectattr('health', 'equalto', 'critical')|list|length }}">
                <canvas id="us-health-donut"></canvas>
                <div class="chart-label">{{ t.upstream }}</div>
            </div>
        </div>
        
        <div class="channel-health-legend">
            <div class="legend-item">
                <span class="legend-dot legend-good"></span>
                <span class="legend-label">{{ t.health_good }}</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot legend-warn"></span>
                <span class="legend-label">{{ t.health_warning }}</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot legend-crit"></span>
                <span class="legend-label">{{ t.health_critical }}</span>
            </div>
        </div>
    </div>



    {# ══════════════════════════════════════════════════════════════════════════
       DOWNSTREAM CHANNELS - Phase 3 Task 3.5
       Modern card containers for channel tables
       ══════════════════════════════════════════════════════════════════════════ #}
    <div class="channel-section">
        <div class="channel-section-header">
            <i data-lucide="radio-tower" class="section-icon"></i>
            <h2 class="section-title">{{ t.downstream }}</h2>
            <span class="section-badge">{{ ds|length }} {{ t.channel if ds|length == 1 else t.channels }}</span>
        </div>

        {% for group in ds|groupby('docsis_version')|reverse %}
        {% set g_crit = group.list|selectattr('health', 'equalto', 'critical')|list|length %}
        {% set g_warn = group.list|rejectattr('health', 'equalto', 'good')|rejectattr('health', 'equalto', 'critical')|list|length %}
        <div class="channel-card">
            <details class="channel-group" open>
                <summary>
                    <div class="channel-group-summary">
                        <span class="channel-group-label">DOCSIS {{ group.grouper }}</span>
                        <span class="channel-group-count">({{ group.list|length }} {{ t.channel if group.list|length == 1 else t.channels }})</span>
                        <div class="channel-group-badges">
                            {% if g_crit %}<span class="badge badge-crit">{{ g_crit }} {{ t.health_critical|lower }}</span>{% endif %}
                            {% if g_warn %}<span class="badge badge-warn">{{ g_warn }} {{ t.health_warning|lower }}</span>{% endif %}
                            {% if not g_crit and not g_warn %}<span class="badge badge-good">&#10003;</span>{% endif %}
                        </div>
                    </div>
                </summary>
                <div class="channel-table-wrapper">
                    <table class="sortable">
            <thead><tr>
                <th>{{ t.status }}</th><th>{{ t.channel }}</th><th>{{ t.frequency }}</th><th>{{ t.power_dbmv }}</th>
                <th>{{ t.snr_db }}</th><th>{{ t.modulation }}</th><th>{{ t.corr }}</th><th>{{ t.uncorr }}</th>
            </tr></thead>
            <tbody>
            {% for ch in group.list %}
            <tr>
                {% set ch_tips = {"power critical": t.ch_power_critical, "power warning": t.ch_power_warning, "snr critical": t.ch_snr_critical, "snr warning": t.ch_snr_warning} %}
                {% set ch_tip_parts = [] %}
                {% for key, label in ch_tips.items() %}{% if key in ch.health_detail %}{% if ch_tip_parts.append(label) %}{% endif %}{% endif %}{% endfor %}
                <td data-sort="{{ 0 if ch.health == 'good' else (2 if ch.health == 'critical' else 1) }}">
                    {% if ch.health == "good" %}<span class="badge badge-good">{{ t.health_good }}</span>
                    {% elif ch.health == "critical" %}<span class="badge badge-crit" title="{{ ch_tip_parts|join(', ') }}">{{ t.health_critical }}</span>
                    {% else %}<span class="badge badge-warn" title="{{ ch_tip_parts|join(', ') }}">{{ t.health_warning }}</span>{% endif %}
                </td>
                <td data-sort="{{ ch.channel_id }}">{{ ch.channel_id }}</td>
                <td>{{ ch.frequency }}</td>
                <td data-sort="{{ ch.power if ch.power is not none else 0 }}" class="{% if ch.power is not none %}{% if 'power critical' in ch.health_detail %}val-crit{% elif 'power warning' in ch.health_detail %}val-warn{% else %}val-good{% endif %}{% endif %}">{{ ch.power }}</td>
                <td data-sort="{{ ch.snr if ch.snr is not none else 0 }}" class="{% if ch.snr is not none %}{% if 'snr critical' in ch.health_detail %}val-crit{% elif 'snr warning' in ch.health_detail %}val-warn{% else %}val-good{% endif %}{% endif %}">{{ ch.snr if ch.snr is not none else "-" }}</td>
                <td>{{ ch.modulation }}</td>
                <td data-sort="{{ ch.correctable_errors }}">{{ ch.correctable_errors|fmt_k }}</td>
                <td data-sort="{{ ch.uncorrectable_errors }}">{{ ch.uncorrectable_errors|fmt_k }}</td>
            </tr>
            {% endfor %}
            </tbody>
                    </table>
                </div>
            </details>
        </div>
        {% endfor %}
    </div>

    {# ══════════════════════════════════════════════════════════════════════════
       UPSTREAM CHANNELS - Phase 3 Task 3.5
       Modern card containers for channel tables
       ══════════════════════════════════════════════════════════════════════════ #}
    <div class="channel-section">
        <div class="channel-section-header">
            <i data-lucide="radio-tower" class="section-icon"></i>
            <h2 class="section-title">{{ t.upstream }}</h2>
            <span class="section-badge">{{ us|length }} {{ t.channel if us|length == 1 else t.channels }}</span>
        </div>

        {% for group in us|groupby('docsis_version')|reverse %}
        {% set g_crit = group.list|selectattr('health', 'equalto', 'critical')|list|length %}
        {% set g_warn = group.list|rejectattr('health', 'equalto', 'good')|rejectattr('health', 'equalto', 'critical')|list|length %}
        <div class="channel-card">
            <details class="channel-group" open>
                <summary>
                    <div class="channel-group-summary">
                        <span class="channel-group-label">DOCSIS {{ group.grouper }}</span>
                        <span class="channel-group-count">({{ group.list|length }} {{ t.channel if group.list|length == 1 else t.channels }})</span>
                        <div class="channel-group-badges">
                            {% if g_crit %}<span class="badge badge-crit">{{ g_crit }} {{ t.health_critical|lower }}</span>{% endif %}
                            {% if g_warn %}<span class="badge badge-warn">{{ g_warn }} {{ t.health_warning|lower }}</span>{% endif %}
                            {% if not g_crit and not g_warn %}<span class="badge badge-good">&#10003;</span>{% endif %}
                        </div>
                    </div>
                </summary>
                <div class="channel-table-wrapper">
                    <table class="sortable">
            <thead><tr>
                <th>{{ t.status }}</th><th>{{ t.channel }}</th><th>{{ t.frequency }}</th><th>{{ t.power_dbmv }}</th>
                <th>{{ t.modulation }}</th><th>{{ t.multiplex }}</th>
            </tr></thead>
            <tbody>
            {% for ch in group.list %}
            {% set ch_tip = t.ch_power_critical if 'power critical' in ch.health_detail else (t.ch_power_warning if 'power warning' in ch.health_detail else '') %}
            <tr>
                <td data-sort="{{ 0 if ch.health == 'good' else (2 if ch.health == 'critical' else 1) }}">
                    {% if ch.health == "good" %}<span class="badge badge-good">{{ t.health_good }}</span>
                    {% elif ch.health == "critical" %}<span class="badge badge-crit" title="{{ ch_tip }}">{{ t.health_critical }}</span>
                    {% else %}<span class="badge badge-warn" title="{{ ch_tip }}">{{ t.health_warning }}</span>{% endif %}
                </td>
                <td data-sort="{{ ch.channel_id }}">{{ ch.channel_id }}</td>
                <td>{{ ch.frequency }}</td>
                <td data-sort="{{ ch.power }}" class="{% if 'power critical' in ch.health_detail %}val-crit{% elif 'power warning' in ch.health_detail %}val-warn{% else %}val-good{% endif %}">{{ ch.power }}</td>
                <td>{{ ch.modulation }}</td>
                <td>{{ ch.multiplex }}</td>
            </tr>
            {% endfor %}
            </tbody>
                    </table>
                </div>
            </details>
        </div>
        {% endfor %}
    </div>
    
    {% if not has_us_ofdma %}
    <div class="card-notice card-notice-warn" style="margin-top:8px;">
        <span>&#9888;</span> {{ t.card_no_docsis31 }}
    </div>
    {% endif %}

{% elif not error %}
    <div class="waiting">
        <div class="spinner"></div>
        <p>{{ t.waiting_msg }}</p>
    </div>
{% endif %}
</div>

<!-- ═══ View: Trends ═══ -->
<div id="view-trends" class="view">
    <div class="trend-header">
        <span class="trend-title" id="trend-title"></span>
        <div class="trend-tabs" id="trend-tabs">
            <button class="trend-tab active" data-range="day">{{ t.day }}</button>
            <button class="trend-tab" data-range="week">{{ t.week }}</button>
            <button class="trend-tab" data-range="month">{{ t.month }}</button>
        </div>
    </div>
    <div id="trend-no-data" class="no-data-msg" style="display:none"></div>
    <div class="charts-grid" id="charts-grid">
        <!-- DS Power Chart -->
        <div class="chart-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                    <div class="chart-label">{{ t.ds_power_avg }}</div>
                </div>
                <button class="chart-expand-btn" data-chart="chart-ds-power" title="Expand">&#x26F6;</button>
            </div>
            <canvas id="chart-ds-power"></canvas>
        </div>
        
        <!-- DS SNR Chart -->
        <div class="chart-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v20M2 12l10-10 10 10M2 12l10 10 10-10"/>
                    </svg>
                    <div class="chart-label">{{ t.ds_snr_avg }}</div>
                </div>
                <button class="chart-expand-btn" data-chart="chart-ds-snr" title="Expand">&#x26F6;</button>
            </div>
            <canvas id="chart-ds-snr"></canvas>
        </div>
        
        <!-- US Power Chart -->
        <div class="chart-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v20M17 7l-5-5-5 5M7 17l5 5 5-5"/>
                    </svg>
                    <div class="chart-label">{{ t.us_power_avg }}</div>
                </div>
                <button class="chart-expand-btn" data-chart="chart-us-power" title="Expand">&#x26F6;</button>
            </div>
            <canvas id="chart-us-power"></canvas>
        </div>
        
        <!-- Errors Chart -->
        <div class="chart-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <div class="chart-label">{{ t.errors }}</div>
                </div>
                <button class="chart-expand-btn" data-chart="chart-errors" title="Expand">&#x26F6;</button>
            </div>
            <canvas id="chart-errors"></canvas>
        </div>
    </div>
</div>

<!-- ═══ View: BQM Graphs ═══ -->
{% if bqm_configured %}
<div id="view-bqm" class="view">
    <div class="trend-header">
        <span class="trend-title">{{ t.bqm_title }}</span>
        <div class="bqm-date-nav" id="bqm-date-nav">
            <button id="bqm-prev">&#8249;</button>
            <span class="bqm-date-label" id="bqm-date-label"></span>
            <button id="bqm-next">&#8250;</button>
        </div>
    </div>
    <div id="bqm-content">
        <!-- Phase 4.5: Card wrapper for BQM image -->
        <div id="bqm-card" class="bqm-card" style="display:none;">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18"/>
                        <path d="M7 12l4-4 4 4 4-4"/>
                    </svg>
                    <div class="chart-label">{{ t.bqm_title }}</div>
                </div>
            </div>
            <div id="bqm-image-wrap" style="text-align:center;">
                <img id="bqm-image" style="max-width:100%; border-radius:8px;" alt="BQM Graph">
            </div>
        </div>
        <div id="bqm-no-data" class="no-data-msg" style="display:none;"></div>
    </div>
</div>
{% endif %}

<!-- ═══ View: Smokeping Graphs ═══ -->
{% if smokeping_configured %}
<div id="view-smokeping" class="view">
    <div style="text-align:center; margin-bottom:24px;">
        <span class="trend-title">{{ t.smokeping_title }}</span>
        <div class="trend-tabs" id="smokeping-tabs" style="display:inline-flex; margin-top:12px;">
            <button class="trend-tab active" data-span="3h">3h</button>
            <button class="trend-tab" data-span="30h">30h</button>
            <button class="trend-tab" data-span="10d">10d</button>
            <button class="trend-tab" data-span="1y">1y</button>
        </div>
    </div>
    <div id="smokeping-content" class="bqm-card-grid">
    </div>
    <div id="smokeping-no-data" class="no-data-msg" style="display:none;"></div>
</div>
{% endif %}

<!-- ═══ View: Correlation Analysis ═══ -->
{% if speedtest_configured or bqm_configured %}
<div id="view-correlation" class="view">
    <div class="trend-header">
        <span class="trend-title">{{ t.correlation_title }}</span>
        <div style="display:flex; gap:8px; align-items:center;">
            <select id="correlation-hours" onchange="loadCorrelationData()">
                <option value="24" selected>{{ t.correlation_hours_24 }}</option>
                <option value="48">{{ t.correlation_hours_48 }}</option>
                <option value="168">{{ t.correlation_hours_168 }}</option>
            </select>
        </div>
    </div>
    <p class="correlation-desc" style="color:var(--muted); font-size:0.85em; margin:0 0 16px;">{{ t.correlation_desc }}</p>

    <div id="correlation-loading" class="waiting" style="display:none;">
        <div class="spinner"></div>
    </div>
    <div id="correlation-no-data" class="no-data-msg" style="display:none;"></div>

    <!-- Signal Health Timeline Chart -->
    <div id="correlation-chart-container" style="display:none;">
        <!-- Phase 4.4: Modern card wrapper for correlation chart -->
        <div class="correlation-chart-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18"/>
                        <path d="M18 17V9"/>
                        <path d="M13 17V5"/>
                        <path d="M8 17v-3"/>
                    </svg>
                    <div class="chart-label">{{ t.correlation_chart_title }}</div>
                </div>
                <div class="chart-export-buttons">
                    <button class="chart-export-btn" onclick="_corrExportPNG()" title="Export as PNG">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        PNG
                    </button>
                    <button class="chart-export-btn" onclick="_corrExportCSV()" title="Export as CSV">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        CSV
                    </button>
                </div>
            </div>
            <div class="correlation-chart-wrap">
                <canvas id="correlation-chart"></canvas>
                <canvas id="correlation-overlay" class="correlation-overlay"></canvas>
                <div class="correlation-tooltip" id="correlation-tooltip"></div>
                <div class="correlation-zoom-reset" id="correlation-zoom-reset" style="display:none;" onclick="_corrResetZoom()">Reset Zoom</div>
                <div class="correlation-chart-legend" id="correlation-legend"></div>
            </div>
        </div>
    </div>

    <!-- Unified Timeline Table -->
    <div id="correlation-table-card" class="table-card" style="display:none;">
        <div class="table-card-header">
            <div class="table-card-title">
                <svg class="table-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                <span>{{ t.correlation_timeline }}</span>
            </div>
        </div>
        <div id="correlation-table-wrap">
            <table id="correlation-table">
                <thead><tr>
                    <th>{{ t.timestamp }}</th>
                    <th style="width:90px;">Source</th>
                    <th>{{ t.event_message }}</th>
                    <th>{{ t.event_details }}</th>
                </tr></thead>
                <tbody id="correlation-tbody"></tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- ═══ View: Incident Journal ═══ -->
<div id="view-journal" class="view">
    <div class="journal-header">
        <span class="trend-title">{{ t.incident_journal }}</span>
        <button class="btn-new-entry" onclick="openIncidentModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                <path d="M12 5v14m-7-7h14"/>
            </svg>
            {{ t.new_entry }}
        </button>
    </div>
    <div id="journal-loading" class="waiting" style="display:none;">
        <div class="spinner"></div>
    </div>
    <div id="journal-empty" class="journal-empty" style="display:none;"></div>
    
    <!-- Phase 4.5: Card wrapper for journal table -->
    <div id="journal-table-card" class="table-card" style="display:none;">
        <div class="table-card-header">
            <div class="table-card-title">
                <svg class="table-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V5a2 2 0 00-2-2z"/>
                    <path d="M16 2v4M8 2v4M3 10h18"/>
                </svg>
                <span>{{ t.incident_journal }}</span>
            </div>
        </div>
        <table id="journal-table">
            <thead><tr>
                <th data-col="date">{{ t.incident_date }}<span class="sort-indicator"></span></th>
                <th data-col="title">{{ t.incident_title }}<span class="sort-indicator"></span></th>
                <th data-col="description" class="journal-hide-mobile">{{ t.incident_description }}<span class="sort-indicator"></span></th>
                <th>&#128206;</th>
            </tr></thead>
            <tbody id="journal-tbody"></tbody>
        </table>
    </div>
</div>

<!-- ═══ View: Event Log ═══ -->
<div id="view-events" class="view">
    <div class="events-header">
        <span class="trend-title">{{ t.event_log }}</span>
    </div>
    
    <!-- Phase 4.3: Pill filter toggles for severity -->
    <div class="events-filter-section">
        <div class="events-filter-label">{{ t.event_severity }}:</div>
        <div class="events-severity-pills">
            <button class="severity-pill active" data-severity="" onclick="filterEventsBySeverity('')">{{ t.event_all_severities }}</button>
            <button class="severity-pill" data-severity="info" onclick="filterEventsBySeverity('info')">{{ t.event_severity_info }}</button>
            <button class="severity-pill" data-severity="warning" onclick="filterEventsBySeverity('warning')">{{ t.event_severity_warning }}</button>
            <button class="severity-pill" data-severity="critical" onclick="filterEventsBySeverity('critical')">{{ t.event_severity_critical }}</button>
        </div>
    </div>
    
    <div id="events-loading" class="waiting" style="display:none;">
        <div class="spinner"></div>
    </div>
    <div id="events-empty" class="events-empty" style="display:none;"></div>
    
    <!-- Phase 4.3: Card wrapper for events table -->
    <div id="events-table-card" class="table-card" style="display:none;">
        <div class="table-card-header">
            <div class="table-card-title">
                <svg class="table-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>{{ t.event_log }}</span>
            </div>
            <button class="btn-ack-all" id="btn-ack-all" onclick="acknowledgeAllEvents()" style="display:none;">&#10003; {{ t.event_acknowledge_all }}</button>
        </div>
        <table id="events-table">
            <thead><tr>
                <th>{{ t.timestamp }}</th>
                <th>{{ t.event_severity }}</th>
                <th>{{ t.event_type }}</th>
                <th>{{ t.event_message }}</th>
                <th></th>
            </tr></thead>
            <tbody id="events-tbody"></tbody>
        </table>
    </div>
    
    <div id="events-show-more" style="text-align:center; padding:16px; display:none;">
        <button class="btn-show-more" onclick="loadMoreEvents()">{{ t.show_more }}</button>
    </div>
</div>

<!-- ═══ View: Channel Timeline ═══ -->
<div id="view-channels" class="view">
    <div class="trend-header">
        <span class="trend-title">{{ t.channel_timeline }}</span>
    </div>
    <div class="channel-filters" style="display:flex; gap:12px; margin-bottom:20px; flex-wrap:wrap;">
        <select id="channel-select" onchange="loadChannelTimeline()">
            <option value="">{{ t.select_channel }}</option>
        </select>
        <select id="channel-time-range" onchange="loadChannelTimeline()">
            <option value="1">1 {{ t.day }}</option>
            <option value="3">3 {{ t.day }}</option>
            <option value="7" selected>7 {{ t.day }}</option>
            <option value="30">30 {{ t.day }}</option>
        </select>
    </div>
    <div id="channel-loading" class="waiting" style="display:none;">
        <div class="spinner"></div>
    </div>
    <div id="channel-empty" class="events-empty" style="display:none;"></div>
    <div id="channel-charts" class="charts-grid" style="display:none;">
        <!-- Power/SNR Chart -->
        <div class="chart-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                    <div class="chart-label">{{ t.power_history }}</div>
                </div>
                <button class="chart-expand-btn" data-chart="chart-ch-power" title="Expand">&#x26F6;</button>
            </div>
            <canvas id="chart-ch-power"></canvas>
        </div>
        
        <!-- Errors Chart -->
        <div class="chart-card" id="channel-errors-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <div class="chart-label">{{ t.error_history }}</div>
                </div>
                <button class="chart-expand-btn" data-chart="chart-ch-errors" title="Expand">&#x26F6;</button>
            </div>
            <canvas id="chart-ch-errors"></canvas>
        </div>
        
        <!-- Modulation Chart -->
        <div class="chart-card" id="channel-modulation-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18"/>
                        <path d="M7 12l4-4 4 4 4-4"/>
                    </svg>
                    <div class="chart-label">{{ t.modulation }}</div>
                </div>
                <button class="chart-expand-btn" data-chart="chart-ch-modulation" title="Expand">&#x26F6;</button>
            </div>
            <canvas id="chart-ch-modulation"></canvas>
        </div>
    </div>
</div>

<!-- ═══ Incident Modal ═══ -->
<div class="modal-overlay" id="incident-modal" onclick="if(event.target===this)closeIncidentModal()">
    <div class="modal" style="max-width:640px;">
        <div class="modal-header">
            <h2 id="incident-modal-title"></h2>
            <button class="modal-close" onclick="closeIncidentModal()">&times;</button>
        </div>
        <div class="modal-body" style="overflow-y:auto;">
            <input type="hidden" id="incident-id">
            <div class="incident-form-group">
                <label for="incident-date">{{ t.incident_date }}</label>
                <input type="date" id="incident-date">
            </div>
            <div class="incident-form-group">
                <label for="incident-title-input">{{ t.incident_title }}</label>
                <input type="text" id="incident-title-input" maxlength="200" placeholder="{{ t.incident_title }}">
            </div>
            <div class="incident-form-group">
                <label for="incident-desc">{{ t.incident_description }}</label>
                <textarea id="incident-desc" maxlength="10000" placeholder="{{ t.incident_description }}"></textarea>
            </div>
            <div class="incident-form-group" id="incident-attachments-section">
                <label>{{ t.attachments }}</label>
                <div class="attachment-list" id="incident-attachment-list"></div>
                <button class="btn-upload" id="incident-upload-btn" onclick="document.getElementById('incident-file-input').click()">
                    &#128206; {{ t.upload_file }}
                </button>
                <span id="incident-upload-spinner" style="display:none;"><span class="upload-spinner"></span></span>
                <input type="file" id="incident-file-input" style="display:none;" multiple
                       accept="image/png,image/jpeg,image/gif,image/webp,application/pdf,text/plain"
                       onchange="handleIncidentFileUpload(this)">
            </div>
        </div>
        <div class="incident-modal-footer">
            <div class="modal-footer-left">
                <button class="btn-danger" id="incident-delete-btn" onclick="deleteIncident()" style="display:none;">{{ t.delete_incident }}</button>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-muted" onclick="closeIncidentModal()">{{ t.cancel }}</button>
                <button class="btn btn-accent" onclick="saveIncident()">{{ t.save }}</button>
            </div>
        </div>
    </div>
</div>

<!-- ═══ View: Speedtest ═══ -->
{% if speedtest_configured %}
<div id="view-speedtest" class="view">
    <div class="trend-header">
        <span class="trend-title">{{ t.speedtest_tracker }}</span>
        <div style="display:flex; gap:8px; align-items:center;">
            <select id="speedtest-days" style="padding:6px 10px; border-radius:6px; border:1px solid var(--input-border); background:var(--surface); color:var(--text);" onchange="filterSpeedtestData()">
                <option value="1">1 {{ t.day }}</option>
                <option value="7" selected>7 {{ t.day }}</option>
                <option value="14">14 {{ t.day }}</option>
                <option value="30">30 {{ t.day }}</option>
                <option value="90">90 {{ t.day }}</option>
                <option value="all">{{ t.fetch_all }}</option>
            </select>
            <button class="refresh-btn" id="speedtest-refresh-btn" title="{{ t.refresh }}" onclick="loadSpeedtestHistory()">&#x1F504;</button>
        </div>
    </div>
    <div id="speedtest-loading" class="waiting" style="display:none;">
        <div class="spinner"></div>
        <p>{{ t.fetching }}</p>
    </div>
    <div id="speedtest-no-data" class="no-data-msg" style="display:none;"></div>
    <div id="speedtest-chart-container" style="display:none;">
        <!-- Phase 4.2: Modern card wrapper for speedtest chart -->
        <div class="speedtest-chart-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    <div class="chart-label">Speedtest History</div>
                </div>
            </div>
            <div class="speedtest-chart-wrap">
                <canvas id="speedtest-chart"></canvas>
                <div class="speedtest-chart-tooltip" id="speedtest-chart-tooltip"></div>
                <div class="speedtest-chart-legend">
                    <span class="legend-dl">Download (Mbps)</span>
                    <span class="legend-ul">Upload (Mbps)</span>
                    <span class="legend-ping">Ping (ms)</span>
                    <span class="legend-thresh">80% Median DL</span>
                </div>
            </div>
        </div>
    </div>
    <!-- Phase 4.2: Table card wrapper -->
    <div id="speedtest-table-wrap" class="table-card">
        <table id="speedtest-table" class="sortable" style="display:none;">
            <thead><tr>
                <th class="st-expand-col"></th>
                <th data-col="timestamp">{{ t.timestamp }}<span class="sort-indicator">▼</span></th>
                <th data-col="download_mbps">{{ t.download }}<span class="sort-indicator"></span></th>
                <th data-col="upload_mbps">{{ t.upload }}<span class="sort-indicator"></span></th>
                <th data-col="ping_ms">{{ t.ping }}<span class="sort-indicator"></span></th>
                <th data-col="jitter_ms">{{ t.jitter }}<span class="sort-indicator"></span></th>
                <th data-col="packet_loss_pct">{{ t.packet_loss }}<span class="sort-indicator"></span></th>
            </tr></thead>
            <tbody id="speedtest-tbody"></tbody>
        </table>
        <div id="speedtest-show-more" style="text-align:center; padding:12px; display:none;">
            <button class="btn btn-muted" id="speedtest-more-btn" onclick="showMoreSpeedtest()"></button>
        </div>
    </div>
</div>
{% endif %}

{% if gaming_quality_enabled %}
<div id="view-gaming" class="view">
    <div class="trend-header">
        <span class="trend-title">{{ t.gaming_quality_label }}</span>
    </div>
    {% if gaming_index %}
    <div class="gaming-overview">
        <div class="gaming-gauge">
            {% set s = gaming_index.score %}
            <div class="gaming-gauge-band">
                <div class="gaming-gauge-segment gauge-f"><span>F</span></div>
                <div class="gaming-gauge-segment gauge-d"><span>D</span></div>
                <div class="gaming-gauge-segment gauge-c"><span>C</span></div>
                <div class="gaming-gauge-segment gauge-b"><span>B</span></div>
                <div class="gaming-gauge-segment gauge-a"><span>A</span></div>
            </div>
            <div class="gaming-gauge-track">
                <div class="gaming-gauge-marker" style="left:{{ s }}%;">
                    <div class="gaming-gauge-needle"></div>
                    <div class="gaming-gauge-score">{{ s }}</div>
                </div>
            </div>
            {% if not gaming_index.has_speedtest %}
            <p class="gaming-no-speedtest-hint"><i data-lucide="info" style="width:14px;height:14px;vertical-align:-2px;"></i> {{ t.gaming_no_speedtest_detail }}</p>
            {% endif %}
        </div>
        <div class="gaming-grade-big gaming-{{ gaming_index.grade|lower }}">
            <span class="gaming-grade-letter">{{ gaming_index.grade }}</span>
            <span class="gaming-grade-text">{{ t['gaming_grade_' ~ gaming_index.grade|lower] }}</span>
        </div>
    </div>
    <div class="gaming-components">
        <h3 class="gaming-section-title">{{ t.gaming_components_title }}</h3>
        {% for key, comp in gaming_index.components.items()|sort(attribute='1.weight', reverse=true) %}
        <div class="gaming-component-card">
            <div class="gaming-comp-header">
                <span class="gaming-comp-icon">
                    {% if key == 'latency' %}<i data-lucide="timer" style="width:16px;height:16px;"></i>
                    {% elif key == 'jitter' %}<i data-lucide="waves" style="width:16px;height:16px;"></i>
                    {% elif key == 'packet_loss' %}<i data-lucide="package-x" style="width:16px;height:16px;"></i>
                    {% elif key == 'docsis_health' %}<i data-lucide="heart-pulse" style="width:16px;height:16px;"></i>
                    {% elif key == 'snr_headroom' %}<i data-lucide="signal" style="width:16px;height:16px;"></i>
                    {% endif %}
                </span>
                <span class="gaming-comp-name">{{ t['gaming_comp_' ~ key] }}</span>
                <span class="gaming-comp-weight">{{ comp.weight }}%</span>
                <span class="gaming-comp-score {% if comp.score >= 80 %}score-good{% elif comp.score >= 50 %}score-warn{% else %}score-crit{% endif %}">{{ comp.score }}</span>
            </div>
            <div class="gaming-comp-bar">
                <div class="gaming-comp-fill {% if comp.score >= 80 %}fill-good{% elif comp.score >= 50 %}fill-warn{% else %}fill-crit{% endif %}" style="width:{{ comp.score }}%;"></div>
            </div>
            <p class="gaming-comp-detail">{{ t['gaming_comp_' ~ key ~ '_detail'] }}</p>
        </div>
        {% endfor %}
    </div>
    <div class="gaming-genres">
        <h3 class="gaming-section-title">{{ t.gaming_genres_title }}</h3>
        {% set g = gaming_index.grade|lower %}
        <div class="gaming-genre-cards">
            <div class="gaming-genre-card {% if g in ['a'] %}genre-ok{% elif g in ['b'] %}genre-ok{% elif g in ['c'] %}genre-warn{% else %}genre-bad{% endif %}">
                <span class="gaming-genre-icon"><i data-lucide="crosshair" style="width:18px;height:18px;"></i></span>
                <span class="gaming-genre-name">{{ t.gaming_genre_fps }}</span>
                <span class="gaming-genre-examples">CS2, Valorant, Fortnite</span>
                <span class="gaming-genre-verdict">{{ t['gaming_genre_fps_' ~ g] }}</span>
            </div>
            <div class="gaming-genre-card {% if g in ['a', 'b'] %}genre-ok{% elif g in ['c'] %}genre-ok{% else %}genre-bad{% endif %}">
                <span class="gaming-genre-icon"><i data-lucide="swords" style="width:18px;height:18px;"></i></span>
                <span class="gaming-genre-name">{{ t.gaming_genre_moba }}</span>
                <span class="gaming-genre-examples">LoL, Dota 2, HotS</span>
                <span class="gaming-genre-verdict">{{ t['gaming_genre_moba_' ~ g] }}</span>
            </div>
            <div class="gaming-genre-card {% if g in ['a', 'b'] %}genre-ok{% elif g in ['c', 'd'] %}genre-ok{% else %}genre-bad{% endif %}">
                <span class="gaming-genre-icon"><i data-lucide="globe" style="width:18px;height:18px;"></i></span>
                <span class="gaming-genre-name">{{ t.gaming_genre_mmo }}</span>
                <span class="gaming-genre-examples">WoW, FFXIV, GW2</span>
                <span class="gaming-genre-verdict">{{ t['gaming_genre_mmo_' ~ g] }}</span>
            </div>
            <div class="gaming-genre-card {% if g in ['a', 'b', 'c'] %}genre-ok{% elif g in ['d'] %}genre-warn{% else %}genre-bad{% endif %}">
                <span class="gaming-genre-icon"><i data-lucide="crown" style="width:18px;height:18px;"></i></span>
                <span class="gaming-genre-name">{{ t.gaming_genre_strategy }}</span>
                <span class="gaming-genre-examples">Civilization, AoE, Chess</span>
                <span class="gaming-genre-verdict">{{ t['gaming_genre_strategy_' ~ g] }}</span>
            </div>
        </div>
    </div>
    {% else %}
    <div class="no-data-msg">{{ t.gaming_no_data }}</div>
    {% endif %}
</div>
{% endif %}

</div><!-- /main-content -->
</div><!-- /app-main -->
</div><!-- /app-layout -->

<!-- Speedtest Setup Modal -->
<div class="modal-overlay" id="speedtest-setup-modal" onclick="if(event.target===this)closeSpeedtestSetupModal()">
    <div class="modal">
        <div class="modal-header">
            <h2>&#9889; {{ t.speedtest_setup_title }}</h2>
            <button class="modal-close" onclick="closeSpeedtestSetupModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 10px 0; font-size: 0.9em; line-height: 1.6;">
            <p style="margin-bottom:12px;">{{ t.speedtest_setup_intro }}</p>
            <div style="background:var(--bg); border-radius:8px; padding:14px; margin-bottom:14px;">
                <p style="font-weight:bold; margin-bottom:8px; color:var(--accent);">{{ t.speedtest_setup_benefits_title }}</p>
                <ul style="list-style:none; padding:0;">
                    <li style="margin-bottom:6px;">&#10003; {{ t.speedtest_setup_benefit_1 }}</li>
                    <li style="margin-bottom:6px;">&#10003; {{ t.speedtest_setup_benefit_2 }}</li>
                    <li style="margin-bottom:6px;">&#10003; {{ t.speedtest_setup_benefit_3 }}</li>
                </ul>
            </div>
            <div style="background:var(--bg); border-radius:8px; padding:14px;">
                <p style="font-weight:bold; margin-bottom:8px; color:var(--accent);">{{ t.speedtest_setup_howto_title }}</p>
                <ol style="padding-left:20px;">
                    <li style="margin-bottom:6px;">{{ t.speedtest_setup_step_1|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.speedtest_setup_step_2|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.speedtest_setup_step_3|safe_html }}</li>
                </ol>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-muted" onclick="closeSpeedtestSetupModal()">{{ t.close }}</button>
            <a class="btn btn-accent" href="/settings" style="text-decoration:none;">&#9881; {{ t.settings }}</a>
        </div>
    </div>
</div>

<!-- BQM Setup Modal -->
<div class="modal-overlay" id="bqm-setup-modal" onclick="if(event.target===this)closeBqmSetupModal()">
    <div class="modal">
        <div class="modal-header">
            <h2>&#128200; {{ t.bqm_setup_title }}</h2>
            <button class="modal-close" onclick="closeBqmSetupModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 10px 0; font-size: 0.9em; line-height: 1.6;">
            <p style="margin-bottom:12px;">{{ t.bqm_setup_intro }}</p>
            <div style="background:var(--bg); border-radius:8px; padding:14px; margin-bottom:14px;">
                <p style="font-weight:bold; margin-bottom:8px; color:var(--accent);">{{ t.bqm_setup_benefits_title }}</p>
                <ul style="list-style:none; padding:0;">
                    <li style="margin-bottom:6px;">✅ {{ t.bqm_setup_benefit_1 }}</li>
                    <li style="margin-bottom:6px;">✅ {{ t.bqm_setup_benefit_2 }}</li>
                    <li style="margin-bottom:6px;">✅ {{ t.bqm_setup_benefit_3 }}</li>
                </ul>
            </div>
            <div style="background:var(--bg); border-radius:8px; padding:14px;">
                <p style="font-weight:bold; margin-bottom:8px; color:var(--accent);">{{ t.bqm_setup_howto_title }}</p>
                <ol style="padding-left:20px;">
                    <li style="margin-bottom:6px;">{{ t.bqm_setup_step_1|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.bqm_setup_step_2|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.bqm_setup_step_3|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.bqm_setup_step_4|safe_html }}</li>
                </ol>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-muted" onclick="closeBqmSetupModal()">{{ t.close }}</button>
            <a class="btn btn-accent" href="/settings" style="text-decoration:none;">&#9881; {{ t.settings }}</a>
        </div>
    </div>
</div>

<!-- Smokeping Setup Modal -->
<div class="modal-overlay" id="smokeping-setup-modal" onclick="if(event.target===this)closeSmokepingSetupModal()">
    <div class="modal">
        <div class="modal-header">
            <h2>&#128225; {{ t.smokeping_setup_title }}</h2>
            <button class="modal-close" onclick="closeSmokepingSetupModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 10px 0; font-size: 0.9em; line-height: 1.6;">
            <p style="margin-bottom:12px;">{{ t.smokeping_setup_intro }}</p>
            <div style="background:var(--bg); border-radius:8px; padding:14px;">
                <p style="font-weight:bold; margin-bottom:8px; color:var(--accent);">{{ t.bqm_setup_howto_title }}</p>
                <ol style="padding-left:20px;">
                    <li style="margin-bottom:6px;">{{ t.smokeping_setup_step_1|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.smokeping_setup_step_2|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.smokeping_setup_step_3|safe_html }}</li>
                </ol>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-muted" onclick="closeSmokepingSetupModal()">{{ t.close }}</button>
            <a class="btn btn-accent" href="/settings#integrations" style="text-decoration:none;">&#9881; {{ t.settings }}</a>
        </div>
    </div>
</div>

<!-- Report Modal -->
<div class="modal-overlay" id="report-modal" onclick="if(event.target===this)closeReportModal()">
    <div class="modal" style="max-width:800px;">
        <div class="modal-header">
            <h2>{{ t.incident_report }}</h2>
            <button class="modal-close" onclick="closeReportModal()">&times;</button>
        </div>
        <p class="modal-hint">{{ t.report_description }}</p>
        <div class="modal-body" style="padding: 10px 0;">
            <!-- Step 1: Settings & Customer Info -->
            <div id="report-step1">
                <div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom:14px;">
                    <div>
                        <label style="font-size:13px; color:var(--muted);">{{ t.report_days }}</label><br>
                        <select id="report-days" style="margin-top:4px; padding:6px 10px; border-radius:6px; border:1px solid var(--border); background:var(--bg); color:var(--text);">
                            <option value="1">1</option><option value="3">3</option>
                            <option value="7" selected>7</option><option value="14">14</option>
                            <option value="30">30</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:13px; color:var(--muted);">{{ t.report_language }}</label><br>
                        <select id="report-lang" style="margin-top:4px; padding:6px 10px; border-radius:6px; border:1px solid var(--border); background:var(--bg); color:var(--text);">
                            {% for code, name in languages.items() %}
                            <option value="{{ code }}" {% if code == lang %}selected{% endif %}>{{ lang_flags.get(code, '') }} {{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div style="background:var(--bg); border-radius:8px; padding:14px; margin-bottom:10px;">
                    <p style="font-size:13px; color:var(--muted); margin-bottom:10px;">{{ t.report_customer_hint }}</p>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <input id="report-name" type="text" placeholder="{{ t.report_name }}" style="padding:8px 12px; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-family:inherit;">
                        <input id="report-number" type="text" placeholder="{{ t.report_customer_number }}" style="padding:8px 12px; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-family:inherit;">
                        <input id="report-address" type="text" placeholder="{{ t.report_address }}" style="padding:8px 12px; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-family:inherit;">
                    </div>
                </div>
            </div>
            <!-- Step 2: Generated complaint text (hidden initially) -->
            <div id="report-step2" style="display:none;">
                <p style="font-size:13px; color:var(--muted); margin-bottom:8px;">{{ t.report_edit_hint }}</p>
                <textarea id="report-complaint-text" style="width:100%; min-height:320px; background:var(--bg); color:var(--text); border:1px solid var(--border); border-radius:6px; padding:12px; font-size:0.85em; font-family:'Consolas','Monaco',monospace; resize:vertical; line-height:1.5;"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-muted" onclick="closeReportModal()">{{ t.close }}</button>
            <button class="btn btn-accent" id="report-generate-btn" onclick="generateComplaint()">&#9998; {{ t.report_generate_letter }}</button>
            <button class="btn btn-accent" id="report-copy-btn" style="display:none;" onclick="copyComplaint()">&#128203; {{ t.report_copy_letter }}</button>
            <button class="btn btn-accent" id="report-pdf-btn" style="display:none;" onclick="downloadReport()">&#128196; {{ t.report_download_pdf }}</button>
        </div>
    </div>
</div>

<!-- Chart Zoom Modal -->
<div class="chart-zoom-overlay" id="chart-zoom-overlay" onclick="if(event.target===this)closeChartZoom()">
    <div class="chart-zoom-modal">
        <div class="modal-header">
            <h2 id="chart-zoom-title"></h2>
            <button class="modal-close" onclick="closeChartZoom()">&times;</button>
        </div>
        <canvas id="chart-zoom-canvas"></canvas>
    </div>
</div>

<!-- Export Modal -->
<div class="modal-overlay" id="export-modal">
    <div class="modal">
        <div class="modal-header">
            <h2>{{ t.export_title }}</h2>
            <button class="modal-close" onclick="closeExportModal()">&times;</button>
        </div>
        <p class="modal-hint">{{ t.export_hint }}</p>
        <div class="export-mode-selector" style="padding:0 1.5rem;display:flex;gap:1.2rem;margin-bottom:0.5rem;">
            <label style="display:flex;align-items:center;gap:0.4rem;cursor:pointer;">
                <input type="radio" name="export-mode" value="full" checked onchange="exportForLLM()">
                &#128202; {{ t.export_full }}
            </label>
            <label style="display:flex;align-items:center;gap:0.4rem;cursor:pointer;">
                <input type="radio" name="export-mode" value="update" onchange="exportForLLM()">
                &#9200; {{ t.export_update }}
            </label>
        </div>
        <div class="modal-body">
            <textarea id="export-text" readonly></textarea>
        </div>
        <div class="modal-footer">
            <button class="btn btn-muted" onclick="closeExportModal()">{{ t.close }}</button>
            <button class="btn btn-accent" id="export-copy-btn" onclick="copyExport()">{{ t.copy_clipboard }}</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/hero-chart.js') }}"></script>

{# ── Channel Health Donut Charts - Phase 3 Task 3.4 ── #}
<script>
(function() {
    'use strict';
    
    // Store chart instances globally to prevent memory leaks on refresh
    window.donutCharts = window.donutCharts || {};
    
    function renderDonut(canvasId) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) {
            console.warn('[ChannelHealth] Canvas element #' + canvasId + ' not found');
            return;
        }
        
        // Read health counts from data-attributes (updated on refresh)
        const container = ctx.parentElement;
        if (!container) {
            console.warn('[ChannelHealth] Container not found for #' + canvasId);
            return;
        }
        
        const counts = {
            good: parseInt(container.getAttribute('data-good') || '0', 10),
            warn: parseInt(container.getAttribute('data-warn') || '0', 10),
            crit: parseInt(container.getAttribute('data-crit') || '0', 10)
        };
        
        // Destroy existing chart instance to prevent rendering issues
        if (window.donutCharts[canvasId]) {
            window.donutCharts[canvasId].destroy();
            delete window.donutCharts[canvasId];
        }
        
        const total = counts.good + counts.warn + counts.crit;
        if (total === 0) {
            console.warn('[ChannelHealth] No data for ' + canvasId);
            return;
        }
        
        window.donutCharts[canvasId] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Good', 'Warning', 'Critical'],
                datasets: [{
                    data: [counts.good, counts.warn, counts.crit],
                    backgroundColor: [
                        'rgba(76, 175, 80, 0.8)',
                        'rgba(255, 152, 0, 0.8)',
                        'rgba(244, 67, 54, 0.8)'
                    ],
                    borderColor: [
                        'rgba(76, 175, 80, 1)',
                        'rgba(255, 152, 0, 1)',
                        'rgba(244, 67, 54, 1)'
                    ],
                    borderWidth: 2,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                cutout: '65%',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(15,20,25,0.95)',
                        titleColor: 'rgba(224,224,224,0.9)',
                        bodyColor: 'rgba(224,224,224,0.8)',
                        borderColor: 'rgba(168,85,247,0.3)',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return label + ': ' + value + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
    
    function initDonuts() {
        renderDonut('ds-health-donut');
        renderDonut('us-health-donut');
    }
    
    // Expose refresh function globally for manual updates (refreshData after innerHTML replace)
    window.refreshDonuts = initDonuts;
    
    // Wait for DOM to be fully loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDonuts);
    } else {
        // DOM already loaded (script deferred or loaded late)
        initDonuts();
    }
})();
</script>

<script>
(function() {
    'use strict';

    var T = {{ t|tojson }};

    /* ── Theme ── */
    var saved = localStorage.getItem('docsis-theme');
    if (saved) document.documentElement.setAttribute('data-theme', saved);

    var themeToggle = document.getElementById('theme-toggle-sidebar');
    function updateThemeState() {
        var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
        themeToggle.checked = isDark;
    }
    updateThemeState();
    themeToggle.addEventListener('change', function() {
        var next = this.checked ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('docsis-theme', next);
    });

    /* ── State ── */
    var currentView = 'live';
    var charts = {};
    var _trendRange = 'day';
    var bqmDate = todayStr();

    function todayStr() {
        var d = new Date();
        return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate());
    }
    function pad(n) { return n < 10 ? '0' + n : '' + n; }
    function formatDateDE(str) {
        var p = str.split('-');
        return p[2] + '.' + p[1] + '.' + p[0];
    }

    /* ── Sortable Tables ── */
    function initSortableTables() {
        document.querySelectorAll('table.sortable').forEach(function(table) {
            var headers = table.querySelectorAll('th');
            headers.forEach(function(th, colIdx) {
                th.addEventListener('click', function() {
                    sortTable(table, colIdx, th);
                });
            });
        });
    }
    initSortableTables();

    function sortTable(table, colIdx, th) {
        var tbody = table.querySelector('tbody');
        var rows = Array.from(tbody.querySelectorAll('tr'));
        var asc = th.getAttribute('data-sort-dir') !== 'asc';

        table.querySelectorAll('th').forEach(function(h) {
            h.removeAttribute('data-sort-dir');
            h.classList.remove('sort-asc', 'sort-desc');
        });
        th.setAttribute('data-sort-dir', asc ? 'asc' : 'desc');
        th.classList.add(asc ? 'sort-asc' : 'sort-desc');

        rows.sort(function(a, b) {
            var cellA = a.cells[colIdx];
            var cellB = b.cells[colIdx];
            var valA = cellA.getAttribute('data-sort') || cellA.textContent.trim();
            var valB = cellB.getAttribute('data-sort') || cellB.textContent.trim();
            var numA = parseFloat(valA);
            var numB = parseFloat(valB);
            if (!isNaN(numA) && !isNaN(numB)) {
                return asc ? numA - numB : numB - numA;
            }
            return asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
        });
        rows.forEach(function(row) { tbody.appendChild(row); });
    }

    /* ── Sidebar ── */
    var sidebar = document.getElementById('sidebar');
    var sidebarBackdrop = document.getElementById('sidebar-backdrop');

    function isMobile() { return window.matchMedia('(max-width: 900px)').matches; }

    function closeMobileSidebar() {
        sidebar.classList.remove('mobile-open');
        sidebarBackdrop.classList.remove('active');
    }

    function collapseSidebar() {
        if (isMobile()) {
            closeMobileSidebar();
        } else {
            sidebar.classList.add('collapsed');
            sidebar.classList.remove('mobile-open');
            sidebarBackdrop.classList.remove('active');
            var btn = document.getElementById('sidebar-collapse');
            btn.innerHTML = '&#10095;'; // Right arrow >
            btn.title = 'Expand';
        }
    }
    function expandSidebar() {
        sidebar.classList.remove('collapsed');
        var btn = document.getElementById('sidebar-collapse');
        btn.innerHTML = '&#10094;'; // Left arrow <
        btn.title = 'Collapse';
    }
    function toggleSidebar() {
        if (sidebar.classList.contains('collapsed')) {
            expandSidebar();
        } else {
            collapseSidebar();
        }
    }

    document.getElementById('sidebar-collapse').addEventListener('click', toggleSidebar);
    document.getElementById('hamburger').addEventListener('click', function() {
        if (isMobile()) {
            // On mobile, NEVER use .collapsed - always use .mobile-open
            sidebar.classList.remove('collapsed');
            var opening = !sidebar.classList.contains('mobile-open');
            sidebar.classList.toggle('mobile-open', opening);
            sidebarBackdrop.classList.toggle('active', opening);
        } else {
            sidebar.classList.toggle('collapsed');
        }
    });
    sidebarBackdrop.addEventListener('click', closeMobileSidebar);

    var sidebarLinks = document.querySelectorAll('.sidebar-link[data-view]');
    sidebarLinks.forEach(function(link) {
        link.addEventListener('click', function() {
            if (isMobile()) { closeMobileSidebar(); }
            switchView(this.getAttribute('data-view'));
        });
    });

    function switchView(view, skipHash) {
        currentView = view;
        if (!skipHash) location.hash = view === 'live' ? '' : view;
        sidebarLinks.forEach(function(l) {
            l.classList.toggle('active', l.getAttribute('data-view') === view);
        });
        var dashView = document.getElementById('view-dashboard');
        var trendView = document.getElementById('view-trends');
        var bqmView = document.getElementById('view-bqm');
        var speedtestView = document.getElementById('view-speedtest');
        var journalView = document.getElementById('view-journal');
        var eventsView = document.getElementById('view-events');
        var channelsView = document.getElementById('view-channels');
        var smokepingView = document.getElementById('view-smokeping');
        var correlationView = document.getElementById('view-correlation');
        var gamingView = document.getElementById('view-gaming');
        dashView.classList.remove('active');
        trendView.classList.remove('active');
        if (bqmView) bqmView.classList.remove('active');
        if (smokepingView) smokepingView.classList.remove('active');
        if (speedtestView) speedtestView.classList.remove('active');
        if (journalView) journalView.classList.remove('active');
        if (eventsView) eventsView.classList.remove('active');
        if (channelsView) channelsView.classList.remove('active');
        if (correlationView) correlationView.classList.remove('active');
        if (gamingView) gamingView.classList.remove('active');
        stopAutoRefresh();
        if (view === 'live') {
            dashView.classList.add('active');
            startAutoRefresh();
        } else if (view === 'bqm') {
            if (bqmView) bqmView.classList.add('active');
            updateBqmDateLabel();
            loadBqmGraph(bqmDate);
        } else if (view === 'smokeping') {
            if (smokepingView) smokepingView.classList.add('active');
            loadSmokepingGraphs();
        } else if (view === 'speedtest') {
            if (speedtestView) speedtestView.classList.add('active');
            loadSpeedtestHistory();
        } else if (view === 'journal') {
            if (journalView) journalView.classList.add('active');
            loadIncidents();
        } else if (view === 'events') {
            if (eventsView) eventsView.classList.add('active');
            loadEvents();
        } else if (view === 'channels') {
            if (channelsView) channelsView.classList.add('active');
            loadChannelList();
        } else if (view === 'correlation') {
            if (correlationView) correlationView.classList.add('active');
            loadCorrelationData();
        } else if (view === 'gaming') {
            if (gamingView) gamingView.classList.add('active');
        } else if (view === 'trends') {
            trendView.classList.add('active');
            updateTrendTabs();
            loadTrends(_trendRange);
        }
        
        // Re-initialize Lucide icons after view switch
        lucide.createIcons();
    }

    /* ── Trend Tabs ── */
    function updateTrendTabs() {
        document.querySelectorAll('#trend-tabs .trend-tab').forEach(function(btn) {
            btn.classList.toggle('active', btn.getAttribute('data-range') === _trendRange);
        });
    }
    document.querySelectorAll('#trend-tabs .trend-tab').forEach(function(btn) {
        btn.addEventListener('click', function() {
            _trendRange = this.getAttribute('data-range');
            updateTrendTabs();
            loadTrends(_trendRange);
        });
    });

    /* ── Hash-based view routing ── */
    var validViews = ['live', 'trends', 'bqm', 'smokeping', 'speedtest', 'journal', 'events', 'channels', 'correlation', 'gaming'];
    function viewFromHash() {
        var h = location.hash.replace('#', '');
        return validViews.indexOf(h) !== -1 ? h : null;
    }
    window.addEventListener('hashchange', function() {
        var v = viewFromHash();
        if (v && v !== currentView) switchView(v, true);
    });

    /* ── BQM Date Navigation ── */
    var bqmDateLabel = document.getElementById('bqm-date-label');
    var bqmPrev = document.getElementById('bqm-prev');
    var bqmNext = document.getElementById('bqm-next');

    function updateBqmDateLabel() {
        if (bqmDateLabel) bqmDateLabel.textContent = formatDateDE(bqmDate);
    }

    function bqmDateNav(dir) {
        var d = new Date(bqmDate + 'T12:00:00');
        d.setDate(d.getDate() + dir);
        bqmDate = d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate());
        updateBqmDateLabel();
        loadBqmGraph(bqmDate);
    }

    if (bqmPrev) bqmPrev.addEventListener('click', function() { bqmDateNav(-1); });
    if (bqmNext) bqmNext.addEventListener('click', function() { bqmDateNav(1); });

    /* ── Auto Refresh with Countdown ── */
    var refreshTimer = null;
    var countdownTimer = null;
    var countdownSeconds = 60;
    var REFRESH_INTERVAL = 60;
    var countdownEl = document.getElementById('topbar-countdown');

    function updateCountdown() {
        if (countdownEl) countdownEl.textContent = countdownSeconds + 's';
    }

    function startAutoRefresh() {
        stopAutoRefresh();
        countdownSeconds = REFRESH_INTERVAL;
        updateCountdown();
        countdownTimer = setInterval(function() {
            if (currentView !== 'live' || document.hidden) return;
            countdownSeconds--;
            if (countdownSeconds <= 0) {
                countdownSeconds = REFRESH_INTERVAL;
                refreshData();
            }
            updateCountdown();
        }, 1000);
    }
    function stopAutoRefresh() {
        if (countdownTimer) { clearInterval(countdownTimer); countdownTimer = null; }
        if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; }
    }

    function refreshData() {
        fetch(window.location.href)
            .then(function(r) { return r.text(); })
            .then(function(html) {
                var doc = new DOMParser().parseFromString(html, 'text/html');

                // Save expanded metric cards by index
                var openCardIndices = [];
                document.querySelectorAll('.metric-card').forEach(function(el, i) {
                    if (el.classList.contains('open')) openCardIndices.push(i);
                });

                // Save expanded channel groups by label text
                var openGroupLabels = [];
                document.querySelectorAll('details.channel-group[open]').forEach(function(el) {
                    var s = el.querySelector('summary');
                    if (s) openGroupLabels.push(s.textContent.trim());
                });

                // Replace dashboard content
                var freshDash = doc.querySelector('#view-dashboard');
                var currentDash = document.querySelector('#view-dashboard');
                if (freshDash && currentDash) {
                    currentDash.innerHTML = freshDash.innerHTML;
                }

                // Update topbar timestamp
                var freshMeta = doc.querySelector('#topbar-meta');
                var currentMeta = document.querySelector('#topbar-meta');
                if (freshMeta && currentMeta) {
                    currentMeta.innerHTML = freshMeta.innerHTML;
                }

                // Reset countdown after refresh
                countdownSeconds = REFRESH_INTERVAL;
                updateCountdown();

                // Restore expanded metric cards
                document.querySelectorAll('.metric-card').forEach(function(el, i) {
                    if (openCardIndices.indexOf(i) !== -1) el.classList.add('open');
                });

                // Restore expanded channel groups
                document.querySelectorAll('details.channel-group').forEach(function(el) {
                    var s = el.querySelector('summary');
                    if (s && openGroupLabels.indexOf(s.textContent.trim()) !== -1) {
                        el.setAttribute('open', '');
                    }
                });

                // Re-init sortable tables (event listeners lost on innerHTML replace)
                initSortableTables();

                // Re-init hero chart (Chart.js instance lost on innerHTML replace)
                if (typeof window.refreshHeroChart === 'function') {
                    window.refreshHeroChart();
                }

                // Re-init channel health donuts (Chart.js instances lost on innerHTML replace)
                if (typeof window.refreshDonuts === 'function') {
                    window.refreshDonuts();
                }

                // Re-init Lucide icons (lost on innerHTML replace)
                lucide.createIcons();

                // Refresh event badge count
                fetch('/api/events/count')
                    .then(function(r) { return r.json(); })
                    .then(function(d) { updateEventBadge(d.count || 0); })
                    .catch(function() {});
            })
            .catch(function(err) {
                console.warn('Auto-refresh failed:', err);
            });
    }

    if (currentView === 'live') startAutoRefresh();

    /* ── Manual Poll (Refresh Button) ── */
    var refreshBtn = document.getElementById('refresh-btn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            if (refreshBtn.disabled) return;
            refreshBtn.disabled = true;
            refreshBtn.classList.add('spinning');
            fetch('/api/poll', {method: 'POST'})
                .then(function(r) { return r.json().then(function(d) { return {status: r.status, data: d}; }); })
                .then(function(res) {
                    if (res.data.success) {
                        showToast(T.refresh_success || 'Data updated', 'success');
                        refreshData();
                    } else {
                        showToast(res.data.error || 'Error', res.status === 429 ? 'error' : 'error');
                    }
                })
                .catch(function() { showToast(T.network_error || 'Error', 'error'); })
                .finally(function() {
                    refreshBtn.classList.remove('spinning');
                    setTimeout(function() { refreshBtn.disabled = false; }, 10000);
                });
        });
    }

    function showToast(msg, type) {
        var toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.className = 'toast toast-' + (type || 'success') + ' show';
        setTimeout(function() { toast.classList.remove('show'); }, 3000);
    }

    /* ── Trend Charts ── */

    function loadTrends(range) {
        var date = todayStr();
        var title = document.getElementById('trend-title');
        var noData = document.getElementById('trend-no-data');
        var grid = document.getElementById('charts-grid');
        var labels = {day: T.day_trend, week: T.week_trend, month: T.month_trend};
        title.textContent = (labels[range] || 'Trend') + ' - ' + formatDateDE(date);

        fetch('/api/trends?range=' + range + '&date=' + date)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (!data || data.length === 0) {
                    noData.textContent = T.no_data;
                    noData.style.display = 'block';
                    grid.style.display = 'none';
                    return;
                }
                noData.style.display = 'none';
                grid.style.display = '';
                var xLabels = data.map(function(d) {
                    if (!d.timestamp) return '';
                    if (range === 'day') return d.timestamp.substring(11, 16);
                    if (range === 'week') return d.timestamp.substring(5, 16).replace('T', ' ');
                    return d.date ? formatDateDE(d.date) : formatDateDE(d.timestamp.substring(0, 10));
                });
                renderChart('chart-ds-power', xLabels,
                    [{label: 'DS Power Avg', data: data.map(function(d){ return d.ds_power_avg; }), color: '#a855f7'}],
                    null, DS_POWER_THRESHOLDS);
                renderChart('chart-ds-snr', xLabels,
                    [{label: 'DS SNR Avg', data: data.map(function(d){ return d.ds_snr_avg; }), color: '#a855f7'}],
                    null, DS_SNR_THRESHOLDS);
                renderChart('chart-us-power', xLabels,
                    [{label: 'US Power Avg', data: data.map(function(d){ return d.us_power_avg; }), color: '#a855f7'}],
                    null, US_POWER_THRESHOLDS);
                renderChart('chart-errors', xLabels, [
                    {label: T.correctable, data: data.map(function(d){ return d.ds_correctable_errors; }), color: '#2196f3'},
                    {label: T.uncorrectable, data: data.map(function(d){ return d.ds_uncorrectable_errors; }), color: '#f44336'}
                ], 'bar');
            })
            .catch(function() {
                noData.textContent = T.trend_error;
                noData.style.display = 'block';
                grid.style.display = 'none';
            });
    }

    var zonesPlugin = {
        id: 'zones',
        beforeDatasetsDraw: function(chart) {
            var zones = chart._docsightZones;
            if (!zones) return;
            var ctx = chart.ctx;
            var yAxis = chart.scales.y;
            var chartArea = chart.chartArea;
            ctx.save();
            ctx.beginPath();
            ctx.rect(chartArea.left, chartArea.top, chartArea.right - chartArea.left, chartArea.bottom - chartArea.top);
            ctx.clip();
            var drawn = {};
            zones.forEach(function(z) {
                if (z.yMin !== undefined) return; /* skip metadata entries */
                if (z.fill !== false) {
                    var top = yAxis.getPixelForValue(z.max);
                    var bottom = yAxis.getPixelForValue(z.min);
                    ctx.fillStyle = z.color;
                    ctx.fillRect(chartArea.left, top, chartArea.right - chartArea.left, bottom - top);
                }
                var lineColor = z.lineColor || z.color.replace(/[\d.]+\)$/, '0.7)');
                var vals = z.fill === false ? [z.value] : [z.min, z.max];
                vals.forEach(function(val) {
                    if (val === undefined || drawn[val]) return;
                    drawn[val] = true;
                    var py = yAxis.getPixelForValue(val);
                    ctx.beginPath();
                    ctx.setLineDash([6, 4]);
                    ctx.strokeStyle = lineColor;
                    ctx.lineWidth = 1;
                    ctx.moveTo(chartArea.left, py);
                    ctx.lineTo(chartArea.right, py);
                    ctx.stroke();
                });
            });
            ctx.restore();
        }
    };

    var DS_POWER_THRESHOLDS = [
        {value: -4, fill: false, lineColor: 'rgba(76,175,80,0.5)'},
        {value: 13, fill: false, lineColor: 'rgba(76,175,80,0.5)'},
        {value: -8, fill: false, lineColor: 'rgba(255,152,0,0.5)'},
        {value: 20, fill: false, lineColor: 'rgba(255,152,0,0.5)'},
        {value: -15, fill: false, lineColor: 'rgba(244,67,54,0.4)'},
        {value: 25, fill: false, lineColor: 'rgba(244,67,54,0.4)'},
        {yMin: -18, yMax: 28}
    ];
    var DS_SNR_THRESHOLDS = [
        {value: 33, fill: false, lineColor: 'rgba(76,175,80,0.5)'},
        {value: 29, fill: false, lineColor: 'rgba(255,152,0,0.5)'},
        {value: 25, fill: false, lineColor: 'rgba(244,67,54,0.4)'},
        {yMin: 20, yMax: 50}
    ];
    var US_POWER_THRESHOLDS = [
        {value: 41, fill: false, lineColor: 'rgba(76,175,80,0.5)'},
        {value: 47, fill: false, lineColor: 'rgba(76,175,80,0.5)'},
        {value: 35, fill: false, lineColor: 'rgba(255,152,0,0.5)'},
        {value: 53, fill: false, lineColor: 'rgba(255,152,0,0.5)'},
        {value: 20, fill: false, lineColor: 'rgba(244,67,54,0.4)'},
        {value: 60, fill: false, lineColor: 'rgba(244,67,54,0.4)'},
        {yMin: 17, yMax: 63}
    ];

    function renderChart(canvasId, labels, datasets, type, zones, opts) {
        if (charts[canvasId]) charts[canvasId].destroy();
        var ctx = document.getElementById(canvasId);
        if (!ctx) return;
        var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
        var gridColor = isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)';
        var textColor = isDark ? '#888' : '#666';
        
        var chartDatasets = datasets.map(function(ds, idx) {
            var r = {
                label: ds.label, data: ds.data,
                borderColor: type === 'bar' ? ds.color : (ds.color || 'rgba(168,85,247,0.9)'),
                backgroundColor: type === 'bar' ? ds.color + 'cc' : 'transparent',
                borderWidth: type === 'bar' ? 3 : 2,
                tension: type === 'bar' ? 0 : 0.4,
                pointRadius: labels.length > 30 ? 0 : 3,
                fill: false
            };
            if (ds.stepped) { r.stepped = 'before'; r.tension = 0; }
            return r;
        });
        var hasLegend = datasets.length > 1;
        var legendPos = hasLegend ? 'bottom' : 'top';
        var chartConfig = {
            type: type || 'line',
            data: { labels: labels, datasets: chartDatasets },
            options: {
                responsive: true, maintainAspectRatio: true,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { display: hasLegend, position: legendPos, labels: { color: textColor, font: { size: 11 } } },
                    tooltip: { backgroundColor: isDark ? '#16213e' : '#fff', titleColor: textColor, bodyColor: textColor, borderColor: gridColor, borderWidth: 1 }
                },
                scales: {
                    x: { ticks: { color: textColor, font: { size: 10 }, maxRotation: 45 }, grid: { color: gridColor } },
                    y: { ticks: { color: textColor, font: { size: 10 }, callback: opts && opts.yTickCallback ? opts.yTickCallback : undefined }, grid: { color: gridColor } }
                }
            },
            plugins: zones ? [zonesPlugin] : []
        };
        if (opts && opts.yMin !== undefined) chartConfig.options.scales.y.min = opts.yMin;
        if (opts && opts.yMax !== undefined) chartConfig.options.scales.y.max = opts.yMax;
        if (opts && opts.yAfterBuildTicks) chartConfig.options.scales.y.afterBuildTicks = opts.yAfterBuildTicks;
        if (zones) {
            var zoneMeta = zones.find(function(z) { return z.yMin !== undefined; });
            if (zoneMeta) {
                chartConfig.options.scales.y.suggestedMin = zoneMeta.yMin;
                chartConfig.options.scales.y.suggestedMax = zoneMeta.yMax;
            }
        }
        charts[canvasId] = new Chart(ctx, chartConfig);
        if (zones) {
            charts[canvasId]._docsightZones = zones;
        }
        /* Store render params so the zoom modal can re-render this chart */
        charts[canvasId]._docsightParams = {labels: labels, datasets: datasets, type: type, zones: zones, opts: opts};
    }

    /* ── Chart Zoom Modal ── */
    var zoomChart = null;

    window.closeChartZoom = closeChartZoom;

    function openChartZoom(canvasId) {
        var src = charts[canvasId];
        if (!src || !src._docsightParams) return;
        var params = src._docsightParams;
        var card = document.getElementById(canvasId).closest('.chart-card');
        var label = card ? card.querySelector('.chart-label') : null;
        document.getElementById('chart-zoom-title').textContent = label ? label.textContent : '';
        var overlay = document.getElementById('chart-zoom-overlay');
        overlay.classList.add('open');
        /* Re-render the chart on the modal canvas (maintainAspectRatio: false to fill) */
        setTimeout(function() {
            if (zoomChart) { zoomChart.destroy(); zoomChart = null; }
            var ctx = document.getElementById('chart-zoom-canvas');
            var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            var gridColor = isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)';
            var textColor = isDark ? '#888' : '#666';
            
            var chartDatasets = params.datasets.map(function(ds) {
                var r = {
                    label: ds.label, data: ds.data,
                    borderColor: params.type === 'bar' ? ds.color : 'rgba(168,85,247,0.9)',
                    backgroundColor: params.type === 'bar' ? ds.color + 'cc' : function(context) {
                        /* Phase 4.1: Create gradient dynamically during render */
                        var chart = context.chart;
                        var ctx = chart.ctx;
                        var chartArea = chart.chartArea;
                        if (!chartArea) return 'rgba(168,85,247,0.25)'; /* Fallback */
                        var gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                        gradient.addColorStop(0, 'rgba(168,85,247,0.5)');  /* Increased from 0.3 */
                        gradient.addColorStop(0.7, 'rgba(168,85,247,0.1)');
                        gradient.addColorStop(1, 'rgba(168,85,247,0)');
                        return gradient;
                    },
                    borderWidth: params.type === 'bar' ? 3 : 2,
                    tension: params.type === 'bar' ? 0.3 : 0.4,
                    pointRadius: params.labels.length > 30 ? 2 : 4,
                    fill: params.type !== 'bar'
                };
                if (ds.stepped) { r.stepped = 'before'; r.tension = 0; }
                return r;
            });
            var hasLegend = params.datasets.length > 1;
            var cfg = {
                type: params.type || 'line',
                data: { labels: params.labels, datasets: chartDatasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { display: hasLegend, position: 'bottom', labels: { color: textColor, font: { size: 12 } } },
                        tooltip: { backgroundColor: isDark ? '#16213e' : '#fff', titleColor: textColor, bodyColor: textColor, borderColor: gridColor, borderWidth: 1 }
                    },
                    scales: {
                        x: { ticks: { color: textColor, font: { size: 11 }, maxRotation: 45 }, grid: { color: gridColor } },
                        y: { ticks: { color: textColor, font: { size: 11 }, callback: params.opts && params.opts.yTickCallback ? params.opts.yTickCallback : undefined }, grid: { color: gridColor } }
                    }
                },
                plugins: params.zones ? [zonesPlugin] : []
            };
            if (params.opts && params.opts.yMin !== undefined) cfg.options.scales.y.min = params.opts.yMin;
            if (params.opts && params.opts.yMax !== undefined) cfg.options.scales.y.max = params.opts.yMax;
            if (params.opts && params.opts.yAfterBuildTicks) cfg.options.scales.y.afterBuildTicks = params.opts.yAfterBuildTicks;
            if (params.zones) {
                var zoneMeta = params.zones.find(function(z) { return z.yMin !== undefined; });
                if (zoneMeta) {
                    cfg.options.scales.y.suggestedMin = zoneMeta.yMin;
                    cfg.options.scales.y.suggestedMax = zoneMeta.yMax;
                }
            }
            zoomChart = new Chart(ctx, cfg);
            if (params.zones) {
                zoomChart._docsightZones = params.zones;
            }
        }, 50);
    }

    function closeChartZoom() {
        document.getElementById('chart-zoom-overlay').classList.remove('open');
        if (zoomChart) { zoomChart.destroy(); zoomChart = null; }
    }

    /* Expand button click handlers */
    document.querySelectorAll('.chart-expand-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            openChartZoom(btn.getAttribute('data-chart'));
        });
    });

    /* Close chart zoom on Escape */
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('chart-zoom-overlay').classList.contains('open')) {
            closeChartZoom();
        }
    });

    /* ── BQM Graph ── */
    function loadBqmGraph(date) {
        var img = document.getElementById('bqm-image');
        var noData = document.getElementById('bqm-no-data');
        var card = document.getElementById('bqm-card');
        if (!img || !noData) return;
        if (card) card.style.display = 'none';
        noData.style.display = 'none';
        img.onload = function() { 
            if (card) card.style.display = 'block';
        };
        img.onerror = function() {
            if (card) card.style.display = 'none';
            noData.textContent = T.bqm_no_data || 'No BQM graph for this date.';
            noData.style.display = 'block';
        };
        img.src = '/api/bqm/image/' + date;
    }

    /* ── Smokeping Graphs ── */
    var _smokepingSpan = '3h';
    var smokepingTabs = document.querySelectorAll('#smokeping-tabs .trend-tab');
    smokepingTabs.forEach(function(btn) {
        btn.addEventListener('click', function() {
            _smokepingSpan = this.getAttribute('data-span');
            smokepingTabs.forEach(function(b) {
                b.classList.toggle('active', b.getAttribute('data-span') === _smokepingSpan);
            });
            loadSmokepingGraphs();
        });
    });

    function loadSmokepingGraphs() {
        var content = document.getElementById('smokeping-content');
        var noData = document.getElementById('smokeping-no-data');
        if (!content || !noData) return;
        content.innerHTML = '';
        noData.style.display = 'none';

        fetch('/api/smokeping/targets')
            .then(function(r) { return r.json(); })
            .then(function(targets) {
                if (!targets || targets.length === 0) {
                    noData.textContent = T.smokeping_no_data || 'Could not load Smokeping graphs.';
                    noData.style.display = 'block';
                    return;
                }
                targets.forEach(function(target) {
                    var card = document.createElement('div');
                    card.className = 'bqm-card';
                    var header = document.createElement('div');
                    header.className = 'chart-card-header';
                    header.innerHTML = '<div class="chart-header-content"><div class="chart-label">' + target + '</div></div>';
                    card.appendChild(header);
                    var wrap = document.createElement('div');
                    wrap.style.textAlign = 'center';
                    var img = document.createElement('img');
                    img.style.maxWidth = '100%';
                    img.style.borderRadius = '8px';
                    img.alt = target;
                    img.src = '/api/smokeping/graph/' + encodeURIComponent(target) + '/' + _smokepingSpan;
                    img.onerror = function() {
                        wrap.innerHTML = '<div class="no-data-msg" style="display:block;">' + (T.smokeping_no_data || 'Could not load graph.') + '</div>';
                    };
                    wrap.appendChild(img);
                    card.appendChild(wrap);
                    content.appendChild(card);
                });
            })
            .catch(function() {
                noData.textContent = T.smokeping_no_data || 'Could not load Smokeping graphs.';
                noData.style.display = 'block';
            });
    }

    window.loadSmokepingGraphs = loadSmokepingGraphs;

    /* ── Init ── */
    // Apply hash-based view routing (must be inside IIFE to access switchView)
    var _initHash = location.hash.replace('#', '');
    if (validViews.indexOf(_initHash) !== -1 && _initHash !== 'live') {
        switchView(_initHash, true);
    }

    /* ── Incident Journal ── */
    var _incidentsLoaded = false;
    var _journalSortCol = 'date';
    var _journalSortAsc = false;

    function loadIncidents() {
        var tableCard = document.getElementById('journal-table-card');
        var tbody = document.getElementById('journal-tbody');
        var empty = document.getElementById('journal-empty');
        var loading = document.getElementById('journal-loading');
        loading.style.display = '';
        tbody.innerHTML = '';
        if (tableCard) tableCard.style.display = 'none';
        empty.style.display = 'none';
        fetch('/api/incidents')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                loading.style.display = 'none';
                if (!data || data.length === 0) {
                    empty.textContent = T.no_incidents || 'No incidents logged yet.';
                    empty.style.display = '';
                    return;
                }
                _incidentsLoaded = true;
                renderJournalTable(data);
            })
            .catch(function() {
                loading.style.display = 'none';
                empty.textContent = T.network_error || 'Error';
                empty.style.display = '';
            });
    }

    function renderJournalTable(data) {
        var table = document.getElementById('journal-table');
        var tbody = document.getElementById('journal-tbody');
        data.sort(function(a, b) {
            var va, vb;
            if (_journalSortCol === 'date') { va = a.date || ''; vb = b.date || ''; }
            else if (_journalSortCol === 'title') { va = (a.title || '').toLowerCase(); vb = (b.title || '').toLowerCase(); }
            else { va = (a.description || '').toLowerCase(); vb = (b.description || '').toLowerCase(); }
            if (va < vb) return _journalSortAsc ? -1 : 1;
            if (va > vb) return _journalSortAsc ? 1 : -1;
            return 0;
        });
        tbody.innerHTML = '';
        data.forEach(function(inc) {
            var tr = document.createElement('tr');
            tr.setAttribute('data-id', inc.id);
            tr.onclick = function() { openIncidentModal(inc.id); };
            var desc = inc.description || '';
            if (desc.length > 80) desc = desc.substring(0, 80) + '…';
            var clipCell = inc.attachment_count > 0 ? '&#128206; ' + inc.attachment_count : '';
            tr.innerHTML =
                '<td>' + formatDateDE(inc.date) + '</td>' +
                '<td>' + escapeHtml(inc.title) + '</td>' +
                '<td class="journal-desc journal-hide-mobile">' + escapeHtml(desc) + '</td>' +
                '<td class="journal-clip">' + clipCell + '</td>';
            tbody.appendChild(tr);
        });
        // Update sort indicators in header
        var ths = table.querySelectorAll('thead th[data-col]');
        for (var i = 0; i < ths.length; i++) {
            ths[i].className = ths[i].getAttribute('data-col') === _journalSortCol ? (_journalSortAsc ? 'sort-asc' : 'sort-desc') : '';
            // Preserve journal-hide-mobile on description column
            if (ths[i].getAttribute('data-col') === 'description') {
                ths[i].className = (ths[i].className ? ths[i].className + ' ' : '') + 'journal-hide-mobile';
            }
        }
        var tableCard = document.getElementById('journal-table-card');
        if (tableCard) tableCard.style.display = '';
    }

    (function() {
        var table = document.getElementById('journal-table');
        if (table) {
            table.addEventListener('click', function(e) {
                var th = e.target.closest ? e.target.closest('th[data-col]') : null;
                if (!th) return;
                var col = th.getAttribute('data-col');
                if (col === _journalSortCol) {
                    _journalSortAsc = !_journalSortAsc;
                } else {
                    _journalSortCol = col;
                    _journalSortAsc = col === 'date' ? false : true;
                }
                loadIncidents();
            });
        }
    })();

    /* ── Event Log ── */
    var _eventsOffset = 0;
    var _eventsPageSize = 50;
    var _eventTypeLabels = {
        health_change: T.event_type_health_change || 'Health Change',
        power_change: T.event_type_power_change || 'Power Change',
        snr_change: T.event_type_snr_change || 'SNR Change',
        channel_change: T.event_type_channel_change || 'Channel Change',
        modulation_change: T.event_type_modulation_change || 'Modulation Change',
        error_spike: T.event_type_error_spike || 'Error Spike'
    };
    var _sevLabels = {
        info: T.event_severity_info || 'Info',
        warning: T.event_severity_warning || 'Warning',
        critical: T.event_severity_critical || 'Critical'
    };

    /* Phase 4.3: Pill filter toggle function */
    var _currentSeverityFilter = '';
    
    function filterEventsBySeverity(severity) {
        _currentSeverityFilter = severity;
        // Update active pill state
        var pills = document.querySelectorAll('.severity-pill');
        pills.forEach(function(pill) {
            if (pill.getAttribute('data-severity') === severity) {
                pill.classList.add('active');
            } else {
                pill.classList.remove('active');
            }
        });
        // Reload events with new filter
        loadEvents();
    }
    
    function loadEvents(append) {
        if (!append) _eventsOffset = 0;
        var severity = _currentSeverityFilter;
        var params = '?limit=' + _eventsPageSize + '&offset=' + _eventsOffset;
        if (severity) params += '&severity=' + severity;

        var tbody = document.getElementById('events-tbody');
        var tableCard = document.getElementById('events-table-card');
        var table = document.getElementById('events-table');
        var empty = document.getElementById('events-empty');
        var loading = document.getElementById('events-loading');
        var moreBtn = document.getElementById('events-show-more');
        var ackAllBtn = document.getElementById('btn-ack-all');

        if (!append) {
            loading.style.display = '';
            tbody.innerHTML = '';
            tableCard.style.display = 'none';
            empty.style.display = 'none';
            moreBtn.style.display = 'none';
        }

        fetch('/api/events' + params)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                loading.style.display = 'none';
                var events = data.events || [];
                var unack = data.unacknowledged_count || 0;
                updateEventBadge(unack);
                ackAllBtn.style.display = unack > 0 ? '' : 'none';

                if (events.length === 0 && !append) {
                    empty.textContent = T.event_no_events || 'No events detected yet.';
                    empty.style.display = '';
                    return;
                }
                events.forEach(function(ev) {
                    var tr = document.createElement('tr');
                    if (ev.acknowledged) tr.className = 'event-acked';
                    tr.setAttribute('data-event-id', ev.id);
                    var sevClass = 'sev-badge-' + ev.severity;
                    var sevLabel = _sevLabels[ev.severity] || ev.severity;
                    var typeLabel = _eventTypeLabels[ev.event_type] || ev.event_type;
                    var ackBtn = ev.acknowledged
                        ? '<span style="color:var(--muted);font-size:0.8em;">&#10003;</span>'
                        : '<button class="btn-ack" onclick="acknowledgeEvent(' + ev.id + ', event)">&#10003;</button>';
                    tr.innerHTML =
                        '<td style="white-space:nowrap;">' + escapeHtml(ev.timestamp.replace('T', ' ')) + '</td>' +
                        '<td><span class="' + sevClass + '">' + sevLabel + '</span></td>' +
                        '<td>' + escapeHtml(typeLabel) + '</td>' +
                        '<td class="event-msg">' + escapeHtml(ev.message) + '</td>' +
                        '<td class="event-actions">' + ackBtn + '</td>';
                    if (ev.details) {
                        tr.style.cursor = 'pointer';
                        tr.onclick = function(e) {
                            if (e.target.tagName === 'BUTTON') return;
                            toggleEventDetail(ev.id, ev.details);
                        };
                    }
                    tbody.appendChild(tr);
                });
                tableCard.style.display = '';
                moreBtn.style.display = events.length >= _eventsPageSize ? '' : 'none';
            })
            .catch(function() {
                loading.style.display = 'none';
                empty.textContent = T.network_error || 'Error';
                empty.style.display = '';
            });
    }

    function loadMoreEvents() {
        _eventsOffset += _eventsPageSize;
        loadEvents(true);
    }

    function toggleEventDetail(eventId, details) {
        var existing = document.getElementById('event-detail-' + eventId);
        if (existing) {
            existing.remove();
            return;
        }
        var eventRow = document.querySelector('tr[data-event-id="' + eventId + '"]');
        if (!eventRow) return;
        var detailRow = document.createElement('tr');
        detailRow.id = 'event-detail-' + eventId;
        detailRow.className = 'event-detail-row';
        var td = document.createElement('td');
        td.colSpan = 5;
        var pre = document.createElement('pre');
        pre.textContent = JSON.stringify(details, null, 2);
        td.appendChild(pre);
        detailRow.appendChild(td);
        eventRow.parentNode.insertBefore(detailRow, eventRow.nextSibling);
    }

    function acknowledgeEvent(eventId, e) {
        if (e) e.stopPropagation();
        fetch('/api/events/' + eventId + '/acknowledge', { method: 'POST' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) loadEvents();
            });
    }

    function acknowledgeAllEvents() {
        fetch('/api/events/acknowledge-all', { method: 'POST' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) loadEvents();
            });
    }

    function updateEventBadge(count) {
        var badge = document.getElementById('event-badge');
        if (!badge) return;
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.style.display = '';
        } else {
            badge.style.display = 'none';
        }
    }

    window.acknowledgeEvent = acknowledgeEvent;
    window.acknowledgeAllEvents = acknowledgeAllEvents;
    window.loadEvents = loadEvents;
    window.filterEventsBySeverity = filterEventsBySeverity;

    // Fetch badge count on page load
    fetch('/api/events/count')
        .then(function(r) { return r.json(); })
        .then(function(data) { updateEventBadge(data.count || 0); })
        .catch(function() {});

    /* ── Channel Timeline ── */
    var _channelsLoaded = false;

    function loadChannelList() {
        if (_channelsLoaded) return;
        var sel = document.getElementById('channel-select');
        fetch('/api/channels')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                sel.innerHTML = '<option value="">' + (T.select_channel || 'Select Channel') + '</option>';
                var ds = data.ds_channels || [];
                var us = data.us_channels || [];
                if (ds.length) {
                    var grp = document.createElement('optgroup');
                    grp.label = T.downstream_channels || 'Downstream Channels';
                    ds.forEach(function(ch) {
                        var opt = document.createElement('option');
                        opt.value = 'ds-' + ch.channel_id;
                        opt.dataset.docsis = ch.docsis_version || '3.0';
                        opt.textContent = 'DS ' + ch.channel_id + ' (' + (ch.frequency || '') + ')';
                        grp.appendChild(opt);
                    });
                    sel.appendChild(grp);
                }
                if (us.length) {
                    var grp2 = document.createElement('optgroup');
                    grp2.label = T.upstream_channels || 'Upstream Channels';
                    us.forEach(function(ch) {
                        var opt = document.createElement('option');
                        opt.value = 'us-' + ch.channel_id;
                        opt.dataset.docsis = ch.docsis_version || '3.0';
                        opt.textContent = 'US ' + ch.channel_id + ' (' + (ch.frequency || '') + ')';
                        grp2.appendChild(opt);
                    });
                    sel.appendChild(grp2);
                }
                _channelsLoaded = true;
            })
            .catch(function() {});
    }

    function loadChannelTimeline() {
        var sel = document.getElementById('channel-select');
        var val = sel.value;
        var chartsEl = document.getElementById('channel-charts');
        var emptyEl = document.getElementById('channel-empty');
        var loadingEl = document.getElementById('channel-loading');
        if (!val) {
            chartsEl.style.display = 'none';
            emptyEl.style.display = 'none';
            return;
        }
        var parts = val.split('-');
        var direction = parts[0];
        var channelId = parts[1];
        var selectedOpt = sel.options[sel.selectedIndex];
        var docsisVersion = selectedOpt ? selectedOpt.dataset.docsis || '3.0' : '3.0';
        var days = document.getElementById('channel-time-range').value;

        loadingEl.style.display = '';
        chartsEl.style.display = 'none';
        emptyEl.style.display = 'none';

        fetch('/api/channel-history?channel_id=' + channelId + '&direction=' + direction + '&days=' + days)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                loadingEl.style.display = 'none';
                if (!data || data.length === 0) {
                    emptyEl.textContent = T.no_channel_data || 'No data available for this channel.';
                    emptyEl.style.display = '';
                    return;
                }
                chartsEl.style.display = '';
                var xLabels = data.map(function(d) {
                    if (!d.timestamp) return '';
                    if (parseInt(days) <= 1) return d.timestamp.substring(11, 16);
                    return d.timestamp.substring(5, 16).replace('T', ' ');
                });
                var powerDatasets = [{label: T.power_dbmv || 'Power (dBmV)', data: data.map(function(d){ return d.power; }), color: '#00e5f0'}];
                var powerThresholds = direction === 'ds' ? DS_POWER_THRESHOLDS : US_POWER_THRESHOLDS;
                var powerCard = document.querySelector('#channel-charts .chart-card:first-child');
                var powerLabel = powerCard ? powerCard.querySelector('.chart-label') : null;
                var errorsCard = document.getElementById('channel-errors-card');
                if (direction === 'ds') {
                    powerDatasets.push({label: T.snr_db || 'SNR (dB)', data: data.map(function(d){ return d.snr; }), color: '#66ff77'});
                    powerThresholds = null; /* DS combines Power + SNR, thresholds don't apply */
                    if (powerLabel) powerLabel.textContent = (T.power_dbmv || 'Power') + ' & ' + (T.snr_db || 'SNR');
                    errorsCard.style.display = '';
                    renderChart('chart-ch-errors', xLabels, [
                        {label: T.correctable || 'Correctable', data: data.map(function(d){ return d.correctable_errors; }), color: '#2196f3'},
                        {label: T.uncorrectable || 'Uncorrectable', data: data.map(function(d){ return d.uncorrectable_errors; }), color: '#f44336'}
                    ], 'bar');
                } else {
                    if (powerLabel) powerLabel.textContent = T.power_dbmv || 'Power (dBmV)';
                    errorsCard.style.display = 'none';
                }
                renderChart('chart-ch-power', xLabels, powerDatasets, null, powerThresholds);

                // Modulation timeline (stepped line chart)
                var modCard = document.getElementById('channel-modulation-card');
                var mods = data.filter(function(d) { return d.modulation; });
                if (mods.length === 0) {
                    modCard.style.display = 'none';
                } else {
                    modCard.style.display = '';
                    // Fixed QAM scales per channel direction and DOCSIS version
                    var is31 = docsisVersion === '3.1' || docsisVersion === '4.0';
                    var usQam30 = [4, 16, 32, 64];
                    var usQam31 = [16, 64, 256, 1024];
                    var dsQam30 = [64, 256];
                    var dsQam31 = [64, 256, 1024, 4096];
                    var qamSteps;
                    if (direction === 'us') { qamSteps = is31 ? usQam31 : usQam30; }
                    else { qamSteps = is31 ? dsQam31 : dsQam30; }
                    var qamLabel = {}; qamSteps.forEach(function(v) { qamLabel[v] = v + 'QAM'; });
                    var qamMap = {}; qamSteps.forEach(function(v, i) { qamMap[v + 'QAM'] = i; });
                    var modLabels = mods.map(function(d) { return d.timestamp.substring(5, 16).replace('T', ' '); });
                    var modValues = mods.map(function(d) { return qamMap[d.modulation] !== undefined ? qamMap[d.modulation] : -1; });
                    var tickValues = [];
                    for (var qi = 0; qi < qamSteps.length; qi++) tickValues.push(qi);
                    renderChart('chart-ch-modulation', modLabels, [
                        {label: T.modulation || 'Modulation', data: modValues, color: '#ffab40', stepped: true}
                    ], null, null, {
                        yTickCallback: function(value) { return qamLabel[qamSteps[value]] || ''; },
                        yMin: -0.5,
                        yMax: qamSteps.length - 0.5,
                        yAfterBuildTicks: function(axis) {
                            axis.ticks = tickValues.map(function(v) { return {value: v}; });
                        }
                    });
                }
            })
            .catch(function() {
                loadingEl.style.display = 'none';
                emptyEl.textContent = T.trend_error || 'Error loading data.';
                emptyEl.style.display = '';
            });
    }
    window.loadChannelTimeline = loadChannelTimeline;

    function openIncidentModal(incidentId) {
        var modal = document.getElementById('incident-modal');
        var titleEl = document.getElementById('incident-modal-title');
        var idEl = document.getElementById('incident-id');
        var dateEl = document.getElementById('incident-date');
        var titleInput = document.getElementById('incident-title-input');
        var descEl = document.getElementById('incident-desc');
        var deleteBtn = document.getElementById('incident-delete-btn');
        var attachSection = document.getElementById('incident-attachments-section');
        var attachList = document.getElementById('incident-attachment-list');

        attachList.innerHTML = '';

        if (incidentId) {
            titleEl.textContent = T.edit_entry || 'Edit Entry';
            deleteBtn.style.display = '';
            fetch('/api/incidents/' + incidentId)
                .then(function(r) { return r.json(); })
                .then(function(inc) {
                    idEl.value = inc.id;
                    dateEl.value = inc.date;
                    titleInput.value = inc.title;
                    descEl.value = inc.description || '';
                    renderAttachments(inc.attachments || [], attachList, incidentId);
                    attachSection.style.display = '';
                    modal.classList.add('open');
                });
        } else {
            titleEl.textContent = T.new_entry || 'New Entry';
            idEl.value = '';
            dateEl.value = todayStr();
            titleInput.value = '';
            descEl.value = '';
            deleteBtn.style.display = 'none';
            attachSection.style.display = 'none';
            modal.classList.add('open');
        }
    }

    function closeIncidentModal() {
        document.getElementById('incident-modal').classList.remove('open');
    }

    function renderAttachments(attachments, container, incidentId) {
        container.innerHTML = '';
        attachments.forEach(function(att) {
            var item = document.createElement('div');
            item.className = 'attachment-item';
            var isImage = att.mime_type && att.mime_type.indexOf('image/') === 0;
            var thumbHtml = '';
            if (isImage) {
                thumbHtml = '<img class="attachment-thumb" src="/api/attachments/' + att.id + '" alt="">';
            } else if (att.mime_type === 'application/pdf') {
                thumbHtml = '<div class="attachment-icon">&#128196;</div>';
            } else {
                thumbHtml = '<div class="attachment-icon">&#128462;</div>';
            }
            item.innerHTML = thumbHtml +
                '<div class="attachment-info">' +
                    '<span class="attachment-name">' + escapeHtml(att.filename) + '</span>' +
                    '<div class="attachment-actions">' +
                        '<a href="/api/attachments/' + att.id + '" download title="Download">&#11015;</a>' +
                        '<button onclick="deleteAttachment(' + att.id + ', ' + incidentId + ')" title="Delete">&#128465;</button>' +
                    '</div>' +
                '</div>';
            container.appendChild(item);
        });
    }

    function saveIncident() {
        var idEl = document.getElementById('incident-id');
        var dateVal = document.getElementById('incident-date').value;
        var titleVal = document.getElementById('incident-title-input').value.trim();
        var descVal = document.getElementById('incident-desc').value.trim();
        var incidentId = idEl.value;

        if (!titleVal) {
            showToast(T.incident_title + ' required', 'error');
            return;
        }

        var payload = JSON.stringify({date: dateVal, title: titleVal, description: descVal});
        var url = incidentId ? '/api/incidents/' + incidentId : '/api/incidents';
        var method = incidentId ? 'PUT' : 'POST';

        fetch(url, {method: method, headers: {'Content-Type': 'application/json'}, body: payload})
            .then(function(r) { return r.json().then(function(d) { return {status: r.status, data: d}; }); })
            .then(function(res) {
                if (res.status >= 400) {
                    showToast(res.data.error || 'Error', 'error');
                    return;
                }
                loadIncidents();
                if (!incidentId && res.data.id) {
                    // New entry: switch modal to edit mode in-place (keep it open)
                    idEl.value = res.data.id;
                    document.getElementById('incident-modal-title').textContent = T.edit_entry || 'Edit Entry';
                    document.getElementById('incident-delete-btn').style.display = '';
                    document.getElementById('incident-attachments-section').style.display = '';
                    showToast(T.saved || 'Saved', 'ok');
                } else {
                    closeIncidentModal();
                }
            })
            .catch(function() { showToast(T.network_error || 'Error', 'error'); });
    }

    function deleteIncident() {
        var incidentId = document.getElementById('incident-id').value;
        if (!incidentId) return;
        if (!confirm(T.confirm_delete || 'Are you sure?')) return;
        fetch('/api/incidents/' + incidentId, {method: 'DELETE'})
            .then(function(r) { return r.json(); })
            .then(function() {
                closeIncidentModal();
                loadIncidents();
            })
            .catch(function() { showToast(T.network_error || 'Error', 'error'); });
    }

    function handleIncidentFileUpload(input) {
        var incidentId = document.getElementById('incident-id').value;
        if (!incidentId || !input.files || input.files.length === 0) return;
        var spinner = document.getElementById('incident-upload-spinner');
        var uploadBtn = document.getElementById('incident-upload-btn');
        spinner.style.display = 'inline';
        uploadBtn.disabled = true;
        var uploads = [];
        for (var i = 0; i < input.files.length; i++) {
            uploads.push(uploadOneFile(incidentId, input.files[i]));
        }
        Promise.all(uploads)
            .then(function(results) {
                var errors = results.filter(function(r) { return r.error; });
                if (errors.length > 0) {
                    showToast(errors[0].error, 'error');
                }
                spinner.style.display = 'none';
                uploadBtn.disabled = false;
                input.value = '';
                // Reload attachments
                fetch('/api/incidents/' + incidentId)
                    .then(function(r) { return r.json(); })
                    .then(function(inc) {
                        renderAttachments(inc.attachments || [], document.getElementById('incident-attachment-list'), incidentId);
                    });
            })
            .catch(function() {
                spinner.style.display = 'none';
                uploadBtn.disabled = false;
                showToast(T.network_error || 'Error', 'error');
            });
    }

    function uploadOneFile(incidentId, file) {
        var formData = new FormData();
        formData.append('file', file);
        return fetch('/api/incidents/' + incidentId + '/attachments', {method: 'POST', body: formData})
            .then(function(r) { return r.json().then(function(d) { return r.status >= 400 ? {error: d.error} : d; }); })
            .catch(function() { return {error: T.network_error || 'Upload failed'}; });
    }

    function deleteAttachment(attachmentId, incidentId) {
        fetch('/api/attachments/' + attachmentId, {method: 'DELETE'})
            .then(function(r) { return r.json(); })
            .then(function() {
                fetch('/api/incidents/' + incidentId)
                    .then(function(r) { return r.json(); })
                    .then(function(inc) {
                        renderAttachments(inc.attachments || [], document.getElementById('incident-attachment-list'), incidentId);
                    });
            })
            .catch(function() { showToast(T.network_error || 'Error', 'error'); });
    }

    /* Expose Journal functions for HTML onclick/onchange handlers */
    window.openIncidentModal = openIncidentModal;
    window.closeIncidentModal = closeIncidentModal;
    window.saveIncident = saveIncident;
    window.deleteIncident = deleteIncident;
    window.deleteAttachment = deleteAttachment;
    window.handleIncidentFileUpload = handleIncidentFileUpload;
    window.loadIncidents = loadIncidents;

})();

/* ── Export for LLM ── */
function exportForLLM() {
    var T = {{ t|tojson }};
    var modal = document.getElementById('export-modal');
    var textarea = document.getElementById('export-text');
    var modeEl = document.querySelector('input[name="export-mode"]:checked');
    var mode = modeEl ? modeEl.value : 'full';
    textarea.value = T.export_no_data;
    modal.classList.add('open');
    fetch('/api/export?mode=' + mode)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.text) {
                textarea.value = data.text;
            } else if (data.error) {
                textarea.value = data.error;
            }
        })
        .catch(function() {
            textarea.value = 'Error loading export data.';
        });
}
function closeExportModal() {
    document.getElementById('export-modal').classList.remove('open');
}
function openBqmSetupModal() {
    document.getElementById('bqm-setup-modal').classList.add('open');
}
function closeBqmSetupModal() {
    document.getElementById('bqm-setup-modal').classList.remove('open');
}
function openReportModal() {
    document.getElementById('report-modal').classList.add('open');
    closeSidebar();
}
function closeReportModal() {
    document.getElementById('report-modal').classList.remove('open');
    // Reset to step 1
    document.getElementById('report-step1').style.display = '';
    document.getElementById('report-step2').style.display = 'none';
    document.getElementById('report-generate-btn').style.display = '';
    document.getElementById('report-copy-btn').style.display = 'none';
    document.getElementById('report-pdf-btn').style.display = 'none';
}
function generateComplaint() {
    var days = document.getElementById('report-days').value;
    var lang = document.getElementById('report-lang').value;
    var name = encodeURIComponent(document.getElementById('report-name').value);
    var number = encodeURIComponent(document.getElementById('report-number').value);
    var address = encodeURIComponent(document.getElementById('report-address').value);
    var btn = document.getElementById('report-generate-btn');
    btn.disabled = true;
    btn.textContent = '...';
    fetch('/api/complaint?days=' + days + '&lang=' + lang + '&name=' + name + '&number=' + number + '&address=' + address)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            document.getElementById('report-complaint-text').value = data.text;
            document.getElementById('report-step1').style.display = 'none';
            document.getElementById('report-step2').style.display = 'block';
            document.getElementById('report-generate-btn').style.display = 'none';
            document.getElementById('report-copy-btn').style.display = '';
            document.getElementById('report-pdf-btn').style.display = '';
        })
        .catch(function(e) { alert('Error: ' + e); })
        .finally(function() { btn.disabled = false; btn.textContent = '\u270E Generate Letter'; });
}
function copyComplaint() {
    var textarea = document.getElementById('report-complaint-text');
    var btn = document.getElementById('report-copy-btn');
    textarea.select();
    textarea.setSelectionRange(0, textarea.value.length);
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textarea.value).then(function() {
            var orig = btn.innerHTML;
            btn.innerHTML = '&#10003; Copied!';
            setTimeout(function() { btn.innerHTML = orig; }, 2000);
        });
    } else {
        document.execCommand('copy');
    }
}
function downloadReport() {
    var days = document.getElementById('report-days').value;
    var lang = document.getElementById('report-lang').value;
    window.location.href = '/api/report?days=' + days + '&lang=' + lang;
}
function copyExport() {
    var T = {{ t|tojson }};
    var textarea = document.getElementById('export-text');
    var btn = document.getElementById('export-copy-btn');
    textarea.select();
    textarea.setSelectionRange(0, textarea.value.length);
    var ok = false;
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textarea.value).then(function() {
            btn.textContent = T.copied;
            setTimeout(function() { btn.textContent = T.copy_clipboard; }, 2000);
        }).catch(function() {
            fallbackCopy(textarea, btn, T);
        });
    } else {
        fallbackCopy(textarea, btn, T);
    }
}
function fallbackCopy(textarea, btn, T) {
    try {
        document.execCommand('copy');
        btn.textContent = T.copied;
        setTimeout(function() { btn.textContent = T.copy_clipboard; }, 2000);
    } catch(e) {
        btn.textContent = 'Select All + Ctrl+C';
        setTimeout(function() { btn.textContent = T.copy_clipboard; }, 3000);
    }
}
function toggleCard(el) {
    el.classList.toggle('open');
}
function openSmokepingSetupModal() {
    document.getElementById('smokeping-setup-modal').classList.add('open');
}
function closeSmokepingSetupModal() {
    document.getElementById('smokeping-setup-modal').classList.remove('open');
}
function openSpeedtestSetupModal() {
    document.getElementById('speedtest-setup-modal').classList.add('open');
}
function closeSpeedtestSetupModal() {
    document.getElementById('speedtest-setup-modal').classList.remove('open');
}
var _speedtestRawData = [];
var _speedtestAllData = [];
var _speedtestVisible = 50;
var _speedtestSortCol = 'timestamp';
var _speedtestSortDir = 'desc';

function formatSpeedtestTimestamp(ts) {
    if (!ts) return '';
    var d = new Date(ts);
    if (isNaN(d.getTime())) return ts;
    var dd = String(d.getDate()).padStart(2, '0');
    var mm = String(d.getMonth() + 1).padStart(2, '0');
    var yyyy = d.getFullYear();
    var hh = String(d.getHours()).padStart(2, '0');
    var min = String(d.getMinutes()).padStart(2, '0');
    return dd + '.' + mm + '.' + yyyy + ' ' + hh + ':' + min;
}

function loadSpeedtestHistory() {
    var T = {{ t|tojson }};
    var tbody = document.getElementById('speedtest-tbody');
    var table = document.getElementById('speedtest-table');
    var noData = document.getElementById('speedtest-no-data');
    var loading = document.getElementById('speedtest-loading');
    var moreWrap = document.getElementById('speedtest-show-more');
    if (!tbody || !table || !noData) return;
    tbody.innerHTML = '';
    table.style.display = 'none';
    noData.style.display = 'none';
    if (loading) loading.style.display = '';
    if (moreWrap) moreWrap.style.display = 'none';
    _speedtestRawData = [];
    _speedtestAllData = [];
    _speedtestVisible = 50;
    fetch('/api/speedtest?count=2000')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (loading) loading.style.display = 'none';
            if (!data || data.length === 0) {
                noData.textContent = T.speedtest_no_data || 'No speedtest data.';
                noData.style.display = 'block';
                return;
            }
            _speedtestRawData = data;
            filterSpeedtestData();
        })
        .catch(function() {
            if (loading) loading.style.display = 'none';
            noData.textContent = T.network_error || 'Error';
            noData.style.display = 'block';
        });
}

function filterSpeedtestData() {
    var T = {{ t|tojson }};
    var daysEl = document.getElementById('speedtest-days');
    var days = daysEl ? daysEl.value : '7';
    var table = document.getElementById('speedtest-table');
    var noData = document.getElementById('speedtest-no-data');
    _speedtestVisible = 50;
    if (days === 'all') {
        _speedtestAllData = _speedtestRawData.slice();
    } else {
        var cutoff = new Date(Date.now() - parseInt(days) * 86400000);
        _speedtestAllData = _speedtestRawData.filter(function(r) {
            return new Date(r.timestamp) >= cutoff;
        });
    }
    sortSpeedtestData();
    if (_speedtestAllData.length === 0) {
        if (table) table.style.display = 'none';
        if (noData) {
            noData.textContent = T.speedtest_no_data || 'No speedtest data.';
            noData.style.display = 'block';
        }
        var cc = document.getElementById('speedtest-chart-container');
        if (cc) cc.style.display = 'none';
    } else {
        if (table) table.style.display = '';
        if (noData) noData.style.display = 'none';
        renderSpeedtestRows();
        renderSpeedtestChart();
    }
}

function sortSpeedtestData() {
    var col = _speedtestSortCol;
    var dir = _speedtestSortDir === 'asc' ? 1 : -1;
    _speedtestAllData.sort(function(a, b) {
        var va = a[col], vb = b[col];
        if (col === 'timestamp') {
            va = new Date(va || 0).getTime();
            vb = new Date(vb || 0).getTime();
        } else {
            va = parseFloat(va) || 0;
            vb = parseFloat(vb) || 0;
        }
        if (va < vb) return -1 * dir;
        if (va > vb) return 1 * dir;
        return 0;
    });
}

function handleSpeedtestSort(col) {
    if (_speedtestSortCol === col) {
        _speedtestSortDir = _speedtestSortDir === 'asc' ? 'desc' : 'asc';
    } else {
        _speedtestSortCol = col;
        _speedtestSortDir = col === 'timestamp' ? 'desc' : 'asc';
    }
    var ths = document.querySelectorAll('#speedtest-table thead th');
    ths.forEach(function(th) {
        var indicator = th.querySelector('.sort-indicator');
        if (indicator) {
            if (th.getAttribute('data-col') === col) {
                indicator.textContent = _speedtestSortDir === 'asc' ? '▲' : '▼';
            } else {
                indicator.textContent = '';
            }
        }
    });
    sortSpeedtestData();
    _speedtestVisible = 50;
    renderSpeedtestRows();
    renderSpeedtestChart();
}

function computeMedian(arr) {
    if (arr.length === 0) return 0;
    var sorted = arr.slice().sort(function(a, b) { return a - b; });
    var mid = Math.floor(sorted.length / 2);
    return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
}

function renderSpeedtestRows() {
    var T = {{ t|tojson }};
    var tbody = document.getElementById('speedtest-tbody');
    var moreWrap = document.getElementById('speedtest-show-more');
    var moreBtn = document.getElementById('speedtest-more-btn');
    if (!tbody) return;
    tbody.innerHTML = '';
    var downloads = [], uploads = [];
    for (var j = 0; j < _speedtestAllData.length; j++) {
        var d = _speedtestAllData[j];
        if (d.download_mbps != null) downloads.push(parseFloat(d.download_mbps) || 0);
        if (d.upload_mbps != null) uploads.push(parseFloat(d.upload_mbps) || 0);
    }
    var medianDl = computeMedian(downloads);
    var medianUl = computeMedian(uploads);
    var show = Math.min(_speedtestVisible, _speedtestAllData.length);
    for (var i = 0; i < show; i++) {
        var r = _speedtestAllData[i];
        var dlVal = parseFloat(r.download_mbps) || 0;
        var ulVal = parseFloat(r.upload_mbps) || 0;
        var pingVal = parseFloat(r.ping_ms) || 0;
        var jitterVal = parseFloat(r.jitter_ms) || 0;
        var dlClass = (medianDl > 0 && dlVal < medianDl * 0.8) ? ' class="val-bad"' : '';
        var ulClass = (medianUl > 0 && ulVal < medianUl * 0.8) ? ' class="val-bad"' : '';
        var pingClass = pingVal > 50 ? ' class="val-warn"' : '';
        var jitterClass = jitterVal > 20 ? ' class="val-warn"' : '';
        var tr = document.createElement('tr');
        tr.innerHTML = '<td class="st-expand-col"><button class="st-expand-btn" data-id="' + r.id + '" onclick="toggleSpeedtestSignal(this)">&#9654;</button></td>'
            + '<td>' + escapeHtml(formatSpeedtestTimestamp(r.timestamp)) + '</td>'
            + '<td><strong' + dlClass + '>' + escapeHtml(r.download_human || (r.download_mbps + ' Mbps')) + '</strong></td>'
            + '<td><strong' + ulClass + '>' + escapeHtml(r.upload_human || (r.upload_mbps + ' Mbps')) + '</strong></td>'
            + '<td' + pingClass + '>' + r.ping_ms + ' ms</td>'
            + '<td' + jitterClass + '>' + r.jitter_ms + ' ms</td>'
            + '<td>' + (r.packet_loss_pct > 0 ? '<span class="val-warn">' + r.packet_loss_pct + '%</span>' : '0%') + '</td>';
        tbody.appendChild(tr);
    }
    if (moreWrap && moreBtn) {
        if (_speedtestAllData.length > _speedtestVisible) {
            moreWrap.style.display = '';
            moreBtn.textContent = (T.show_more || 'Show more') + ' (' + (_speedtestAllData.length - _speedtestVisible) + ')';
        } else {
            moreWrap.style.display = 'none';
        }
    }
}

function toggleSpeedtestSignal(btn) {
    var T = {{ t|tojson }};
    var id = btn.getAttribute('data-id');
    var parentRow = btn.closest('tr');
    var detailRow = parentRow.nextElementSibling;
    // If detail row exists and belongs to this entry, toggle it
    if (detailRow && detailRow.classList.contains('st-signal-row')) {
        detailRow.remove();
        btn.classList.remove('open');
        return;
    }
    // Create detail row and fetch data
    btn.classList.add('open');
    var newRow = document.createElement('tr');
    newRow.className = 'st-signal-row';
    var cols = parentRow.children.length;
    var td = document.createElement('td');
    td.colSpan = cols;
    td.innerHTML = '<div class="st-signal-detail"><span class="st-sig-no-data" style="text-align:center;">...</span></div>';
    newRow.appendChild(td);
    parentRow.after(newRow);
    fetch('/api/speedtest/' + id + '/signal')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var container = newRow.querySelector('.st-signal-detail');
            if (!data.found) {
                container.innerHTML = '<span class="st-sig-no-data">' + escapeHtml(data.message || T.signal_no_snapshot) + '</span>';
                return;
            }
            var healthClass = 'health-' + (data.health === 'good' ? 'good' : data.health === 'marginal' ? 'marginal' : 'poor');
            var healthLabel = data.health === 'good' ? (T.health_good || 'Good')
                : data.health === 'marginal' ? (T.health_marginal || 'Marginal')
                : (T.health_poor || 'Poor');
            var html = '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_health || 'Health') + '</span>'
                + '<span class="st-health-badge ' + healthClass + '">' + escapeHtml(healthLabel) + '</span></div>'
                + '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_ds_power || 'DS Power') + '</span>'
                + '<span class="st-sig-value">' + data.ds_power_min + ' / ' + data.ds_power_avg + ' / ' + data.ds_power_max + ' dBmV</span></div>'
                + '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_ds_snr || 'DS SNR') + '</span>'
                + '<span class="st-sig-value">' + data.ds_snr_min + ' / ' + data.ds_snr_avg + ' dB</span></div>'
                + '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_us_power || 'US Power') + '</span>'
                + '<span class="st-sig-value">' + data.us_power_min + ' / ' + data.us_power_avg + ' / ' + data.us_power_max + ' dBmV</span></div>'
                + '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_errors || 'Errors') + '</span>'
                + '<span class="st-sig-value">' + (data.ds_correctable_errors || 0).toLocaleString() + ' ' + (T.signal_corr || 'corr.') + ' / '
                + (data.ds_uncorrectable_errors || 0).toLocaleString() + ' ' + (T.signal_uncorr || 'uncorr.') + '</span></div>'
                + '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_ds_channels || 'DS') + ' / ' + (T.signal_us_channels || 'US') + '</span>'
                + '<span class="st-sig-value">' + (data.ds_total || 0) + ' / ' + (data.us_total || 0) + '</span></div>';
            if (data.us_channels && data.us_channels.length > 0) {
                html += '<div class="st-us-mods"><span class="st-sig-label">' + (T.signal_us_modulation || 'US Modulation') + ': </span>';
                for (var c = 0; c < data.us_channels.length; c++) {
                    var ch = data.us_channels[c];
                    html += '<span>Ch' + (ch.channel_id || c) + ': ' + escapeHtml(ch.modulation || '?') + '</span>';
                }
                html += '</div>';
            }
            html += '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_snapshot_time || 'Snapshot') + '</span>'
                + '<span class="st-sig-value" style="font-size:0.85em; color:var(--muted);">' + escapeHtml(data.snapshot_timestamp || '') + '</span></div>';
            container.innerHTML = html;
        })
        .catch(function() {
            var container = newRow.querySelector('.st-signal-detail');
            if (container) container.innerHTML = '<span class="st-sig-no-data">Error loading signal data</span>';
        });
}

function renderSpeedtestChart() {
    var container = document.getElementById('speedtest-chart-container');
    var canvas = document.getElementById('speedtest-chart');
    if (!container || !canvas) return;
    // Sort data chronologically for chart (oldest first)
    var data = _speedtestAllData.slice().sort(function(a, b) {
        return new Date(a.timestamp) - new Date(b.timestamp);
    });
    if (data.length < 2) { container.style.display = 'none'; return; }
    container.style.display = '';
    var wrap = canvas.parentElement;
    var dpr = window.devicePixelRatio || 1;
    var w = wrap.clientWidth;
    var h = canvas.clientHeight || 250;
    canvas.width = w * dpr;
    canvas.height = h * dpr;
    var ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);
    // Padding
    var padL = 60, padR = 60, padT = 20, padB = 30;
    var cw = w - padL - padR;
    var ch = h - padT - padB;
    // Extract data arrays
    var dls = [], uls = [], pings = [], times = [];
    for (var i = 0; i < data.length; i++) {
        dls.push(parseFloat(data[i].download_mbps) || 0);
        uls.push(parseFloat(data[i].upload_mbps) || 0);
        pings.push(parseFloat(data[i].ping_ms) || 0);
        times.push(new Date(data[i].timestamp));
    }
    // Scales
    var maxSpeed = Math.max.apply(null, dls.concat(uls)) * 1.1 || 1;
    var maxPing = Math.max.apply(null, pings) * 1.1 || 1;
    var medianDl = computeMedian(dls);
    var threshold = medianDl * 0.8;
    function xPos(idx) { return padL + (idx / (data.length - 1)) * cw; }
    function ySpeed(v) { return padT + ch - (v / maxSpeed) * ch; }
    function yPing(v) { return padT + ch - (v / maxPing) * ch; }
    // Clear
    ctx.clearRect(0, 0, w, h);
    // Background zones (green/red tint per segment)
    for (var i = 0; i < data.length - 1; i++) {
        var x1 = xPos(i), x2 = xPos(i + 1);
        var isHealthy = dls[i] >= threshold && dls[i + 1] >= threshold;
        ctx.fillStyle = isHealthy ? 'rgba(34,197,94,0.06)' : 'rgba(239,68,68,0.06)';
        ctx.fillRect(x1, padT, x2 - x1, ch);
    }
    // Grid lines + left Y axis labels (speed)
    var cs = getComputedStyle(document.documentElement);
    var mutedColor = cs.getPropertyValue('--muted').trim() || '#888';
    ctx.strokeStyle = 'rgba(255,255,255,0.07)';
    ctx.lineWidth = 1;
    ctx.font = '11px monospace';
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    var gridLines = 5;
    for (var g = 0; g <= gridLines; g++) {
        var gy = padT + (g / gridLines) * ch;
        var speedVal = maxSpeed - (g / gridLines) * maxSpeed;
        var pingVal = maxPing - (g / gridLines) * maxPing;
        ctx.beginPath();
        ctx.moveTo(padL, gy);
        ctx.lineTo(w - padR, gy);
        ctx.stroke();
        ctx.fillStyle = mutedColor;
        ctx.textAlign = 'right';
        ctx.fillText(speedVal.toFixed(0), padL - 6, gy);
        ctx.textAlign = 'left';
        ctx.fillText(pingVal.toFixed(0), w - padR + 6, gy);
    }
    ctx.fillStyle = mutedColor;
    ctx.font = '10px monospace';
    ctx.textAlign = 'center';
    ctx.save();
    ctx.translate(12, padT + ch / 2);
    ctx.rotate(-Math.PI / 2);
    ctx.fillText('Mbps', 0, 0);
    ctx.restore();
    ctx.save();
    ctx.translate(w - 10, padT + ch / 2);
    ctx.rotate(Math.PI / 2);
    ctx.fillText('ms', 0, 0);
    ctx.restore();
    // X axis labels (timestamps)
    ctx.fillStyle = mutedColor;
    ctx.font = '10px monospace';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    var labelCount = Math.min(6, data.length);
    for (var li = 0; li < labelCount; li++) {
        var idx = Math.round(li * (data.length - 1) / (labelCount - 1));
        var t = times[idx];
        var label = String(t.getDate()).padStart(2, '0') + '.' + String(t.getMonth() + 1).padStart(2, '0') + ' ' + String(t.getHours()).padStart(2, '0') + ':' + String(t.getMinutes()).padStart(2, '0');
        ctx.fillText(label, xPos(idx), padT + ch + 6);
    }
    // Threshold line (dashed red)
    ctx.setLineDash([6, 4]);
    ctx.strokeStyle = 'rgba(239,68,68,0.6)';
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    var threshY = ySpeed(threshold);
    ctx.moveTo(padL, threshY);
    ctx.lineTo(w - padR, threshY);
    ctx.stroke();
    ctx.setLineDash([]);
    // Helper: draw filled line with gradient (Phase 4.2)
    function drawLine(values, yFn, color, gradientColors) {
        // Filled area with gradient
        ctx.beginPath();
        ctx.moveTo(xPos(0), padT + ch);
        for (var i = 0; i < values.length; i++) {
            ctx.lineTo(xPos(i), yFn(values[i]));
        }
        ctx.lineTo(xPos(values.length - 1), padT + ch);
        ctx.closePath();
        
        // Create gradient if provided
        if (gradientColors && gradientColors.length === 2) {
            var gradient = ctx.createLinearGradient(0, padT, 0, padT + ch);
            gradient.addColorStop(0, gradientColors[0]);
            gradient.addColorStop(1, gradientColors[1]);
            ctx.fillStyle = gradient;
        } else {
            ctx.fillStyle = gradientColors;
        }
        ctx.fill();
        
        // Line with smooth curves
        ctx.beginPath();
        for (var i = 0; i < values.length; i++) {
            if (i === 0) {
                ctx.moveTo(xPos(i), yFn(values[i]));
            } else {
                // Smooth curve approximation using quadratic curves
                var prevX = xPos(i - 1);
                var prevY = yFn(values[i - 1]);
                var currX = xPos(i);
                var currY = yFn(values[i]);
                var cpX = (prevX + currX) / 2;
                var cpY = (prevY + currY) / 2;
                ctx.quadraticCurveTo(prevX, prevY, cpX, cpY);
                if (i === values.length - 1) {
                    ctx.lineTo(currX, currY);
                }
            }
        }
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.stroke();
    }
    
    // Phase 4.2: Purple gradient for download, green for upload, amber line for ping
    drawLine(uls, ySpeed, '#22c55e', ['rgba(34,197,94,0.3)', 'rgba(34,197,94,0)']);
    drawLine(dls, ySpeed, '#a855f7', ['rgba(168,85,247,0.3)', 'rgba(168,85,247,0)']);
    drawLine(pings, yPing, '#f59e0b', 'rgba(245,158,11,0.10)');
    // Hover interaction
    var tooltip = document.getElementById('speedtest-chart-tooltip');
    // Move tooltip to body so it's never clipped
    if (tooltip.parentElement !== document.body) document.body.appendChild(tooltip);
    tooltip.style.position = 'fixed';
    function onMouseMove(e) {
        var rect = canvas.getBoundingClientRect();
        var scaleX = w / rect.width;
        var scaleY = h / rect.height;
        var mx = (e.clientX - rect.left) * scaleX;
        var my = (e.clientY - rect.top) * scaleY;
        if (mx < padL || mx > w - padR || my < padT || my > padT + ch) {
            tooltip.style.display = 'none'; return;
        }
        var ratio = (mx - padL) / cw;
        var idx = Math.round(ratio * (data.length - 1));
        if (idx < 0) idx = 0;
        if (idx >= data.length) idx = data.length - 1;
        tooltip.style.display = 'block';
        tooltip.innerHTML = '<strong>' + formatSpeedtestTimestamp(data[idx].timestamp) + '</strong><br>'
            + '<span style="color:#a855f7">&#9660;</span> DL: ' + dls[idx].toFixed(2) + ' Mbps<br>'
            + '<span style="color:#22c55e">&#9650;</span> UL: ' + uls[idx].toFixed(2) + ' Mbps<br>'
            + '<span style="color:#f59e0b">&#9679;</span> Ping: ' + pings[idx].toFixed(1) + ' ms';
        tooltip.style.left = (e.clientX + 14) + 'px';
        tooltip.style.top = (e.clientY - 10) + 'px';
    }
    function onMouseLeave() { tooltip.style.display = 'none'; }
    if (canvas._chartMoveHandler) canvas.removeEventListener('mousemove', canvas._chartMoveHandler);
    if (canvas._chartLeaveHandler) canvas.removeEventListener('mouseleave', canvas._chartLeaveHandler);
    canvas._chartMoveHandler = onMouseMove;
    canvas._chartLeaveHandler = onMouseLeave;
    canvas.addEventListener('mousemove', onMouseMove);
    canvas.addEventListener('mouseleave', onMouseLeave);
}
window.addEventListener('resize', function() {
    if (_speedtestAllData.length >= 2) renderSpeedtestChart();
    
    // Clean up sidebar state on resize
    if (isMobile()) {
        // On mobile, remove .collapsed if it exists (from desktop state)
        sidebar.classList.remove('collapsed');
        // Also close mobile sidebar on resize to avoid weird states
        closeMobileSidebar();
    } else {
        // On desktop, remove mobile-specific classes
        sidebar.classList.remove('mobile-open');
        sidebarBackdrop.classList.remove('active');
    }
});

function showMoreSpeedtest() {
    _speedtestVisible += 50;
    renderSpeedtestRows();
}

(function() {
    var ths = document.querySelectorAll('#speedtest-table thead th[data-col]');
    ths.forEach(function(th) {
        th.addEventListener('click', function() {
            handleSpeedtestSort(th.getAttribute('data-col'));
        });
    });
})();

function escapeHtml(str) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
}

/* ═══ Correlation Analysis ═══ */
var _correlationData = [];
var _correlationChart = null;
var _corrVisible = { snr: true, txPower: true, dsPower: true, download: true, upload: true, events: true, errors: true, poorSignal: true };
var _corrChartState = null; // Stores scales/data for tooltip lookups
var _corrZoom = null; // { tMin, tMax } when zoomed in

// Re-render chart on container resize
(function() {
    var resizeTimer;
    var observer = new ResizeObserver(function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            if (_correlationData && _correlationData.length > 0) {
                renderCorrelationChart(_correlationData);
            }
        }, 150);
    });
    document.addEventListener('DOMContentLoaded', function() {
        var wrap = document.getElementById('correlation-chart');
        if (wrap && wrap.parentElement) observer.observe(wrap.parentElement);
    });
})();

function loadCorrelationData() {
    var hours = document.getElementById('correlation-hours').value;

    var loading = document.getElementById('correlation-loading');
    var noData = document.getElementById('correlation-no-data');
    var chartContainer = document.getElementById('correlation-chart-container');
    var tableCard = document.getElementById('correlation-table-card');
    loading.style.display = 'flex';
    noData.style.display = 'none';
    chartContainer.style.display = 'none';
    tableCard.style.display = 'none';

    fetch('/api/correlation?hours=' + hours + '&sources=modem,speedtest,events')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            loading.style.display = 'none';
            _correlationData = data;
            if (!data || data.length === 0) {
                noData.textContent = {{ t.correlation_no_data | tojson }};
                noData.style.display = 'block';
                return;
            }
            chartContainer.style.display = 'block';
            tableCard.style.display = 'block';
            renderCorrelationChart(data);
            renderCorrelationTable(data);
        })
        .catch(function() {
            loading.style.display = 'none';
            noData.textContent = {{ t.correlation_no_data | tojson }};
            noData.style.display = 'block';
        });
}

function renderCorrelationChart(data) {
    var canvas = document.getElementById('correlation-chart');
    var ctx = canvas.getContext('2d');
    var dpr = window.devicePixelRatio || 1;
    var rect = canvas.parentElement.getBoundingClientRect();
    var W = rect.width;
    var H = 280;
    canvas.width = W * dpr;
    canvas.height = H * dpr;
    canvas.style.width = W + 'px';
    canvas.style.height = H + 'px';
    ctx.scale(dpr, dpr);
    ctx.clearRect(0, 0, W, H);

    // Setup overlay canvas to match main canvas
    var overlay = document.getElementById('correlation-overlay');
    overlay.width = W * dpr;
    overlay.height = H * dpr;
    overlay.style.width = W + 'px';
    overlay.style.height = H + 'px';
    var octx = overlay.getContext('2d');
    octx.scale(dpr, dpr);
    octx.clearRect(0, 0, W, H);

    var pad = { top: 20, right: 60, bottom: 40, left: 60 };
    var plotW = W - pad.left - pad.right;
    var plotH = H - pad.top - pad.bottom;

    var modem = data.filter(function(d) { return d.source === 'modem'; });
    var speedtest = data.filter(function(d) { return d.source === 'speedtest'; });
    var events = data.filter(function(d) { return d.source === 'event'; });

    if (modem.length === 0 && speedtest.length === 0) {
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted').trim() || '#888';
        ctx.font = '13px system-ui, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText({{ t.correlation_no_data | tojson }}, W / 2, H / 2);
        return;
    }

    // Time range (with zoom support)
    var allTs = data.map(function(d) { return new Date(d.timestamp).getTime(); });
    var tMinFull = Math.min.apply(null, allTs);
    var tMaxFull = Math.max.apply(null, allTs);
    if (tMinFull === tMaxFull) { tMaxFull = tMinFull + 3600000; }
    var tMin = _corrZoom ? _corrZoom.tMin : tMinFull;
    var tMax = _corrZoom ? _corrZoom.tMax : tMaxFull;

    function xScale(ts) { return pad.left + (ts - tMin) / (tMax - tMin) * plotW; }

    // SNR axis (left, for modem SNR)
    var snrValues = modem.map(function(d) { return d.ds_snr_min || 0; }).filter(function(v) { return v > 0; });
    var snrMin = snrValues.length ? Math.floor(Math.min.apply(null, snrValues) - 2) : 20;
    var snrMax = snrValues.length ? Math.ceil(Math.max.apply(null, snrValues) + 2) : 45;
    function ySnr(v) { return pad.top + plotH - (v - snrMin) / (snrMax - snrMin) * plotH; }

    // Speed axis (right, for speedtest download/upload)
    var dlValues = speedtest.map(function(d) { return d.download_mbps || 0; });
    var ulValues = speedtest.map(function(d) { return d.upload_mbps || 0; });
    var speedMax = dlValues.length ? Math.ceil(Math.max.apply(null, dlValues) * 1.1) : 500;
    var dlMax = speedMax;
    var dlMin = 0;
    function yDl(v) { return pad.top + plotH - (v - dlMin) / (dlMax - dlMin) * plotH; }
    // TX Power axis (shares left side, separate scale)
    var txValues = modem.map(function(d) { return d.us_power_avg || 0; }).filter(function(v) { return v > 0; });
    var txMin = txValues.length ? Math.floor(Math.min.apply(null, txValues) - 2) : 30;
    var txMax = txValues.length ? Math.ceil(Math.max.apply(null, txValues) + 2) : 55;
    function yTx(v) { return pad.top + plotH - (v - txMin) / (txMax - txMin) * plotH; }

    // DS Power axis (separate scale)
    var dsPowerValues = modem.map(function(d) { return d.ds_power_avg || 0; }).filter(function(v) { return v !== 0; });
    var dsPowerMin = dsPowerValues.length ? Math.floor(Math.min.apply(null, dsPowerValues) - 2) : -10;
    var dsPowerMax = dsPowerValues.length ? Math.ceil(Math.max.apply(null, dsPowerValues) + 2) : 15;
    function yDsPower(v) { return pad.top + plotH - (v - dsPowerMin) / (dsPowerMax - dsPowerMin) * plotH; }

    // Uncorrectable errors (spike height relative to plotH)
    var errorValues = modem.map(function(d) { return d.ds_uncorrectable_errors || 0; });
    var errorMax = errorValues.length ? Math.max.apply(null, errorValues) : 0;

    var uploadColor = '#06b6d4'; // cyan
    var snrColor = 'rgba(168,85,247,1)'; // purple
    var txColor = '#f59e0b'; // amber/orange
    var dsPowerColor = '#ec4899'; // pink
    var errorColor = 'rgba(239,68,68,0.6)'; // red semi-transparent

    var style = getComputedStyle(document.documentElement);
    var textColor = style.getPropertyValue('--muted').trim() || '#888';
    var gridColor = style.getPropertyValue('--input-border').trim() || '#333';
    var goodColor = style.getPropertyValue('--good').trim() || '#4caf50';
    var warnColor = style.getPropertyValue('--warn').trim() || '#ff9800';
    var critColor = style.getPropertyValue('--crit').trim() || '#f44336';
    var accentColor = style.getPropertyValue('--accent').trim() || '#2196f3';

    // Store chart state for tooltip lookups
    var sortedSpeedtest = speedtest.slice().sort(function(a, b) {
        return new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime();
    });
    _corrChartState = {
        pad: pad, plotW: plotW, plotH: plotH, W: W, H: H,
        tMin: tMin, tMax: tMax, tMinFull: tMinFull, tMaxFull: tMaxFull,
        snrMin: snrMin, snrMax: snrMax, txMin: txMin, txMax: txMax,
        dsPowerMin: dsPowerMin, dsPowerMax: dsPowerMax, errorMax: errorMax,
        dlMin: dlMin, dlMax: dlMax,
        modem: modem, speedtest: sortedSpeedtest, events: events, data: data,
        xScale: xScale, ySnr: ySnr, yTx: yTx, yDsPower: yDsPower, yDl: yDl,
        colors: { snr: snrColor, txPower: txColor, dsPower: dsPowerColor, download: goodColor, upload: uploadColor, event: warnColor, errors: errorColor, text: textColor, grid: gridColor },
        dpr: dpr
    };

    // Grid lines
    ctx.strokeStyle = gridColor;
    ctx.lineWidth = 0.5;
    ctx.setLineDash([2, 4]);
    for (var s = Math.ceil(snrMin); s <= snrMax; s += 5) {
        var y = ySnr(s);
        ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + plotW, y); ctx.stroke();
    }
    ctx.setLineDash([]);

    // Time axis labels
    ctx.fillStyle = textColor;
    ctx.font = '10px system-ui, sans-serif';
    ctx.textAlign = 'center';
    var labelCount = Math.min(8, Math.floor(plotW / 80));
    for (var i = 0; i <= labelCount; i++) {
        var t = tMin + (tMax - tMin) * i / labelCount;
        var d = new Date(t);
        var hours = document.getElementById('correlation-hours').value;
        var label;
        if (parseInt(hours) > 48) {
            label = (d.getMonth() + 1) + '/' + d.getDate() + ' ' + String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
        } else {
            label = String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
        }
        ctx.fillText(label, xScale(t), H - pad.bottom + 18);
    }

    // Left axis labels (SNR) — only if SNR visible
    if (_corrVisible.snr && modem.length > 0) {
        ctx.textAlign = 'right';
        ctx.fillStyle = accentColor;
        for (var s = Math.ceil(snrMin); s <= snrMax; s += 5) {
            ctx.fillText(s + ' dB', pad.left - 6, ySnr(s) + 3);
        }
        ctx.save();
        ctx.translate(12, pad.top + plotH / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.textAlign = 'center';
        ctx.font = '11px system-ui, sans-serif';
        ctx.fillText('SNR (dB)', 0, 0);
        ctx.restore();
    }

    // Right axis labels (Speed) — only if download or upload visible
    if ((_corrVisible.download || _corrVisible.upload) && speedtest.length > 0) {
        ctx.textAlign = 'left';
        ctx.fillStyle = goodColor;
        var dlStep = Math.max(1, Math.ceil(dlMax / 5 / 50) * 50);
        for (var v = 0; v <= dlMax; v += dlStep) {
            ctx.fillText(v + ' Mbps', pad.left + plotW + 6, yDl(v) + 3);
        }
        ctx.save();
        ctx.translate(W - 8, pad.top + plotH / 2);
        ctx.rotate(Math.PI / 2);
        ctx.textAlign = 'center';
        ctx.font = '11px system-ui, sans-serif';
        ctx.fillText('Mbps', 0, 0);
        ctx.restore();
    }

    // Draw modem SNR line with gradient fill
    if (_corrVisible.snr && modem.length > 1) {
        var gradient = ctx.createLinearGradient(0, pad.top, 0, pad.top + plotH);
        gradient.addColorStop(0, 'rgba(168,85,247,0.3)');
        gradient.addColorStop(1, 'rgba(168,85,247,0)');
        ctx.beginPath();
        ctx.moveTo(xScale(new Date(modem[0].timestamp).getTime()), pad.top + plotH);
        for (var i = 0; i < modem.length; i++) {
            var x = xScale(new Date(modem[i].timestamp).getTime());
            var y = ySnr(modem[i].ds_snr_min || snrMin);
            ctx.lineTo(x, y);
        }
        ctx.lineTo(xScale(new Date(modem[modem.length - 1].timestamp).getTime()), pad.top + plotH);
        ctx.closePath();
        ctx.fillStyle = gradient;
        ctx.fill();
        ctx.beginPath();
        for (var i = 0; i < modem.length; i++) {
            var x = xScale(new Date(modem[i].timestamp).getTime());
            var y = ySnr(modem[i].ds_snr_min || snrMin);
            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                var x0 = xScale(new Date(modem[i - 1].timestamp).getTime());
                var y0 = ySnr(modem[i - 1].ds_snr_min || snrMin);
                var cpx = x0 + (x - x0) * 0.4;
                ctx.bezierCurveTo(cpx, y0, x - (x - x0) * 0.4, y, x, y);
            }
        }
        ctx.strokeStyle = snrColor;
        ctx.lineWidth = 2;
        ctx.stroke();
    }

    // Draw upstream TX power line
    if (_corrVisible.txPower && modem.length > 1 && txValues.length > 0) {
        ctx.beginPath();
        for (var i = 0; i < modem.length; i++) {
            var txVal = modem[i].us_power_avg;
            if (!txVal) continue;
            var x = xScale(new Date(modem[i].timestamp).getTime());
            var y = yTx(txVal);
            if (ctx._txStarted) {
                var x0 = ctx._txLastX;
                var y0 = ctx._txLastY;
                var cpx = x0 + (x - x0) * 0.4;
                ctx.bezierCurveTo(cpx, y0, x - (x - x0) * 0.4, y, x, y);
            } else {
                ctx.moveTo(x, y);
                ctx._txStarted = true;
            }
            ctx._txLastX = x;
            ctx._txLastY = y;
        }
        delete ctx._txStarted;
        delete ctx._txLastX;
        delete ctx._txLastY;
        ctx.strokeStyle = txColor;
        ctx.lineWidth = 2;
        ctx.setLineDash([6, 3]);
        ctx.stroke();
        ctx.setLineDash([]);
    }

    // Draw DS Power line (dotted pink)
    if (_corrVisible.dsPower && modem.length > 1 && dsPowerValues.length > 0) {
        ctx.beginPath();
        var dsStarted = false;
        for (var i = 0; i < modem.length; i++) {
            var dsVal = modem[i].ds_power_avg;
            if (dsVal == null) continue;
            var x = xScale(new Date(modem[i].timestamp).getTime());
            var y = yDsPower(dsVal);
            if (!dsStarted) {
                ctx.moveTo(x, y);
                dsStarted = true;
            } else {
                ctx.lineTo(x, y);
            }
        }
        ctx.strokeStyle = dsPowerColor;
        ctx.lineWidth = 1.5;
        ctx.setLineDash([2, 3]);
        ctx.stroke();
        ctx.setLineDash([]);
    }

    // Draw uncorrectable error spikes (red bars from bottom)
    if (_corrVisible.errors && errorMax > 0) {
        var spikeMaxH = plotH * 0.3; // max 30% of plot height
        for (var i = 0; i < modem.length; i++) {
            var errVal = modem[i].ds_uncorrectable_errors || 0;
            if (errVal === 0) continue;
            var x = xScale(new Date(modem[i].timestamp).getTime());
            var spikeH = (errVal / errorMax) * spikeMaxH;
            if (spikeH < 2) spikeH = 2;
            ctx.fillStyle = errorColor;
            ctx.fillRect(x - 1.5, pad.top + plotH - spikeH, 3, spikeH);
        }
    }

    // Draw modem health background bands
    if (_corrVisible.poorSignal) {
        for (var i = 0; i < modem.length; i++) {
            var x1 = xScale(new Date(modem[i].timestamp).getTime());
            var x2 = i < modem.length - 1 ? xScale(new Date(modem[i + 1].timestamp).getTime()) : x1 + 2;
            var h = modem[i].health;
            if (h === 'poor' || h === 'critical') {
                ctx.fillStyle = 'rgba(244,67,54,0.08)';
            } else if (h === 'marginal') {
                ctx.fillStyle = 'rgba(255,152,0,0.06)';
            } else {
                continue;
            }
            ctx.fillRect(x1, pad.top, x2 - x1, plotH);
        }
    }

    // Draw speedtest lines
    if (sortedSpeedtest.length > 1) {
        // Download line with gradient fill
        if (_corrVisible.download) {
            var dlGrad = ctx.createLinearGradient(0, pad.top, 0, pad.top + plotH);
            dlGrad.addColorStop(0, 'rgba(76,175,80,0.2)');
            dlGrad.addColorStop(1, 'rgba(76,175,80,0)');
            ctx.beginPath();
            ctx.moveTo(xScale(new Date(sortedSpeedtest[0].timestamp).getTime()), pad.top + plotH);
            for (var i = 0; i < sortedSpeedtest.length; i++) {
                var x = xScale(new Date(sortedSpeedtest[i].timestamp).getTime());
                var y = yDl(sortedSpeedtest[i].download_mbps || 0);
                ctx.lineTo(x, y);
            }
            ctx.lineTo(xScale(new Date(sortedSpeedtest[sortedSpeedtest.length - 1].timestamp).getTime()), pad.top + plotH);
            ctx.closePath();
            ctx.fillStyle = dlGrad;
            ctx.fill();
            ctx.beginPath();
            for (var i = 0; i < sortedSpeedtest.length; i++) {
                var x = xScale(new Date(sortedSpeedtest[i].timestamp).getTime());
                var y = yDl(sortedSpeedtest[i].download_mbps || 0);
                if (i === 0) { ctx.moveTo(x, y); }
                else {
                    var x0 = xScale(new Date(sortedSpeedtest[i - 1].timestamp).getTime());
                    var y0 = yDl(sortedSpeedtest[i - 1].download_mbps || 0);
                    var cpx = x0 + (x - x0) * 0.4;
                    ctx.bezierCurveTo(cpx, y0, x - (x - x0) * 0.4, y, x, y);
                }
            }
            ctx.strokeStyle = goodColor;
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // Upload line
        if (_corrVisible.upload) {
            ctx.beginPath();
            for (var i = 0; i < sortedSpeedtest.length; i++) {
                var x = xScale(new Date(sortedSpeedtest[i].timestamp).getTime());
                var y = yDl(sortedSpeedtest[i].upload_mbps || 0);
                if (i === 0) { ctx.moveTo(x, y); }
                else {
                    var x0 = xScale(new Date(sortedSpeedtest[i - 1].timestamp).getTime());
                    var y0 = yDl(sortedSpeedtest[i - 1].upload_mbps || 0);
                    var cpx = x0 + (x - x0) * 0.4;
                    ctx.bezierCurveTo(cpx, y0, x - (x - x0) * 0.4, y, x, y);
                }
            }
            ctx.strokeStyle = uploadColor;
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // Data point dots
        for (var i = 0; i < sortedSpeedtest.length; i++) {
            var x = xScale(new Date(sortedSpeedtest[i].timestamp).getTime());
            if (_corrVisible.download) {
                ctx.beginPath();
                ctx.arc(x, yDl(sortedSpeedtest[i].download_mbps || 0), 3, 0, Math.PI * 2);
                ctx.fillStyle = goodColor;
                ctx.fill();
            }
            if (_corrVisible.upload) {
                ctx.beginPath();
                ctx.arc(x, yDl(sortedSpeedtest[i].upload_mbps || 0), 3, 0, Math.PI * 2);
                ctx.fillStyle = uploadColor;
                ctx.fill();
            }
        }
    } else if (sortedSpeedtest.length === 1) {
        var x = xScale(new Date(sortedSpeedtest[0].timestamp).getTime());
        if (_corrVisible.download) {
            ctx.beginPath();
            ctx.arc(x, yDl(sortedSpeedtest[0].download_mbps || 0), 5, 0, Math.PI * 2);
            ctx.fillStyle = goodColor;
            ctx.fill();
        }
        if (_corrVisible.upload) {
            ctx.beginPath();
            ctx.arc(x, yDl(sortedSpeedtest[0].upload_mbps || 0), 5, 0, Math.PI * 2);
            ctx.fillStyle = uploadColor;
            ctx.fill();
        }
    }

    // Draw event markers (vertical dashed lines)
    if (_corrVisible.events) {
        for (var i = 0; i < events.length; i++) {
            var x = xScale(new Date(events[i].timestamp).getTime());
            var sev = events[i].severity;
            ctx.strokeStyle = sev === 'critical' ? critColor : sev === 'warning' ? warnColor : textColor;
            ctx.lineWidth = 1;
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.moveTo(x, pad.top);
            ctx.lineTo(x, pad.top + plotH);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = ctx.strokeStyle;
            ctx.beginPath();
            ctx.moveTo(x, pad.top);
            ctx.lineTo(x - 4, pad.top - 8);
            ctx.lineTo(x + 4, pad.top - 8);
            ctx.closePath();
            ctx.fill();
        }
    }

    // Interactive Legend
    var legend = document.getElementById('correlation-legend');
    var legendItems = [];
    if (modem.length > 0) {
        legendItems.push({ metric: 'snr', color: snrColor, label: '&#9644; SNR (dB)' });
        if (txValues.length > 0) {
            legendItems.push({ metric: 'txPower', color: txColor, label: '&#9476; TX Power (dBmV)' });
        }
        if (dsPowerValues.length > 0) {
            legendItems.push({ metric: 'dsPower', color: dsPowerColor, label: '&#183;&#183; DS Power (dBmV)' });
        }
        if (errorMax > 0) {
            legendItems.push({ metric: 'errors', color: 'rgba(239,68,68,0.8)', label: '&#9612; Errors' });
        }
    }
    if (speedtest.length > 0) {
        legendItems.push({ metric: 'download', color: goodColor, label: '&#9644; Download (Mbps)' });
        legendItems.push({ metric: 'upload', color: uploadColor, label: '&#9644; Upload (Mbps)' });
    }
    if (events.length > 0) {
        legendItems.push({ metric: 'events', color: warnColor, label: '&#9650; Events' });
    }
    legend.innerHTML = legendItems.map(function(item) {
        var cls = _corrVisible[item.metric] ? '' : ' disabled';
        return '<span data-metric="' + item.metric + '" class="' + cls + '" title="Klicken zum Ein-/Ausblenden" style="color:' + item.color + ';">' + item.label + '</span>';
    }).join('') + '<span data-metric="poorSignal" class="' + (_corrVisible.poorSignal ? '' : 'disabled') + '" title="Klicken zum Ein-/Ausblenden" style="background:rgba(244,67,54,0.15); padding:1px 6px; border-radius:3px; font-size:0.8em; color:#f44336;">Poor Signal</span>';

    // Legend click handlers
    var legendSpans = legend.querySelectorAll('span[data-metric]');
    for (var li = 0; li < legendSpans.length; li++) {
        legendSpans[li].addEventListener('click', function(e) {
            var metric = this.getAttribute('data-metric');
            // Prevent disabling all metrics
            var visibleCount = 0;
            for (var k in _corrVisible) { if (_corrVisible[k]) visibleCount++; }
            if (_corrVisible[metric] && visibleCount <= 1) return;
            _corrVisible[metric] = !_corrVisible[metric];
            renderCorrelationChart(data);
        });
    }

    // Show/hide zoom reset button
    var zoomBtn = document.getElementById('correlation-zoom-reset');
    if (zoomBtn) zoomBtn.style.display = _corrZoom ? 'block' : 'none';

    // Setup tooltip interaction on overlay canvas
    _setupCorrelationTooltip(overlay, octx);
}

function _corrResetZoom() {
    _corrZoom = null;
    if (_correlationData && _correlationData.length > 0) {
        renderCorrelationChart(_correlationData);
    }
}

function _setupCorrelationTooltip(overlay, octx) {
    var tooltip = document.getElementById('correlation-tooltip');

    // Remove old listeners by replacing the overlay node
    var newOverlay = overlay.cloneNode(true);
    overlay.parentNode.replaceChild(newOverlay, overlay);
    var newOctx = newOverlay.getContext('2d');
    var st = _corrChartState;
    if (!st) return;
    newOctx.setTransform(st.dpr, 0, 0, st.dpr, 0, 0);

    // Drag-zoom state
    var dragStart = null; // mouseX where drag started

    newOverlay.addEventListener('mousedown', function(e) {
        if (!_corrChartState) return;
        var st = _corrChartState;
        var rect = newOverlay.getBoundingClientRect();
        var mouseX = e.clientX - rect.left;
        if (mouseX >= st.pad.left && mouseX <= st.pad.left + st.plotW) {
            dragStart = mouseX;
        }
    });

    newOverlay.addEventListener('mouseup', function(e) {
        if (!_corrChartState || dragStart === null) return;
        var st = _corrChartState;
        var rect = newOverlay.getBoundingClientRect();
        var mouseX = e.clientX - rect.left;
        var minDrag = 20; // minimum drag distance in px
        if (Math.abs(mouseX - dragStart) > minDrag) {
            var x1 = Math.max(st.pad.left, Math.min(dragStart, mouseX));
            var x2 = Math.min(st.pad.left + st.plotW, Math.max(dragStart, mouseX));
            var t1 = st.tMin + (x1 - st.pad.left) / st.plotW * (st.tMax - st.tMin);
            var t2 = st.tMin + (x2 - st.pad.left) / st.plotW * (st.tMax - st.tMin);
            _corrZoom = { tMin: t1, tMax: t2 };
            dragStart = null;
            renderCorrelationChart(st.data);
            return;
        }
        dragStart = null;
    });

    newOverlay.addEventListener('mousemove', function(e) {
        if (!_corrChartState) return;
        var st = _corrChartState;
        var rect = newOverlay.getBoundingClientRect();
        var mouseX = e.clientX - rect.left;
        var mouseY = e.clientY - rect.top;

        // Draw drag selection overlay
        if (dragStart !== null) {
            newOctx.clearRect(0, 0, st.W, st.H);
            var x1 = Math.max(st.pad.left, Math.min(dragStart, mouseX));
            var x2 = Math.min(st.pad.left + st.plotW, Math.max(dragStart, mouseX));
            newOctx.fillStyle = 'rgba(168,85,247,0.15)';
            newOctx.fillRect(x1, st.pad.top, x2 - x1, st.plotH);
            newOctx.strokeStyle = 'rgba(168,85,247,0.5)';
            newOctx.lineWidth = 1;
            newOctx.strokeRect(x1, st.pad.top, x2 - x1, st.plotH);
            tooltip.style.display = 'none';
            return;
        }

        // Only interact within plot area
        if (mouseX < st.pad.left || mouseX > st.pad.left + st.plotW || mouseY < st.pad.top || mouseY > st.pad.top + st.plotH) {
            newOctx.clearRect(0, 0, st.W, st.H);
            tooltip.style.display = 'none';
            return;
        }

        // Convert mouseX to timestamp
        var tHover = st.tMin + (mouseX - st.pad.left) / st.plotW * (st.tMax - st.tMin);

        // Find nearest modem point
        var nearestModem = null;
        if (st.modem.length > 0 && _corrVisible.snr) {
            var bestDist = Infinity;
            for (var i = 0; i < st.modem.length; i++) {
                var ts = new Date(st.modem[i].timestamp).getTime();
                var dist = Math.abs(ts - tHover);
                if (dist < bestDist) { bestDist = dist; nearestModem = st.modem[i]; }
            }
        }

        // Find nearest speedtest point
        var nearestSpeed = null;
        if (st.speedtest.length > 0 && (_corrVisible.download || _corrVisible.upload)) {
            var bestDist = Infinity;
            for (var i = 0; i < st.speedtest.length; i++) {
                var ts = new Date(st.speedtest[i].timestamp).getTime();
                var dist = Math.abs(ts - tHover);
                if (dist < bestDist) { bestDist = dist; nearestSpeed = st.speedtest[i]; }
            }
        }

        // Find nearest event
        var nearestEvent = null;
        if (st.events.length > 0 && _corrVisible.events) {
            var bestDist = Infinity;
            for (var i = 0; i < st.events.length; i++) {
                var ts = new Date(st.events[i].timestamp).getTime();
                var dist = Math.abs(ts - tHover);
                if (dist < bestDist) { bestDist = dist; nearestEvent = st.events[i]; }
            }
        }

        // Draw crosshair on overlay
        newOctx.clearRect(0, 0, st.W, st.H);
        newOctx.strokeStyle = 'rgba(255,255,255,0.25)';
        newOctx.lineWidth = 1;
        newOctx.setLineDash([4, 4]);
        newOctx.beginPath();
        newOctx.moveTo(mouseX, st.pad.top);
        newOctx.lineTo(mouseX, st.pad.top + st.plotH);
        newOctx.stroke();
        newOctx.setLineDash([]);

        // Draw highlight dots at nearest data points
        if (nearestModem && _corrVisible.snr) {
            var dx = st.xScale(new Date(nearestModem.timestamp).getTime());
            var dy = st.ySnr(nearestModem.ds_snr_min || st.snrMin);
            newOctx.beginPath();
            newOctx.arc(dx, dy, 5, 0, Math.PI * 2);
            newOctx.fillStyle = st.colors.snr;
            newOctx.fill();
            newOctx.strokeStyle = '#fff';
            newOctx.lineWidth = 2;
            newOctx.stroke();
        }
        if (nearestModem && _corrVisible.txPower && nearestModem.us_power_avg) {
            var dx = st.xScale(new Date(nearestModem.timestamp).getTime());
            var dy = st.yTx(nearestModem.us_power_avg);
            newOctx.beginPath();
            newOctx.arc(dx, dy, 5, 0, Math.PI * 2);
            newOctx.fillStyle = st.colors.txPower;
            newOctx.fill();
            newOctx.strokeStyle = '#fff';
            newOctx.lineWidth = 2;
            newOctx.stroke();
        }
        if (nearestModem && _corrVisible.dsPower && nearestModem.ds_power_avg != null) {
            var dx = st.xScale(new Date(nearestModem.timestamp).getTime());
            var dy = st.yDsPower(nearestModem.ds_power_avg);
            newOctx.beginPath();
            newOctx.arc(dx, dy, 5, 0, Math.PI * 2);
            newOctx.fillStyle = st.colors.dsPower;
            newOctx.fill();
            newOctx.strokeStyle = '#fff';
            newOctx.lineWidth = 2;
            newOctx.stroke();
        }
        if (nearestSpeed) {
            if (_corrVisible.download) {
                var dx = st.xScale(new Date(nearestSpeed.timestamp).getTime());
                var dy = st.yDl(nearestSpeed.download_mbps || 0);
                newOctx.beginPath();
                newOctx.arc(dx, dy, 5, 0, Math.PI * 2);
                newOctx.fillStyle = st.colors.download;
                newOctx.fill();
                newOctx.strokeStyle = '#fff';
                newOctx.lineWidth = 2;
                newOctx.stroke();
            }
            if (_corrVisible.upload) {
                var dx = st.xScale(new Date(nearestSpeed.timestamp).getTime());
                var dy = st.yDl(nearestSpeed.upload_mbps || 0);
                newOctx.beginPath();
                newOctx.arc(dx, dy, 5, 0, Math.PI * 2);
                newOctx.fillStyle = st.colors.upload;
                newOctx.fill();
                newOctx.strokeStyle = '#fff';
                newOctx.lineWidth = 2;
                newOctx.stroke();
            }
        }

        // Build tooltip content
        var html = '';
        // Use the closest data point's timestamp as the display time
        var displayTs = tHover;
        if (nearestModem) displayTs = new Date(nearestModem.timestamp).getTime();
        if (nearestSpeed) {
            var spTs = new Date(nearestSpeed.timestamp).getTime();
            if (!nearestModem || Math.abs(spTs - tHover) < Math.abs(new Date(nearestModem.timestamp).getTime() - tHover)) {
                displayTs = spTs;
            }
        }
        var dDate = new Date(displayTs);
        var timeStr = String(dDate.getHours()).padStart(2, '0') + ':' + String(dDate.getMinutes()).padStart(2, '0') + ':' + String(dDate.getSeconds()).padStart(2, '0');
        var dateStr = dDate.getFullYear() + '-' + String(dDate.getMonth() + 1).padStart(2, '0') + '-' + String(dDate.getDate()).padStart(2, '0');
        html += '<div class="tt-time">' + dateStr + ' ' + timeStr + '</div>';

        if (nearestModem && _corrVisible.snr) {
            html += '<div class="tt-row"><span class="tt-dot" style="background:' + st.colors.snr + ';"></span> SNR: ' + (nearestModem.ds_snr_min || 0).toFixed(1) + ' dB</div>';
        }
        if (nearestModem && _corrVisible.txPower && nearestModem.us_power_avg) {
            html += '<div class="tt-row"><span class="tt-dot" style="background:' + st.colors.txPower + ';"></span> TX Power: ' + nearestModem.us_power_avg.toFixed(1) + ' dBmV</div>';
        }
        if (nearestModem && _corrVisible.dsPower && nearestModem.ds_power_avg != null) {
            html += '<div class="tt-row"><span class="tt-dot" style="background:' + st.colors.dsPower + ';"></span> DS Power: ' + nearestModem.ds_power_avg.toFixed(1) + ' dBmV</div>';
        }
        if (nearestModem && _corrVisible.errors && (nearestModem.ds_uncorrectable_errors || 0) > 0) {
            html += '<div class="tt-row"><span class="tt-dot" style="background:' + st.colors.errors + ';"></span> Errors: ' + nearestModem.ds_uncorrectable_errors.toLocaleString() + '</div>';
        }
        if (nearestSpeed && _corrVisible.download) {
            html += '<div class="tt-row"><span class="tt-dot" style="background:' + st.colors.download + ';"></span> Download: ' + (nearestSpeed.download_mbps || 0).toFixed(1) + ' Mbps</div>';
        }
        if (nearestSpeed && _corrVisible.upload) {
            html += '<div class="tt-row"><span class="tt-dot" style="background:' + st.colors.upload + ';"></span> Upload: ' + (nearestSpeed.upload_mbps || 0).toFixed(1) + ' Mbps</div>';
        }
        if (nearestEvent && _corrVisible.events) {
            html += '<div class="tt-row"><span class="tt-dot" style="background:' + st.colors.event + ';"></span> Event: ' + (nearestEvent.message || nearestEvent.severity || '') + '</div>';
        }

        tooltip.innerHTML = html;
        tooltip.style.display = 'block';

        // Position tooltip — flip to left side if near right edge
        var ttW = tooltip.offsetWidth;
        var ttH = tooltip.offsetHeight;
        var ttX = mouseX + 12;
        var ttY = mouseY - ttH / 2;
        if (ttX + ttW > st.W - 10) {
            ttX = mouseX - ttW - 12;
        }
        if (ttY < 0) ttY = 4;
        if (ttY + ttH > st.H) ttY = st.H - ttH - 4;
        tooltip.style.left = ttX + 'px';
        tooltip.style.top = ttY + 'px';

        // Highlight corresponding table rows
        _corrHighlightTableRows(nearestModem, nearestSpeed, nearestEvent);
    });

    newOverlay.addEventListener('mouseleave', function() {
        dragStart = null;
        if (!_corrChartState) return;
        var st = _corrChartState;
        newOctx.clearRect(0, 0, st.W, st.H);
        tooltip.style.display = 'none';
        _corrClearTableHighlight();
    });
}

// Highlight matching table rows when hovering on chart
function _corrHighlightTableRows(modemPt, speedPt, eventPt) {
    _corrClearTableHighlight();
    var tbody = document.getElementById('correlation-tbody');
    if (!tbody) return;
    var rows = tbody.querySelectorAll('tr[data-ts]');
    var timestamps = [];
    if (modemPt) timestamps.push(modemPt.timestamp);
    if (speedPt) timestamps.push(speedPt.timestamp);
    if (eventPt) timestamps.push(eventPt.timestamp);
    if (timestamps.length === 0) return;
    var wrap = document.getElementById('correlation-table-wrap');
    var firstMatch = null;
    for (var i = 0; i < rows.length; i++) {
        var rowTs = rows[i].getAttribute('data-ts');
        if (timestamps.indexOf(rowTs) !== -1) {
            rows[i].classList.add('corr-highlight');
            if (!firstMatch) firstMatch = rows[i];
        }
    }
    // Scroll first highlighted row into view within the table wrapper
    if (firstMatch && wrap) {
        var wrapRect = wrap.getBoundingClientRect();
        var rowRect = firstMatch.getBoundingClientRect();
        var thead = wrap.querySelector('thead');
        var theadH = thead ? thead.offsetHeight : 0;
        // Check if row is outside visible area of the wrapper
        if (rowRect.top < wrapRect.top + theadH || rowRect.bottom > wrapRect.bottom) {
            var scrollTarget = rowRect.top - wrapRect.top + wrap.scrollTop - theadH - 8;
            wrap.scrollTo({ top: scrollTarget, behavior: 'smooth' });
        }
    }
}

function _corrClearTableHighlight() {
    var highlighted = document.querySelectorAll('#correlation-tbody tr.corr-highlight');
    for (var i = 0; i < highlighted.length; i++) {
        highlighted[i].classList.remove('corr-highlight');
    }
}

// Draw highlight on chart overlay when hovering a table row
function _corrHighlightFromTable(timestamp, source) {
    var overlay = document.getElementById('correlation-overlay');
    if (!overlay || !_corrChartState) return;
    var octx = overlay.getContext('2d');
    var st = _corrChartState;
    octx.setTransform(st.dpr, 0, 0, st.dpr, 0, 0);
    octx.clearRect(0, 0, st.W, st.H);

    var ts = new Date(timestamp).getTime();
    var x = st.xScale(ts);

    // Draw crosshair
    octx.strokeStyle = 'rgba(255,255,255,0.3)';
    octx.lineWidth = 1;
    octx.setLineDash([4, 4]);
    octx.beginPath();
    octx.moveTo(x, st.pad.top);
    octx.lineTo(x, st.pad.top + st.plotH);
    octx.stroke();
    octx.setLineDash([]);

    // Draw highlight dot based on source
    if (source === 'modem') {
        for (var i = 0; i < st.modem.length; i++) {
            if (st.modem[i].timestamp === timestamp) {
                if (_corrVisible.snr) {
                    var dy = st.ySnr(st.modem[i].ds_snr_min || st.snrMin);
                    octx.beginPath();
                    octx.arc(x, dy, 6, 0, Math.PI * 2);
                    octx.fillStyle = st.colors.snr;
                    octx.fill();
                    octx.strokeStyle = '#fff';
                    octx.lineWidth = 2;
                    octx.stroke();
                }
                if (_corrVisible.txPower && st.modem[i].us_power_avg) {
                    var dy = st.yTx(st.modem[i].us_power_avg);
                    octx.beginPath();
                    octx.arc(x, dy, 6, 0, Math.PI * 2);
                    octx.fillStyle = st.colors.txPower;
                    octx.fill();
                    octx.strokeStyle = '#fff';
                    octx.lineWidth = 2;
                    octx.stroke();
                }
                break;
            }
        }
    } else if (source === 'speedtest') {
        for (var i = 0; i < st.speedtest.length; i++) {
            if (st.speedtest[i].timestamp === timestamp) {
                if (_corrVisible.download) {
                    var dy = st.yDl(st.speedtest[i].download_mbps || 0);
                    octx.beginPath();
                    octx.arc(x, dy, 6, 0, Math.PI * 2);
                    octx.fillStyle = st.colors.download;
                    octx.fill();
                    octx.strokeStyle = '#fff';
                    octx.lineWidth = 2;
                    octx.stroke();
                }
                if (_corrVisible.upload) {
                    var dy = st.yDl(st.speedtest[i].upload_mbps || 0);
                    octx.beginPath();
                    octx.arc(x, dy, 6, 0, Math.PI * 2);
                    octx.fillStyle = st.colors.upload;
                    octx.fill();
                    octx.strokeStyle = '#fff';
                    octx.lineWidth = 2;
                    octx.stroke();
                }
                break;
            }
        }
    } else if (source === 'event' && _corrVisible.events) {
        octx.strokeStyle = st.colors.event;
        octx.lineWidth = 2;
        octx.setLineDash([3, 3]);
        octx.beginPath();
        octx.moveTo(x, st.pad.top);
        octx.lineTo(x, st.pad.top + st.plotH);
        octx.stroke();
        octx.setLineDash([]);
    }
}

function _corrClearChartHighlight() {
    var overlay = document.getElementById('correlation-overlay');
    if (!overlay || !_corrChartState) return;
    var octx = overlay.getContext('2d');
    var st = _corrChartState;
    octx.setTransform(st.dpr, 0, 0, st.dpr, 0, 0);
    octx.clearRect(0, 0, st.W, st.H);
}

function _corrExportPNG() {
    var canvas = document.getElementById('correlation-chart');
    if (!canvas) return;
    var link = document.createElement('a');
    link.download = 'correlation-chart-' + new Date().toISOString().slice(0, 10) + '.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
}

function _corrExportCSV() {
    if (!_correlationData || _correlationData.length === 0) return;
    var headers = ['timestamp', 'source', 'health', 'ds_snr_min', 'ds_power_avg', 'us_power_avg', 'ds_uncorrectable_errors', 'download_mbps', 'upload_mbps', 'ping_ms', 'severity', 'message'];
    var rows = [headers.join(',')];
    for (var i = 0; i < _correlationData.length; i++) {
        var d = _correlationData[i];
        var row = headers.map(function(h) {
            var v = d[h];
            if (v == null) return '';
            if (typeof v === 'string' && (v.indexOf(',') !== -1 || v.indexOf('"') !== -1)) {
                return '"' + v.replace(/"/g, '""') + '"';
            }
            return v;
        });
        rows.push(row.join(','));
    }
    var blob = new Blob([rows.join('\n')], { type: 'text/csv' });
    var link = document.createElement('a');
    link.download = 'correlation-data-' + new Date().toISOString().slice(0, 10) + '.csv';
    link.href = URL.createObjectURL(blob);
    link.click();
    URL.revokeObjectURL(link.href);
}

function renderCorrelationTable(data) {
    var tbody = document.getElementById('correlation-tbody');
    tbody.innerHTML = '';

    // Show newest first in table
    var sorted = data.slice().reverse();

    var healthLabels = {
        good: {{ t.health_good | tojson }},
        marginal: {{ t.health_marginal | tojson }},
        poor: {{ t.health_poor | tojson }},
        critical: {{ t.health_critical | tojson }}
    };
    var sevLabels = {
        info: {{ t.event_severity_info | tojson }},
        warning: {{ t.event_severity_warning | tojson }},
        critical: {{ t.event_severity_critical | tojson }}
    };
    var typeLabels = {
        health_change: {{ t.event_type_health_change | tojson }},
        power_change: {{ t.event_type_power_change | tojson }},
        snr_change: {{ t.event_type_snr_change | tojson }},
        channel_change: {{ t.event_type_channel_change | tojson }},
        modulation_change: {{ t.event_type_modulation_change | tojson }},
        error_spike: {{ t.event_type_error_spike | tojson }}
    };

    // Pre-filter modem entries: only show health transitions (not repeated same-status)
    // Data is chronological, sorted is reversed (newest first)
    var chronological = data.slice().sort(function(a, b) {
        return new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime();
    });
    var modemTransitionTs = {};
    var lastModemHealth = null;
    for (var i = 0; i < chronological.length; i++) {
        if (chronological[i].source !== 'modem') continue;
        var h = chronological[i].health || 'unknown';
        if (h !== lastModemHealth) {
            modemTransitionTs[chronological[i].timestamp] = true;
            lastModemHealth = h;
        }
    }

    var sorted = data.slice().reverse();
    var maxRows = 200;
    var count = 0;
    for (var i = 0; i < sorted.length && count < maxRows; i++) {
        var e = sorted[i];

        // Skip modem entries that are not health transitions
        if (e.source === 'modem' && !modemTransitionTs[e.timestamp]) continue;

        var tr = document.createElement('tr');
        tr.setAttribute('data-ts', e.timestamp);
        tr.setAttribute('data-src', e.source);
        var ts = escapeHtml(e.timestamp.replace('T', ' '));
        var src = e.source;
        var msg = '';
        var details = '';

        if (src === 'modem') {
            var h = e.health || 'unknown';
            var badge = '<span class="st-health-badge health-' + h + '">' + (healthLabels[h] || h) + '</span>';
            src = '<span style="color:var(--accent);">Modem</span>';
            msg = badge;
            details = 'SNR ' + (e.ds_snr_min != null ? e.ds_snr_min + ' dB' : '') +
                      ' | Power ' + (e.ds_power_avg != null ? e.ds_power_avg + ' dBmV' : '') +
                      ' | TX ' + (e.us_power_avg != null ? e.us_power_avg + ' dBmV' : '') +
                      ' | Errors ' + (e.ds_uncorrectable_errors || 0);
        } else if (src === 'speedtest') {
            src = '<span style="color:var(--good);">Speedtest</span>';
            msg = (e.download_mbps ? e.download_mbps.toFixed(1) + ' / ' + (e.upload_mbps || 0).toFixed(1) + ' Mbps' : '');
            var mhBadge = '';
            if (e.modem_health) {
                mhBadge = ' <span class="st-health-badge health-' + e.modem_health + '" style="font-size:0.75em;">'
                    + (healthLabels[e.modem_health] || e.modem_health) + '</span>';
            }
            details = 'Ping ' + (e.ping_ms || '') + ' ms | Jitter ' + (e.jitter_ms || '') + ' ms' + mhBadge;
        } else if (src === 'event') {
            var sevColor = e.severity === 'critical' ? 'var(--crit)' : e.severity === 'warning' ? 'var(--warn)' : 'var(--muted)';
            src = '<span style="color:' + sevColor + ';">' + (sevLabels[e.severity] || e.severity) + '</span>';
            msg = escapeHtml(e.message || '');
            details = typeLabels[e.event_type] || e.event_type || '';
        }

        tr.innerHTML = '<td style="white-space:nowrap; font-size:0.82em;">' + ts + '</td>'
            + '<td>' + src + '</td>'
            + '<td>' + msg + '</td>'
            + '<td style="font-size:0.82em; color:var(--muted);">' + details + '</td>';
        tr.addEventListener('mouseenter', function() {
            var rowTs = this.getAttribute('data-ts');
            var rowSrc = this.getAttribute('data-src');
            _corrHighlightFromTable(rowTs, rowSrc);
        });
        tr.addEventListener('mouseleave', function() {
            _corrClearChartHighlight();
        });
        tbody.appendChild(tr);
        count++;
    }
}

</script>

<script>
  // Initialize Lucide icons after DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();
  });
</script>
</body>
</html>
