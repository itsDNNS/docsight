<!DOCTYPE html>
<html lang="{{ lang }}" data-theme="{{ theme|default('dark') }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DOCSight</title>
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg">
    <link rel="icon" type="image/png" href="/static/icon.png">
    <link rel="apple-touch-icon" href="/static/icon.png">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#a855f7">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/main.css">
    <!-- Icon Library (Lucide) -->
    <script src="https://unpkg.com/lucide@0.575.0/dist/umd/lucide.min.js"
            integrity="sha384-GzE8qT1LzDfRNjtvLN/dXDLPlJOB3BBom3Twb9/RwHkXCgNl6OU1pBxM9397HWGU"
            crossorigin="anonymous"></script>
</head>
<body>
<div class="app-layout">

<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <img src="/static/logo.svg" alt="DOCSight" style="width:36px;height:36px;vertical-align:middle;margin-right:8px;">
        <span>DOCSight</span>
        <button class="sidebar-toggle" id="sidebar-collapse" title="Collapse"></button>
    </div>
    <div class="sidebar-content">
        <div class="sidebar-section-label">{{ t.sidebar_monitoring }}</div>
        <a class="sidebar-link active" data-view="live" data-tooltip="{{ t.live_dashboard }}">
            <span class="icon"><i data-lucide="radio"></i></span> {{ t.live_dashboard }}
        </a>
        <a class="sidebar-link" data-view="events" data-tooltip="{{ t.event_log }}">
            <span class="icon"><i data-lucide="bell"></i></span> {{ t.event_log }}
            <span class="event-badge" id="event-badge" style="display:none;"></span>
        </a>
        <a class="sidebar-link" data-view="trends" data-tooltip="{{ t.signal_trends }}">
            <span class="icon"><i data-lucide="trending-up"></i></span> {{ t.signal_trends }}
        </a>
        <a class="sidebar-link" data-view="channels" data-tooltip="{{ t.channels }}">
            <span class="icon"><i data-lucide="clock"></i></span> {{ t.channels }}
        </a>
        {% if speedtest_configured or bqm_configured %}
        <a class="sidebar-link" data-view="correlation" data-tooltip="{{ t.correlation_analysis }}">
            <span class="icon"><i data-lucide="bar-chart-3"></i></span> {{ t.correlation_analysis }}
        </a>
        {% endif %}
        {% if gaming_quality_enabled %}
        <a class="sidebar-link" data-view="gaming" data-tooltip="{{ t.gaming_quality_label }}">
            <span class="icon"><i data-lucide="gamepad-2"></i></span> {{ t.gaming_quality_label }}
        </a>
        {% endif %}
        <div class="sidebar-section-label">{{ t.sidebar_external }}</div>
        {% if speedtest_configured %}
        <a class="sidebar-link" data-view="speedtest" data-tooltip="{{ t.speedtest }}">
            <span class="icon"><i data-lucide="rabbit"></i></span> {{ t.speedtest }}
        </a>
        {% endif %}
        {% if not speedtest_configured %}
        <a class="sidebar-link" onclick="openSpeedtestSetupModal()" data-tooltip="{{ t.speedtest_setup }}">
            <span class="icon"><i data-lucide="settings"></i></span> {{ t.speedtest_setup }}
        </a>
        {% endif %}
        {% if bqm_configured %}
        <a class="sidebar-link" data-view="bqm" data-tooltip="{{ t.bqm_title }}">
            <span class="icon"><i data-lucide="activity"></i></span> {{ t.bqm_title }}
        </a>
        {% endif %}
        {% if not bqm_configured %}
        <a class="sidebar-link" onclick="openBqmSetupModal()" data-tooltip="{{ t.bqm_setup }}">
            <span class="icon"><i data-lucide="settings"></i></span> {{ t.bqm_setup }}
        </a>
        {% endif %}
        {% if smokeping_configured %}
        <a class="sidebar-link" data-view="smokeping" data-tooltip="{{ t.smokeping_title }}">
            <span class="icon"><i data-lucide="radar"></i></span> {{ t.smokeping_title }}
        </a>
        {% endif %}
        {% if not smokeping_configured %}
        <a class="sidebar-link" onclick="openSmokepingSetupModal()" data-tooltip="{{ t.smokeping_setup }}">
            <span class="icon"><i data-lucide="settings"></i></span> {{ t.smokeping_setup }}
        </a>
        {% endif %}
        {% if bnetz_enabled %}
        <a class="sidebar-link" data-view="bnetz" data-tooltip="{{ t.bnetz_title }}">
            <span class="icon"><i data-lucide="file-check"></i></span> {{ t.bnetz_title }}
        </a>
        {% endif %}
        <div class="sidebar-section-label">{{ t.sidebar_documentation }}</div>
        <a class="sidebar-link" data-view="journal" data-tooltip="{{ t.incident_journal }}">
            <span class="icon"><i data-lucide="clipboard-list"></i></span> {{ t.incident_journal }}
        </a>
        <a class="sidebar-link" id="export-link" href="javascript:void(0)" onclick="exportForLLM()" data-tooltip="{{ t.export_llm }}">
            <span class="icon"><i data-lucide="file-output"></i></span> {{ t.export_llm }}
        </a>
        <a class="sidebar-link" id="report-link" href="javascript:void(0)" onclick="openReportModal()" data-tooltip="{{ t.incident_report }}">
            <span class="icon"><i data-lucide="file-text"></i></span> {{ t.incident_report }}
        </a>
        <div style="flex:1;"></div>
        <div class="sidebar-divider"></div>
        <a class="sidebar-link" href="/settings" data-tooltip="{{ t.settings }}">
            <span class="icon"><i data-lucide="settings"></i></span> {{ t.settings }}
        </a>
        {% if auth_enabled %}
        <a class="sidebar-link" href="/logout">
            <span class="icon"><i data-lucide="log-out"></i></span> {{ t.logout }}
        </a>
        {% endif %}
        <div class="sidebar-footer">
            <div class="dark-mode-toggle">
                <span class="dark-mode-label"><i data-lucide="moon"></i> {{ t.dark_mode or 'Dark mode' }}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="theme-toggle-sidebar">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="sidebar-version-row">
                <a href="https://github.com/itsDNNS/docsight/releases" target="_blank" class="version-link">
                    {{ version }}
                    {% if update_available %}
                    <span class="update-badge" title="{{ update_available }}">Update</span>
                    {% endif %}
                </a>
                <div class="sidebar-links-row">
                    <a href="https://github.com/itsDNNS/docsight/issues" target="_blank" rel="noopener noreferrer" class="sponsor-link" title="Report a bug">
                        <i data-lucide="bug" style="width:14px;height:14px;"></i>
                    </a>
                    <a href="https://paypal.me/itsDNNS" target="_blank" rel="noopener noreferrer" class="sponsor-link" title="Donate via PayPal">
                        <i data-lucide="wallet" style="width:14px;height:14px;"></i>
                    </a>
                    <a href="https://ko-fi.com/itsdnns" target="_blank" rel="noopener noreferrer" class="sponsor-link" title="Support on Ko-fi">
                        <i data-lucide="coffee" style="width:14px;height:14px;"></i>
                    </a>
                    <a href="https://github.com/sponsors/itsDNNS" target="_blank" rel="noopener noreferrer" class="sponsor-link" title="Support on GitHub Sponsors">
                        <i data-lucide="heart" style="width:14px;height:14px;"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</nav>
<div class="sidebar-backdrop" id="sidebar-backdrop"></div>

<!-- Main Area -->
<div class="app-main">

<!-- Topbar -->
<div class="topbar">
    <div class="topbar-left">
        <button class="hamburger-btn" id="hamburger" title="Menu">&#9776;</button>
    </div>
    <div class="topbar-right">
        <span class="topbar-meta" id="topbar-meta">
            {% if last_update %}{{ t.last_update }}: {{ last_update }}{% endif %}
        </span>
        <span class="topbar-countdown" id="topbar-countdown"></span>
        <button class="refresh-btn" id="refresh-btn" title="{{ t.refresh }}">&#x1F504;</button>
    </div>
</div>


<!-- ═══ View: Dashboard ═══ -->
<div class="main-content">
<div id="view-dashboard" class="view active">


{% if error %}
<div class="error-box">{{ t.error_label }}: {{ error }}</div>
{% endif %}

{% if analysis %}
    {% set s = analysis.summary %}
    {% set ds = analysis.ds_channels %}
    {% set us = analysis.us_channels %}

    {% set health_map = {"good": t.health_good, "marginal": t.health_marginal, "poor": t.health_poor} %}
    {% set health_label = health_map.get(s.health, s.health) %}
    {% set health_msgs = {"good": t.health_good_msg, "marginal": t.health_marginal_msg, "poor": t.health_poor_msg} %}
    {% set issue_labels = {
        "ds_power_critical": t.issue_ds_power_critical,
        "us_power_critical_low": t.issue_us_power_critical_low,
        "us_power_critical_high": t.issue_us_power_critical_high,
        "us_power_warn_low": t.issue_us_power_warn_low,
        "us_power_warn_high": t.issue_us_power_warn_high,
        "us_modulation_warn": t.issue_us_modulation_warn,
        "us_modulation_critical": t.issue_us_modulation_critical,
        "snr_critical": t.issue_snr_critical,
        "snr_warn": t.issue_snr_warn,
        "uncorr_errors_high": t.issue_uncorr_errors_high,
    } %}
    {% set issue_descs = {
        "ds_power_critical": t.issue_ds_power_critical_desc,
        "us_power_critical_low": t.issue_us_power_critical_low_desc,
        "us_power_critical_high": t.issue_us_power_critical_high_desc,
        "us_power_warn_low": t.issue_us_power_warn_low_desc,
        "us_power_warn_high": t.issue_us_power_warn_high_desc,
        "us_modulation_warn": t.issue_us_modulation_warn_desc,
        "us_modulation_critical": t.issue_us_modulation_critical_desc,
        "snr_critical": t.issue_snr_critical_desc,
        "snr_warn": t.issue_snr_warn_desc,
        "uncorr_errors_high": t.issue_uncorr_errors_high_desc,
    } %}

    {# ══════════════════════════════════════════════════════════════════════════
       HERO CARD - Phase 3 Task 3.1
       Health status + inline trend chart (SNR/Power, 24h)
       ══════════════════════════════════════════════════════════════════════════ #}
    <div class="hero-card health-{{ 'good' if s.health == 'good' else ('crit' if s.health == 'poor' else 'warn') }}">
        <div class="hero-header">
            <div class="hero-status">
                <i data-lucide="activity" class="hero-icon"></i>
                <div class="hero-status-text">
                    <h1 class="hero-title">{{ health_label }}{% if demo_mode %}<span class="demo-badge">{{ t.demo_mode|default('DEMO') }}</span>{% endif %}</h1>
                    <p class="hero-subtitle">{{ health_msgs.get(s.health, '') }}</p>
                </div>
            </div>
            <div class="hero-meta">
                {# 1. Provider #}
                {% if isp_name %}
                <span class="hero-isp">
                    {% set isp_lower = isp_name.lower() %}
                    {% if 'vodafone' in isp_lower %}
                    <img src="/static/img/providers/vodafone.svg" alt="{{ isp_name }}" style="width:14px;height:14px;margin-right:4px;">
                    {% elif 'telekom' in isp_lower %}
                    <img src="/static/img/providers/telekom.svg" alt="{{ isp_name }}" style="width:14px;height:14px;margin-right:4px;">
                    {% elif 'o2' in isp_lower %}
                    <img src="/static/img/providers/o2.svg" alt="{{ isp_name }}" style="width:14px;height:14px;margin-right:4px;">
                    {% else %}
                    <img src="/static/img/providers/generic.svg" alt="{{ isp_name }}" style="width:14px;height:14px;margin-right:4px;opacity:0.7;">
                    {% endif %}
                    {{ isp_name }}
                </span>
                {% endif %}
                
                {# 2. Speed #}
                {% if connection_info and connection_info.max_downstream_kbps %}
                <span class="hero-speed">
                    {{ connection_info.max_downstream_kbps // 1000 }}/{{ connection_info.max_upstream_kbps // 1000 }} MBit/s
                    <span class="info-icon" data-tooltip="Auto-detected from modem" style="margin-left:3px;">
                        <i data-lucide="info" style="width:12px;height:12px;opacity:0.5;"></i>
                    </span>
                </span>
                {% elif booked_download and booked_download > 0 %}
                <span class="hero-speed">
                    {{ booked_download|int }}/{{ booked_upload|int }} MBit/s
                    <span class="info-icon" data-tooltip="Configured in Settings" style="margin-left:3px;">
                        <i data-lucide="settings" style="width:12px;height:12px;opacity:0.5;"></i>
                    </span>
                </span>
                {% else %}
                <a href="/settings" style="color:var(--text-secondary);text-decoration:none;font-size:12px;opacity:0.7;transition:opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
                    <i data-lucide="settings" style="width:11px;height:11px;margin-right:4px;"></i>
                    <span>Set speed in Settings</span>
                </a>
                {% endif %}
                
                {# 3. Channels #}
                <span class="hero-channels">
                    {{ s.ds_total }} DS / {{ s.us_total }} US {{ t.channel if (s.ds_total + s.us_total) == 1 else t.channels }}
                    <span class="info-icon" data-tooltip="Auto-detected from modem" style="margin-left:3px;">
                        <i data-lucide="info" style="width:12px;height:12px;opacity:0.5;"></i>
                    </span>
                </span>

                {# 4. Gaming Quality Index #}
                {% if gaming_quality_enabled and gaming_index %}
                <span class="hero-gaming gaming-{{ gaming_index.grade|lower }}"
                      data-tooltip="{{ gaming_index.score }}/100 — {{ t['gaming_tooltip_' ~ gaming_index.grade|lower] }}{% if not gaming_index.has_speedtest %} ({{ t.gaming_no_speedtest }}){% endif %}">
                    <i data-lucide="gamepad-2" style="width:14px;height:14px;"></i>
                    <span class="gaming-grade">{{ gaming_index.grade }}</span>
                    <span class="gaming-label">Gaming</span>
                </span>
                {% endif %}
            </div>
        </div>
        
        {% if s.health_issues %}
        <div class="hero-issues">
            {% for issue in s.health_issues %}
            <span class="issue-badge" title="{{ issue_descs.get(issue, '') }}">{{ issue_labels.get(issue, issue) }}</span>
            {% endfor %}
        </div>
        {% endif %}
        
        <div class="hero-chart-container">
            <canvas id="hero-trend-chart"></canvas>
        </div>
    </div>

    {# ── OLD Health Banner (DEPRECATED, replaced by Hero Card) ── #}
    {# <div class="health-banner health-{{ 'good' if s.health == 'good' else ('crit' if s.health == 'poor' else 'warn') }}">
        <div class="health-status">
            <span class="health-icon">{% if s.health == 'good' %}&#10004;{% elif s.health == 'poor' %}&#10006;{% else %}&#9888;{% endif %}</span>
            <span class="health-title">{{ health_label }}</span>
        </div>
        <div class="health-msg">{{ health_msgs.get(s.health, '') }}</div>
        {% if s.health_issues %}
        <div class="health-issues">
            {% for issue in s.health_issues %}
            <div class="health-issue">
                <span class="health-issue-name">{{ issue_labels.get(issue, issue) }}<span class="info-tip"><i class="tip-icon" tabindex="0">&#9432;</i><span class="tip-text">{{ issue_descs.get(issue, '') }}</span></span></span>
                <span class="health-issue-desc">{{ issue_descs.get(issue, '') }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div> #}

    {# ── OLD Connection Info Bar (DEPRECATED, moved into Hero Card meta) ── #}
    {# {% if isp_name or (connection_info and connection_info.max_downstream_kbps) %}
    <div class="conn-info-bar">
        {% if isp_name %}{{ isp_name }}{% endif %}
        {% if connection_info and connection_info.max_downstream_kbps %}
            {% if isp_name %}<span class="conn-sep">&middot;</span>{% endif %}
            {{ connection_info.max_downstream_kbps // 1000 }}/{{ connection_info.max_upstream_kbps // 1000 }} Mbit/s
        {% endif %}
        <span class="conn-sep">|</span>
        {{ s.ds_total }} DS <span class="conn-sep">/</span> {{ s.us_total }} US {{ t.channels|lower }}
    </div>
    {% endif %} #}

    {# ── Per-card health ── #}
    {% set signal_health = 'crit' if 'ds_power_critical' in s.health_issues or 'snr_critical' in s.health_issues
       else ('warn' if 'ds_power_warn' in s.health_issues or 'snr_warn' in s.health_issues else 'good') %}
    {% set us_health = 'crit' if 'us_power_critical_low' in s.health_issues or 'us_power_critical_high' in s.health_issues
       else ('warn' if 'us_power_warn_low' in s.health_issues or 'us_power_warn_high' in s.health_issues else 'good') %}
    {% set error_health = 'crit' if 'uncorr_errors_high' in s.health_issues else 'good' %}

    {# ── DS Power health ── #}
    {% set ds_pwr_health = 'crit' if 'ds_power_critical' in s.health_issues else ('warn' if 'ds_power_warn' in s.health_issues else 'good') %}
    {# ── SNR health ── #}
    {% set snr_health = 'crit' if 'snr_critical' in s.health_issues else ('warn' if 'snr_warn' in s.health_issues else 'good') %}

    {# ── Speedtest health (for new Metric Summary Row) ── #}
    {% if speedtest_configured and speedtest_latest %}
        {% set eff_booked_dl = booked_download if (booked_download and booked_download > 0) else ((connection_info.max_downstream_kbps // 1000) if connection_info and connection_info.max_downstream_kbps else 0) %}
        {% set eff_booked_ul = booked_upload if (booked_upload and booked_upload > 0) else ((connection_info.max_upstream_kbps // 1000) if connection_info and connection_info.max_upstream_kbps else 0) %}
        {% if eff_booked_dl > 0 %}
            {% set dl_ratio = speedtest_latest.download_mbps / eff_booked_dl %}
            {% if dl_ratio >= 0.8 %}
                {% set speed_health = 'health-good' %}
                {% set dl_val_class = 'val-good' %}
            {% elif dl_ratio >= 0.5 %}
                {% set speed_health = 'health-warn' %}
                {% set dl_val_class = 'val-warn' %}
            {% else %}
                {% set speed_health = 'health-crit' %}
                {% set dl_val_class = 'val-bad' %}
            {% endif %}
        {% else %}
            {% set speed_health = 'health-good' %}
            {% set dl_val_class = 'val-good' %}
        {% endif %}
        {% if eff_booked_ul > 0 %}
            {% set ul_ratio = speedtest_latest.upload_mbps / eff_booked_ul %}
            {% if ul_ratio >= 0.8 %}
                {% set ul_val_class = 'val-good' %}
            {% elif ul_ratio >= 0.5 %}
                {% set ul_val_class = 'val-warn' %}
            {% else %}
                {% set ul_val_class = 'val-bad' %}
            {% endif %}
        {% else %}
            {% set ul_val_class = 'val-good' %}
        {% endif %}
    {% endif %}

    {# ══════════════════════════════════════════════════════════════════════════
       METRIC SUMMARY ROW - Phase 3 Task 3.2
       Compact metric cards: DS, US, Errors, Speed (no expandable details)
       ══════════════════════════════════════════════════════════════════════════ #}
    <div class="metric-summary-row">
        {# Card 1: Downstream Signal #}
        <div class="metric-summary-card health-{{ signal_health }}">
            <div class="metric-summary-header">
                <i data-lucide="radio" class="metric-icon"></i>
                <span class="metric-label">{{ t.downstream }}</span>
            </div>
            <div class="metric-summary-values">
                <div class="metric-value-item">
                    <span class="value val-{{ ds_pwr_health }}">{{ s.ds_power_avg }}</span>
                    <span class="unit">dBmV</span>
                    <span class="sublabel">Ø {{ t.card_ds_power }}</span>
                </div>
                <div class="metric-value-divider"></div>
                <div class="metric-value-item">
                    <span class="value val-{{ snr_health }}">{{ s.ds_snr_avg }}</span>
                    <span class="unit">dB</span>
                    <span class="sublabel">Ø {{ t.card_snr }}</span>
                </div>
            </div>
        </div>

        {# Card 2: Upstream Signal #}
        <div class="metric-summary-card health-{{ us_health }}">
            <div class="metric-summary-header">
                <i data-lucide="radio" class="metric-icon"></i>
                <span class="metric-label">{{ t.upstream }}</span>
            </div>
            <div class="metric-summary-values">
                <div class="metric-value-item">
                    <span class="value val-{{ us_health }}">{{ s.us_power_avg }}</span>
                    <span class="unit">dBmV</span>
                    <span class="sublabel">Ø {{ t.card_transmit_power }}</span>
                </div>
                {% if s.us_capacity_mbps is not none %}
                <div class="metric-value-divider"></div>
                <div class="metric-value-item">
                    <span class="value val-{{ us_health }}">{{ s.us_capacity_mbps }}</span>
                    <span class="unit">Mbit/s</span>
                    <span class="sublabel">{{ t.card_us_capacity or 'Capacity' }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        {# Card 3: Errors #}
        <div class="metric-summary-card health-{{ error_health }}">
            <div class="metric-summary-header">
                <i data-lucide="alert-triangle" class="metric-icon"></i>
                <span class="metric-label">{{ t.card_errors }}</span>
            </div>
            <div class="metric-summary-values">
                <div class="metric-value-item">
                    <span class="value val-{{ error_health }}">{{ s.ds_uncorrectable_errors|fmt_k }}</span>
                    <span class="unit">{{ t.card_uncorr_label }}</span>
                    <span class="sublabel">{{ s.ds_correctable_errors|fmt_k }} {{ t.card_corr_label }}</span>
                </div>
            </div>
        </div>

        {# Card 4: Speedtest (conditional) #}
        {% if speedtest_configured and speedtest_latest %}
        <div class="metric-summary-card {{ speed_health }}">
            <div class="metric-summary-header">
                <i data-lucide="zap" class="metric-icon"></i>
                <span class="metric-label">{{ t.speed }}</span>
            </div>
            <div class="metric-summary-values" style="display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;">
                <div class="metric-value-item">
                    <span class="value {{ dl_val_class }}">{{ speedtest_latest.download_mbps|fmt_speed_value }}</span>
                    <span class="unit">{{ speedtest_latest.download_mbps|fmt_speed_unit }}</span>
                    <span class="sublabel">{{ t.download }}</span>
                </div>
                <div class="metric-value-divider"></div>
                <div class="metric-value-item">
                    <span class="value {{ ul_val_class }}">{{ speedtest_latest.upload_mbps|fmt_speed_value }}</span>
                    <span class="unit">{{ speedtest_latest.upload_mbps|fmt_speed_unit }}</span>
                    <span class="sublabel">{{ t.upload }}</span>
                </div>
                <div class="metric-value-item secondary" style="grid-column:1;">
                    <span class="value">{{ speedtest_latest.ping_ms|round(0)|int }}</span>
                    <span class="unit">ms</span>
                    <span class="sublabel">Ping</span>
                </div>
                <div class="metric-value-divider"></div>
                <div class="metric-value-item secondary" style="grid-column:3;">
                    <span class="value">{{ speedtest_latest.jitter_ms|round(1) }}</span>
                    <span class="unit">ms</span>
                    <span class="sublabel">Jitter</span>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    {# ══════════════════════════════════════════════════════════════════════════
       BREITBANDMESSUNG (BNetzA) - Conditional card, only shown when data exists
       ══════════════════════════════════════════════════════════════════════════ #}
    {% if bnetz_enabled and bnetz_latest %}
    {% set bnetz_dl_pct = ((bnetz_latest.download_measured_avg / bnetz_latest.download_max_tariff * 100)|round(0)|int) if bnetz_latest.download_max_tariff else 0 %}
    {% set bnetz_ul_pct = ((bnetz_latest.upload_measured_avg / bnetz_latest.upload_max_tariff * 100)|round(0)|int) if bnetz_latest.upload_max_tariff else 0 %}
    {% set bnetz_has_deviation = bnetz_latest.verdict_download == 'deviation' or bnetz_latest.verdict_upload == 'deviation' %}
    <div class="metric-summary-row">
        <div class="metric-summary-card {{ 'health-crit' if bnetz_has_deviation else 'health-good' }}" style="flex:1;">
            <div class="metric-summary-header">
                <i data-lucide="file-check" class="metric-icon"></i>
                <span class="metric-label">{{ t.bnetz_title }}</span>
            </div>
            <div class="metric-summary-values" style="display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;">
                <div class="metric-value-item">
                    <span class="value">{{ bnetz_latest.download_measured_avg|round(0)|int }}</span>
                    <span class="unit">/ {{ bnetz_latest.download_max_tariff|round(0)|int }} Mbit/s ({{ bnetz_dl_pct }}%)</span>
                    <span class="sublabel">{{ t.download }}</span>
                </div>
                <div class="metric-value-divider"></div>
                <div class="metric-value-item">
                    <span class="value">{{ bnetz_latest.upload_measured_avg|round(0)|int }}</span>
                    <span class="unit">/ {{ bnetz_latest.upload_max_tariff|round(0)|int }} Mbit/s ({{ bnetz_ul_pct }}%)</span>
                    <span class="sublabel">{{ t.upload }}</span>
                </div>
                <div class="metric-value-item secondary" style="grid-column:1/-1;text-align:center;">
                    <span class="value" style="font-size:0.8em;color:{{ 'var(--crit)' if bnetz_has_deviation else 'var(--good)' }};">
                        {{ t.bnetz_verdict_deviation if bnetz_has_deviation else t.bnetz_verdict_ok }}
                    </span>
                    <span class="sublabel">{{ bnetz_latest.date }} &middot; {{ bnetz_latest.provider }}</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {# ══════════════════════════════════════════════════════════════════════════
       CHANNEL HEALTH OVERVIEW - Phase 3 Task 3.4
       Donut charts showing health distribution for DS/US channels
       ══════════════════════════════════════════════════════════════════════════ #}
    <div class="channel-health-card">
        <div class="channel-health-header">
            <i data-lucide="pie-chart" class="channel-health-icon"></i>
            <h3 class="channel-health-title">{{ t.get('channel_health_overview', 'Channel Health Overview') }}</h3>
        </div>
        
        <div class="channel-health-charts">
            <!-- Downstream Donut -->
            <div class="health-chart-container" 
                 data-good="{{ ds|selectattr('health', 'equalto', 'good')|list|length }}"
                 data-warn="{{ ds|rejectattr('health', 'equalto', 'good')|rejectattr('health', 'equalto', 'critical')|list|length }}"
                 data-crit="{{ ds|selectattr('health', 'equalto', 'critical')|list|length }}">
                <canvas id="ds-health-donut"></canvas>
                <div class="chart-label">{{ t.downstream }}</div>
            </div>
            
            <!-- Upstream Donut -->
            <div class="health-chart-container"
                 data-good="{{ us|selectattr('health', 'equalto', 'good')|list|length }}"
                 data-warn="{{ us|rejectattr('health', 'equalto', 'good')|rejectattr('health', 'equalto', 'critical')|list|length }}"
                 data-crit="{{ us|selectattr('health', 'equalto', 'critical')|list|length }}">
                <canvas id="us-health-donut"></canvas>
                <div class="chart-label">{{ t.upstream }}</div>
            </div>
        </div>
        
        <div class="channel-health-legend">
            <div class="legend-item">
                <span class="legend-dot legend-good"></span>
                <span class="legend-label">{{ t.health_good }}</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot legend-warn"></span>
                <span class="legend-label">{{ t.health_warning }}</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot legend-crit"></span>
                <span class="legend-label">{{ t.health_critical }}</span>
            </div>
        </div>
    </div>



    {# ══════════════════════════════════════════════════════════════════════════
       DOWNSTREAM CHANNELS - Phase 3 Task 3.5
       Modern card containers for channel tables
       ══════════════════════════════════════════════════════════════════════════ #}
    <div class="channel-section">
        <div class="channel-section-header">
            <i data-lucide="radio-tower" class="section-icon"></i>
            <h2 class="section-title">{{ t.downstream }}</h2>
            <span class="section-badge">{{ ds|length }} {{ t.channel if ds|length == 1 else t.channels }}</span>
        </div>

        {% for group in ds|groupby('docsis_version')|reverse %}
        {% set g_crit = group.list|selectattr('health', 'equalto', 'critical')|list|length %}
        {% set g_warn = group.list|rejectattr('health', 'equalto', 'good')|rejectattr('health', 'equalto', 'critical')|list|length %}
        <div class="channel-card">
            <details class="channel-group" open>
                <summary>
                    <div class="channel-group-summary">
                        <span class="channel-group-label">DOCSIS {{ group.grouper }}</span>
                        <span class="channel-group-count">({{ group.list|length }} {{ t.channel if group.list|length == 1 else t.channels }})</span>
                        <div class="channel-group-badges">
                            {% if g_crit %}<span class="badge badge-crit">{{ g_crit }} {{ t.health_critical|lower }}</span>{% endif %}
                            {% if g_warn %}<span class="badge badge-warn">{{ g_warn }} {{ t.health_warning|lower }}</span>{% endif %}
                            {% if not g_crit and not g_warn %}<span class="badge badge-good">&#10003;</span>{% endif %}
                        </div>
                    </div>
                </summary>
                <div class="channel-table-wrapper">
                    <table class="sortable">
            <thead><tr>
                <th>{{ t.status }}</th><th>{{ t.channel }}</th><th>{{ t.frequency }}</th><th>{{ t.power_dbmv }}</th>
                <th>{{ t.snr_db }}</th><th>{{ t.modulation }}</th><th>{{ t.corr }}</th><th>{{ t.uncorr }}</th>
            </tr></thead>
            <tbody>
            {% for ch in group.list %}
            <tr>
                {% set ch_tips = {"power critical": t.ch_power_critical, "power warning": t.ch_power_warning, "snr critical": t.ch_snr_critical, "snr warning": t.ch_snr_warning} %}
                {% set ch_tip_parts = [] %}
                {% for key, label in ch_tips.items() %}{% if key in ch.health_detail %}{% if ch_tip_parts.append(label) %}{% endif %}{% endif %}{% endfor %}
                <td data-sort="{{ 0 if ch.health == 'good' else (2 if ch.health == 'critical' else 1) }}">
                    {% if ch.health == "good" %}<span class="badge badge-good">{{ t.health_good }}</span>
                    {% elif ch.health == "critical" %}<span class="badge badge-crit" title="{{ ch_tip_parts|join(', ') }}">{{ t.health_critical }}</span>
                    {% else %}<span class="badge badge-warn" title="{{ ch_tip_parts|join(', ') }}">{{ t.health_warning }}</span>{% endif %}
                </td>
                <td data-sort="{{ ch.channel_id }}">{{ ch.channel_id }}</td>
                <td>{{ ch.frequency }}</td>
                <td data-sort="{{ ch.power if ch.power is not none else 0 }}" class="{% if ch.power is not none %}{% if 'power critical' in ch.health_detail %}val-crit{% elif 'power warning' in ch.health_detail %}val-warn{% else %}val-good{% endif %}{% endif %}">{{ ch.power if ch.power is not none else "—" }}</td>
                <td data-sort="{{ ch.snr if ch.snr is not none else 0 }}" class="{% if ch.snr is not none %}{% if 'snr critical' in ch.health_detail %}val-crit{% elif 'snr warning' in ch.health_detail %}val-warn{% else %}val-good{% endif %}{% endif %}">{{ ch.snr if ch.snr is not none else "-" }}</td>
                <td>{{ ch.modulation }}</td>
                <td data-sort="{{ ch.correctable_errors }}">{{ ch.correctable_errors|fmt_k }}</td>
                <td data-sort="{{ ch.uncorrectable_errors }}">{{ ch.uncorrectable_errors|fmt_k }}</td>
            </tr>
            {% endfor %}
            </tbody>
                    </table>
                </div>
            </details>
        </div>
        {% endfor %}
    </div>

    {# ══════════════════════════════════════════════════════════════════════════
       UPSTREAM CHANNELS - Phase 3 Task 3.5
       Modern card containers for channel tables
       ══════════════════════════════════════════════════════════════════════════ #}
    <div class="channel-section">
        <div class="channel-section-header">
            <i data-lucide="radio-tower" class="section-icon"></i>
            <h2 class="section-title">{{ t.upstream }}</h2>
            <span class="section-badge">{{ us|length }} {{ t.channel if us|length == 1 else t.channels }}</span>
        </div>

        {% for group in us|groupby('docsis_version')|reverse %}
        {% set g_crit = group.list|selectattr('health', 'equalto', 'critical')|list|length %}
        {% set g_warn = group.list|rejectattr('health', 'equalto', 'good')|rejectattr('health', 'equalto', 'critical')|list|length %}
        <div class="channel-card">
            <details class="channel-group" open>
                <summary>
                    <div class="channel-group-summary">
                        <span class="channel-group-label">DOCSIS {{ group.grouper }}</span>
                        <span class="channel-group-count">({{ group.list|length }} {{ t.channel if group.list|length == 1 else t.channels }})</span>
                        <div class="channel-group-badges">
                            {% if g_crit %}<span class="badge badge-crit">{{ g_crit }} {{ t.health_critical|lower }}</span>{% endif %}
                            {% if g_warn %}<span class="badge badge-warn">{{ g_warn }} {{ t.health_warning|lower }}</span>{% endif %}
                            {% if not g_crit and not g_warn %}<span class="badge badge-good">&#10003;</span>{% endif %}
                        </div>
                    </div>
                </summary>
                <div class="channel-table-wrapper">
                    <table class="sortable">
            <thead><tr>
                <th>{{ t.status }}</th><th>{{ t.channel }}</th><th>{{ t.frequency }}</th><th>{{ t.power_dbmv }}</th>
                <th>{{ t.modulation }}</th><th>{{ t.bitrate or 'Bitrate' }}</th><th>{{ t.multiplex }}</th>
            </tr></thead>
            <tbody>
            {% for ch in group.list %}
            {% set ch_tips = [] %}
            {% if 'power critical low' in ch.health_detail %}{% set _ = ch_tips.append(t.ch_power_critical_low) %}{% elif 'power critical high' in ch.health_detail %}{% set _ = ch_tips.append(t.ch_power_critical_high) %}{% elif 'power warning low' in ch.health_detail %}{% set _ = ch_tips.append(t.ch_power_warning_low) %}{% elif 'power warning high' in ch.health_detail %}{% set _ = ch_tips.append(t.ch_power_warning_high) %}{% endif %}
            {% if 'modulation critical' in ch.health_detail %}{% set _ = ch_tips.append(t.ch_modulation_critical) %}{% elif 'modulation warning' in ch.health_detail %}{% set _ = ch_tips.append(t.ch_modulation_warning) %}{% endif %}
            {% set ch_tip = ch_tips|join(', ') %}
            <tr>
                <td data-sort="{{ 0 if ch.health == 'good' else (2 if ch.health == 'critical' else 1) }}">
                    {% if ch.health == "good" %}<span class="badge badge-good">{{ t.health_good }}</span>
                    {% elif ch.health == "critical" %}<span class="badge badge-crit" title="{{ ch_tip }}">{{ t.health_critical }}</span>
                    {% else %}<span class="badge badge-warn" title="{{ ch_tip }}">{{ t.health_warning }}</span>{% endif %}
                </td>
                <td data-sort="{{ ch.channel_id }}">{{ ch.channel_id }}</td>
                <td>{{ ch.frequency }}</td>
                <td data-sort="{{ ch.power if ch.power is not none else 0 }}" class="{% if ch.power is not none %}{% if 'power critical' in ch.health_detail %}val-crit{% elif 'power warning' in ch.health_detail %}val-warn{% else %}val-good{% endif %}{% endif %}">{{ ch.power if ch.power is not none else "—" }}</td>
                <td class="{% if 'modulation critical' in ch.health_detail %}val-crit{% elif 'modulation warning' in ch.health_detail %}val-warn{% else %}val-good{% endif %}">{{ ch.modulation }}</td>
                <td class="{% if 'modulation critical' in ch.health_detail %}val-crit{% elif 'modulation warning' in ch.health_detail %}val-warn{% endif %}">{% if ch.theoretical_bitrate %}{{ ch.theoretical_bitrate }} Mbit/s{% else %}—{% endif %}</td>
                <td>{{ ch.multiplex }}</td>
            </tr>
            {% endfor %}
            </tbody>
                    </table>
                </div>
            </details>
        </div>
        {% endfor %}
    </div>
    
    {% if not has_us_ofdma %}
    <div class="card-notice card-notice-warn" style="margin-top:8px;">
        <span>&#9888;</span> {{ t.card_no_docsis31 }}
    </div>
    {% endif %}

{% elif not error %}
    <div class="waiting">
        <div class="spinner"></div>
        <p>{{ t.waiting_msg }}</p>
    </div>
{% endif %}
</div>

<!-- ═══ View: Trends ═══ -->
<div id="view-trends" class="view">
    <div class="trend-header">
        <span class="trend-title" id="trend-title"></span>
        <div style="display:flex; align-items:center; gap:8px;">
            <button class="trend-tab temp-toggle" id="temp-toggle-btn" style="display:none;" title="{{ t.temp_overlay_show }}">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;">
                    <path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/>
                </svg>
            </button>
            <div class="trend-tabs" id="trend-tabs">
                <button class="trend-tab active" data-range="day">{{ t.day }}</button>
                <button class="trend-tab" data-range="week">{{ t.week }}</button>
                <button class="trend-tab" data-range="month">{{ t.month }}</button>
            </div>
        </div>
    </div>
    <div id="trend-no-data" class="no-data-msg" style="display:none"></div>
    <div class="charts-grid" id="charts-grid">
        <!-- DS Power Chart -->
        <div class="chart-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                    <div class="chart-label">{{ t.ds_power_avg }}</div>
                </div>
                <button class="chart-expand-btn" data-chart="chart-ds-power" title="Expand">&#x26F6;</button>
            </div>
            <canvas id="chart-ds-power"></canvas>
        </div>
        
        <!-- DS SNR Chart -->
        <div class="chart-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v20M2 12l10-10 10 10M2 12l10 10 10-10"/>
                    </svg>
                    <div class="chart-label">{{ t.ds_snr_avg }}</div>
                </div>
                <button class="chart-expand-btn" data-chart="chart-ds-snr" title="Expand">&#x26F6;</button>
            </div>
            <canvas id="chart-ds-snr"></canvas>
        </div>
        
        <!-- US Power Chart -->
        <div class="chart-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v20M17 7l-5-5-5 5M7 17l5 5 5-5"/>
                    </svg>
                    <div class="chart-label">{{ t.us_power_avg }}</div>
                </div>
                <button class="chart-expand-btn" data-chart="chart-us-power" title="Expand">&#x26F6;</button>
            </div>
            <canvas id="chart-us-power"></canvas>
        </div>
        
        <!-- Errors Chart -->
        <div class="chart-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <div class="chart-label">{{ t.errors }}</div>
                </div>
                <button class="chart-expand-btn" data-chart="chart-errors" title="Expand">&#x26F6;</button>
            </div>
            <canvas id="chart-errors"></canvas>
        </div>
    </div>
</div>

<!-- ═══ View: BQM Graphs ═══ -->
{% if bqm_configured %}
<div id="view-bqm" class="view">
    <div class="trend-header">
        <span class="trend-title">{{ t.bqm_title }}</span>
    </div>
    <!-- BQM Toolbar: quick-jump + month nav -->
    <div id="bqm-toolbar" class="bqm-toolbar">
        <button class="trend-tab bqm-quick" id="bqm-today-btn">{{ t.bqm_today }}</button>
        <button class="trend-tab bqm-quick" id="bqm-yesterday-btn">{{ t.bqm_yesterday }}</button>
        <div class="bqm-month-nav">
            <button id="bqm-month-prev" class="bqm-nav-btn">&#8249;</button>
            <span id="bqm-month-label" class="bqm-month-label"></span>
            <button id="bqm-month-next" class="bqm-nav-btn">&#8250;</button>
        </div>
        <button class="bqm-nav-btn bqm-import-btn" onclick="openBqmImportModal()" title="{{ t.bqm_import_title }}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" style="display:block;">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
        </button>
        <button class="bqm-nav-btn bqm-import-btn bqm-delete-btn" onclick="deleteBqmImages()" title="{{ t.bqm_delete }}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" style="display:block;">
                <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
            </svg>
        </button>
    </div>
    <!-- Calendar grid -->
    <div id="bqm-calendar" class="bqm-calendar">
        <div class="bqm-weekday-header">
            <span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span><span>Su</span>
        </div>
        <div id="bqm-calendar-grid" class="bqm-calendar-grid"></div>
    </div>
    <!-- Slideshow controls -->
    <div id="bqm-slideshow-controls" class="bqm-slideshow-controls">
        <button id="bqm-play-btn" class="bqm-ctrl-btn" title="{{ t.bqm_play }}">
            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><polygon points="6,4 20,12 6,20"/></svg>
        </button>
        <button id="bqm-stop-btn" class="bqm-ctrl-btn" title="{{ t.bqm_stop }}" style="display:none;">
            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><rect x="5" y="5" width="14" height="14" rx="2"/></svg>
        </button>
        <div class="bqm-speed-tabs" id="bqm-speed-tabs">
            <span class="bqm-speed-label">{{ t.bqm_speed }}:</span>
            <button class="trend-tab" data-speed="1000">1s</button>
            <button class="trend-tab active" data-speed="2000">2s</button>
            <button class="trend-tab" data-speed="5000">5s</button>
        </div>
        <span id="bqm-range-label" class="bqm-range-label"></span>
    </div>
    <div id="bqm-content">
        <div id="bqm-card" class="bqm-card" style="display:none;">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18"/>
                        <path d="M7 12l4-4 4 4 4-4"/>
                    </svg>
                    <div class="chart-label">{{ t.bqm_title }}</div>
                    <span id="bqm-live-badge" class="bqm-live-badge" style="display:none;">{{ t.bqm_live }}</span>
                    <span id="bqm-last-updated" class="bqm-last-updated" style="display:none;"></span>
                </div>
            </div>
            <div id="bqm-image-wrap" style="text-align:center;">
                <img id="bqm-image" style="max-width:100%; border-radius:8px;" alt="BQM Graph">
            </div>
        </div>
        <div id="bqm-no-data" class="no-data-msg" style="display:none;"></div>
    </div>
</div>
{% endif %}

<!-- ═══ BQM Import Modal ═══ -->
<div class="modal-overlay" id="bqm-import-modal" onclick="if(event.target===this)closeBqmImportModal()">
    <div class="modal" style="max-width:800px;">
        <div class="modal-header">
            <h2>{{ t.bqm_import_title }}</h2>
            <button class="modal-close" onclick="closeBqmImportModal()">&times;</button>
        </div>
        <div class="modal-body" style="overflow-y:auto;">
            <!-- Drop zone -->
            <div id="bqm-import-dropzone" class="import-upload-zone bqm-import-dropzone">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:48px;height:48px;color:var(--muted);">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <p>{{ t.bqm_import_drop }}</p>
                <p style="font-size:0.8em;color:var(--muted);">{{ t.bqm_import_formats }}</p>
                <input type="file" id="bqm-import-file-input" style="display:none;" accept="image/png,image/jpeg,.png,.jpg,.jpeg" multiple>
            </div>
            <!-- Options: overwrite + date offset -->
            <div id="bqm-import-options" style="display:none; margin:10px 0;">
                <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;">
                    <label style="display:flex;align-items:center;gap:8px;font-size:0.9em;cursor:pointer;">
                        <input type="checkbox" id="bqm-import-overwrite">
                        {{ t.bqm_import_overwrite }}
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;font-size:0.9em;">
                        {{ t.bqm_import_offset }}:
                        <input type="number" id="bqm-import-offset" class="bqm-offset-input" min="-30" max="30" value="0" step="1">
                    </label>
                </div>
            </div>
            <!-- Status line -->
            <div id="bqm-import-status" class="import-info" style="display:none;"></div>
            <!-- Preview table -->
            <div id="bqm-import-preview" style="display:none;">
                <div class="import-table-wrap">
                    <table class="bqm-import-table">
                        <thead><tr>
                            <th style="width:70px;"></th>
                            <th>{{ t.incident_title }}</th>
                            <th style="width:160px;">{{ t.incident_date }}</th>
                            <th style="width:36px;"></th>
                        </tr></thead>
                        <tbody id="bqm-import-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="incident-modal-footer" id="bqm-import-footer" style="display:none;">
            <div class="modal-footer-left"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-muted" onclick="closeBqmImportModal()">{{ t.cancel }}</button>
                <button class="btn btn-accent" id="bqm-import-confirm-btn" onclick="executeBqmImport()" disabled>{{ t.bqm_import }}</button>
            </div>
        </div>
    </div>
</div>

<!-- ═══ View: Smokeping Graphs ═══ -->
{% if smokeping_configured %}
<div id="view-smokeping" class="view">
    <div style="text-align:center; margin-bottom:24px;">
        <span class="trend-title">{{ t.smokeping_title }}</span>
        <div class="trend-tabs" id="smokeping-tabs" style="display:inline-flex; margin-top:12px;">
            <button class="trend-tab active" data-span="3h">3h</button>
            <button class="trend-tab" data-span="30h">30h</button>
            <button class="trend-tab" data-span="10d">10d</button>
            <button class="trend-tab" data-span="1y">1y</button>
        </div>
    </div>
    <div id="smokeping-content" class="bqm-card-grid">
    </div>
    <div id="smokeping-no-data" class="no-data-msg" style="display:none;"></div>
</div>
{% endif %}

<!-- ═══ View: Correlation Analysis ═══ -->
{% if speedtest_configured or bqm_configured %}
<div id="view-correlation" class="view">
    <div class="trend-header">
        <span class="trend-title">{{ t.correlation_title }}</span>
        <div class="trend-tabs" id="correlation-tabs">
            <button class="trend-tab active" data-value="24" onclick="selectPill(this, loadCorrelationData)">{{ t.correlation_hours_24 }}</button>
            <button class="trend-tab" data-value="48" onclick="selectPill(this, loadCorrelationData)">{{ t.correlation_hours_48 }}</button>
            <button class="trend-tab" data-value="168" onclick="selectPill(this, loadCorrelationData)">{{ t.correlation_hours_168 }}</button>
        </div>
    </div>
    <p class="correlation-desc" style="color:var(--muted); font-size:0.85em; margin:0 0 16px;">{{ t.correlation_desc }}</p>

    <div id="correlation-loading" class="waiting" style="display:none;">
        <div class="spinner"></div>
    </div>
    <div id="correlation-no-data" class="no-data-msg" style="display:none;"></div>

    <!-- Signal Health Timeline Chart -->
    <div id="correlation-chart-container" style="display:none;">
        <!-- Phase 4.4: Modern card wrapper for correlation chart -->
        <div class="correlation-chart-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18"/>
                        <path d="M18 17V9"/>
                        <path d="M13 17V5"/>
                        <path d="M8 17v-3"/>
                    </svg>
                    <div class="chart-label">{{ t.correlation_chart_title }}</div>
                </div>
                <div class="chart-export-buttons">
                    <button class="chart-export-btn" onclick="_corrExportPNG()" title="Export as PNG">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        PNG
                    </button>
                    <button class="chart-export-btn" onclick="_corrExportCSV()" title="Export as CSV">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        CSV
                    </button>
                </div>
            </div>
            <div class="correlation-chart-wrap">
                <canvas id="correlation-chart"></canvas>
                <canvas id="correlation-overlay" class="correlation-overlay"></canvas>
                <div class="correlation-tooltip" id="correlation-tooltip"></div>
                <div class="correlation-zoom-reset" id="correlation-zoom-reset" style="display:none;" onclick="_corrResetZoom()">Reset Zoom</div>
                <div class="correlation-chart-legend" id="correlation-legend"></div>
            </div>
        </div>
    </div>

    <!-- Unified Timeline Table -->
    <div id="correlation-table-card" class="table-card" style="display:none;">
        <div class="table-card-header">
            <div class="table-card-title">
                <svg class="table-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                <span>{{ t.correlation_timeline }}</span>
            </div>
        </div>
        <div id="correlation-table-wrap">
            <table id="correlation-table">
                <thead><tr>
                    <th>{{ t.timestamp }}</th>
                    <th style="width:90px;">Source</th>
                    <th>{{ t.event_message }}</th>
                    <th>{{ t.event_details }}</th>
                </tr></thead>
                <tbody id="correlation-tbody"></tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- ═══ View: Incident Journal ═══ -->
<div id="view-journal" class="view">
    <div class="journal-header">
        <span class="trend-title">{{ t.incident_journal }}</span>
        <div class="journal-header-actions">
            <button class="btn-new-entry" onclick="openEntryModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                    <path d="M12 5v14m-7-7h14"/>
                </svg>
                {{ t.new_entry }}
            </button>
            <button class="btn-new-entry btn-import" onclick="openImportModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                {{ t.import }}
            </button>
            <div class="journal-export-wrapper" style="position:relative;display:inline-block;">
                <button class="btn-new-entry btn-import" onclick="toggleExportDropdown(event)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    {{ t.export_journal }}
                </button>
                <div class="journal-export-dropdown" id="journal-export-dropdown">
                    <button onclick="exportJournal('csv')">CSV</button>
                    <button onclick="exportJournal('json')">JSON</button>
                    <button onclick="exportJournal('md')">Markdown</button>
                </div>
            </div>
            <button class="btn-danger btn-delete-all" id="btn-delete-all-entries" onclick="deleteAllEntries()" style="display:none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
                {{ t.delete_all }}
            </button>
        </div>
    </div>
    <div class="incident-filter-bar" id="incident-filter-bar" style="display:none;"></div>
    <div class="incident-summary" id="incident-summary" style="display:none;"></div>
    <div class="journal-bulk-bar" id="journal-bulk-bar" style="display:none;">
        <span class="journal-bulk-count" id="journal-bulk-count"></span>
        <select id="journal-bulk-incident-select" class="journal-bulk-select">
            <option value="" disabled selected>{{ t.incident_assign }}…</option>
        </select>
        <button class="btn-small btn-accent" onclick="bulkAssign()">{{ t.bulk_assign }}</button>
        <button class="btn-small btn-muted" onclick="bulkUnassign()">{{ t.bulk_unassign }}</button>
        <span class="journal-bulk-sep"></span>
        <button class="btn-small btn-ghost" onclick="clearBulkSelection()">{{ t.bulk_deselect }}</button>
    </div>
    <div class="journal-search-wrap" id="journal-search-wrap" style="display:none;">
        <div class="journal-search-box">
            <svg class="journal-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input type="text" id="journal-search-input" placeholder="{{ t.search_placeholder }}" autocomplete="off" spellcheck="false">
            <button class="journal-search-clear" id="journal-search-clear" onclick="clearJournalSearch()" style="display:none;">&times;</button>
        </div>
        <span class="journal-search-count" id="journal-search-count"></span>
    </div>
    <div id="journal-loading" class="waiting" style="display:none;">
        <div class="spinner"></div>
    </div>
    <div id="journal-empty" class="journal-empty" style="display:none;"></div>
    
    <!-- Phase 4.5: Card wrapper for journal table -->
    <div id="journal-table-card" class="table-card" style="display:none;">
        <div class="table-card-header">
            <div class="table-card-title">
                <svg class="table-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V5a2 2 0 00-2-2z"/>
                    <path d="M16 2v4M8 2v4M3 10h18"/>
                </svg>
                <span>{{ t.incident_journal }}</span>
            </div>
            <button class="btn-bulk-toggle" id="btn-bulk-toggle" onclick="toggleBulkMode()" style="display:none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;">
                    <polyline points="9 11 12 14 22 4"/>
                    <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                </svg>
                <span id="btn-bulk-toggle-label">{{ t.bulk_select }}</span>
            </button>
        </div>
        <table id="journal-table">
            <thead><tr id="journal-thead-row">
                <th style="width:36px;"></th>
                <th data-col="date">{{ t.incident_date }}<span class="sort-indicator"></span></th>
                <th data-col="title">{{ t.incident_title }}<span class="sort-indicator"></span></th>
                <th data-col="description" class="journal-hide-mobile">{{ t.incident_description }}<span class="sort-indicator"></span></th>
                <th>&#128206;</th>
            </tr></thead>
            <tbody id="journal-tbody"></tbody>
        </table>
    </div>

    <!-- ═══ Incident Timeline View (replaces journal table) ═══ -->
    <div id="incident-timeline-view" style="display:none;">
        <button class="incident-timeline-back" onclick="closeIncidentTimeline()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;">
                <polyline points="15 18 9 12 15 6"/>
            </svg>
            <span data-i18n="incident_back_journal">{{ t.incident_back_journal }}</span>
        </button>
        <div id="incident-timeline-header" class="incident-timeline-card"></div>
        <div id="incident-timeline-entries" class="incident-timeline-card"></div>
        <div id="incident-timeline-chart-card" class="incident-timeline-card">
            <div class="incident-timeline-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                <span data-i18n="incident_signal_timeline">{{ t.incident_signal_timeline }}</span>
            </div>
            <div class="incident-timeline-chart-wrap">
                <canvas id="incident-timeline-canvas"></canvas>
            </div>
        </div>
        <div id="incident-timeline-signals" class="incident-timeline-card"></div>
        <div id="incident-timeline-bnetz" class="incident-timeline-card" style="display:none;"></div>
    </div>
</div>

<!-- ═══ View: Event Log ═══ -->
<div id="view-events" class="view">
    <div class="events-header">
        <span class="trend-title">{{ t.event_log }}</span>
    </div>
    
    <!-- Phase 4.3: Pill filter toggles for severity -->
    <div class="events-filter-section">
        <div class="events-filter-label">{{ t.event_severity }}:</div>
        <div class="events-severity-pills">
            <button class="severity-pill active" data-severity="" onclick="filterEventsBySeverity('')">{{ t.event_all_severities }}</button>
            <button class="severity-pill" data-severity="info" onclick="filterEventsBySeverity('info')">{{ t.event_severity_info }}</button>
            <button class="severity-pill" data-severity="warning" onclick="filterEventsBySeverity('warning')">{{ t.event_severity_warning }}</button>
            <button class="severity-pill" data-severity="critical" onclick="filterEventsBySeverity('critical')">{{ t.event_severity_critical }}</button>
        </div>
    </div>
    
    <div id="events-loading" class="waiting" style="display:none;">
        <div class="spinner"></div>
    </div>
    <div id="events-empty" class="events-empty" style="display:none;"></div>
    
    <!-- Phase 4.3: Card wrapper for events table -->
    <div id="events-table-card" class="table-card" style="display:none;">
        <div class="table-card-header">
            <div class="table-card-title">
                <svg class="table-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>{{ t.event_log }}</span>
            </div>
            <button class="btn-ack-all" id="btn-ack-all" onclick="acknowledgeAllEvents()" style="display:none;">&#10003; {{ t.event_acknowledge_all }}</button>
        </div>
        <table id="events-table">
            <thead><tr>
                <th>{{ t.timestamp }}</th>
                <th>{{ t.event_severity }}</th>
                <th>{{ t.event_type }}</th>
                <th>{{ t.event_message }}</th>
                <th></th>
            </tr></thead>
            <tbody id="events-tbody"></tbody>
        </table>
    </div>
    
    <div id="events-show-more" style="text-align:center; padding:16px; display:none;">
        <button class="btn-show-more" onclick="loadMoreEvents()">{{ t.show_more }}</button>
    </div>
</div>

<!-- ═══ View: Channel Timeline ═══ -->
<div id="view-channels" class="view">
    <div class="trend-header" style="margin-bottom:12px;">
        <span class="trend-title">{{ t.channels }}</span>
        <div class="trend-tabs" id="channel-mode-tabs" style="margin-left:auto;">
            <button class="trend-tab active" data-value="timeline" onclick="selectPill(this, switchChannelMode)">{{ t.channel_timeline }}</button>
            <button class="trend-tab" data-value="compare" onclick="selectPill(this, switchChannelMode)">{{ t.channel_compare }}</button>
        </div>
    </div>

    <!-- ── Timeline Sub-View ── -->
    <div id="channel-panel-timeline">
        <div class="channel-filters" style="display:flex; gap:12px; margin-bottom:20px; flex-wrap:wrap; align-items:center;">
            <select id="channel-select" class="channel-select-styled" onchange="loadChannelTimeline()">
                <option value="">{{ t.select_channel }}</option>
            </select>
            <div class="trend-tabs" id="channel-time-tabs">
                <button class="trend-tab" data-value="1" onclick="selectPill(this, loadChannelTimeline)">1d</button>
                <button class="trend-tab" data-value="3" onclick="selectPill(this, loadChannelTimeline)">3d</button>
                <button class="trend-tab active" data-value="7" onclick="selectPill(this, loadChannelTimeline)">7d</button>
                <button class="trend-tab" data-value="30" onclick="selectPill(this, loadChannelTimeline)">30d</button>
            </div>
        </div>
        <div id="channel-loading" class="waiting" style="display:none;">
            <div class="spinner"></div>
        </div>
        <div id="channel-empty" class="events-empty" style="display:none;"></div>
        <div id="channel-charts" class="charts-grid" style="display:none;">
            <div class="chart-card">
                <div class="chart-card-header">
                    <div class="chart-header-content">
                        <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                        </svg>
                        <div class="chart-label">{{ t.power_history }}</div>
                    </div>
                    <button class="chart-expand-btn" data-chart="chart-ch-power" title="Expand">&#x26F6;</button>
                </div>
                <canvas id="chart-ch-power"></canvas>
            </div>
            <div class="chart-card" id="channel-errors-card">
                <div class="chart-card-header">
                    <div class="chart-header-content">
                        <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <div class="chart-label">{{ t.error_history }}</div>
                    </div>
                    <button class="chart-expand-btn" data-chart="chart-ch-errors" title="Expand">&#x26F6;</button>
                </div>
                <canvas id="chart-ch-errors"></canvas>
            </div>
            <div class="chart-card" id="channel-modulation-card">
                <div class="chart-card-header">
                    <div class="chart-header-content">
                        <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3v18h18"/>
                            <path d="M7 12l4-4 4 4 4-4"/>
                        </svg>
                        <div class="chart-label">{{ t.modulation }}</div>
                    </div>
                    <button class="chart-expand-btn" data-chart="chart-ch-modulation" title="Expand">&#x26F6;</button>
                </div>
                <canvas id="chart-ch-modulation"></canvas>
            </div>
        </div>
    </div>

    <!-- ── Compare Sub-View ── -->
    <div id="channel-panel-compare" style="display:none;">
        <div class="compare-controls">
            <div class="trend-tabs" id="compare-dir-tabs">
                <button class="trend-tab active" data-value="ds" onclick="selectPill(this, onCompareDirectionChange)">{{ t.downstream }}</button>
                <button class="trend-tab" data-value="us" onclick="selectPill(this, onCompareDirectionChange)">{{ t.upstream }}</button>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
                <select id="compare-channel-select"><option value="">{{ t.select_channel }}</option></select>
                <button class="compare-add-btn" onclick="addCompareChannel()">+ {{ t.add_channel }}</button>
            </div>
            <div class="trend-tabs" id="compare-time-tabs">
                <button class="trend-tab" data-value="1" onclick="selectPill(this, loadCompareCharts)">1d</button>
                <button class="trend-tab" data-value="3" onclick="selectPill(this, loadCompareCharts)">3d</button>
                <button class="trend-tab active" data-value="7" onclick="selectPill(this, loadCompareCharts)">7d</button>
                <button class="trend-tab" data-value="30" onclick="selectPill(this, loadCompareCharts)">30d</button>
            </div>
        </div>
        <div id="compare-chips" class="compare-chips"></div>
        <div id="compare-empty" class="events-empty" style="display:none;"></div>
        <div id="compare-loading" class="waiting" style="display:none;">
            <div class="spinner"></div>
        </div>
        <div id="compare-charts" class="charts-grid" style="display:none;">
            <div class="chart-card">
                <div class="chart-card-header">
                    <div class="chart-header-content">
                        <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                        </svg>
                        <div class="chart-label">{{ t.power_history }}</div>
                    </div>
                    <button class="chart-expand-btn" data-chart="chart-cmp-power" title="Expand">&#x26F6;</button>
                </div>
                <canvas id="chart-cmp-power"></canvas>
            </div>
            <div class="chart-card" id="compare-snr-card">
                <div class="chart-card-header">
                    <div class="chart-header-content">
                        <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                        </svg>
                        <div class="chart-label">{{ t.snr_history }}</div>
                    </div>
                    <button class="chart-expand-btn" data-chart="chart-cmp-snr" title="Expand">&#x26F6;</button>
                </div>
                <canvas id="chart-cmp-snr"></canvas>
            </div>
            <div class="chart-card" id="compare-errors-card">
                <div class="chart-card-header">
                    <div class="chart-header-content">
                        <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <div class="chart-label">{{ t.error_history }}</div>
                    </div>
                    <button class="chart-expand-btn" data-chart="chart-cmp-errors" title="Expand">&#x26F6;</button>
                </div>
                <canvas id="chart-cmp-errors"></canvas>
            </div>
            <div class="chart-card" id="compare-modulation-card">
                <div class="chart-card-header">
                    <div class="chart-header-content">
                        <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3v18h18"/>
                            <path d="M7 12l4-4 4 4 4-4"/>
                        </svg>
                        <div class="chart-label">{{ t.modulation }}</div>
                    </div>
                    <button class="chart-expand-btn" data-chart="chart-cmp-modulation" title="Expand">&#x26F6;</button>
                </div>
                <canvas id="chart-cmp-modulation"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- ═══ Entry Modal ═══ -->
<div class="modal-overlay" id="entry-modal" onclick="if(event.target===this)closeEntryModal()">
    <div class="modal" style="max-width:640px;">
        <div class="modal-header">
            <div style="display:flex;align-items:center;gap:10px;">
                <span id="entry-modal-icon" class="incident-modal-icon"></span>
                <h2 id="entry-modal-title"></h2>
            </div>
            <button class="modal-close" onclick="closeEntryModal()">&times;</button>
        </div>
        <div class="modal-body" style="overflow-y:auto;">
            <input type="hidden" id="entry-id">
            <div class="incident-form-group">
                <label for="entry-date">{{ t.incident_date }}</label>
                <input type="date" id="entry-date">
            </div>
            <div class="incident-form-group">
                <label for="entry-title-input">{{ t.incident_title }}</label>
                <input type="text" id="entry-title-input" maxlength="200" placeholder="{{ t.incident_title }}">
            </div>
            <div class="incident-form-group">
                <label>{{ t.icon }}</label>
                <input type="hidden" id="entry-icon-value">
                <div class="icon-picker" id="entry-icon-picker"></div>
            </div>
            <div class="incident-form-group">
                <label for="entry-desc">{{ t.incident_description }}</label>
                <textarea id="entry-desc" maxlength="10000" placeholder="{{ t.incident_description }}"></textarea>
            </div>
            <div class="incident-form-group">
                <label for="entry-incident-select">{{ t.incident_assign }}</label>
                <select id="entry-incident-select" class="entry-incident-select">
                    <option value="">{{ t.incident_none }}</option>
                </select>
            </div>
            <div class="incident-form-group" id="entry-attachments-section">
                <label>{{ t.attachments }}</label>
                <div class="attachment-list" id="entry-attachment-list"></div>
                <button class="btn-upload" id="entry-upload-btn" onclick="document.getElementById('entry-file-input').click()">
                    &#128206; {{ t.upload_file }}
                </button>
                <span id="entry-upload-spinner" style="display:none;"><span class="upload-spinner"></span></span>
                <input type="file" id="entry-file-input" style="display:none;" multiple
                       accept="image/png,image/jpeg,image/gif,image/webp,application/pdf,text/plain"
                       onchange="handleEntryFileUpload(this)">
            </div>
        </div>
        <div class="incident-modal-footer">
            <div class="modal-footer-left">
                <button class="btn-danger" id="entry-delete-btn" onclick="deleteEntry()" style="display:none;">{{ t.delete_incident }}</button>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-muted" onclick="closeEntryModal()">{{ t.cancel }}</button>
                <button class="btn btn-accent" onclick="saveEntry()">{{ t.save }}</button>
            </div>
        </div>
    </div>
</div>

<!-- ═══ Incident Container Modal ═══ -->
<div class="modal-overlay" id="incident-container-modal" onclick="if(event.target===this)closeIncidentModal()">
    <div class="modal incident-container-modal" style="max-width:560px;">
        <div class="modal-header">
            <h2 id="incident-container-modal-title"></h2>
            <button class="modal-close" onclick="closeIncidentModal()">&times;</button>
        </div>
        <div class="modal-body" style="overflow-y:auto;">
            <input type="hidden" id="incident-container-id">
            <div class="incident-form-group">
                <label for="incident-container-name">{{ t.incident_name }}</label>
                <input type="text" id="incident-container-name" maxlength="200" placeholder="{{ t.incident_name }}">
            </div>
            <div class="incident-form-group">
                <label for="incident-container-status">{{ t.incident_status }}</label>
                <select id="incident-container-status">
                    <option value="open">{{ t.incident_status_open }}</option>
                    <option value="resolved">{{ t.incident_status_resolved }}</option>
                    <option value="escalated">{{ t.incident_status_escalated }}</option>
                </select>
            </div>
            <div class="incident-form-group" style="display:flex;gap:12px;">
                <div style="flex:1;">
                    <label for="incident-container-start">{{ t.incident_start_date }}</label>
                    <input type="date" id="incident-container-start">
                </div>
                <div style="flex:1;">
                    <label for="incident-container-end">{{ t.incident_end_date }}</label>
                    <input type="date" id="incident-container-end">
                </div>
            </div>
            <div class="incident-form-group">
                <label>{{ t.icon }}</label>
                <input type="hidden" id="incident-container-icon-value">
                <div class="icon-picker" id="incident-container-icon-picker"></div>
            </div>
            <div class="incident-form-group">
                <label for="incident-container-desc">{{ t.incident_description }}</label>
                <textarea id="incident-container-desc" maxlength="5000" placeholder="{{ t.incident_description }}"></textarea>
            </div>
            <div class="incident-form-group" id="incident-container-entry-count-section" style="display:none;">
                <label>{{ t.incident_entry_count }}</label>
                <span id="incident-container-entry-count" style="font-weight:600;"></span>
            </div>
        </div>
        <div class="incident-modal-footer">
            <div class="modal-footer-left">
                <button class="btn-danger" id="incident-container-delete-btn" onclick="deleteIncident()" style="display:none;">{{ t.delete }}</button>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-muted" onclick="closeIncidentModal()">{{ t.cancel }}</button>
                <button class="btn btn-accent" onclick="saveIncident()">{{ t.save }}</button>
            </div>
        </div>
    </div>
</div>

<!-- ═══ Import Modal ═══ -->
<div class="modal-overlay" id="import-modal" onclick="if(event.target===this)closeImportModal()">
    <div class="modal" style="max-width:900px;">
        <div class="modal-header">
            <h2>{{ t.import_incidents }}</h2>
            <button class="modal-close" onclick="closeImportModal()">&times;</button>
        </div>
        <div class="modal-body" style="overflow-y:auto;">
            <!-- Upload zone -->
            <div id="import-upload-zone" class="import-upload-zone">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:48px;height:48px;color:var(--muted);">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <p>{{ t.import_upload_hint }}</p>
                <p style="font-size:0.8em;color:var(--muted);">{{ t.import_file_types }}</p>
                <input type="file" id="import-file-input" style="display:none;" accept=".xlsx,.csv" onchange="handleImportFile(this)">
            </div>
            <!-- Loading -->
            <div id="import-loading" style="display:none;text-align:center;padding:20px;">
                <div class="spinner"></div>
                <p style="margin-top:10px;color:var(--muted);">{{ t.import_parsing }}</p>
            </div>
            <!-- Preview -->
            <div id="import-preview" style="display:none;">
                <div class="import-info" id="import-info"></div>
                <div class="import-controls">
                    <label class="import-select-all">
                        <input type="checkbox" id="import-select-all" checked onchange="toggleImportAll(this.checked)">
                        {{ t.import_select_all }}
                    </label>
                </div>
                <div class="import-table-wrap">
                    <table class="import-table" id="import-table">
                        <thead><tr>
                            <th style="width:40px;"></th>
                            <th style="width:36px;"></th>
                            <th>{{ t.incident_date }}</th>
                            <th>{{ t.incident_title }}</th>
                            <th class="journal-hide-mobile">{{ t.incident_description }}</th>
                        </tr></thead>
                        <tbody id="import-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="incident-modal-footer" id="import-footer" style="display:none;">
            <div class="modal-footer-left"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-muted" onclick="closeImportModal()">{{ t.cancel }}</button>
                <button class="btn btn-accent" id="import-confirm-btn" onclick="confirmImport()">{{ t.import_selected }}</button>
            </div>
        </div>
    </div>
</div>

<!-- ═══ View: Speedtest ═══ -->
{% if speedtest_configured %}
<div id="view-speedtest" class="view">
    <div class="trend-header">
        <span class="trend-title">{{ t.speedtest_tracker }}</span>
        <div style="display:flex; gap:8px; align-items:center;">
            <div class="trend-tabs" id="speedtest-tabs">
                <button class="trend-tab" data-value="1" onclick="selectPill(this, filterSpeedtestData)">1d</button>
                <button class="trend-tab active" data-value="7" onclick="selectPill(this, filterSpeedtestData)">7d</button>
                <button class="trend-tab" data-value="14" onclick="selectPill(this, filterSpeedtestData)">14d</button>
                <button class="trend-tab" data-value="30" onclick="selectPill(this, filterSpeedtestData)">30d</button>
                <button class="trend-tab" data-value="90" onclick="selectPill(this, filterSpeedtestData)">90d</button>
                <button class="trend-tab" data-value="all" onclick="selectPill(this, filterSpeedtestData)">{{ t.fetch_all }}</button>
            </div>
            <button class="refresh-btn" id="speedtest-refresh-btn" title="{{ t.refresh }}" onclick="loadSpeedtestHistory()">&#x1F504;</button>
        </div>
    </div>
    <div id="speedtest-loading" class="waiting" style="display:none;">
        <div class="spinner"></div>
        <p>{{ t.fetching }}</p>
    </div>
    <div id="speedtest-no-data" class="no-data-msg" style="display:none;"></div>
    <div id="speedtest-chart-container" style="display:none;">
        <!-- Phase 4.2: Modern card wrapper for speedtest chart -->
        <div class="speedtest-chart-card">
            <div class="chart-card-header">
                <div class="chart-header-content">
                    <svg class="chart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    <div class="chart-label">Speedtest History</div>
                </div>
            </div>
            <div class="speedtest-chart-wrap">
                <canvas id="speedtest-chart"></canvas>
                <div class="speedtest-chart-tooltip" id="speedtest-chart-tooltip"></div>
                <div class="speedtest-chart-legend">
                    <span class="legend-dl">Download (Mbps)</span>
                    <span class="legend-ul">Upload (Mbps)</span>
                    <span class="legend-ping">Ping (ms)</span>
                    <span class="legend-thresh">80% Median DL</span>
                </div>
            </div>
        </div>
    </div>
    <!-- Phase 4.2: Table card wrapper -->
    <div id="speedtest-table-wrap" class="table-card">
        <table id="speedtest-table" class="sortable" style="display:none;">
            <thead><tr>
                <th class="st-expand-col"></th>
                <th data-col="timestamp">{{ t.timestamp }}<span class="sort-indicator">▼</span></th>
                <th data-col="server_id">{{ t.server or 'Server' }}<span class="sort-indicator"></span></th>
                <th data-col="download_mbps">{{ t.download }}<span class="sort-indicator"></span></th>
                <th data-col="upload_mbps">{{ t.upload }}<span class="sort-indicator"></span></th>
                <th data-col="ping_ms">{{ t.ping }}<span class="sort-indicator"></span></th>
                <th data-col="jitter_ms">{{ t.jitter }}<span class="sort-indicator"></span></th>
                <th data-col="packet_loss_pct">{{ t.packet_loss }}<span class="sort-indicator"></span></th>
            </tr></thead>
            <tbody id="speedtest-tbody"></tbody>
        </table>
        <div id="speedtest-show-more" style="text-align:center; padding:12px; display:none;">
            <button class="btn btn-muted" id="speedtest-more-btn" onclick="showMoreSpeedtest()"></button>
        </div>
    </div>
</div>
{% endif %}

{% if gaming_quality_enabled %}
<div id="view-gaming" class="view">
    <div class="trend-header">
        <span class="trend-title">{{ t.gaming_quality_label }}</span>
    </div>
    {% if gaming_index %}
    <div class="gaming-overview">
        <div class="gaming-gauge">
            {% set s = gaming_index.score %}
            <div class="gaming-gauge-band">
                <div class="gaming-gauge-segment gauge-f"><span>F</span></div>
                <div class="gaming-gauge-segment gauge-d"><span>D</span></div>
                <div class="gaming-gauge-segment gauge-c"><span>C</span></div>
                <div class="gaming-gauge-segment gauge-b"><span>B</span></div>
                <div class="gaming-gauge-segment gauge-a"><span>A</span></div>
            </div>
            <div class="gaming-gauge-track">
                <div class="gaming-gauge-marker" style="left:{{ s }}%;">
                    <div class="gaming-gauge-needle"></div>
                    <div class="gaming-gauge-score">{{ s }}</div>
                </div>
            </div>
            {% if not gaming_index.has_speedtest %}
            <p class="gaming-no-speedtest-hint"><i data-lucide="info" style="width:14px;height:14px;vertical-align:-2px;"></i> {{ t.gaming_no_speedtest_detail }}</p>
            {% endif %}
        </div>
        <div class="gaming-grade-big gaming-{{ gaming_index.grade|lower }}">
            <span class="gaming-grade-letter">{{ gaming_index.grade }}</span>
            <span class="gaming-grade-text">{{ t['gaming_grade_' ~ gaming_index.grade|lower] }}</span>
        </div>
    </div>
    <div class="gaming-components">
        <h3 class="gaming-section-title">{{ t.gaming_components_title }}</h3>
        {% for key, comp in gaming_index.components.items()|sort(attribute='1.weight', reverse=true) %}
        <div class="gaming-component-card">
            <div class="gaming-comp-header">
                <span class="gaming-comp-icon">
                    {% if key == 'latency' %}<i data-lucide="timer" style="width:16px;height:16px;"></i>
                    {% elif key == 'jitter' %}<i data-lucide="waves" style="width:16px;height:16px;"></i>
                    {% elif key == 'packet_loss' %}<i data-lucide="package-x" style="width:16px;height:16px;"></i>
                    {% elif key == 'docsis_health' %}<i data-lucide="heart-pulse" style="width:16px;height:16px;"></i>
                    {% elif key == 'snr_headroom' %}<i data-lucide="signal" style="width:16px;height:16px;"></i>
                    {% endif %}
                </span>
                <span class="gaming-comp-name">{{ t['gaming_comp_' ~ key] }}</span>
                <span class="gaming-comp-weight">{{ comp.weight }}%</span>
                <span class="gaming-comp-score {% if comp.score >= 80 %}score-good{% elif comp.score >= 50 %}score-warn{% else %}score-crit{% endif %}">{{ comp.score }}</span>
            </div>
            <div class="gaming-comp-bar">
                <div class="gaming-comp-fill {% if comp.score >= 80 %}fill-good{% elif comp.score >= 50 %}fill-warn{% else %}fill-crit{% endif %}" style="width:{{ comp.score }}%;"></div>
            </div>
            <p class="gaming-comp-detail">{{ t['gaming_comp_' ~ key ~ '_detail'] }}</p>
        </div>
        {% endfor %}
    </div>
    <div class="gaming-genres">
        <h3 class="gaming-section-title">{{ t.gaming_genres_title }}</h3>
        {% set g = gaming_index.grade|lower %}
        <div class="gaming-genre-cards">
            <div class="gaming-genre-card {% if g in ['a'] %}genre-ok{% elif g in ['b'] %}genre-ok{% elif g in ['c'] %}genre-warn{% else %}genre-bad{% endif %}">
                <span class="gaming-genre-icon"><i data-lucide="crosshair" style="width:18px;height:18px;"></i></span>
                <span class="gaming-genre-name">{{ t.gaming_genre_fps }}</span>
                <span class="gaming-genre-examples">CS2, Valorant, Fortnite</span>
                <span class="gaming-genre-verdict">{{ t['gaming_genre_fps_' ~ g] }}</span>
            </div>
            <div class="gaming-genre-card {% if g in ['a', 'b'] %}genre-ok{% elif g in ['c'] %}genre-ok{% else %}genre-bad{% endif %}">
                <span class="gaming-genre-icon"><i data-lucide="swords" style="width:18px;height:18px;"></i></span>
                <span class="gaming-genre-name">{{ t.gaming_genre_moba }}</span>
                <span class="gaming-genre-examples">LoL, Dota 2, HotS</span>
                <span class="gaming-genre-verdict">{{ t['gaming_genre_moba_' ~ g] }}</span>
            </div>
            <div class="gaming-genre-card {% if g in ['a', 'b'] %}genre-ok{% elif g in ['c', 'd'] %}genre-ok{% else %}genre-bad{% endif %}">
                <span class="gaming-genre-icon"><i data-lucide="globe" style="width:18px;height:18px;"></i></span>
                <span class="gaming-genre-name">{{ t.gaming_genre_mmo }}</span>
                <span class="gaming-genre-examples">WoW, FFXIV, GW2</span>
                <span class="gaming-genre-verdict">{{ t['gaming_genre_mmo_' ~ g] }}</span>
            </div>
            <div class="gaming-genre-card {% if g in ['a', 'b', 'c'] %}genre-ok{% elif g in ['d'] %}genre-warn{% else %}genre-bad{% endif %}">
                <span class="gaming-genre-icon"><i data-lucide="crown" style="width:18px;height:18px;"></i></span>
                <span class="gaming-genre-name">{{ t.gaming_genre_strategy }}</span>
                <span class="gaming-genre-examples">Civilization, AoE, Chess</span>
                <span class="gaming-genre-verdict">{{ t['gaming_genre_strategy_' ~ g] }}</span>
            </div>
        </div>
    </div>
    {% else %}
    <div class="no-data-msg">{{ t.gaming_no_data }}</div>
    {% endif %}
</div>
{% endif %}

<!-- ═══ View: Breitbandmessung (BNetzA) ═══ -->
{% if bnetz_enabled %}
<div id="view-bnetz" class="view">
    <div class="trend-header">
        <span class="trend-title">{{ t.bnetz_title }}</span>
        <div style="display:flex;gap:8px;align-items:center;">
            <label class="btn btn-muted" style="cursor:pointer;">
                <i data-lucide="upload" style="width:14px;height:14px;vertical-align:-2px;"></i> {{ t.bnetz_upload }}
                <input type="file" accept=".pdf,.csv" id="bnetz-file-input" style="display:none;" onchange="uploadBnetzFromView(this)">
            </label>
            <button class="refresh-btn" title="{{ t.refresh }}" onclick="loadBnetzData()">&#x1F504;</button>
        </div>
    </div>
    <div id="bnetz-watcher-status" style="display:none;padding:8px 14px;margin-bottom:10px;border-radius:8px;background:var(--card-bg);border:1px solid var(--input-border);font-size:0.85em;color:var(--text-muted);align-items:center;gap:8px;">
        <i data-lucide="eye" style="width:14px;height:14px;flex-shrink:0;"></i>
        <span id="bnetz-watcher-text"></span>
    </div>
    <div id="bnetz-loading" class="waiting" style="display:none;">
        <div class="spinner"></div>
    </div>
    <div id="bnetz-empty" class="no-data-msg" style="display:none;">
        {{ t.bnetz_no_measurements }}
    </div>
    <div id="bnetz-table-card" class="table-card" style="display:none;">
        <table id="bnetz-table">
            <thead><tr>
                <th>{{ t.bnetz_date }}</th>
                <th>{{ t.bnetz_provider }}</th>
                <th>{{ t.bnetz_download_target }}</th>
                <th>{{ t.bnetz_download_actual }}</th>
                <th>{{ t.bnetz_upload_target }}</th>
                <th>{{ t.bnetz_upload_actual }}</th>
                <th>{{ t.bnetz_verdict }}</th>
                <th></th>
            </tr></thead>
            <tbody id="bnetz-tbody"></tbody>
        </table>
    </div>
</div>
{% endif %}

</div><!-- /main-content -->
</div><!-- /app-main -->
</div><!-- /app-layout -->

<!-- Speedtest Setup Modal -->
<div class="modal-overlay" id="speedtest-setup-modal" onclick="if(event.target===this)closeSpeedtestSetupModal()">
    <div class="modal">
        <div class="modal-header">
            <h2>&#9889; {{ t.speedtest_setup_title }}</h2>
            <button class="modal-close" onclick="closeSpeedtestSetupModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 10px 0; font-size: 0.9em; line-height: 1.6;">
            <p style="margin-bottom:12px;">{{ t.speedtest_setup_intro }}</p>
            <div style="background:var(--bg); border-radius:8px; padding:14px; margin-bottom:14px;">
                <p style="font-weight:bold; margin-bottom:8px; color:var(--accent);">{{ t.speedtest_setup_benefits_title }}</p>
                <ul style="list-style:none; padding:0;">
                    <li style="margin-bottom:6px;">&#10003; {{ t.speedtest_setup_benefit_1 }}</li>
                    <li style="margin-bottom:6px;">&#10003; {{ t.speedtest_setup_benefit_2 }}</li>
                    <li style="margin-bottom:6px;">&#10003; {{ t.speedtest_setup_benefit_3 }}</li>
                </ul>
            </div>
            <div style="background:var(--bg); border-radius:8px; padding:14px;">
                <p style="font-weight:bold; margin-bottom:8px; color:var(--accent);">{{ t.speedtest_setup_howto_title }}</p>
                <ol style="padding-left:20px;">
                    <li style="margin-bottom:6px;">{{ t.speedtest_setup_step_1|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.speedtest_setup_step_2|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.speedtest_setup_step_3|safe_html }}</li>
                </ol>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-muted" onclick="closeSpeedtestSetupModal()">{{ t.close }}</button>
            <a class="btn btn-accent" href="/settings" style="text-decoration:none;">&#9881; {{ t.settings }}</a>
        </div>
    </div>
</div>

<!-- BQM Setup Modal -->
<div class="modal-overlay" id="bqm-setup-modal" onclick="if(event.target===this)closeBqmSetupModal()">
    <div class="modal">
        <div class="modal-header">
            <h2>&#128200; {{ t.bqm_setup_title }}</h2>
            <button class="modal-close" onclick="closeBqmSetupModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 10px 0; font-size: 0.9em; line-height: 1.6;">
            <p style="margin-bottom:12px;">{{ t.bqm_setup_intro }}</p>
            <div style="background:var(--bg); border-radius:8px; padding:14px; margin-bottom:14px;">
                <p style="font-weight:bold; margin-bottom:8px; color:var(--accent);">{{ t.bqm_setup_benefits_title }}</p>
                <ul style="list-style:none; padding:0;">
                    <li style="margin-bottom:6px;">✅ {{ t.bqm_setup_benefit_1 }}</li>
                    <li style="margin-bottom:6px;">✅ {{ t.bqm_setup_benefit_2 }}</li>
                    <li style="margin-bottom:6px;">✅ {{ t.bqm_setup_benefit_3 }}</li>
                </ul>
            </div>
            <div style="background:var(--bg); border-radius:8px; padding:14px;">
                <p style="font-weight:bold; margin-bottom:8px; color:var(--accent);">{{ t.bqm_setup_howto_title }}</p>
                <ol style="padding-left:20px;">
                    <li style="margin-bottom:6px;">{{ t.bqm_setup_step_1|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.bqm_setup_step_2|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.bqm_setup_step_3|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.bqm_setup_step_4|safe_html }}</li>
                </ol>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-muted" onclick="closeBqmSetupModal()">{{ t.close }}</button>
            <a class="btn btn-accent" href="/settings" style="text-decoration:none;">&#9881; {{ t.settings }}</a>
        </div>
    </div>
</div>

<!-- Smokeping Setup Modal -->
<div class="modal-overlay" id="smokeping-setup-modal" onclick="if(event.target===this)closeSmokepingSetupModal()">
    <div class="modal">
        <div class="modal-header">
            <h2>&#128225; {{ t.smokeping_setup_title }}</h2>
            <button class="modal-close" onclick="closeSmokepingSetupModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 10px 0; font-size: 0.9em; line-height: 1.6;">
            <p style="margin-bottom:12px;">{{ t.smokeping_setup_intro }}</p>
            <div style="background:var(--bg); border-radius:8px; padding:14px;">
                <p style="font-weight:bold; margin-bottom:8px; color:var(--accent);">{{ t.bqm_setup_howto_title }}</p>
                <ol style="padding-left:20px;">
                    <li style="margin-bottom:6px;">{{ t.smokeping_setup_step_1|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.smokeping_setup_step_2|safe_html }}</li>
                    <li style="margin-bottom:6px;">{{ t.smokeping_setup_step_3|safe_html }}</li>
                </ol>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-muted" onclick="closeSmokepingSetupModal()">{{ t.close }}</button>
            <a class="btn btn-accent" href="/settings#integrations" style="text-decoration:none;">&#9881; {{ t.settings }}</a>
        </div>
    </div>
</div>

<!-- Report Modal -->
<div class="modal-overlay" id="report-modal" onclick="if(event.target===this)closeReportModal()">
    <div class="modal" style="max-width:800px;">
        <div class="modal-header">
            <h2>{{ t.incident_report }}</h2>
            <button class="modal-close" onclick="closeReportModal()">&times;</button>
        </div>
        <p class="modal-hint">{{ t.report_description }}</p>
        <div class="modal-body" style="padding: 10px 0;">
            <!-- Step 1: Settings & Customer Info -->
            <div id="report-step1">
                <div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom:14px;">
                    <div>
                        <label style="font-size:13px; color:var(--muted);">{{ t.report_days }}</label><br>
                        <select id="report-days" style="margin-top:4px; padding:6px 10px; border-radius:6px; border:1px solid var(--border); background:var(--bg); color:var(--text);">
                            <option value="1">1</option><option value="3">3</option>
                            <option value="7" selected>7</option><option value="14">14</option>
                            <option value="30">30</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:13px; color:var(--muted);">{{ t.report_language }}</label><br>
                        <select id="report-lang" style="margin-top:4px; padding:6px 10px; border-radius:6px; border:1px solid var(--border); background:var(--bg); color:var(--text);">
                            {% for code, name in languages.items() %}
                            <option value="{{ code }}" {% if code == lang %}selected{% endif %}>{{ lang_flags.get(code, '') }} {{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div style="background:var(--bg); border-radius:8px; padding:14px; margin-bottom:10px;">
                    <p style="font-size:13px; color:var(--muted); margin-bottom:10px;">{{ t.report_customer_hint }}</p>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <input id="report-name" type="text" placeholder="{{ t.report_name }}" style="padding:8px 12px; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-family:inherit;">
                        <input id="report-number" type="text" placeholder="{{ t.report_customer_number }}" style="padding:8px 12px; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-family:inherit;">
                        <input id="report-address" type="text" placeholder="{{ t.report_address }}" style="padding:8px 12px; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-family:inherit;">
                    </div>
                </div>
                {% if bnetz_enabled %}
                <div style="margin-top:10px;">
                    <label style="display:flex; align-items:center; gap:8px; font-size:13px; color:var(--text);">
                        <input type="checkbox" id="report-include-bnetz" checked>
                        {{ t.report_include_bnetz }}
                    </label>
                </div>
                {% endif %}
                <input type="hidden" id="report-bnetz-id" value="">
            </div>
            <!-- Step 2: Generated complaint text (hidden initially) -->
            <div id="report-step2" style="display:none;">
                <p style="font-size:13px; color:var(--muted); margin-bottom:8px;">{{ t.report_edit_hint }}</p>
                <textarea id="report-complaint-text" style="width:100%; min-height:320px; background:var(--bg); color:var(--text); border:1px solid var(--border); border-radius:6px; padding:12px; font-size:0.85em; font-family:'Consolas','Monaco',monospace; resize:vertical; line-height:1.5;"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-muted" onclick="closeReportModal()">{{ t.close }}</button>
            <button class="btn btn-accent" id="report-generate-btn" onclick="generateComplaint()">&#9998; {{ t.report_generate_letter }}</button>
            <button class="btn btn-accent" id="report-copy-btn" style="display:none;" onclick="copyComplaint()">&#128203; {{ t.report_copy_letter }}</button>
            <button class="btn btn-accent" id="report-pdf-btn" style="display:none;" onclick="downloadReport()">&#128196; {{ t.report_download_pdf }}</button>
        </div>
    </div>
</div>

<!-- Chart Zoom Modal -->
<div class="chart-zoom-overlay" id="chart-zoom-overlay" onclick="if(event.target===this)closeChartZoom()">
    <div class="chart-zoom-modal">
        <div class="modal-header">
            <h2 id="chart-zoom-title"></h2>
            <button class="modal-close" onclick="closeChartZoom()">&times;</button>
        </div>
        <canvas id="chart-zoom-canvas"></canvas>
    </div>
</div>

<!-- Export Modal -->
<div class="modal-overlay" id="export-modal">
    <div class="modal">
        <div class="modal-header">
            <h2>{{ t.export_title }}</h2>
            <button class="modal-close" onclick="closeExportModal()">&times;</button>
        </div>
        <p class="modal-hint">{{ t.export_hint }}</p>
        <div class="export-mode-selector" style="padding:0 1.5rem;display:flex;gap:1.2rem;margin-bottom:0.5rem;">
            <label style="display:flex;align-items:center;gap:0.4rem;cursor:pointer;">
                <input type="radio" name="export-mode" value="full" checked onchange="exportForLLM()">
                &#128202; {{ t.export_full }}
            </label>
            <label style="display:flex;align-items:center;gap:0.4rem;cursor:pointer;">
                <input type="radio" name="export-mode" value="update" onchange="exportForLLM()">
                &#9200; {{ t.export_update }}
            </label>
        </div>
        <div class="modal-body">
            <textarea id="export-text" readonly></textarea>
        </div>
        <div class="modal-footer">
            <button class="btn btn-muted" onclick="closeExportModal()">{{ t.close }}</button>
            <button class="btn btn-accent" id="export-copy-btn" onclick="copyExport()">{{ t.copy_clipboard }}</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js"
        integrity="sha384-jb8JQMbMoBUzgWatfe6COACi2ljcDdZQ2OxczGA3bGNeWe+6DChMTBJemed7ZnvJ"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"
        integrity="sha384-cVMg8E3QFwTvGCDuK+ET4PD341jF3W8nO1auiXfuZNQkzbUUiBGLsIQUE+b1mxws"
        crossorigin="anonymous"></script>
<script src="{{ url_for('static', filename='js/hero-chart.js') }}"></script>

{# ── Channel Health Donut Charts - Phase 3 Task 3.4 ── #}
<script>
(function() {
    'use strict';
    
    // Store chart instances globally to prevent memory leaks on refresh
    window.donutCharts = window.donutCharts || {};
    
    function renderDonut(canvasId) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) {
            console.warn('[ChannelHealth] Canvas element #' + canvasId + ' not found');
            return;
        }
        
        // Read health counts from data-attributes (updated on refresh)
        const container = ctx.parentElement;
        if (!container) {
            console.warn('[ChannelHealth] Container not found for #' + canvasId);
            return;
        }
        
        const counts = {
            good: parseInt(container.getAttribute('data-good') || '0', 10),
            warn: parseInt(container.getAttribute('data-warn') || '0', 10),
            crit: parseInt(container.getAttribute('data-crit') || '0', 10)
        };
        
        // Destroy existing chart instance to prevent rendering issues
        if (window.donutCharts[canvasId]) {
            window.donutCharts[canvasId].destroy();
            delete window.donutCharts[canvasId];
        }
        
        const total = counts.good + counts.warn + counts.crit;
        if (total === 0) {
            console.warn('[ChannelHealth] No data for ' + canvasId);
            return;
        }
        
        var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
        window.donutCharts[canvasId] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Good', 'Warning', 'Critical'],
                datasets: [{
                    data: [counts.good, counts.warn, counts.crit],
                    backgroundColor: [
                        'rgba(76, 175, 80, 0.8)',
                        'rgba(255, 152, 0, 0.8)',
                        'rgba(244, 67, 54, 0.8)'
                    ],
                    borderColor: [
                        'rgba(76, 175, 80, 1)',
                        'rgba(255, 152, 0, 1)',
                        'rgba(244, 67, 54, 1)'
                    ],
                    borderWidth: 2,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                cutout: '65%',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: isDark ? 'rgba(15,20,25,0.95)' : 'rgba(255,255,255,0.95)',
                        titleColor: isDark ? 'rgba(224,224,224,0.9)' : 'rgba(30,30,30,0.9)',
                        bodyColor: isDark ? 'rgba(224,224,224,0.8)' : 'rgba(30,30,30,0.8)',
                        borderColor: isDark ? 'rgba(168,85,247,0.3)' : 'rgba(168,85,247,0.4)',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return label + ': ' + value + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
    
    function initDonuts() {
        renderDonut('ds-health-donut');
        renderDonut('us-health-donut');
    }
    
    // Expose refresh function globally for manual updates (refreshData after innerHTML replace)
    window.refreshDonuts = initDonuts;
    
    // Wait for DOM to be fully loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDonuts);
    } else {
        // DOM already loaded (script deferred or loaded late)
        initDonuts();
    }
})();
</script>

<script>
var T = {{ t|tojson }};

(function() {
    'use strict';

    /* ── Theme ── */
    var saved = localStorage.getItem('docsis-theme');
    if (saved) document.documentElement.setAttribute('data-theme', saved);

    var themeToggle = document.getElementById('theme-toggle-sidebar');
    function updateThemeState() {
        var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
        themeToggle.checked = isDark;
    }
    updateThemeState();
    themeToggle.addEventListener('change', function() {
        var next = this.checked ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('docsis-theme', next);
        // Re-render charts with updated theme colors
        if (typeof window.refreshDonuts === 'function') {
            setTimeout(window.refreshDonuts, 50);
        }
    });

    /* ── State ── */
    var currentView = 'live';
    var charts = {};
    var _trendRange = 'day';
    var bqmDate = todayStr();
    var _bqmAvailableDates = new Set();
    var _bqmCalYear = new Date().getFullYear();
    var _bqmCalMonth = new Date().getMonth(); // 0-based
    var _bqmDatesLoaded = false;
    var _bqmLiveTimer = null;
    var _BQM_LIVE_INTERVAL = 300000; // 5 min
    var _bqmSlideshow = { playing: false, speed: 2000, range: [], currentIdx: 0, timer: null };
    var _bqmRangeStart = null;
    var _bqmRangeEnd = null;

    function todayStr() {
        var d = new Date();
        return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate());
    }
    function pad(n) { return n < 10 ? '0' + n : '' + n; }
    function formatDateDE(str) {
        var p = str.split('-');
        return p[2] + '.' + p[1] + '.' + p[0];
    }

    /* ── Sortable Tables ── */
    function initSortableTables() {
        document.querySelectorAll('table.sortable').forEach(function(table) {
            var headers = table.querySelectorAll('th');
            headers.forEach(function(th, colIdx) {
                th.addEventListener('click', function() {
                    sortTable(table, colIdx, th);
                });
            });
        });
    }
    initSortableTables();

    function sortTable(table, colIdx, th) {
        var tbody = table.querySelector('tbody');
        var rows = Array.from(tbody.querySelectorAll('tr'));
        var asc = th.getAttribute('data-sort-dir') !== 'asc';

        table.querySelectorAll('th').forEach(function(h) {
            h.removeAttribute('data-sort-dir');
            h.classList.remove('sort-asc', 'sort-desc');
        });
        th.setAttribute('data-sort-dir', asc ? 'asc' : 'desc');
        th.classList.add(asc ? 'sort-asc' : 'sort-desc');

        rows.sort(function(a, b) {
            var cellA = a.cells[colIdx];
            var cellB = b.cells[colIdx];
            var valA = cellA.getAttribute('data-sort') || cellA.textContent.trim();
            var valB = cellB.getAttribute('data-sort') || cellB.textContent.trim();
            var numA = parseFloat(valA);
            var numB = parseFloat(valB);
            if (!isNaN(numA) && !isNaN(numB)) {
                return asc ? numA - numB : numB - numA;
            }
            return asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
        });
        rows.forEach(function(row) { tbody.appendChild(row); });
    }

    /* ── Sidebar ── */
    var sidebar = document.getElementById('sidebar');
    var sidebarBackdrop = document.getElementById('sidebar-backdrop');

    function isMobile() { return window.matchMedia('(max-width: 900px)').matches; }

    function closeMobileSidebar() {
        sidebar.classList.remove('mobile-open');
        sidebarBackdrop.classList.remove('active');
    }

    function collapseSidebar() {
        if (isMobile()) {
            closeMobileSidebar();
        } else {
            sidebar.classList.add('collapsed');
            sidebar.classList.remove('mobile-open');
            sidebarBackdrop.classList.remove('active');
            var btn = document.getElementById('sidebar-collapse');
            btn.innerHTML = '&#10095;'; // Right arrow >
            btn.title = 'Expand';
        }
    }
    function expandSidebar() {
        sidebar.classList.remove('collapsed');
        var btn = document.getElementById('sidebar-collapse');
        btn.innerHTML = '&#10094;'; // Left arrow <
        btn.title = 'Collapse';
    }
    function toggleSidebar() {
        if (sidebar.classList.contains('collapsed')) {
            expandSidebar();
        } else {
            collapseSidebar();
        }
    }

    document.getElementById('sidebar-collapse').addEventListener('click', toggleSidebar);
    document.getElementById('hamburger').addEventListener('click', function() {
        if (isMobile()) {
            // On mobile, NEVER use .collapsed - always use .mobile-open
            sidebar.classList.remove('collapsed');
            var opening = !sidebar.classList.contains('mobile-open');
            sidebar.classList.toggle('mobile-open', opening);
            sidebarBackdrop.classList.toggle('active', opening);
        } else {
            sidebar.classList.toggle('collapsed');
        }
    });
    sidebarBackdrop.addEventListener('click', closeMobileSidebar);

    var sidebarLinks = document.querySelectorAll('.sidebar-link[data-view]');
    sidebarLinks.forEach(function(link) {
        link.addEventListener('click', function() {
            if (isMobile()) { closeMobileSidebar(); }
            switchView(this.getAttribute('data-view'));
        });
    });

    /* ── Pill tab helpers ── */
    window.selectPill = function(btn, callback) {
        btn.parentElement.querySelectorAll('.trend-tab').forEach(function(t) { t.classList.remove('active'); });
        btn.classList.add('active');
        if (callback) callback();
    };
    window.getPillValue = function(containerId) {
        var active = document.querySelector('#' + containerId + ' .trend-tab.active');
        return active ? active.dataset.value : null;
    };

    function switchView(view, skipHash) {
        currentView = view;
        if (!skipHash) location.hash = view === 'live' ? '' : view;
        sidebarLinks.forEach(function(l) {
            l.classList.toggle('active', l.getAttribute('data-view') === view);
        });
        var dashView = document.getElementById('view-dashboard');
        var trendView = document.getElementById('view-trends');
        var bqmView = document.getElementById('view-bqm');
        var speedtestView = document.getElementById('view-speedtest');
        var journalView = document.getElementById('view-journal');
        var eventsView = document.getElementById('view-events');
        var channelsView = document.getElementById('view-channels');
        var smokepingView = document.getElementById('view-smokeping');
        var correlationView = document.getElementById('view-correlation');
        var gamingView = document.getElementById('view-gaming');
        var bnetzView = document.getElementById('view-bnetz');
        dashView.classList.remove('active');
        trendView.classList.remove('active');
        if (bqmView) bqmView.classList.remove('active');
        if (smokepingView) smokepingView.classList.remove('active');
        if (speedtestView) speedtestView.classList.remove('active');
        if (journalView) journalView.classList.remove('active');
        if (eventsView) eventsView.classList.remove('active');
        if (channelsView) channelsView.classList.remove('active');
        if (correlationView) correlationView.classList.remove('active');
        if (gamingView) gamingView.classList.remove('active');
        if (bnetzView) bnetzView.classList.remove('active');
        stopAutoRefresh();
        stopBqmLiveRefresh();
        stopBqmSlideshow();
        if (view === 'live') {
            dashView.classList.add('active');
            startAutoRefresh();
        } else if (view === 'bqm') {
            if (bqmView) bqmView.classList.add('active');
            // Cross-view date linking (Phase 4)
            if (window._selectedDateRange) {
                _bqmRangeStart = window._selectedDateRange.start;
                _bqmRangeEnd = window._selectedDateRange.end;
                updateBqmRangeLabel();
            }
            if (!_bqmDatesLoaded) {
                initBqmCalendar();
            } else {
                renderBqmCalendar(_bqmCalYear, _bqmCalMonth);
            }
            if (bqmDate === todayStr()) {
                loadBqmLive();
                startBqmLiveRefresh();
            } else {
                loadBqmGraph(bqmDate);
            }
        } else if (view === 'smokeping') {
            if (smokepingView) smokepingView.classList.add('active');
            loadSmokepingGraphs();
        } else if (view === 'speedtest') {
            if (speedtestView) speedtestView.classList.add('active');
            loadSpeedtestHistory();
        } else if (view === 'journal') {
            if (journalView) journalView.classList.add('active');
            if (_timelineActive) closeIncidentTimeline();
            loadIncidents();
            loadJournal();
        } else if (view === 'events') {
            if (eventsView) eventsView.classList.add('active');
            loadEvents();
        } else if (view === 'channels') {
            if (channelsView) channelsView.classList.add('active');
            loadChannelList();
            var mode = getPillValue('channel-mode-tabs') || 'timeline';
            if (mode === 'compare') loadCompareChannelList();
        } else if (view === 'correlation') {
            if (correlationView) correlationView.classList.add('active');
            loadCorrelationData();
        } else if (view === 'gaming') {
            if (gamingView) gamingView.classList.add('active');
        } else if (view === 'bnetz') {
            if (bnetzView) bnetzView.classList.add('active');
            loadBnetzData();
        } else if (view === 'trends') {
            trendView.classList.add('active');
            updateTrendTabs();
            loadTrends(_trendRange);
        }
        
        // Re-initialize Lucide icons after view switch
        lucide.createIcons();
    }

    /* ── Trend Tabs ── */
    function updateTrendTabs() {
        document.querySelectorAll('#trend-tabs .trend-tab').forEach(function(btn) {
            btn.classList.toggle('active', btn.getAttribute('data-range') === _trendRange);
        });
    }
    document.querySelectorAll('#trend-tabs .trend-tab').forEach(function(btn) {
        btn.addEventListener('click', function() {
            _trendRange = this.getAttribute('data-range');
            updateTrendTabs();
            loadTrends(_trendRange);
        });
    });

    /* ── Hash-based view routing ── */
    var validViews = ['live', 'trends', 'bqm', 'smokeping', 'speedtest', 'journal', 'events', 'channels', 'correlation', 'gaming', 'bnetz'];
    function viewFromHash() {
        var h = location.hash.replace('#', '');
        return validViews.indexOf(h) !== -1 ? h : null;
    }
    window.addEventListener('hashchange', function() {
        var v = viewFromHash();
        if (v && v !== currentView) switchView(v, true);
    });

    /* ── BNetzA Breitbandmessung ── */
    function loadBnetzData() {
        var loading = document.getElementById('bnetz-loading');
        var empty = document.getElementById('bnetz-empty');
        var card = document.getElementById('bnetz-table-card');
        var tbody = document.getElementById('bnetz-tbody');
        if (!loading) return;
        loading.style.display = 'block';
        empty.style.display = 'none';
        card.style.display = 'none';
        fetch('/api/bnetz/measurements').then(function(r) { return r.json(); }).then(function(data) {
            loading.style.display = 'none';
            if (!data || data.length === 0) {
                empty.style.display = 'block';
                return;
            }
            card.style.display = 'block';
            tbody.innerHTML = '';
            data.forEach(function(m, idx) {
                var hasDeviation = m.verdict_download === 'deviation' || m.verdict_upload === 'deviation';
                var verdictText = hasDeviation ? T.bnetz_verdict_deviation : T.bnetz_verdict_ok;
                var verdictClass = hasDeviation ? 'val-crit' : 'val-good';
                var dlPct = m.download_max_tariff ? Math.round(m.download_measured_avg / m.download_max_tariff * 100) : 0;
                var ulPct = m.upload_max_tariff ? Math.round(m.upload_measured_avg / m.upload_max_tariff * 100) : 0;
                var hasMeasurements = m.measurements && (
                    (m.measurements.download && m.measurements.download.length > 0) ||
                    (m.measurements.upload && m.measurements.upload.length > 0));
                var tr = document.createElement('tr');
                tr.style.cursor = hasMeasurements ? 'pointer' : 'default';
                tr.setAttribute('data-bnetz-idx', idx);
                if (hasMeasurements) {
                    tr.onclick = function() { toggleBnetzDetail(idx); };
                }
                var complaintBtn = '';
                if (hasDeviation) {
                    complaintBtn = '<a href="javascript:void(0)" onclick="generateBnetzComplaint(' + m.id + ')" ' +
                        'title="' + (T.bnetz_generate_complaint || 'Generate complaint') + '" ' +
                        'style="margin-right:8px;">&#9998;</a>';
                }
                tr.innerHTML = '<td>' + (hasMeasurements ? '<span class="bnetz-expand-arrow" id="bnetz-arrow-' + idx + '">&#9654;</span> ' : '') + m.date + '</td>' +
                    '<td>' + (m.provider || '-') + '</td>' +
                    '<td>' + Math.round(m.download_max_tariff || 0) + ' Mbit/s</td>' +
                    '<td>' + Math.round(m.download_measured_avg || 0) + ' Mbit/s (' + dlPct + '%)</td>' +
                    '<td>' + Math.round(m.upload_max_tariff || 0) + ' Mbit/s</td>' +
                    '<td>' + Math.round(m.upload_measured_avg || 0) + ' Mbit/s (' + ulPct + '%)</td>' +
                    '<td class="' + verdictClass + '">' + verdictText + '</td>' +
                    '<td style="white-space:nowrap;" onclick="event.stopPropagation();">' +
                        complaintBtn +
                        (m.source !== 'csv_import' ? '<a href="/api/bnetz/pdf/' + m.id + '" title="PDF" style="margin-right:8px;">&#128196;</a>' : '') +
                        '<a href="javascript:void(0)" onclick="deleteBnetzFromView(' + m.id + ')" title="' + (T.delete_incident || 'Delete') + '">&#128465;</a>' +
                    '</td>';
                tbody.appendChild(tr);
                // Detail expand row (hidden by default)
                if (hasMeasurements) {
                    var detailTr = document.createElement('tr');
                    detailTr.id = 'bnetz-detail-' + idx;
                    detailTr.style.display = 'none';
                    var detailTd = document.createElement('td');
                    detailTd.colSpan = 8;
                    detailTd.style.padding = '0 8px 12px 24px';
                    detailTd.innerHTML = buildBnetzDetailHtml(m);
                    detailTr.appendChild(detailTd);
                    tbody.appendChild(detailTr);
                }
            });
            lucide.createIcons();
        }).catch(function() {
            loading.style.display = 'none';
            empty.style.display = 'block';
            empty.textContent = 'Error loading data';
        });

        /* Fetch watcher status for the banner */
        var watcherBanner = document.getElementById('bnetz-watcher-status');
        var watcherText = document.getElementById('bnetz-watcher-text');
        if (watcherBanner) {
            fetch('/api/collectors/status').then(function(r) { return r.json(); }).then(function(collectors) {
                var watcher = null;
                for (var i = 0; i < collectors.length; i++) {
                    if (collectors[i].name === 'bnetz_watcher') { watcher = collectors[i]; break; }
                }
                if (watcher && watcher.enabled) {
                    watcherBanner.style.display = 'flex';
                    var parts = [(T.bnetz_watcher_active || 'File watcher active')];
                    if (watcher.watch_dir) parts.push((T.bnetz_watcher_watching || 'Watching {dir}').replace('{dir}', watcher.watch_dir));
                    if (watcher.last_import_count > 0) parts.push((T.bnetz_watcher_last_import || '{count} file(s) imported').replace('{count}', watcher.last_import_count));
                    if (watcher.next_poll_in > 0) parts.push('Next check in ' + Math.round(watcher.next_poll_in / 60) + 'min');
                    watcherText.textContent = parts.join(' · ');
                    lucide.createIcons();
                } else {
                    watcherBanner.style.display = 'none';
                }
            }).catch(function() { watcherBanner.style.display = 'none'; });
        }
    }

    function toggleBnetzDetail(idx) {
        var row = document.getElementById('bnetz-detail-' + idx);
        var arrow = document.getElementById('bnetz-arrow-' + idx);
        if (!row) return;
        var isOpen = row.style.display !== 'none';
        row.style.display = isOpen ? 'none' : 'table-row';
        if (arrow) arrow.innerHTML = isOpen ? '&#9654;' : '&#9660;';
    }

    function buildBnetzDetailHtml(m) {
        var ms = m.measurements || {};
        var dlList = ms.download || [];
        var ulList = ms.upload || [];
        var html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:8px;">';
        // Download measurements
        if (dlList.length > 0) {
            html += '<div><strong style="font-size:0.85em;color:var(--text-secondary);">' + (T.download || 'Download') + '</strong>';
            html += '<table style="width:100%;font-size:0.8em;border-collapse:collapse;margin-top:4px;">';
            html += '<tr style="color:var(--text-secondary);border-bottom:1px solid var(--card-border);">' +
                '<th style="text-align:left;padding:3px 6px;">' + (T.bnetz_measurement_nr || 'Nr.') + '</th>' +
                '<th style="text-align:left;padding:3px 6px;">' + (T.bnetz_measurement_time || 'Time') + '</th>' +
                '<th style="text-align:right;padding:3px 6px;">' + (T.bnetz_measurement_speed || 'Speed') + '</th></tr>';
            dlList.forEach(function(meas, i) {
                var speed = meas.speed || meas.value || 0;
                var color = 'var(--text)';
                if (m.download_min_tariff && speed < m.download_min_tariff) color = 'var(--crit)';
                else if (m.download_normal_tariff && speed < m.download_normal_tariff) color = 'var(--warn, orange)';
                html += '<tr style="border-bottom:1px solid var(--card-border);">' +
                    '<td style="padding:3px 6px;">' + (i + 1) + '</td>' +
                    '<td style="padding:3px 6px;">' + (meas.date || '') + ' ' + (meas.time || '') + '</td>' +
                    '<td style="text-align:right;padding:3px 6px;color:' + color + ';">' + (typeof speed === 'number' ? speed.toFixed(1) : speed) + ' Mbit/s</td></tr>';
            });
            html += '</table></div>';
        }
        // Upload measurements
        if (ulList.length > 0) {
            html += '<div><strong style="font-size:0.85em;color:var(--text-secondary);">' + (T.upload || 'Upload') + '</strong>';
            html += '<table style="width:100%;font-size:0.8em;border-collapse:collapse;margin-top:4px;">';
            html += '<tr style="color:var(--text-secondary);border-bottom:1px solid var(--card-border);">' +
                '<th style="text-align:left;padding:3px 6px;">' + (T.bnetz_measurement_nr || 'Nr.') + '</th>' +
                '<th style="text-align:left;padding:3px 6px;">' + (T.bnetz_measurement_time || 'Time') + '</th>' +
                '<th style="text-align:right;padding:3px 6px;">' + (T.bnetz_measurement_speed || 'Speed') + '</th></tr>';
            ulList.forEach(function(meas, i) {
                var speed = meas.speed || meas.value || 0;
                var color = 'var(--text)';
                if (m.upload_min_tariff && speed < m.upload_min_tariff) color = 'var(--crit)';
                else if (m.upload_normal_tariff && speed < m.upload_normal_tariff) color = 'var(--warn, orange)';
                html += '<tr style="border-bottom:1px solid var(--card-border);">' +
                    '<td style="padding:3px 6px;">' + (i + 1) + '</td>' +
                    '<td style="padding:3px 6px;">' + (meas.date || '') + ' ' + (meas.time || '') + '</td>' +
                    '<td style="text-align:right;padding:3px 6px;color:' + color + ';">' + (typeof speed === 'number' ? speed.toFixed(1) : speed) + ' Mbit/s</td></tr>';
            });
            html += '</table></div>';
        }
        html += '</div>';
        return html;
    }

    function uploadBnetzFromView(input) {
        if (!input.files || !input.files[0]) return;
        var fd = new FormData();
        fd.append('file', input.files[0]);
        fetch('/api/bnetz/upload', {method: 'POST', body: fd})
            .then(function(r) { return r.json(); })
            .then(function(data) {
                input.value = '';
                if (data.error) { alert(data.error); return; }
                loadBnetzData();
            })
            .catch(function(e) { alert('Upload failed: ' + e); input.value = ''; });
    }

    function deleteBnetzFromView(id) {
        if (!confirm(T.bnetz_delete_confirm)) return;
        fetch('/api/bnetz/' + id, {method: 'DELETE'})
            .then(function() { loadBnetzData(); });
    }

    /* ── BQM Calendar Navigation ── */
    function fetchBqmDates(cb) {
        fetch('/api/bqm/dates').then(function(r) { return r.json(); }).then(function(dates) {
            _bqmAvailableDates = new Set(dates);
            _bqmDatesLoaded = true;
            if (cb) cb();
        }).catch(function() { _bqmDatesLoaded = true; if (cb) cb(); });
    }

    function renderBqmCalendar(year, month) {
        var grid = document.getElementById('bqm-calendar-grid');
        var label = document.getElementById('bqm-month-label');
        if (!grid || !label) return;
        var monthNames = T.month_names || ['January','February','March','April','May','June','July','August','September','October','November','December'];
        label.textContent = monthNames[month] + ' ' + year;
        grid.innerHTML = '';
        var firstDay = new Date(year, month, 1);
        // Monday-start: 0=Mon..6=Sun
        var startDow = (firstDay.getDay() + 6) % 7;
        var daysInMonth = new Date(year, month + 1, 0).getDate();
        var today = todayStr();
        // Fill leading empty cells
        for (var e = 0; e < startDow; e++) {
            var empty = document.createElement('div');
            empty.className = 'bqm-day other-month';
            grid.appendChild(empty);
        }
        for (var d = 1; d <= daysInMonth; d++) {
            var dateStr = year + '-' + pad(month + 1) + '-' + pad(d);
            var cell = document.createElement('div');
            cell.className = 'bqm-day';
            cell.textContent = d;
            cell.setAttribute('data-date', dateStr);
            if (_bqmAvailableDates.has(dateStr)) cell.classList.add('has-data');
            if (dateStr === today) cell.classList.add('today');
            if (dateStr === bqmDate) cell.classList.add('selected');
            // Range highlighting
            if (_bqmRangeStart && _bqmRangeEnd) {
                if (dateStr === _bqmRangeStart) cell.classList.add('range-start');
                else if (dateStr === _bqmRangeEnd) cell.classList.add('range-end');
                else if (dateStr > _bqmRangeStart && dateStr < _bqmRangeEnd) cell.classList.add('in-range');
            }
            cell.addEventListener('click', (function(ds, ev) {
                return function(e) {
                    if (!_bqmAvailableDates.has(ds)) return;
                    if (e.shiftKey && bqmDate) {
                        // Range selection
                        var a = bqmDate < ds ? bqmDate : ds;
                        var b = bqmDate < ds ? ds : bqmDate;
                        _bqmRangeStart = a;
                        _bqmRangeEnd = b;
                        updateBqmRangeLabel();
                        renderBqmCalendar(_bqmCalYear, _bqmCalMonth);
                    } else {
                        _bqmRangeStart = null;
                        _bqmRangeEnd = null;
                        selectBqmDate(ds);
                    }
                };
            })(dateStr));
            grid.appendChild(cell);
        }
    }

    function selectBqmDate(date) {
        bqmDate = date;
        stopBqmSlideshow();
        renderBqmCalendar(_bqmCalYear, _bqmCalMonth);
        if (date === todayStr()) {
            loadBqmLive();
        } else {
            hideBqmLiveBadge();
            loadBqmGraph(date);
        }
    }

    function bqmMonthNav(dir) {
        _bqmCalMonth += dir;
        if (_bqmCalMonth < 0) { _bqmCalMonth = 11; _bqmCalYear--; }
        if (_bqmCalMonth > 11) { _bqmCalMonth = 0; _bqmCalYear++; }
        renderBqmCalendar(_bqmCalYear, _bqmCalMonth);
    }

    function initBqmCalendar() {
        // Set calendar month to match selected date
        var d = new Date(bqmDate + 'T12:00:00');
        _bqmCalYear = d.getFullYear();
        _bqmCalMonth = d.getMonth();
        fetchBqmDates(function() {
            renderBqmCalendar(_bqmCalYear, _bqmCalMonth);
        });
    }

    // Quick-jump buttons
    var bqmTodayBtn = document.getElementById('bqm-today-btn');
    var bqmYesterdayBtn = document.getElementById('bqm-yesterday-btn');
    if (bqmTodayBtn) bqmTodayBtn.addEventListener('click', function() {
        var t = todayStr();
        _bqmCalYear = new Date().getFullYear();
        _bqmCalMonth = new Date().getMonth();
        selectBqmDate(t);
    });
    if (bqmYesterdayBtn) bqmYesterdayBtn.addEventListener('click', function() {
        var d = new Date(); d.setDate(d.getDate() - 1);
        var yd = d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate());
        _bqmCalYear = d.getFullYear();
        _bqmCalMonth = d.getMonth();
        selectBqmDate(yd);
    });

    // Month nav
    var bqmMonthPrev = document.getElementById('bqm-month-prev');
    var bqmMonthNext = document.getElementById('bqm-month-next');
    if (bqmMonthPrev) bqmMonthPrev.addEventListener('click', function() { bqmMonthNav(-1); });
    if (bqmMonthNext) bqmMonthNext.addEventListener('click', function() { bqmMonthNav(1); });

    /* ── BQM Live Refresh ── */
    function loadBqmLive() {
        var img = document.getElementById('bqm-image');
        var noData = document.getElementById('bqm-no-data');
        var card = document.getElementById('bqm-card');
        if (!img || !noData) return;
        if (card) card.style.display = 'none';
        noData.style.display = 'none';
        fetch('/api/bqm/live').then(function(r) {
            if (!r.ok) throw new Error('Live fetch failed');
            var source = r.headers.get('X-BQM-Source') || 'cached';
            var ts = r.headers.get('X-BQM-Timestamp');
            return r.blob().then(function(blob) {
                return { blob: blob, source: source, timestamp: ts };
            });
        }).then(function(data) {
            var url = URL.createObjectURL(data.blob);
            img.onload = function() {
                if (card) card.style.display = 'block';
                URL.revokeObjectURL(url);
            };
            img.onerror = function() {
                if (card) card.style.display = 'none';
                noData.textContent = T.bqm_no_data || 'No BQM graph for this date.';
                noData.style.display = 'block';
                URL.revokeObjectURL(url);
            };
            img.src = url;
            showBqmLiveBadge(data.source, data.timestamp);
        }).catch(function() {
            // Fallback to cached
            hideBqmLiveBadge();
            loadBqmGraph(todayStr());
        });
    }

    function showBqmLiveBadge(source, timestamp) {
        var badge = document.getElementById('bqm-live-badge');
        var updated = document.getElementById('bqm-last-updated');
        if (badge) badge.style.display = source === 'live' ? 'inline' : 'none';
        if (updated && timestamp) {
            var d = new Date(timestamp);
            updated.textContent = (T.bqm_last_updated || 'Last updated') + ': ' + d.toLocaleTimeString();
            updated.style.display = 'inline';
        }
    }

    function hideBqmLiveBadge() {
        var badge = document.getElementById('bqm-live-badge');
        var updated = document.getElementById('bqm-last-updated');
        if (badge) badge.style.display = 'none';
        if (updated) updated.style.display = 'none';
    }

    function startBqmLiveRefresh() {
        stopBqmLiveRefresh();
        if (bqmDate === todayStr()) {
            _bqmLiveTimer = setInterval(function() {
                if (currentView !== 'bqm' || document.hidden || bqmDate !== todayStr()) return;
                loadBqmLive();
            }, _BQM_LIVE_INTERVAL);
        }
    }

    function stopBqmLiveRefresh() {
        if (_bqmLiveTimer) { clearInterval(_bqmLiveTimer); _bqmLiveTimer = null; }
    }

    /* ── BQM Slideshow ── */
    function getBqmRangeDates() {
        if (!_bqmRangeStart || !_bqmRangeEnd) {
            // Use all available dates
            return Array.from(_bqmAvailableDates).sort();
        }
        return Array.from(_bqmAvailableDates).filter(function(d) {
            return d >= _bqmRangeStart && d <= _bqmRangeEnd;
        }).sort();
    }

    function startBqmSlideshow() {
        var dates = getBqmRangeDates();
        if (dates.length === 0) return;
        _bqmSlideshow.range = dates;
        _bqmSlideshow.currentIdx = 0;
        _bqmSlideshow.playing = true;
        updateBqmSlideshowUI();
        selectBqmSlideshowFrame();
        _bqmSlideshow.timer = setInterval(function() {
            _bqmSlideshow.currentIdx++;
            if (_bqmSlideshow.currentIdx >= _bqmSlideshow.range.length) {
                _bqmSlideshow.currentIdx = 0; // loop
            }
            selectBqmSlideshowFrame();
        }, _bqmSlideshow.speed);
    }

    function pauseBqmSlideshow() {
        if (_bqmSlideshow.timer) { clearInterval(_bqmSlideshow.timer); _bqmSlideshow.timer = null; }
        _bqmSlideshow.playing = false;
        updateBqmSlideshowUI();
    }

    function stopBqmSlideshow() {
        if (_bqmSlideshow.timer) { clearInterval(_bqmSlideshow.timer); _bqmSlideshow.timer = null; }
        _bqmSlideshow.playing = false;
        _bqmSlideshow.range = [];
        _bqmSlideshow.currentIdx = 0;
        updateBqmSlideshowUI();
    }

    function selectBqmSlideshowFrame() {
        var date = _bqmSlideshow.range[_bqmSlideshow.currentIdx];
        if (!date) return;
        bqmDate = date;
        // Update calendar to show the month of the current frame
        var d = new Date(date + 'T12:00:00');
        _bqmCalYear = d.getFullYear();
        _bqmCalMonth = d.getMonth();
        renderBqmCalendar(_bqmCalYear, _bqmCalMonth);
        hideBqmLiveBadge();
        loadBqmGraph(date);
    }

    function updateBqmSlideshowUI() {
        var playBtn = document.getElementById('bqm-play-btn');
        var stopBtn = document.getElementById('bqm-stop-btn');
        if (!playBtn) return;
        if (_bqmSlideshow.playing) {
            // Show pause icon
            playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><rect x="5" y="4" width="4" height="16" rx="1"/><rect x="15" y="4" width="4" height="16" rx="1"/></svg>';
            playBtn.classList.add('playing');
            playBtn.title = T.bqm_pause || 'Pause';
            if (stopBtn) stopBtn.style.display = 'inline-flex';
        } else {
            // Show play icon
            playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><polygon points="6,4 20,12 6,20"/></svg>';
            playBtn.classList.remove('playing');
            playBtn.title = T.bqm_play || 'Play';
            if (stopBtn) stopBtn.style.display = _bqmSlideshow.range.length ? 'inline-flex' : 'none';
        }
    }

    function updateBqmRangeLabel() {
        var label = document.getElementById('bqm-range-label');
        if (!label) return;
        if (_bqmRangeStart && _bqmRangeEnd) {
            var count = getBqmRangeDates().length;
            label.textContent = formatDateDE(_bqmRangeStart) + ' \u2013 ' + formatDateDE(_bqmRangeEnd) + ' (' + count + ')';
        } else {
            label.textContent = '';
        }
    }

    // Play/Pause button
    var bqmPlayBtn = document.getElementById('bqm-play-btn');
    if (bqmPlayBtn) bqmPlayBtn.addEventListener('click', function() {
        if (_bqmSlideshow.playing) {
            pauseBqmSlideshow();
        } else {
            startBqmSlideshow();
        }
    });

    // Stop button
    var bqmStopBtn = document.getElementById('bqm-stop-btn');
    if (bqmStopBtn) bqmStopBtn.addEventListener('click', function() {
        stopBqmSlideshow();
    });

    // Speed tabs
    var bqmSpeedTabs = document.querySelectorAll('#bqm-speed-tabs .trend-tab');
    bqmSpeedTabs.forEach(function(btn) {
        btn.addEventListener('click', function() {
            _bqmSlideshow.speed = parseInt(this.getAttribute('data-speed'), 10);
            bqmSpeedTabs.forEach(function(b) { b.classList.remove('active'); });
            this.classList.add('active');
            if (_bqmSlideshow.playing) {
                pauseBqmSlideshow();
                startBqmSlideshow();
            }
        });
    });

    /* ── Auto Refresh with Countdown ── */
    var refreshTimer = null;
    var countdownTimer = null;
    var countdownSeconds = 60;
    var REFRESH_INTERVAL = 60;
    var countdownEl = document.getElementById('topbar-countdown');

    function updateCountdown() {
        if (countdownEl) countdownEl.textContent = countdownSeconds + 's';
    }

    function startAutoRefresh() {
        stopAutoRefresh();
        countdownSeconds = REFRESH_INTERVAL;
        updateCountdown();
        countdownTimer = setInterval(function() {
            if (currentView !== 'live' || document.hidden) return;
            countdownSeconds--;
            if (countdownSeconds <= 0) {
                countdownSeconds = REFRESH_INTERVAL;
                refreshData();
            }
            updateCountdown();
        }, 1000);
    }
    function stopAutoRefresh() {
        if (countdownTimer) { clearInterval(countdownTimer); countdownTimer = null; }
        if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; }
    }

    function refreshData() {
        fetch(window.location.href)
            .then(function(r) { return r.text(); })
            .then(function(html) {
                var doc = new DOMParser().parseFromString(html, 'text/html');

                // Save expanded metric cards by index
                var openCardIndices = [];
                document.querySelectorAll('.metric-card').forEach(function(el, i) {
                    if (el.classList.contains('open')) openCardIndices.push(i);
                });

                // Save expanded channel groups by label text
                var openGroupLabels = [];
                document.querySelectorAll('details.channel-group[open]').forEach(function(el) {
                    var s = el.querySelector('summary');
                    if (s) openGroupLabels.push(s.textContent.trim());
                });

                // Replace dashboard content
                var freshDash = doc.querySelector('#view-dashboard');
                var currentDash = document.querySelector('#view-dashboard');
                if (freshDash && currentDash) {
                    currentDash.innerHTML = freshDash.innerHTML;
                }

                // Update topbar timestamp
                var freshMeta = doc.querySelector('#topbar-meta');
                var currentMeta = document.querySelector('#topbar-meta');
                if (freshMeta && currentMeta) {
                    currentMeta.innerHTML = freshMeta.innerHTML;
                }

                // Reset countdown after refresh
                countdownSeconds = REFRESH_INTERVAL;
                updateCountdown();

                // Restore expanded metric cards
                document.querySelectorAll('.metric-card').forEach(function(el, i) {
                    if (openCardIndices.indexOf(i) !== -1) el.classList.add('open');
                });

                // Restore expanded channel groups
                document.querySelectorAll('details.channel-group').forEach(function(el) {
                    var s = el.querySelector('summary');
                    if (s && openGroupLabels.indexOf(s.textContent.trim()) !== -1) {
                        el.setAttribute('open', '');
                    }
                });

                // Re-init sortable tables (event listeners lost on innerHTML replace)
                initSortableTables();

                // Re-init hero chart (Chart.js instance lost on innerHTML replace)
                if (typeof window.refreshHeroChart === 'function') {
                    window.refreshHeroChart();
                }

                // Re-init channel health donuts (Chart.js instances lost on innerHTML replace)
                if (typeof window.refreshDonuts === 'function') {
                    window.refreshDonuts();
                }

                // Re-init Lucide icons (lost on innerHTML replace)
                lucide.createIcons();

                // Refresh event badge count
                fetch('/api/events/count')
                    .then(function(r) { return r.json(); })
                    .then(function(d) { updateEventBadge(d.count || 0); })
                    .catch(function() {});
            })
            .catch(function(err) {
                console.warn('Auto-refresh failed:', err);
            });
    }

    if (currentView === 'live') startAutoRefresh();

    /* ── Manual Poll (Refresh Button) ── */
    var refreshBtn = document.getElementById('refresh-btn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            if (refreshBtn.disabled) return;
            refreshBtn.disabled = true;
            refreshBtn.classList.add('spinning');
            fetch('/api/poll', {method: 'POST'})
                .then(function(r) { return r.json().then(function(d) { return {status: r.status, data: d}; }); })
                .then(function(res) {
                    if (res.data.success) {
                        showToast(T.refresh_success || 'Data updated', 'success');
                        refreshData();
                    } else {
                        showToast(res.data.error || 'Error', res.status === 429 ? 'error' : 'error');
                    }
                })
                .catch(function() { showToast(T.network_error || 'Error', 'error'); })
                .finally(function() {
                    refreshBtn.classList.remove('spinning');
                    setTimeout(function() { refreshBtn.disabled = false; }, 10000);
                });
        });
    }

    function showToast(msg, type) {
        var toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.className = 'toast toast-' + (type || 'success') + ' show';
        setTimeout(function() { toast.classList.remove('show'); }, 3000);
    }

    /* ── Trend Charts ── */

    var _tempOverlayVisible = true;
    var _lastTrendData = null;
    var _lastTrendWeather = null;
    var _lastTrendRange = 'day';

    function _getWeatherRange(range, date) {
        var d = new Date(date + 'T00:00:00');
        var end = date + ' 23:59:59Z';
        var start;
        if (range === 'day') {
            start = date + ' 00:00:00Z';
        } else if (range === 'week') {
            var s = new Date(d.getTime() - 6 * 86400000);
            start = s.toISOString().substring(0, 10) + ' 00:00:00Z';
        } else {
            var s = new Date(d.getTime() - 29 * 86400000);
            start = s.toISOString().substring(0, 10) + ' 00:00:00Z';
        }
        return { start: start, end: end };
    }

    function _alignWeatherToTrends(trendData, weatherData, range) {
        if (!weatherData || weatherData.length === 0) return null;
        var temps = [];
        if (range === 'day') {
            for (var i = 0; i < trendData.length; i++) {
                if (!trendData[i].timestamp) { temps.push(null); continue; }
                var tTs = new Date(trendData[i].timestamp).getTime();
                var best = null, bestDist = Infinity;
                for (var j = 0; j < weatherData.length; j++) {
                    var wTs = new Date(weatherData[j].timestamp).getTime();
                    var dist = Math.abs(wTs - tTs);
                    if (dist < bestDist) { bestDist = dist; best = weatherData[j].temperature; }
                }
                temps.push(bestDist <= 5400000 ? best : null);
            }
        } else {
            var dailyTemps = {};
            for (var j = 0; j < weatherData.length; j++) {
                var day = weatherData[j].timestamp.substring(0, 10);
                if (!dailyTemps[day]) dailyTemps[day] = [];
                dailyTemps[day].push(weatherData[j].temperature);
            }
            var dailyAvg = {};
            for (var day in dailyTemps) {
                var sum = 0;
                for (var k = 0; k < dailyTemps[day].length; k++) sum += dailyTemps[day][k];
                dailyAvg[day] = Math.round(sum / dailyTemps[day].length * 10) / 10;
            }
            for (var i = 0; i < trendData.length; i++) {
                var date = trendData[i].date || (trendData[i].timestamp ? trendData[i].timestamp.substring(0, 10) : '');
                temps.push(dailyAvg[date] !== undefined ? dailyAvg[date] : null);
            }
        }
        return temps;
    }

    function _renderTrendCharts() {
        var data = _lastTrendData;
        var range = _lastTrendRange;
        if (!data || data.length === 0) return;
        var xLabels = data.map(function(d) {
            if (!d.timestamp) return '';
            if (range === 'day') return d.timestamp.substring(11, 16);
            if (range === 'week') return d.timestamp.substring(5, 16).replace('T', ' ');
            return d.date ? formatDateDE(d.date) : formatDateDE(d.timestamp.substring(0, 10));
        });
        var tempOpts = (_lastTrendWeather && _lastTrendWeather.length > 0) ? { tempData: _lastTrendWeather } : null;
        renderChart('chart-ds-power', xLabels,
            [{label: 'DS Power Avg', data: data.map(function(d){ return d.ds_power_avg; }), color: '#a855f7'}],
            null, DS_POWER_THRESHOLDS, tempOpts);
        renderChart('chart-ds-snr', xLabels,
            [{label: 'DS SNR Avg', data: data.map(function(d){ return d.ds_snr_avg; }), color: '#a855f7'}],
            null, DS_SNR_THRESHOLDS, tempOpts);
        renderChart('chart-us-power', xLabels,
            [{label: 'US Power Avg', data: data.map(function(d){ return d.us_power_avg; }), color: '#a855f7'}],
            null, US_POWER_THRESHOLDS, tempOpts);
        renderChart('chart-errors', xLabels, [
            {label: T.correctable, data: data.map(function(d){ return d.ds_correctable_errors; }), color: '#2196f3'},
            {label: T.uncorrectable, data: data.map(function(d){ return d.ds_uncorrectable_errors; }), color: '#f44336'}
        ], 'bar');
    }

    function loadTrends(range) {
        var date = todayStr();
        var title = document.getElementById('trend-title');
        var noData = document.getElementById('trend-no-data');
        var grid = document.getElementById('charts-grid');
        var labels = {day: T.day_trend, week: T.week_trend, month: T.month_trend};
        title.textContent = (labels[range] || 'Trend') + ' - ' + formatDateDE(date);
        _lastTrendRange = range;

        var wr = _getWeatherRange(range, date);
        var trendsUrl = '/api/trends?range=' + range + '&date=' + date;
        var weatherUrl = '/api/weather/range?start=' + encodeURIComponent(wr.start) + '&end=' + encodeURIComponent(wr.end);

        Promise.all([
            fetch(trendsUrl).then(function(r) { return r.json(); }),
            fetch(weatherUrl).then(function(r) { return r.json(); }).catch(function() { return []; })
        ]).then(function(results) {
                var data = results[0];
                var weatherData = results[1];
                if (!data || data.length === 0) {
                    noData.textContent = T.no_data;
                    noData.style.display = 'block';
                    grid.style.display = 'none';
                    _lastTrendData = null;
                    _lastTrendWeather = null;
                    _updateTempToggle();
                    return;
                }
                noData.style.display = 'none';
                grid.style.display = '';
                _lastTrendData = data;
                _lastTrendWeather = _alignWeatherToTrends(data, weatherData, range);
                _updateTempToggle();
                _renderTrendCharts();
            })
            .catch(function() {
                noData.textContent = T.trend_error;
                noData.style.display = 'block';
                grid.style.display = 'none';
            });
    }

    function _updateTempToggle() {
        var btn = document.getElementById('temp-toggle-btn');
        if (!btn) return;
        var hasWeather = _lastTrendWeather && _lastTrendWeather.some(function(v) { return v !== null; });
        btn.style.display = hasWeather ? '' : 'none';
        btn.classList.toggle('active', _tempOverlayVisible && hasWeather);
        btn.title = _tempOverlayVisible ? (T.temp_overlay_hide || 'Hide temperature overlay') : (T.temp_overlay_show || 'Show temperature overlay');
    }

    (function() {
        var btn = document.getElementById('temp-toggle-btn');
        if (btn) {
            btn.addEventListener('click', function() {
                _tempOverlayVisible = !_tempOverlayVisible;
                _updateTempToggle();
                _renderTrendCharts();
            });
        }
    })();

    var zonesPlugin = {
        id: 'zones',
        beforeDatasetsDraw: function(chart) {
            var zones = chart._docsightZones;
            if (!zones) return;
            var ctx = chart.ctx;
            var yAxis = chart.scales.y;
            var chartArea = chart.chartArea;
            ctx.save();
            ctx.beginPath();
            ctx.rect(chartArea.left, chartArea.top, chartArea.right - chartArea.left, chartArea.bottom - chartArea.top);
            ctx.clip();
            var drawn = {};
            zones.forEach(function(z) {
                if (z.yMin !== undefined) return; /* skip metadata entries */
                if (z.fill !== false) {
                    var top = yAxis.getPixelForValue(z.max);
                    var bottom = yAxis.getPixelForValue(z.min);
                    ctx.fillStyle = z.color;
                    ctx.fillRect(chartArea.left, top, chartArea.right - chartArea.left, bottom - top);
                }
                var lineColor = z.lineColor || z.color.replace(/[\d.]+\)$/, '0.7)');
                var vals = z.fill === false ? [z.value] : [z.min, z.max];
                vals.forEach(function(val) {
                    if (val === undefined || drawn[val]) return;
                    drawn[val] = true;
                    var py = yAxis.getPixelForValue(val);
                    ctx.beginPath();
                    ctx.setLineDash([6, 4]);
                    ctx.strokeStyle = lineColor;
                    ctx.lineWidth = 1;
                    ctx.moveTo(chartArea.left, py);
                    ctx.lineTo(chartArea.right, py);
                    ctx.stroke();
                });
            });
            ctx.restore();
        }
    };

    var DS_POWER_THRESHOLDS = [
        {value: -4, fill: false, lineColor: 'rgba(76,175,80,0.5)'},
        {value: 13, fill: false, lineColor: 'rgba(76,175,80,0.5)'},
        {value: -8, fill: false, lineColor: 'rgba(255,152,0,0.5)'},
        {value: 20, fill: false, lineColor: 'rgba(255,152,0,0.5)'},
        {value: -15, fill: false, lineColor: 'rgba(244,67,54,0.4)'},
        {value: 25, fill: false, lineColor: 'rgba(244,67,54,0.4)'},
        {yMin: -18, yMax: 28}
    ];
    var DS_SNR_THRESHOLDS = [
        {value: 33, fill: false, lineColor: 'rgba(76,175,80,0.5)'},
        {value: 29, fill: false, lineColor: 'rgba(255,152,0,0.5)'},
        {value: 25, fill: false, lineColor: 'rgba(244,67,54,0.4)'},
        {yMin: 20, yMax: 50}
    ];
    var US_POWER_THRESHOLDS = [
        {value: 41, fill: false, lineColor: 'rgba(76,175,80,0.5)'},
        {value: 47, fill: false, lineColor: 'rgba(76,175,80,0.5)'},
        {value: 35, fill: false, lineColor: 'rgba(255,152,0,0.5)'},
        {value: 53, fill: false, lineColor: 'rgba(255,152,0,0.5)'},
        {value: 20, fill: false, lineColor: 'rgba(244,67,54,0.4)'},
        {value: 60, fill: false, lineColor: 'rgba(244,67,54,0.4)'},
        {yMin: 17, yMax: 63}
    ];

    function renderChart(canvasId, labels, datasets, type, zones, opts) {
        if (charts[canvasId]) charts[canvasId].destroy();
        var ctx = document.getElementById(canvasId);
        if (!ctx) return;
        var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
        var gridColor = isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)';
        var textColor = isDark ? '#888' : '#666';

        var chartDatasets = datasets.map(function(ds, idx) {
            var r = {
                label: ds.label, data: ds.data,
                borderColor: type === 'bar' ? ds.color : (ds.color || 'rgba(168,85,247,0.9)'),
                backgroundColor: type === 'bar' ? ds.color + 'cc' : 'transparent',
                borderWidth: type === 'bar' ? 3 : 2,
                tension: type === 'bar' ? 0 : 0.4,
                pointRadius: labels.length > 30 ? 0 : 3,
                fill: false
            };
            if (ds.stepped) { r.stepped = 'before'; r.tension = 0; }
            if (ds.dashed) { r.borderDash = [5, 5]; }
            if (ds.spanGaps !== undefined) { r.spanGaps = ds.spanGaps; }
            return r;
        });

        /* Temperature overlay dataset */
        var tempData = opts && opts.tempData && _tempOverlayVisible ? opts.tempData : null;
        var hasTemp = tempData && tempData.some(function(v) { return v !== null; });
        if (hasTemp && type !== 'bar') {
            chartDatasets.push({
                label: T.temperature || 'Temperature',
                data: tempData,
                borderColor: 'rgba(249,115,22,0.7)',
                backgroundColor: 'transparent',
                borderWidth: 1.5,
                borderDash: [5, 3],
                tension: 0.4,
                pointRadius: 0,
                yAxisID: 'y-temp',
                fill: false,
                spanGaps: true
            });
        }

        var hasLegend = chartDatasets.length > 1;
        var legendPos = hasLegend ? 'bottom' : 'top';
        var tooltipCallbacks = {};
        if (opts && opts.tooltipLabelCallback) {
            tooltipCallbacks.label = opts.tooltipLabelCallback;
        } else if (hasTemp) {
            tooltipCallbacks.label = function(context) {
                var val = context.parsed.y;
                if (val == null) return '';
                if (context.dataset.yAxisID === 'y-temp') {
                    return context.dataset.label + ': ' + val.toFixed(1) + ' °C';
                }
                return context.dataset.label + ': ' + val;
            };
        }
        var chartConfig = {
            type: type || 'line',
            data: { labels: labels, datasets: chartDatasets },
            options: {
                responsive: true, maintainAspectRatio: true,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { display: hasLegend, position: legendPos, labels: { color: textColor, font: { size: 11 } } },
                    tooltip: { backgroundColor: isDark ? '#16213e' : '#fff', titleColor: textColor, bodyColor: textColor, borderColor: gridColor, borderWidth: 1,
                        callbacks: Object.keys(tooltipCallbacks).length > 0 ? tooltipCallbacks : undefined }
                },
                scales: {
                    x: { ticks: { color: textColor, font: { size: 10 }, maxRotation: 45 }, grid: { color: gridColor } },
                    y: { ticks: { color: textColor, font: { size: 10 }, callback: opts && opts.yTickCallback ? opts.yTickCallback : undefined }, grid: { color: gridColor } }
                }
            },
            plugins: zones ? [zonesPlugin] : []
        };

        /* Secondary temperature Y-axis */
        if (hasTemp && type !== 'bar') {
            chartConfig.options.scales['y-temp'] = {
                type: 'linear', position: 'right',
                title: { display: true, text: '°C', color: 'rgba(249,115,22,0.8)', font: { size: 10 } },
                grid: { display: false },
                ticks: { color: 'rgba(249,115,22,0.6)', font: { size: 10 } }
            };
        }

        if (opts && opts.yMin !== undefined) chartConfig.options.scales.y.min = opts.yMin;
        if (opts && opts.yMax !== undefined) chartConfig.options.scales.y.max = opts.yMax;
        if (opts && opts.yAfterBuildTicks) chartConfig.options.scales.y.afterBuildTicks = opts.yAfterBuildTicks;
        if (zones) {
            var zoneMeta = zones.find(function(z) { return z.yMin !== undefined; });
            if (zoneMeta) {
                chartConfig.options.scales.y.suggestedMin = zoneMeta.yMin;
                chartConfig.options.scales.y.suggestedMax = zoneMeta.yMax;
            }
        }
        charts[canvasId] = new Chart(ctx, chartConfig);
        if (zones) {
            charts[canvasId]._docsightZones = zones;
        }
        /* Store render params so the zoom modal can re-render this chart */
        charts[canvasId]._docsightParams = {labels: labels, datasets: datasets, type: type, zones: zones, opts: opts};
    }

    /* ── Chart Zoom Modal ── */
    var zoomChart = null;

    window.closeChartZoom = closeChartZoom;

    function openChartZoom(canvasId) {
        var src = charts[canvasId];
        if (!src || !src._docsightParams) return;
        var params = src._docsightParams;
        var card = document.getElementById(canvasId).closest('.chart-card');
        var label = card ? card.querySelector('.chart-label') : null;
        document.getElementById('chart-zoom-title').textContent = label ? label.textContent : '';
        var overlay = document.getElementById('chart-zoom-overlay');
        overlay.classList.add('open');
        /* Re-render the chart on the modal canvas (maintainAspectRatio: false to fill) */
        setTimeout(function() {
            if (zoomChart) { zoomChart.destroy(); zoomChart = null; }
            var ctx = document.getElementById('chart-zoom-canvas');
            var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            var gridColor = isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)';
            var textColor = isDark ? '#888' : '#666';
            
            var isMulti = params.datasets.length > 1;
            var chartDatasets = params.datasets.map(function(ds) {
                var lineColor = ds.color || 'rgba(168,85,247,0.9)';
                var r = {
                    label: ds.label, data: ds.data,
                    borderColor: params.type === 'bar' ? ds.color : lineColor,
                    backgroundColor: params.type === 'bar' ? ds.color + 'cc' : (isMulti ? 'transparent' : function(context) {
                        var chart = context.chart;
                        var ctx = chart.ctx;
                        var chartArea = chart.chartArea;
                        if (!chartArea) return 'rgba(168,85,247,0.25)';
                        var gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                        gradient.addColorStop(0, 'rgba(168,85,247,0.5)');
                        gradient.addColorStop(0.7, 'rgba(168,85,247,0.1)');
                        gradient.addColorStop(1, 'rgba(168,85,247,0)');
                        return gradient;
                    }),
                    borderWidth: params.type === 'bar' ? 3 : 2,
                    tension: params.type === 'bar' ? 0.3 : 0.4,
                    pointRadius: params.labels.length > 30 ? 2 : 4,
                    fill: isMulti ? false : params.type !== 'bar'
                };
                if (ds.stepped) { r.stepped = 'before'; r.tension = 0; }
                if (ds.dashed) { r.borderDash = [5, 5]; }
                return r;
            });

            /* Temperature overlay in zoom modal */
            var zoomTempData = params.opts && params.opts.tempData && _tempOverlayVisible ? params.opts.tempData : null;
            var zoomHasTemp = zoomTempData && zoomTempData.some(function(v) { return v !== null; });
            if (zoomHasTemp && params.type !== 'bar') {
                chartDatasets.push({
                    label: T.temperature || 'Temperature',
                    data: zoomTempData,
                    borderColor: 'rgba(249,115,22,0.7)',
                    backgroundColor: 'transparent',
                    borderWidth: 1.5,
                    borderDash: [5, 3],
                    tension: 0.4,
                    pointRadius: params.labels.length > 30 ? 0 : 2,
                    yAxisID: 'y-temp',
                    fill: false,
                    spanGaps: true
                });
            }

            var hasLegend = chartDatasets.length > 1;
            var zoomTooltipCallbacks = {};
            if (params.opts && params.opts.tooltipLabelCallback) {
                zoomTooltipCallbacks.label = params.opts.tooltipLabelCallback;
            } else if (zoomHasTemp) {
                zoomTooltipCallbacks.label = function(context) {
                    var val = context.parsed.y;
                    if (val == null) return '';
                    if (context.dataset.yAxisID === 'y-temp') return context.dataset.label + ': ' + val.toFixed(1) + ' °C';
                    return context.dataset.label + ': ' + val;
                };
            }
            var cfg = {
                type: params.type || 'line',
                data: { labels: params.labels, datasets: chartDatasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { display: hasLegend, position: 'bottom', labels: { color: textColor, font: { size: 12 } } },
                        tooltip: { backgroundColor: isDark ? '#16213e' : '#fff', titleColor: textColor, bodyColor: textColor, borderColor: gridColor, borderWidth: 1,
                            callbacks: Object.keys(zoomTooltipCallbacks).length > 0 ? zoomTooltipCallbacks : undefined }
                    },
                    scales: {
                        x: { ticks: { color: textColor, font: { size: 11 }, maxRotation: 45 }, grid: { color: gridColor } },
                        y: { ticks: { color: textColor, font: { size: 11 }, callback: params.opts && params.opts.yTickCallback ? params.opts.yTickCallback : undefined }, grid: { color: gridColor } }
                    }
                },
                plugins: params.zones ? [zonesPlugin] : []
            };
            if (zoomHasTemp && params.type !== 'bar') {
                cfg.options.scales['y-temp'] = {
                    type: 'linear', position: 'right',
                    title: { display: true, text: '°C', color: 'rgba(249,115,22,0.8)', font: { size: 11 } },
                    grid: { display: false },
                    ticks: { color: 'rgba(249,115,22,0.6)', font: { size: 11 } }
                };
            }
            if (params.opts && params.opts.yMin !== undefined) cfg.options.scales.y.min = params.opts.yMin;
            if (params.opts && params.opts.yMax !== undefined) cfg.options.scales.y.max = params.opts.yMax;
            if (params.opts && params.opts.yAfterBuildTicks) cfg.options.scales.y.afterBuildTicks = params.opts.yAfterBuildTicks;
            if (params.zones) {
                var zoneMeta = params.zones.find(function(z) { return z.yMin !== undefined; });
                if (zoneMeta) {
                    cfg.options.scales.y.suggestedMin = zoneMeta.yMin;
                    cfg.options.scales.y.suggestedMax = zoneMeta.yMax;
                }
            }
            zoomChart = new Chart(ctx, cfg);
            if (params.zones) {
                zoomChart._docsightZones = params.zones;
            }
        }, 50);
    }

    function closeChartZoom() {
        document.getElementById('chart-zoom-overlay').classList.remove('open');
        if (zoomChart) { zoomChart.destroy(); zoomChart = null; }
    }

    /* Expand button click handlers */
    document.querySelectorAll('.chart-expand-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            openChartZoom(btn.getAttribute('data-chart'));
        });
    });

    /* Close chart zoom on Escape + BQM keyboard shortcuts */
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('chart-zoom-overlay').classList.contains('open')) {
            closeChartZoom();
            return;
        }
        // BQM slideshow keyboard shortcuts (only when BQM view active)
        if (currentView !== 'bqm') return;
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
        if (e.key === ' ' || e.code === 'Space') {
            e.preventDefault();
            if (_bqmSlideshow.playing) pauseBqmSlideshow();
            else startBqmSlideshow();
        } else if (e.key === 'Escape') {
            stopBqmSlideshow();
        } else if (e.key === 'ArrowLeft') {
            if (_bqmSlideshow.playing || _bqmSlideshow.range.length) {
                e.preventDefault();
                if (_bqmSlideshow.playing) pauseBqmSlideshow();
                if (_bqmSlideshow.currentIdx > 0) {
                    _bqmSlideshow.currentIdx--;
                    selectBqmSlideshowFrame();
                }
            }
        } else if (e.key === 'ArrowRight') {
            if (_bqmSlideshow.playing || _bqmSlideshow.range.length) {
                e.preventDefault();
                if (_bqmSlideshow.playing) pauseBqmSlideshow();
                if (_bqmSlideshow.currentIdx < _bqmSlideshow.range.length - 1) {
                    _bqmSlideshow.currentIdx++;
                    selectBqmSlideshowFrame();
                }
            }
        }
    });

    /* ── BQM Graph ── */
    function loadBqmGraph(date) {
        var img = document.getElementById('bqm-image');
        var noData = document.getElementById('bqm-no-data');
        var card = document.getElementById('bqm-card');
        if (!img || !noData) return;
        if (card) card.style.display = 'none';
        noData.style.display = 'none';
        img.onload = function() { 
            if (card) card.style.display = 'block';
        };
        img.onerror = function() {
            if (card) card.style.display = 'none';
            noData.textContent = T.bqm_no_data || 'No BQM graph for this date.';
            noData.style.display = 'block';
        };
        img.src = '/api/bqm/image/' + date;
    }

    /* ── BQM Import ── */
    var _bqmImportFiles = [];

    function detectDateFromFilename(filename) {
        var base = filename.replace(/\.[^.]+$/, '');
        var m;
        // YYYY-MM-DD (with optional _HHMM or _HH-MM suffix)
        m = base.match(/(\d{4})-(\d{2})-(\d{2})/);
        if (m) return m[1] + '-' + m[2] + '-' + m[3];
        // YYYYMMDD
        m = base.match(/(\d{4})(\d{2})(\d{2})/);
        if (m && +m[2] >= 1 && +m[2] <= 12 && +m[3] >= 1 && +m[3] <= 31)
            return m[1] + '-' + m[2] + '-' + m[3];
        // DD.MM.YYYY (German)
        m = base.match(/(\d{2})\.(\d{2})\.(\d{4})/);
        if (m) return m[3] + '-' + m[2] + '-' + m[1];
        // DD-MM-YYYY
        m = base.match(/(\d{2})-(\d{2})-(\d{4})/);
        if (m) return m[3] + '-' + m[2] + '-' + m[1];
        return '';
    }

    function openBqmImportModal() {
        _bqmImportFiles = [];
        var modal = document.getElementById('bqm-import-modal');
        document.getElementById('bqm-import-dropzone').style.display = '';
        document.getElementById('bqm-import-options').style.display = 'none';
        document.getElementById('bqm-import-status').style.display = 'none';
        document.getElementById('bqm-import-preview').style.display = 'none';
        document.getElementById('bqm-import-footer').style.display = 'none';
        document.getElementById('bqm-import-overwrite').checked = false;
        document.getElementById('bqm-import-offset').value = '0';
        document.getElementById('bqm-import-tbody').innerHTML = '';
        modal.classList.add('open');
    }

    function closeBqmImportModal() {
        document.getElementById('bqm-import-modal').classList.remove('open');
        // Revoke thumb URLs
        _bqmImportFiles.forEach(function(f) { if (f.thumbUrl) URL.revokeObjectURL(f.thumbUrl); });
        _bqmImportFiles = [];
    }

    function offsetDate(isoDate, days) {
        if (!isoDate || !days) return isoDate;
        var d = new Date(isoDate + 'T12:00:00');
        d.setDate(d.getDate() + days);
        return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate());
    }

    function applyBqmImportOffset() {
        var days = parseInt(document.getElementById('bqm-import-offset').value) || 0;
        _bqmImportFiles.forEach(function(entry) {
            if (entry.originalDate) {
                entry.date = offsetDate(entry.originalDate, days);
            }
        });
        renderBqmImportPreview();
    }

    function handleBqmImportFiles(fileList) {
        var rejected = 0;
        for (var i = 0; i < fileList.length; i++) {
            var f = fileList[i];
            // Check type by MIME or extension fallback
            var validMime = (f.type === 'image/png' || f.type === 'image/jpeg');
            var ext = f.name.toLowerCase().split('.').pop();
            var validExt = (ext === 'png' || ext === 'jpg' || ext === 'jpeg');
            if (!validMime && !validExt) { rejected++; continue; }
            var date = detectDateFromFilename(f.name);
            var thumbUrl = URL.createObjectURL(f);
            _bqmImportFiles.push({ file: f, date: date, originalDate: date, thumbUrl: thumbUrl });
        }
        if (rejected > 0) showToast(T.bqm_import_invalid || 'Only PNG and JPEG images', 'error');
        if (_bqmImportFiles.length > 0) {
            // Apply current offset to newly added files
            var days = parseInt(document.getElementById('bqm-import-offset').value) || 0;
            if (days !== 0) {
                _bqmImportFiles.forEach(function(entry) {
                    if (entry.originalDate) entry.date = offsetDate(entry.originalDate, days);
                });
            }
            renderBqmImportPreview();
        }
    }

    function renderBqmImportPreview() {
        var tbody = document.getElementById('bqm-import-tbody');
        tbody.innerHTML = '';
        var datesDetected = 0;
        var datesMissing = 0;

        _bqmImportFiles.forEach(function(entry, idx) {
            var tr = document.createElement('tr');
            // Thumbnail
            var tdThumb = document.createElement('td');
            if (entry.thumbUrl) {
                var img = document.createElement('img');
                img.src = entry.thumbUrl;
                img.className = 'bqm-import-thumb';
                tdThumb.appendChild(img);
            }
            tr.appendChild(tdThumb);

            // Filename
            var tdName = document.createElement('td');
            var nameSpan = document.createElement('span');
            nameSpan.className = 'bqm-import-filename';
            nameSpan.textContent = entry.file.name.length > 30 ? entry.file.name.substring(0, 27) + '...' : entry.file.name;
            nameSpan.title = entry.file.name;
            tdName.appendChild(nameSpan);
            // Conflict badge
            if (entry.date && _bqmAvailableDates.has(entry.date)) {
                var badge = document.createElement('span');
                badge.className = 'bqm-import-conflict';
                badge.textContent = T.bqm_import_conflict || 'Already exists';
                tdName.appendChild(badge);
            }
            tr.appendChild(tdName);

            // Date input
            var tdDate = document.createElement('td');
            var dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.value = entry.date;
            dateInput.setAttribute('data-idx', idx);
            if (!entry.date) {
                dateInput.classList.add('bqm-import-date-missing');
                datesMissing++;
            } else {
                datesDetected++;
            }
            dateInput.addEventListener('change', function() {
                var i = parseInt(this.getAttribute('data-idx'));
                _bqmImportFiles[i].date = this.value;
                renderBqmImportPreview();
            });
            tdDate.appendChild(dateInput);
            tr.appendChild(tdDate);

            // Remove button
            var tdRemove = document.createElement('td');
            var removeBtn = document.createElement('button');
            removeBtn.className = 'modal-close';
            removeBtn.innerHTML = '&times;';
            removeBtn.setAttribute('data-idx', idx);
            removeBtn.addEventListener('click', function() {
                var i = parseInt(this.getAttribute('data-idx'));
                if (_bqmImportFiles[i].thumbUrl) URL.revokeObjectURL(_bqmImportFiles[i].thumbUrl);
                _bqmImportFiles.splice(i, 1);
                if (_bqmImportFiles.length === 0) {
                    openBqmImportModal();
                } else {
                    renderBqmImportPreview();
                }
            });
            tdRemove.appendChild(removeBtn);
            tr.appendChild(tdRemove);

            tbody.appendChild(tr);
        });

        // Status line
        var statusEl = document.getElementById('bqm-import-status');
        statusEl.textContent = datesDetected + ' dates detected' + (datesMissing > 0 ? ', ' + datesMissing + ' needs manual entry' : '');
        statusEl.style.display = 'block';

        document.getElementById('bqm-import-dropzone').style.display = 'none';
        document.getElementById('bqm-import-options').style.display = 'block';
        document.getElementById('bqm-import-preview').style.display = 'block';
        document.getElementById('bqm-import-footer').style.display = 'flex';

        // Update button text and state
        var btn = document.getElementById('bqm-import-confirm-btn');
        var allValid = _bqmImportFiles.length > 0 && datesMissing === 0;
        btn.disabled = !allValid;
        var label = (T.bqm_import_btn || 'Import {0} images').replace('{0}', _bqmImportFiles.length);
        btn.textContent = label;
    }

    function executeBqmImport() {
        var btn = document.getElementById('bqm-import-confirm-btn');
        btn.disabled = true;
        btn.textContent = '...';

        var fd = new FormData();
        var dates = [];
        var overwrite = document.getElementById('bqm-import-overwrite').checked;

        _bqmImportFiles.forEach(function(entry) {
            fd.append('files[]', entry.file);
            dates.push(entry.date);
        });
        fd.append('dates', dates.join(','));
        if (overwrite) fd.append('overwrite', 'true');

        fetch('/api/bqm/import', { method: 'POST', body: fd })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                // Reload BQM calendar
                fetchBqmDates(function() {
                    renderBqmCalendar(_bqmCalYear, _bqmCalMonth);
                });
                // Show result inside the modal
                showBqmImportResult(data);
            })
            .catch(function(err) {
                showToast('Import failed: ' + err.message, 'error');
                btn.disabled = false;
                var label = (T.bqm_import_btn || 'Import {0} images').replace('{0}', _bqmImportFiles.length);
                btn.textContent = label;
            });
    }

    function showBqmImportResult(data) {
        var total = data.imported + (data.replaced || 0);
        var tbody = document.getElementById('bqm-import-tbody');
        var status = document.getElementById('bqm-import-status');
        var preview = document.getElementById('bqm-import-preview');
        var footer = document.getElementById('bqm-import-footer');
        var options = document.getElementById('bqm-import-options');

        // Build result summary
        var html = '<span style="color:var(--accent-purple,var(--accent));">' + total + ' imported</span>';
        if (data.replaced) html += ' (' + data.replaced + ' replaced)';
        if (data.skipped) html += ', <span style="color:#eab308;">' + data.skipped + ' skipped</span>';
        if (data.errors && data.errors.length) html += ', <span style="color:#ef4444;">' + data.errors.length + ' errors</span>';
        status.innerHTML = html;
        status.style.display = 'block';

        // Show skipped dates if any
        if (data.skipped_dates && data.skipped_dates.length) {
            tbody.innerHTML = '';
            var tr = document.createElement('tr');
            var td = document.createElement('td');
            td.colSpan = 4;
            td.style.cssText = 'padding:12px 8px; font-size:0.85em;';
            var datesHtml = '<div style="margin-bottom:6px;color:#eab308;font-weight:500;">Skipped (already exist):</div>';
            datesHtml += '<div style="display:flex;flex-wrap:wrap;gap:4px 10px;">';
            data.skipped_dates.forEach(function(d) {
                datesHtml += '<span style="color:var(--muted);">' + d + '</span>';
            });
            datesHtml += '</div>';
            td.innerHTML = datesHtml;
            tr.appendChild(td);
            tbody.appendChild(tr);
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }

        options.style.display = 'none';

        // Replace footer with close button
        var footerRight = footer.querySelector('div:last-child');
        footerRight.innerHTML = '<button class="btn btn-accent" onclick="closeBqmImportModal()">' + (T.close || 'Close') + '</button>';
        footer.style.display = 'flex';
    }

    // Drop zone event handlers
    (function() {
        var zone = document.getElementById('bqm-import-dropzone');
        var input = document.getElementById('bqm-import-file-input');
        if (!zone || !input) return;

        zone.addEventListener('click', function() { input.click(); });
        input.addEventListener('change', function() {
            if (this.files.length) handleBqmImportFiles(this.files);
            this.value = '';
        });
        zone.addEventListener('dragover', function(e) {
            e.preventDefault(); e.stopPropagation();
            zone.classList.add('dragover');
        });
        zone.addEventListener('dragleave', function(e) {
            e.preventDefault(); e.stopPropagation();
            zone.classList.remove('dragover');
        });
        zone.addEventListener('drop', function(e) {
            e.preventDefault(); e.stopPropagation();
            zone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleBqmImportFiles(e.dataTransfer.files);
        });
    })();
    // Offset change handler
    (function() {
        var offsetInput = document.getElementById('bqm-import-offset');
        if (offsetInput) {
            offsetInput.addEventListener('change', applyBqmImportOffset);
            offsetInput.addEventListener('input', applyBqmImportOffset);
        }
    })();

    function deleteBqmImages() {
        var totalCount = _bqmAvailableDates.size;
        if (totalCount === 0) {
            showToast(T.bqm_no_data_range || 'No BQM data in this range', 'info');
            return;
        }

        if (_bqmRangeStart && _bqmRangeEnd) {
            // Count dates in range
            var rangeDates = [];
            _bqmAvailableDates.forEach(function(d) {
                if (d >= _bqmRangeStart && d <= _bqmRangeEnd) rangeDates.push(d);
            });
            if (rangeDates.length === 0) {
                showToast(T.bqm_no_data_range || 'No BQM data in this range', 'info');
                return;
            }
            var msg = (T.bqm_delete_range || 'Delete {0} images from {1} to {2}?')
                .replace('{0}', rangeDates.length)
                .replace('{1}', _bqmRangeStart)
                .replace('{2}', _bqmRangeEnd);
            if (!confirm(msg)) return;

            fetch('/api/bqm/images', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ start: _bqmRangeStart, end: _bqmRangeEnd })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var successMsg = (T.bqm_delete_success || '{0} images deleted').replace('{0}', data.deleted);
                showToast(successMsg, 'success');
                _bqmRangeStart = null;
                _bqmRangeEnd = null;
                fetchBqmDates(function() { renderBqmCalendar(_bqmCalYear, _bqmCalMonth); });
            })
            .catch(function(err) { showToast('Delete failed: ' + err.message, 'error'); });
        } else {
            // Delete all
            var msg = (T.bqm_delete_all || 'Delete all {0} BQM images?').replace('{0}', totalCount);
            if (!confirm(msg)) return;
            var confirmText = prompt(T.bqm_delete_confirm || 'Type DELETE to confirm');
            if (confirmText !== 'DELETE') return;

            fetch('/api/bqm/images', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ all: true, confirm: 'DELETE_ALL' })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var successMsg = (T.bqm_delete_success || '{0} images deleted').replace('{0}', data.deleted);
                showToast(successMsg, 'success');
                _bqmRangeStart = null;
                _bqmRangeEnd = null;
                fetchBqmDates(function() { renderBqmCalendar(_bqmCalYear, _bqmCalMonth); });
            })
            .catch(function(err) { showToast('Delete failed: ' + err.message, 'error'); });
        }
    }

    window.deleteBqmImages = deleteBqmImages;
    window.openBqmImportModal = openBqmImportModal;
    window.closeBqmImportModal = closeBqmImportModal;
    window.executeBqmImport = executeBqmImport;

    /* ── Smokeping Graphs ── */
    var _smokepingSpan = '3h';
    var smokepingTabs = document.querySelectorAll('#smokeping-tabs .trend-tab');
    smokepingTabs.forEach(function(btn) {
        btn.addEventListener('click', function() {
            _smokepingSpan = this.getAttribute('data-span');
            smokepingTabs.forEach(function(b) {
                b.classList.toggle('active', b.getAttribute('data-span') === _smokepingSpan);
            });
            loadSmokepingGraphs();
        });
    });

    function loadSmokepingGraphs() {
        var content = document.getElementById('smokeping-content');
        var noData = document.getElementById('smokeping-no-data');
        if (!content || !noData) return;
        content.innerHTML = '';
        noData.style.display = 'none';

        fetch('/api/smokeping/targets')
            .then(function(r) { return r.json(); })
            .then(function(targets) {
                if (!targets || targets.length === 0) {
                    noData.textContent = T.smokeping_no_data || 'Could not load Smokeping graphs.';
                    noData.style.display = 'block';
                    return;
                }
                targets.forEach(function(target) {
                    var card = document.createElement('div');
                    card.className = 'bqm-card';
                    var header = document.createElement('div');
                    header.className = 'chart-card-header';
                    header.innerHTML = '<div class="chart-header-content"><div class="chart-label">' + target + '</div></div>';
                    card.appendChild(header);
                    var wrap = document.createElement('div');
                    wrap.style.textAlign = 'center';
                    var img = document.createElement('img');
                    img.style.maxWidth = '100%';
                    img.style.borderRadius = '8px';
                    img.alt = target;
                    img.src = '/api/smokeping/graph/' + encodeURIComponent(target) + '/' + _smokepingSpan;
                    img.onerror = function() {
                        wrap.innerHTML = '<div class="no-data-msg" style="display:block;">' + (T.smokeping_no_data || 'Could not load graph.') + '</div>';
                    };
                    wrap.appendChild(img);
                    card.appendChild(wrap);
                    content.appendChild(card);
                });
            })
            .catch(function() {
                noData.textContent = T.smokeping_no_data || 'Could not load Smokeping graphs.';
                noData.style.display = 'block';
            });
    }

    window.loadSmokepingGraphs = loadSmokepingGraphs;

    /* ── Init ── */
    // Apply hash-based view routing (must be inside IIFE to access switchView)
    var _initHash = location.hash.replace('#', '');
    if (validViews.indexOf(_initHash) !== -1 && _initHash !== 'live') {
        switchView(_initHash, true);
    }

    /* ── Incident Journal ── */
    var _journalLoaded = false;
    var _journalSortCol = 'date';
    var _journalSortAsc = false;
    var _activeIncidentFilter = null; // null=all, 0=unassigned, N=incident id
    var _selectedEntryIds = []; // bulk selection state
    var _bulkMode = false;
    var _incidentsData = []; // cached incident containers

    var INCIDENT_ICONS = [
        {keys: ['telefon', 'anruf', 'hotline', 'telefonat', 'angerufen', 'rückruf', 'callcenter'], icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="incident-icon"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>', label: 'phone'},
        {keys: ['techniker', 'monteur', 'reparatur', 'vor ort', 'service-termin', 'servicetermin'], icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="incident-icon"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>', label: 'technician'},
        {keys: ['ausfall', 'störung', 'stoerung', 'offline', 'totalausfall', 'kein internet', 'abbruch', 'abbrüche', 'disconnect', 'unterbrechung'], icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="incident-icon"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>', label: 'outage'},
        {keys: ['email', 'e-mail', 'schreiben', 'einschreiben', 'schriftlich', 'brieflich', 'fax', 'per post', 'brief geschickt', 'brief gesendet', 'brief erhalten', 'brief geschrieben'], icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="incident-icon"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>', label: 'mail'},
        {keys: ['beschwerde', 'reklamation', 'widerspruch', 'einspruch', 'beanstandung'], icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="incident-icon"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>', label: 'complaint'},
        {keys: ['vertrag', 'kündigung', 'kuendigung', 'sonderkündigung', 'laufzeit', 'tarif', 'wechsel', 'anbieterwechsel'], icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="incident-icon"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>', label: 'contract'},
        {keys: ['messung', 'speedtest', 'breitbandmessung', 'bandbreite', 'geschwindigkeit', 'mbit'], icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="incident-icon"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>', label: 'measurement'},
        {keys: ['bundesnetzagentur', 'bnetz', 'bnetza', 'regulierung', 'schlichtung', 'behörde', 'behoerde'], icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="incident-icon"><path d="M3 21h18"/><path d="M5 21V7l7-4 7 4v14"/><path d="M9 21v-4h6v4"/></svg>', label: 'authority'},
        {keys: ['rechnung', 'zahlung', 'erstattung', 'gutschrift', 'kosten', 'minderung', 'geld'], icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="incident-icon"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>', label: 'billing'},
        {keys: ['router', 'modem', 'fritzbox', 'fritz!box', 'hardware', 'gerät', 'geraet', 'tausch', 'austausch'], icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="incident-icon"><rect x="2" y="6" width="20" height="12" rx="2"/><line x1="6" y1="14" x2="6" y2="14.01"/><line x1="10" y1="14" x2="10" y2="14.01"/></svg>', label: 'hardware'},
        {keys: ['dokumentation', 'protokoll', 'nachweis', 'beweis', 'screenshot', 'foto', 'aufzeichnung'], icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="incident-icon"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>', label: 'documentation'},
        {keys: ['anwalt', 'rechtsanwalt', 'klage', 'gericht', 'rechtlich', 'jurist', 'mahnung', 'frist'], icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="incident-icon"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>', label: 'legal'}
    ];

    // Pre-compile word-boundary regexes for icon detection
    var _iconRegexCache = {};
    function _getIconRegex(keyword) {
        if (!_iconRegexCache[keyword]) {
            // Use word boundaries for single words, plain indexOf for multi-word phrases
            if (keyword.indexOf(' ') !== -1) {
                _iconRegexCache[keyword] = new RegExp(keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
            } else {
                _iconRegexCache[keyword] = new RegExp('(?:^|[\\s,;.!?()\\[\\]"\'/\\-])' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '(?:$|[\\s,;.!?()\\[\\]"\'/\\-])', 'i');
            }
        }
        return _iconRegexCache[keyword];
    }

    function detectIcon(title, description) {
        if (!title && !description) return null;
        var text = ' ' + ((title || '') + ' ' + (description || '')).toLowerCase() + ' ';
        for (var i = 0; i < INCIDENT_ICONS.length; i++) {
            var entry = INCIDENT_ICONS[i];
            for (var j = 0; j < entry.keys.length; j++) {
                if (_getIconRegex(entry.keys[j]).test(text)) {
                    return entry;
                }
            }
        }
        return null;
    }

    function getIconByLabel(label) {
        if (!label) return null;
        for (var i = 0; i < INCIDENT_ICONS.length; i++) {
            if (INCIDENT_ICONS[i].label === label) return INCIDENT_ICONS[i];
        }
        return null;
    }

    function resolveIcon(incident) {
        if (incident.icon) return getIconByLabel(incident.icon);
        return detectIcon(incident.title, incident.description);
    }

    function renderIconPicker(selectedLabel) {
        var picker = document.getElementById('entry-icon-picker');
        var hiddenInput = document.getElementById('entry-icon-value');
        picker.innerHTML = '';
        // "None" button
        var noneBtn = document.createElement('button');
        noneBtn.type = 'button';
        noneBtn.className = 'icon-pick' + (!selectedLabel ? ' active' : '');
        noneBtn.title = T.icon_auto;
        noneBtn.innerHTML = '<span style="font-size:14px;color:var(--muted);">' + T.icon_auto.toLowerCase() + '</span>';
        noneBtn.onclick = function() {
            hiddenInput.value = '';
            picker.querySelectorAll('.icon-pick').forEach(function(b) { b.classList.remove('active'); });
            noneBtn.classList.add('active');
            updateModalIcon();
        };
        picker.appendChild(noneBtn);

        INCIDENT_ICONS.forEach(function(entry) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'icon-pick' + (selectedLabel === entry.label ? ' active' : '');
            btn.title = T['icon_' + entry.label] || entry.label;
            btn.innerHTML = entry.icon;
            btn.onclick = function() {
                hiddenInput.value = entry.label;
                picker.querySelectorAll('.icon-pick').forEach(function(b) { b.classList.remove('active'); });
                btn.classList.add('active');
                updateModalIcon();
            };
            picker.appendChild(btn);
        });
    }

    var MONTH_NAMES = T.month_names || ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];

    var _journalSearchQuery = '';
    var _journalSearchTimer = null;
    var _journalAllData = null;

    function loadJournal(searchQuery) {
        var tableCard = document.getElementById('journal-table-card');
        var tbody = document.getElementById('journal-tbody');
        var empty = document.getElementById('journal-empty');
        var loading = document.getElementById('journal-loading');
        var deleteAllBtn = document.getElementById('btn-delete-all-entries');
        var searchWrap = document.getElementById('journal-search-wrap');
        var searchCount = document.getElementById('journal-search-count');
        loading.style.display = '';
        tbody.innerHTML = '';
        if (tableCard) tableCard.style.display = 'none';
        empty.style.display = 'none';
        if (deleteAllBtn) deleteAllBtn.style.display = 'none';
        var bulkToggle = document.getElementById('btn-bulk-toggle');
        if (bulkToggle) bulkToggle.style.display = 'none';
        if (searchCount) searchCount.textContent = '';
        /* Reset bulk selection on reload */
        _selectedEntryIds = [];
        var master = document.getElementById('journal-select-all');
        if (master) master.checked = false;
        var bulkBar = document.getElementById('journal-bulk-bar');
        if (bulkBar) bulkBar.style.display = 'none';

        var url = '/api/journal?limit=1000';
        if (searchQuery) url += '&search=' + encodeURIComponent(searchQuery);
        if (_activeIncidentFilter !== null) url += '&incident_id=' + _activeIncidentFilter;

        fetch(url)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                loading.style.display = 'none';
                if (!searchQuery) _journalAllData = data;
                if (!data || data.length === 0) {
                    if (searchQuery) {
                        empty.textContent = T.search_no_results + ' "' + searchQuery + '"';
                        if (searchCount) searchCount.textContent = '0 ' + T.search_results;
                    } else {
                        empty.textContent = T.no_incidents || 'No incidents logged yet.';
                    }
                    empty.style.display = '';
                    if (searchWrap && !searchQuery) searchWrap.style.display = 'none';
                    return;
                }
                _journalLoaded = true;
                if (searchWrap) searchWrap.style.display = '';
                if (deleteAllBtn && !searchQuery) deleteAllBtn.style.display = '';
                var bulkToggle = document.getElementById('btn-bulk-toggle');
                if (bulkToggle && !searchQuery) bulkToggle.style.display = '';
                if (searchQuery && searchCount) {
                    searchCount.textContent = data.length + ' ' + (data.length !== 1 ? T.search_results : T.search_result);
                }
                renderJournalTable(data, searchQuery);
            })
            .catch(function() {
                loading.style.display = 'none';
                empty.textContent = T.network_error || 'Error';
                empty.style.display = '';
            });
    }

    function highlightText(text, query) {
        if (!query || !text) return escapeHtml(text);
        var escaped = escapeHtml(text);
        var lowerEscaped = escaped.toLowerCase();
        var lowerQuery = query.toLowerCase();
        var result = '';
        var lastIdx = 0;
        var idx = lowerEscaped.indexOf(lowerQuery);
        while (idx !== -1) {
            result += escaped.substring(lastIdx, idx);
            result += '<mark class="search-highlight">' + escaped.substring(idx, idx + lowerQuery.length) + '</mark>';
            lastIdx = idx + lowerQuery.length;
            idx = lowerEscaped.indexOf(lowerQuery, lastIdx);
        }
        result += escaped.substring(lastIdx);
        return result;
    }

    function renderJournalTable(data, searchQuery) {
        var table = document.getElementById('journal-table');
        var tbody = document.getElementById('journal-tbody');
        data.sort(function(a, b) {
            var va, vb;
            if (_journalSortCol === 'date') { va = a.date || ''; vb = b.date || ''; }
            else if (_journalSortCol === 'title') { va = (a.title || '').toLowerCase(); vb = (b.title || '').toLowerCase(); }
            else { va = (a.description || '').toLowerCase(); vb = (b.description || '').toLowerCase(); }
            if (va < vb) return _journalSortAsc ? -1 : 1;
            if (va > vb) return _journalSortAsc ? 1 : -1;
            return 0;
        });
        tbody.innerHTML = '';
        var lastMonthKey = '';
        var sortByDate = _journalSortCol === 'date';
        var q = searchQuery || '';
        data.forEach(function(inc) {
            // Month/Year grouping headers (only when sorted by date)
            if (sortByDate && inc.date) {
                var parts = inc.date.split('-');
                var monthKey = parts[0] + '-' + parts[1];
                if (monthKey !== lastMonthKey) {
                    lastMonthKey = monthKey;
                    var monthIdx = parseInt(parts[1], 10) - 1;
                    var monthLabel = MONTH_NAMES[monthIdx] + ' ' + parts[0];
                    var groupTr = document.createElement('tr');
                    groupTr.className = 'journal-month-header';
                    groupTr.innerHTML = '<td colspan="' + (_bulkMode ? 6 : 5) + '">' + monthLabel + '</td>';
                    tbody.appendChild(groupTr);
                }
            }
            var tr = document.createElement('tr');
            tr.setAttribute('data-id', inc.id);
            var isSelected = _selectedEntryIds.indexOf(inc.id) !== -1;
            if (isSelected) tr.classList.add('journal-row-selected');
            tr.onclick = function(e) {
                if (e.target.closest('.journal-check-cell')) return;
                openEntryModal(inc.id);
            };
            var desc = inc.description || '';
            if (desc.length > 80) desc = desc.substring(0, 80) + '…';
            var clipCell = inc.attachment_count > 0 ? '&#128206; ' + inc.attachment_count : '';
            var iconMatch = resolveIcon(inc);
            var iconHtml = iconMatch ? iconMatch.icon : '<span class="incident-icon-placeholder"></span>';
            var titleHtml = q ? highlightText(inc.title, q) : escapeHtml(inc.title);
            var descHtml = q ? highlightText(desc, q) : escapeHtml(desc);
            var dateHtml = q ? highlightText(formatDateDE(inc.date), q) : formatDateDE(inc.date);
            tr.innerHTML =
                (_bulkMode ? '<td class="journal-check-cell"><input type="checkbox" class="journal-row-check" data-entry-id="' + inc.id + '"' + (isSelected ? ' checked' : '') + ' onclick="toggleEntrySelection(this, ' + inc.id + ')"></td>' : '') +
                '<td class="journal-icon-cell">' + iconHtml + '</td>' +
                '<td>' + dateHtml + '</td>' +
                '<td>' + titleHtml + '</td>' +
                '<td class="journal-desc journal-hide-mobile">' + descHtml + '</td>' +
                '<td class="journal-clip">' + clipCell + '</td>';
            tbody.appendChild(tr);
        });
        // Update sort indicators in header
        var ths = table.querySelectorAll('thead th[data-col]');
        for (var i = 0; i < ths.length; i++) {
            ths[i].className = ths[i].getAttribute('data-col') === _journalSortCol ? (_journalSortAsc ? 'sort-asc' : 'sort-desc') : '';
            // Preserve journal-hide-mobile on description column
            if (ths[i].getAttribute('data-col') === 'description') {
                ths[i].className = (ths[i].className ? ths[i].className + ' ' : '') + 'journal-hide-mobile';
            }
        }
        var tableCard = document.getElementById('journal-table-card');
        if (tableCard) tableCard.style.display = '';
    }

    (function() {
        var table = document.getElementById('journal-table');
        if (table) {
            table.addEventListener('click', function(e) {
                var th = e.target.closest ? e.target.closest('th[data-col]') : null;
                if (!th) return;
                var col = th.getAttribute('data-col');
                if (col === _journalSortCol) {
                    _journalSortAsc = !_journalSortAsc;
                } else {
                    _journalSortCol = col;
                    _journalSortAsc = col === 'date' ? false : true;
                }
                loadJournal();
            });
        }
    })();

    /* ── Event Log ── */
    var _eventsOffset = 0;
    var _eventsPageSize = 50;
    var _eventTypeLabels = {
        health_change: T.event_type_health_change || 'Health Change',
        power_change: T.event_type_power_change || 'Power Change',
        snr_change: T.event_type_snr_change || 'SNR Change',
        channel_change: T.event_type_channel_change || 'Channel Change',
        modulation_change: T.event_type_modulation_change || 'Modulation Change',
        error_spike: T.event_type_error_spike || 'Error Spike'
    };
    var _sevLabels = {
        info: T.event_severity_info || 'Info',
        warning: T.event_severity_warning || 'Warning',
        critical: T.event_severity_critical || 'Critical'
    };

    /* Phase 4.3: Pill filter toggle function */
    var _currentSeverityFilter = '';
    
    function filterEventsBySeverity(severity) {
        _currentSeverityFilter = severity;
        // Update active pill state
        var pills = document.querySelectorAll('.severity-pill');
        pills.forEach(function(pill) {
            if (pill.getAttribute('data-severity') === severity) {
                pill.classList.add('active');
            } else {
                pill.classList.remove('active');
            }
        });
        // Reload events with new filter
        loadEvents();
    }
    
    function loadEvents(append) {
        if (!append) _eventsOffset = 0;
        var severity = _currentSeverityFilter;
        var params = '?limit=' + _eventsPageSize + '&offset=' + _eventsOffset;
        if (severity) params += '&severity=' + severity;

        var tbody = document.getElementById('events-tbody');
        var tableCard = document.getElementById('events-table-card');
        var table = document.getElementById('events-table');
        var empty = document.getElementById('events-empty');
        var loading = document.getElementById('events-loading');
        var moreBtn = document.getElementById('events-show-more');
        var ackAllBtn = document.getElementById('btn-ack-all');

        if (!append) {
            loading.style.display = '';
            tbody.innerHTML = '';
            tableCard.style.display = 'none';
            empty.style.display = 'none';
            moreBtn.style.display = 'none';
        }

        fetch('/api/events' + params)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                loading.style.display = 'none';
                var events = data.events || [];
                var unack = data.unacknowledged_count || 0;
                updateEventBadge(unack);
                ackAllBtn.style.display = unack > 0 ? '' : 'none';

                if (events.length === 0 && !append) {
                    empty.textContent = T.event_no_events || 'No events detected yet.';
                    empty.style.display = '';
                    return;
                }
                events.forEach(function(ev) {
                    var tr = document.createElement('tr');
                    if (ev.acknowledged) tr.className = 'event-acked';
                    tr.setAttribute('data-event-id', ev.id);
                    var sevClass = 'sev-badge-' + ev.severity;
                    var sevLabel = _sevLabels[ev.severity] || ev.severity;
                    var typeLabel = _eventTypeLabels[ev.event_type] || ev.event_type;
                    var ackBtn = ev.acknowledged
                        ? '<span style="color:var(--muted);font-size:0.8em;">&#10003;</span>'
                        : '<button class="btn-ack" onclick="acknowledgeEvent(' + ev.id + ', event)">&#10003;</button>';
                    tr.innerHTML =
                        '<td style="white-space:nowrap;">' + escapeHtml(ev.timestamp.replace('T', ' ')) + '</td>' +
                        '<td><span class="' + sevClass + '">' + sevLabel + '</span></td>' +
                        '<td>' + escapeHtml(typeLabel) + '</td>' +
                        '<td class="event-msg">' + escapeHtml(ev.message) + '</td>' +
                        '<td class="event-actions">' + ackBtn + '</td>';
                    if (ev.details) {
                        tr.style.cursor = 'pointer';
                        tr.onclick = function(e) {
                            if (e.target.tagName === 'BUTTON') return;
                            toggleEventDetail(ev.id, ev.details);
                        };
                    }
                    tbody.appendChild(tr);
                });
                tableCard.style.display = '';
                moreBtn.style.display = events.length >= _eventsPageSize ? '' : 'none';
            })
            .catch(function() {
                loading.style.display = 'none';
                empty.textContent = T.network_error || 'Error';
                empty.style.display = '';
            });
    }

    function loadMoreEvents() {
        _eventsOffset += _eventsPageSize;
        loadEvents(true);
    }

    function toggleEventDetail(eventId, details) {
        var existing = document.getElementById('event-detail-' + eventId);
        if (existing) {
            existing.remove();
            return;
        }
        var eventRow = document.querySelector('tr[data-event-id="' + eventId + '"]');
        if (!eventRow) return;
        var detailRow = document.createElement('tr');
        detailRow.id = 'event-detail-' + eventId;
        detailRow.className = 'event-detail-row';
        var td = document.createElement('td');
        td.colSpan = 5;
        var pre = document.createElement('pre');
        pre.textContent = JSON.stringify(details, null, 2);
        td.appendChild(pre);
        detailRow.appendChild(td);
        eventRow.parentNode.insertBefore(detailRow, eventRow.nextSibling);
    }

    function acknowledgeEvent(eventId, e) {
        if (e) e.stopPropagation();
        fetch('/api/events/' + eventId + '/acknowledge', { method: 'POST' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) loadEvents();
            });
    }

    function acknowledgeAllEvents() {
        fetch('/api/events/acknowledge-all', { method: 'POST' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) loadEvents();
            });
    }

    function updateEventBadge(count) {
        var badge = document.getElementById('event-badge');
        if (!badge) return;
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.style.display = '';
        } else {
            badge.style.display = 'none';
        }
    }

    window.acknowledgeEvent = acknowledgeEvent;
    window.acknowledgeAllEvents = acknowledgeAllEvents;
    window.loadEvents = loadEvents;
    window.filterEventsBySeverity = filterEventsBySeverity;

    // Fetch badge count on page load
    fetch('/api/events/count')
        .then(function(r) { return r.json(); })
        .then(function(data) { updateEventBadge(data.count || 0); })
        .catch(function() {});

    /* ── Channel Mode Switch (Timeline / Compare) ── */
    function switchChannelMode() {
        var mode = getPillValue('channel-mode-tabs') || 'timeline';
        var timelinePanel = document.getElementById('channel-panel-timeline');
        var comparePanel = document.getElementById('channel-panel-compare');
        if (mode === 'compare') {
            timelinePanel.style.display = 'none';
            comparePanel.style.display = '';
            loadCompareChannelList();
        } else {
            timelinePanel.style.display = '';
            comparePanel.style.display = 'none';
        }
    }
    window.switchChannelMode = switchChannelMode;

    /* ── Channel Timeline ── */
    var _channelsLoaded = false;

    function loadChannelList() {
        if (_channelsLoaded) return;
        var sel = document.getElementById('channel-select');
        fetch('/api/channels')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                sel.innerHTML = '<option value="">' + (T.select_channel || 'Select Channel') + '</option>';
                var ds = data.ds_channels || [];
                var us = data.us_channels || [];
                if (ds.length) {
                    var grp = document.createElement('optgroup');
                    grp.label = T.downstream_channels || 'Downstream Channels';
                    ds.forEach(function(ch) {
                        var opt = document.createElement('option');
                        opt.value = 'ds-' + ch.channel_id;
                        opt.dataset.docsis = ch.docsis_version || '3.0';
                        opt.textContent = 'DS ' + ch.channel_id + ' (' + (ch.frequency || '') + ')';
                        grp.appendChild(opt);
                    });
                    sel.appendChild(grp);
                }
                if (us.length) {
                    var grp2 = document.createElement('optgroup');
                    grp2.label = T.upstream_channels || 'Upstream Channels';
                    us.forEach(function(ch) {
                        var opt = document.createElement('option');
                        opt.value = 'us-' + ch.channel_id;
                        opt.dataset.docsis = ch.docsis_version || '3.0';
                        opt.textContent = 'US ' + ch.channel_id + ' (' + (ch.frequency || '') + ')';
                        grp2.appendChild(opt);
                    });
                    sel.appendChild(grp2);
                }
                _channelsLoaded = true;
            })
            .catch(function() {});
    }

    function loadChannelTimeline() {
        var sel = document.getElementById('channel-select');
        var val = sel.value;
        var chartsEl = document.getElementById('channel-charts');
        var emptyEl = document.getElementById('channel-empty');
        var loadingEl = document.getElementById('channel-loading');
        if (!val) {
            chartsEl.style.display = 'none';
            emptyEl.style.display = 'none';
            return;
        }
        var parts = val.split('-');
        var direction = parts[0];
        var channelId = parts[1];
        var selectedOpt = sel.options[sel.selectedIndex];
        var docsisVersion = selectedOpt ? selectedOpt.dataset.docsis || '3.0' : '3.0';
        var days = getPillValue('channel-time-tabs');

        loadingEl.style.display = '';
        chartsEl.style.display = 'none';
        emptyEl.style.display = 'none';

        fetch('/api/channel-history?channel_id=' + channelId + '&direction=' + direction + '&days=' + days)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                loadingEl.style.display = 'none';
                if (!data || data.length === 0) {
                    emptyEl.textContent = T.no_channel_data || 'No data available for this channel.';
                    emptyEl.style.display = '';
                    return;
                }
                chartsEl.style.display = '';
                var xLabels = data.map(function(d) {
                    if (!d.timestamp) return '';
                    if (parseInt(days) <= 1) return d.timestamp.substring(11, 16);
                    return d.timestamp.substring(5, 16).replace('T', ' ');
                });
                var powerDatasets = [{label: T.power_dbmv || 'Power (dBmV)', data: data.map(function(d){ return d.power; }), color: '#00e5f0'}];
                var powerThresholds = direction === 'ds' ? DS_POWER_THRESHOLDS : US_POWER_THRESHOLDS;
                var powerCard = document.querySelector('#channel-charts .chart-card:first-child');
                var powerLabel = powerCard ? powerCard.querySelector('.chart-label') : null;
                var errorsCard = document.getElementById('channel-errors-card');
                if (direction === 'ds') {
                    powerDatasets.push({label: T.snr_db || 'SNR (dB)', data: data.map(function(d){ return d.snr; }), color: '#66ff77'});
                    powerThresholds = null; /* DS combines Power + SNR, thresholds don't apply */
                    if (powerLabel) powerLabel.textContent = (T.power_dbmv || 'Power') + ' & ' + (T.snr_db || 'SNR');
                    errorsCard.style.display = '';
                    renderChart('chart-ch-errors', xLabels, [
                        {label: T.correctable || 'Correctable', data: data.map(function(d){ return d.correctable_errors; }), color: '#2196f3'},
                        {label: T.uncorrectable || 'Uncorrectable', data: data.map(function(d){ return d.uncorrectable_errors; }), color: '#f44336'}
                    ], 'bar');
                } else {
                    if (powerLabel) powerLabel.textContent = T.power_dbmv || 'Power (dBmV)';
                    errorsCard.style.display = 'none';
                }
                renderChart('chart-ch-power', xLabels, powerDatasets, null, powerThresholds);

                // Modulation timeline (stepped line chart)
                var modCard = document.getElementById('channel-modulation-card');
                var mods = data.filter(function(d) { return d.modulation; });
                if (mods.length === 0) {
                    modCard.style.display = 'none';
                } else {
                    modCard.style.display = '';
                    // Fixed QAM scales per channel direction and DOCSIS version
                    var is31 = docsisVersion === '3.1' || docsisVersion === '4.0';
                    var usQam30 = [4, 8, 16, 32, 64, 128];
                    var usQam31 = [4, 8, 16, 32, 64, 128, 256, 512, 1024];
                    var dsQam30 = [64, 256];
                    var dsQam31 = [16, 64, 256, 1024, 2048, 4096];
                    var qamSteps;
                    if (direction === 'us') { qamSteps = is31 ? usQam31 : usQam30; }
                    else { qamSteps = is31 ? dsQam31 : dsQam30; }
                    var qamLabel = {}; qamSteps.forEach(function(v) { qamLabel[v] = v + 'QAM'; });
                    var qamMap = {}; qamSteps.forEach(function(v, i) { qamMap[v + 'QAM'] = i; });
                    var modLabels = mods.map(function(d) { return d.timestamp.substring(5, 16).replace('T', ' '); });
                    var modValues = mods.map(function(d) { return qamMap[d.modulation] !== undefined ? qamMap[d.modulation] : -1; });
                    var tickValues = [];
                    for (var qi = 0; qi < qamSteps.length; qi++) tickValues.push(qi);
                    renderChart('chart-ch-modulation', modLabels, [
                        {label: T.modulation || 'Modulation', data: modValues, color: '#ffab40', stepped: true}
                    ], null, null, {
                        yTickCallback: function(value) { return qamLabel[qamSteps[value]] || ''; },
                        tooltipLabelCallback: function(ctx) { return (T.modulation || 'Modulation') + ': ' + (qamLabel[qamSteps[ctx.raw]] || ctx.raw); },
                        yMin: -0.5,
                        yMax: qamSteps.length - 0.5,
                        yAfterBuildTicks: function(axis) {
                            axis.ticks = tickValues.map(function(v) { return {value: v}; });
                        }
                    });
                }
            })
            .catch(function() {
                loadingEl.style.display = 'none';
                emptyEl.textContent = T.trend_error || 'Error loading data.';
                emptyEl.style.display = '';
            });
    }
    window.loadChannelTimeline = loadChannelTimeline;

    /* ── Channel Compare ── */
    var _compareChannels = [];
    var _compareColors = ['#a855f7', '#3b82f6', '#10b981', '#f59e0b', '#ec4899', '#06b6d4'];
    var _compareChannelData = null;

    function loadCompareChannelList() {
        var dir = getPillValue('compare-dir-tabs') || 'ds';
        var sel = document.getElementById('compare-channel-select');
        fetch('/api/channels')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                sel.innerHTML = '<option value="">' + (T.select_channel || 'Select Channel') + '</option>';
                var channels = dir === 'ds' ? (data.ds_channels || []) : (data.us_channels || []);
                channels.forEach(function(ch) {
                    var already = _compareChannels.some(function(c) { return c.id === ch.channel_id; });
                    if (already) return;
                    var opt = document.createElement('option');
                    opt.value = ch.channel_id;
                    opt.dataset.docsis = ch.docsis_version || '3.0';
                    opt.dataset.freq = ch.frequency || '';
                    var prefix = dir === 'ds' ? 'DS' : 'US';
                    opt.textContent = prefix + ' ' + ch.channel_id + ' (' + (ch.frequency || '') + ')';
                    sel.appendChild(opt);
                });
            })
            .catch(function() {});
    }

    function onCompareDirectionChange() {
        _compareChannels = [];
        renderCompareChips();
        var chartsEl = document.getElementById('compare-charts');
        var emptyEl = document.getElementById('compare-empty');
        chartsEl.style.display = 'none';
        emptyEl.style.display = 'none';
        // Destroy existing compare charts
        ['chart-cmp-power', 'chart-cmp-snr', 'chart-cmp-errors', 'chart-cmp-modulation'].forEach(function(id) {
            if (charts[id]) { charts[id].destroy(); delete charts[id]; }
        });
        loadCompareChannelList();
    }
    window.onCompareDirectionChange = onCompareDirectionChange;

    function addCompareChannel() {
        var sel = document.getElementById('compare-channel-select');
        var opt = sel.options[sel.selectedIndex];
        if (!opt || !opt.value) return;
        if (_compareChannels.length >= 6) {
            alert(T.max_channels_reached || 'Maximum 6 channels');
            return;
        }
        var id = parseInt(opt.value);
        if (_compareChannels.some(function(c) { return c.id === id; })) return;
        var dir = getPillValue('compare-dir-tabs') || 'ds';
        var prefix = dir === 'ds' ? 'DS' : 'US';
        _compareChannels.push({
            id: id,
            label: prefix + ' ' + id + ' (' + (opt.dataset.freq || '') + ')',
            color: _compareColors[_compareChannels.length],
            docsis: opt.dataset.docsis || '3.0'
        });
        renderCompareChips();
        loadCompareChannelList();
        loadCompareCharts();
    }
    window.addCompareChannel = addCompareChannel;

    function removeCompareChannel(id) {
        _compareChannels = _compareChannels.filter(function(c) { return c.id !== id; });
        // Re-assign colors sequentially
        _compareChannels.forEach(function(c, i) { c.color = _compareColors[i]; });
        renderCompareChips();
        loadCompareChannelList();
        if (_compareChannels.length > 0) {
            loadCompareCharts();
        } else {
            document.getElementById('compare-charts').style.display = 'none';
            ['chart-cmp-power', 'chart-cmp-snr', 'chart-cmp-errors', 'chart-cmp-modulation'].forEach(function(id) {
                if (charts[id]) { charts[id].destroy(); delete charts[id]; }
            });
        }
    }
    window.removeCompareChannel = removeCompareChannel;

    function renderCompareChips() {
        var container = document.getElementById('compare-chips');
        container.innerHTML = '';
        _compareChannels.forEach(function(ch) {
            var chip = document.createElement('span');
            chip.className = 'compare-chip';
            chip.style.backgroundColor = ch.color;
            chip.innerHTML = ch.label + ' <button class="compare-chip-remove" onclick="removeCompareChannel(' + ch.id + ')">&times;</button>';
            container.appendChild(chip);
        });
    }

    function loadCompareCharts() {
        var chartsEl = document.getElementById('compare-charts');
        var emptyEl = document.getElementById('compare-empty');
        var loadingEl = document.getElementById('compare-loading');
        if (_compareChannels.length === 0) {
            chartsEl.style.display = 'none';
            emptyEl.textContent = T.no_channels_selected || 'Select channels to compare';
            emptyEl.style.display = '';
            return;
        }
        var dir = getPillValue('compare-dir-tabs') || 'ds';
        var days = getPillValue('compare-time-tabs') || '7';
        var ids = _compareChannels.map(function(c) { return c.id; }).join(',');

        loadingEl.style.display = '';
        chartsEl.style.display = 'none';
        emptyEl.style.display = 'none';

        fetch('/api/channel-compare?channels=' + ids + '&direction=' + dir + '&days=' + days)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                loadingEl.style.display = 'none';
                _compareChannelData = data;

                // Build unified timestamp list from all channels
                var tsSet = {};
                _compareChannels.forEach(function(ch) {
                    var chData = data[String(ch.id)] || [];
                    chData.forEach(function(d) { tsSet[d.timestamp] = true; });
                });
                var timestamps = Object.keys(tsSet).sort();
                if (timestamps.length === 0) {
                    emptyEl.textContent = T.no_channel_data || 'No data available.';
                    emptyEl.style.display = '';
                    return;
                }
                chartsEl.style.display = '';

                var xLabels = timestamps.map(function(ts) {
                    if (parseInt(days) <= 1) return ts.substring(11, 16);
                    return ts.substring(5, 16).replace('T', ' ');
                });

                // Build lookup maps per channel: timestamp -> data point
                var lookups = {};
                _compareChannels.forEach(function(ch) {
                    var map = {};
                    (data[String(ch.id)] || []).forEach(function(d) { map[d.timestamp] = d; });
                    lookups[ch.id] = map;
                });

                // Power Chart
                var powerDatasets = _compareChannels.map(function(ch) {
                    return {
                        label: 'CH ' + ch.id,
                        data: timestamps.map(function(ts) { var d = lookups[ch.id][ts]; return d ? d.power : null; }),
                        color: ch.color
                    };
                });
                var powerThresholds = dir === 'ds' ? DS_POWER_THRESHOLDS : US_POWER_THRESHOLDS;
                renderChart('chart-cmp-power', xLabels, powerDatasets, null, powerThresholds);

                // SNR Chart (DS only)
                var snrCard = document.getElementById('compare-snr-card');
                if (dir === 'ds') {
                    snrCard.style.display = '';
                    var snrDatasets = _compareChannels.map(function(ch) {
                        return {
                            label: 'CH ' + ch.id,
                            data: timestamps.map(function(ts) { var d = lookups[ch.id][ts]; return d ? d.snr : null; }),
                            color: ch.color
                        };
                    });
                    renderChart('chart-cmp-snr', xLabels, snrDatasets, null, DS_SNR_THRESHOLDS);
                } else {
                    snrCard.style.display = 'none';
                }

                // Errors Chart (DS only, lines not bars)
                var errorsCard = document.getElementById('compare-errors-card');
                if (dir === 'ds') {
                    errorsCard.style.display = '';
                    var errorDatasets = [];
                    _compareChannels.forEach(function(ch) {
                        errorDatasets.push({
                            label: 'CH ' + ch.id + ' ' + (T.uncorrectable || 'Uncorr.'),
                            data: timestamps.map(function(ts) { var d = lookups[ch.id][ts]; return d ? d.uncorrectable_errors : null; }),
                            color: ch.color
                        });
                        errorDatasets.push({
                            label: 'CH ' + ch.id + ' ' + (T.correctable || 'Corr.'),
                            data: timestamps.map(function(ts) { var d = lookups[ch.id][ts]; return d ? d.correctable_errors : null; }),
                            color: ch.color,
                            dashed: true
                        });
                    });
                    renderChart('chart-cmp-errors', xLabels, errorDatasets);
                } else {
                    errorsCard.style.display = 'none';
                }

                // Modulation Chart
                var modCard = document.getElementById('compare-modulation-card');
                var hasMod = false;
                _compareChannels.forEach(function(ch) {
                    var chData = data[String(ch.id)] || [];
                    if (chData.some(function(d) { return d.modulation; })) hasMod = true;
                });
                if (!hasMod) {
                    modCard.style.display = 'none';
                } else {
                    modCard.style.display = '';
                    // Collect all unique QAM values
                    var allQam = {};
                    _compareChannels.forEach(function(ch) {
                        (data[String(ch.id)] || []).forEach(function(d) {
                            if (d.modulation) allQam[d.modulation] = true;
                        });
                    });
                    var qamNames = Object.keys(allQam).sort(function(a, b) {
                        var na = parseInt(a) || 0, nb = parseInt(b) || 0;
                        return na - nb;
                    });
                    var qamMap = {};
                    qamNames.forEach(function(name, idx) { qamMap[name] = idx; });
                    var qamLabel = {};
                    qamNames.forEach(function(name, idx) { qamLabel[idx] = name; });

                    var modDatasets = _compareChannels.map(function(ch) {
                        return {
                            label: 'CH ' + ch.id,
                            data: timestamps.map(function(ts) {
                                var d = lookups[ch.id][ts];
                                if (!d || !d.modulation) return null;
                                return qamMap[d.modulation] !== undefined ? qamMap[d.modulation] : null;
                            }),
                            color: ch.color,
                            stepped: true
                        };
                    });
                    var tickValues = [];
                    for (var qi = 0; qi < qamNames.length; qi++) tickValues.push(qi);
                    renderChart('chart-cmp-modulation', xLabels, modDatasets, null, null, {
                        yTickCallback: function(value) { return qamLabel[value] || ''; },
                        tooltipLabelCallback: function(ctx) { return ctx.dataset.label + ': ' + (qamLabel[ctx.raw] || ctx.raw); },
                        yMin: -0.5,
                        yMax: qamNames.length - 0.5,
                        yAfterBuildTicks: function(axis) {
                            axis.ticks = tickValues.map(function(v) { return {value: v}; });
                        }
                    });
                }
            })
            .catch(function() {
                loadingEl.style.display = 'none';
                emptyEl.textContent = T.trend_error || 'Error loading data.';
                emptyEl.style.display = '';
            });
    }
    window.loadCompareCharts = loadCompareCharts;

    function updateModalIcon() {
        var iconEl = document.getElementById('entry-modal-icon');
        var manualIcon = document.getElementById('entry-icon-value').value;
        var match;
        if (manualIcon) {
            match = getIconByLabel(manualIcon);
        } else {
            var title = document.getElementById('entry-title-input').value;
            var desc = document.getElementById('entry-desc').value;
            match = detectIcon(title, desc);
        }
        iconEl.innerHTML = match ? match.icon : '';
    }

    function populateIncidentSelect(selectedId) {
        var sel = document.getElementById('entry-incident-select');
        sel.innerHTML = '<option value="">' + (T.incident_none || 'No Incident') + '</option>';
        _incidentsData.forEach(function(inc) {
            var opt = document.createElement('option');
            opt.value = inc.id;
            opt.textContent = inc.name + ' (' + (T['incident_status_' + inc.status] || inc.status) + ')';
            if (selectedId && parseInt(selectedId) === inc.id) opt.selected = true;
            sel.appendChild(opt);
        });
    }

    function openEntryModal(entryId) {
        var modal = document.getElementById('entry-modal');
        var titleEl = document.getElementById('entry-modal-title');
        var idEl = document.getElementById('entry-id');
        var dateEl = document.getElementById('entry-date');
        var titleInput = document.getElementById('entry-title-input');
        var descEl = document.getElementById('entry-desc');
        var iconVal = document.getElementById('entry-icon-value');
        var deleteBtn = document.getElementById('entry-delete-btn');
        var attachSection = document.getElementById('entry-attachments-section');
        var attachList = document.getElementById('entry-attachment-list');

        attachList.innerHTML = '';

        if (entryId) {
            titleEl.textContent = T.edit_entry || 'Edit Entry';
            deleteBtn.style.display = '';
            fetch('/api/journal/' + entryId)
                .then(function(r) { return r.json(); })
                .then(function(entry) {
                    idEl.value = entry.id;
                    dateEl.value = entry.date;
                    titleInput.value = entry.title;
                    descEl.value = entry.description || '';
                    iconVal.value = entry.icon || '';
                    renderIconPicker(entry.icon || '');
                    updateModalIcon();
                    populateIncidentSelect(entry.incident_id);
                    renderAttachments(entry.attachments || [], attachList, entryId);
                    attachSection.style.display = '';
                    modal.classList.add('open');
                });
        } else {
            titleEl.textContent = T.new_entry || 'New Entry';
            idEl.value = '';
            dateEl.value = todayStr();
            titleInput.value = '';
            descEl.value = '';
            iconVal.value = '';
            renderIconPicker('');
            updateModalIcon();
            populateIncidentSelect(_activeIncidentFilter > 0 ? _activeIncidentFilter : null);
            deleteBtn.style.display = 'none';
            attachSection.style.display = 'none';
            modal.classList.add('open');
        }
    }

    // Live icon update when typing title
    (function() {
        var ti = document.getElementById('entry-title-input');
        if (ti) ti.addEventListener('input', updateModalIcon);
    })();

    function closeEntryModal() {
        document.getElementById('entry-modal').classList.remove('open');
    }

    function renderAttachments(attachments, container, incidentId) {
        container.innerHTML = '';
        attachments.forEach(function(att) {
            var item = document.createElement('div');
            item.className = 'attachment-item';
            var isImage = att.mime_type && att.mime_type.indexOf('image/') === 0;
            var thumbHtml = '';
            if (isImage) {
                thumbHtml = '<img class="attachment-thumb" src="/api/attachments/' + att.id + '" alt="">';
            } else if (att.mime_type === 'application/pdf') {
                thumbHtml = '<div class="attachment-icon">&#128196;</div>';
            } else {
                thumbHtml = '<div class="attachment-icon">&#128462;</div>';
            }
            item.innerHTML = thumbHtml +
                '<div class="attachment-info">' +
                    '<span class="attachment-name">' + escapeHtml(att.filename) + '</span>' +
                    '<div class="attachment-actions">' +
                        '<a href="/api/attachments/' + att.id + '" download title="Download">&#11015;</a>' +
                        '<button onclick="deleteAttachment(' + att.id + ', ' + incidentId + ')" title="Delete">&#128465;</button>' +
                    '</div>' +
                '</div>';
            container.appendChild(item);
        });
    }

    function saveEntry() {
        var idEl = document.getElementById('entry-id');
        var dateVal = document.getElementById('entry-date').value;
        var titleVal = document.getElementById('entry-title-input').value.trim();
        var descVal = document.getElementById('entry-desc').value.trim();
        var entryId = idEl.value;

        if (!titleVal) {
            showToast(T.incident_title + ' required', 'error');
            return;
        }

        var iconVal = document.getElementById('entry-icon-value').value || '';
        var incidentSel = document.getElementById('entry-incident-select');
        var incidentIdVal = incidentSel ? incidentSel.value : '';
        var payload = JSON.stringify({date: dateVal, title: titleVal, description: descVal, icon: iconVal, incident_id: incidentIdVal ? parseInt(incidentIdVal) : null});
        var url = entryId ? '/api/journal/' + entryId : '/api/journal';
        var method = entryId ? 'PUT' : 'POST';

        fetch(url, {method: method, headers: {'Content-Type': 'application/json'}, body: payload})
            .then(function(r) { return r.json().then(function(d) { return {status: r.status, data: d}; }); })
            .then(function(res) {
                if (res.status >= 400) {
                    showToast(res.data.error || 'Error', 'error');
                    return;
                }
                loadJournal();
                loadIncidents();
                if (!entryId && res.data.id) {
                    // New entry: switch modal to edit mode in-place (keep it open)
                    idEl.value = res.data.id;
                    document.getElementById('entry-modal-title').textContent = T.edit_entry || 'Edit Entry';
                    document.getElementById('entry-delete-btn').style.display = '';
                    document.getElementById('entry-attachments-section').style.display = '';
                    showToast(T.saved || 'Saved', 'ok');
                } else {
                    closeEntryModal();
                }
            })
            .catch(function() { showToast(T.network_error || 'Error', 'error'); });
    }

    function deleteEntry() {
        var entryId = document.getElementById('entry-id').value;
        if (!entryId) return;
        if (!confirm(T.confirm_delete || 'Are you sure?')) return;
        fetch('/api/journal/' + entryId, {method: 'DELETE'})
            .then(function(r) { return r.json(); })
            .then(function() {
                closeEntryModal();
                loadJournal();
            })
            .catch(function() { showToast(T.network_error || 'Error', 'error'); });
    }

    function handleEntryFileUpload(input) {
        var incidentId = document.getElementById('entry-id').value;
        if (!incidentId || !input.files || input.files.length === 0) return;
        var spinner = document.getElementById('entry-upload-spinner');
        var uploadBtn = document.getElementById('entry-upload-btn');
        spinner.style.display = 'inline';
        uploadBtn.disabled = true;
        var uploads = [];
        for (var i = 0; i < input.files.length; i++) {
            uploads.push(uploadOneFile(incidentId, input.files[i]));
        }
        Promise.all(uploads)
            .then(function(results) {
                var errors = results.filter(function(r) { return r.error; });
                if (errors.length > 0) {
                    showToast(errors[0].error, 'error');
                }
                spinner.style.display = 'none';
                uploadBtn.disabled = false;
                input.value = '';
                // Reload attachments
                fetch('/api/journal/' + incidentId)
                    .then(function(r) { return r.json(); })
                    .then(function(inc) {
                        renderAttachments(inc.attachments || [], document.getElementById('entry-attachment-list'), incidentId);
                    });
            })
            .catch(function() {
                spinner.style.display = 'none';
                uploadBtn.disabled = false;
                showToast(T.network_error || 'Error', 'error');
            });
    }

    function uploadOneFile(incidentId, file) {
        var formData = new FormData();
        formData.append('file', file);
        return fetch('/api/journal/' + incidentId + '/attachments', {method: 'POST', body: formData})
            .then(function(r) { return r.json().then(function(d) { return r.status >= 400 ? {error: d.error} : d; }); })
            .catch(function() { return {error: T.network_error || 'Upload failed'}; });
    }

    function deleteAttachment(attachmentId, incidentId) {
        fetch('/api/attachments/' + attachmentId, {method: 'DELETE'})
            .then(function(r) { return r.json(); })
            .then(function() {
                fetch('/api/journal/' + incidentId)
                    .then(function(r) { return r.json(); })
                    .then(function(inc) {
                        renderAttachments(inc.attachments || [], document.getElementById('entry-attachment-list'), incidentId);
                    });
            })
            .catch(function() { showToast(T.network_error || 'Error', 'error'); });
    }

    /* ── Import Modal ── */
    var _importPreviewData = null;

    function openImportModal() {
        var modal = document.getElementById('import-modal');
        document.getElementById('import-upload-zone').style.display = '';
        document.getElementById('import-loading').style.display = 'none';
        document.getElementById('import-preview').style.display = 'none';
        document.getElementById('import-footer').style.display = 'none';
        document.getElementById('import-file-input').value = '';
        _importPreviewData = null;
        modal.classList.add('open');
    }

    function closeImportModal() {
        document.getElementById('import-modal').classList.remove('open');
    }

    // Drag & drop support
    (function() {
        var zone = document.getElementById('import-upload-zone');
        if (!zone) return;
        zone.addEventListener('click', function() {
            document.getElementById('import-file-input').click();
        });
        zone.addEventListener('dragover', function(e) {
            e.preventDefault();
            zone.classList.add('dragover');
        });
        zone.addEventListener('dragleave', function() {
            zone.classList.remove('dragover');
        });
        zone.addEventListener('drop', function(e) {
            e.preventDefault();
            zone.classList.remove('dragover');
            var files = e.dataTransfer.files;
            if (files.length > 0) {
                var input = document.getElementById('import-file-input');
                input.files = files;
                handleImportFile(input);
            }
        });
    })();

    function handleImportFile(input) {
        if (!input.files || input.files.length === 0) return;
        var file = input.files[0];
        var lower = file.name.toLowerCase();
        if (!lower.endsWith('.xlsx') && !lower.endsWith('.csv')) {
            showToast(T.import_file_unsupported, 'error');
            return;
        }
        if (file.size > 5 * 1024 * 1024) {
            showToast(T.import_file_too_large, 'error');
            return;
        }

        document.getElementById('import-upload-zone').style.display = 'none';
        document.getElementById('import-loading').style.display = '';

        var formData = new FormData();
        formData.append('file', file);

        fetch('/api/journal/import/preview', {method: 'POST', body: formData})
            .then(function(r) { return r.json().then(function(d) { return {status: r.status, data: d}; }); })
            .then(function(res) {
                document.getElementById('import-loading').style.display = 'none';
                if (res.status >= 400) {
                    showToast(res.data.error || T.error_prefix, 'error');
                    document.getElementById('import-upload-zone').style.display = '';
                    return;
                }
                _importPreviewData = res.data;
                renderImportPreview(res.data);
            })
            .catch(function() {
                document.getElementById('import-loading').style.display = 'none';
                document.getElementById('import-upload-zone').style.display = '';
                showToast(T.network_error || 'Error', 'error');
            });
    }

    function renderImportPreview(data) {
        var tbody = document.getElementById('import-tbody');
        tbody.innerHTML = '';

        var dupeCount = data.duplicates || 0;
        var validCount = data.total - data.skipped;
        var info = data.total + ' ' + T.import_entries_found;
        if (data.skipped > 0) info += ', ' + data.skipped + ' ' + T.import_skipped;
        if (dupeCount > 0) info += ', ' + dupeCount + ' ' + T.import_duplicates;
        document.getElementById('import-info').textContent = info;

        data.rows.forEach(function(row, i) {
            var tr = document.createElement('tr');
            var isSkipped = row.skipped;
            var isDupe = row.duplicate;
            if (isDupe) tr.className = 'import-row-duplicate';
            if (isSkipped) tr.className = 'import-row-skipped';
            var checked = (isDupe || isSkipped) ? '' : 'checked';
            var desc = row.description || '';
            if (desc.length > 60) desc = desc.substring(0, 60) + '...';
            var dupeBadge = isDupe ? '<span class="import-duplicate-badge">' + T.import_duplicate + '</span>' : '';
            var iconMatch = detectIcon(row.title, row.description);
            var iconHtml = iconMatch ? iconMatch.icon : '';
            var dateCell;
            if (isSkipped) {
                var rawHint = row.raw_date ? ' placeholder="' + escapeHtml(row.raw_date) + '"' : '';
                dateCell = '<input type="date" class="import-date-fix" data-idx="' + i + '"' + rawHint +
                    ' style="width:140px;padding:2px 4px;border:1px solid var(--accent);border-radius:4px;background:var(--bg);color:var(--fg);font-size:0.85em;"' +
                    ' onchange="fixImportDate(this,' + i + ')">' +
                    '<span class="import-skipped-badge">' + (T.import_no_date || 'no date') + '</span>';
            } else {
                dateCell = escapeHtml(row.date);
            }
            tr.innerHTML =
                '<td><input type="checkbox" class="import-row-cb" data-idx="' + i + '" ' + checked + '></td>' +
                '<td style="text-align:center;">' + iconHtml + '</td>' +
                '<td>' + dateCell + '</td>' +
                '<td>' + escapeHtml(row.title) + dupeBadge + '</td>' +
                '<td class="journal-hide-mobile">' + escapeHtml(desc) + '</td>';
            tbody.appendChild(tr);
        });

        document.getElementById('import-select-all').checked = true;
        document.getElementById('import-preview').style.display = '';
        document.getElementById('import-footer').style.display = '';
    }

    function fixImportDate(input, idx) {
        if (!_importPreviewData || !_importPreviewData.rows[idx]) return;
        var val = input.value;
        if (val) {
            _importPreviewData.rows[idx].date = val;
            _importPreviewData.rows[idx].skipped = false;
            var tr = input.closest('tr');
            if (tr) {
                tr.classList.remove('import-row-skipped');
                var cb = tr.querySelector('.import-row-cb');
                if (cb) cb.checked = true;
            }
            var badge = tr.querySelector('.import-skipped-badge');
            if (badge) badge.style.display = 'none';
        }
    }

    function toggleImportAll(checked) {
        var cbs = document.querySelectorAll('.import-row-cb');
        for (var i = 0; i < cbs.length; i++) {
            cbs[i].checked = checked;
        }
    }

    function confirmImport() {
        if (!_importPreviewData) return;
        var cbs = document.querySelectorAll('.import-row-cb');
        var selectedRows = [];
        for (var i = 0; i < cbs.length; i++) {
            if (cbs[i].checked) {
                var idx = parseInt(cbs[i].getAttribute('data-idx'));
                var row = _importPreviewData.rows[idx];
                if (row && row.date) {
                    selectedRows.push({
                        date: row.date,
                        title: row.title,
                        description: row.description
                    });
                }
            }
        }
        if (selectedRows.length === 0) {
            showToast(T.import_no_selection, 'error');
            return;
        }

        var btn = document.getElementById('import-confirm-btn');
        btn.disabled = true;
        btn.textContent = T.import_importing;

        fetch('/api/journal/import/confirm', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({rows: selectedRows})
        })
            .then(function(r) { return r.json().then(function(d) { return {status: r.status, data: d}; }); })
            .then(function(res) {
                btn.disabled = false;
                btn.textContent = T.import_selected;
                if (res.status >= 400) {
                    showToast(res.data.error || T.error_prefix, 'error');
                    return;
                }
                var msg = res.data.imported + ' ' + T.import_success;
                if (res.data.duplicates > 0) msg += ', ' + res.data.duplicates + ' ' + T.import_duplicates_skipped;
                showToast(msg, 'ok');
                closeImportModal();
                loadJournal();
            })
            .catch(function() {
                btn.disabled = false;
                btn.textContent = T.import_selected;
                showToast(T.network_error || 'Error', 'error');
            });
    }

    /* ── Delete All ── */
    function deleteAllEntries() {
        var count = document.querySelectorAll('#journal-tbody tr').length;
        if (count === 0) return;
        if (!confirm(T.delete_all_confirm.replace('{n}', count))) return;
        var confirmation = prompt(T.delete_all_type_confirm);
        if (confirmation !== 'DELETE') {
            showToast(T.delete_all_cancelled, 'error');
            return;
        }
        fetch('/api/journal/batch', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({all: true, confirm: 'DELETE_ALL'})
        })
            .then(function(r) { return r.json().then(function(d) { return {status: r.status, data: d}; }); })
            .then(function(res) {
                if (res.status >= 400) {
                    showToast(res.data.error || T.delete_failed, 'error');
                    return;
                }
                showToast(res.data.deleted + ' ' + T.delete_all_success, 'ok');
                loadJournal();
            })
            .catch(function() { showToast(T.network_error || 'Error', 'error'); });
    }

    /* ── Incident Containers ── */
    function loadIncidents() {
        fetch('/api/incidents')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                _incidentsData = data || [];
                renderIncidentBar(_incidentsData);
            })
            .catch(function() { _incidentsData = []; });
    }

    function renderIncidentBar(incidents) {
        var bar = document.getElementById('incident-filter-bar');
        if (!bar) return;
        bar.innerHTML = '';
        bar.style.display = '';

        // "All" pill
        var totalCount = 0;
        incidents.forEach(function(inc) { totalCount += (inc.entry_count || 0); });
        var allPill = document.createElement('button');
        allPill.className = 'incident-pill' + (_activeIncidentFilter === null ? ' active' : '');
        allPill.innerHTML = (T.incident_filter_all || 'All');
        allPill.onclick = function() { filterByIncident(null); };
        bar.appendChild(allPill);

        // "Unassigned" pill
        var unPill = document.createElement('button');
        unPill.className = 'incident-pill' + (_activeIncidentFilter === 0 ? ' active' : '');
        unPill.innerHTML = (T.incident_filter_unassigned || 'Unassigned');
        unPill.onclick = function() { filterByIncident(0); };
        bar.appendChild(unPill);

        // Incident pills
        incidents.forEach(function(inc) {
            var pill = document.createElement('button');
            pill.className = 'incident-pill incident-pill-has-edit' + (_activeIncidentFilter === inc.id ? ' active' : '');
            var statusDot = '<span class="incident-pill-status incident-pill-status-' + inc.status + '"></span>';
            pill.innerHTML = statusDot + ' ' + escapeHtml(inc.name) + ' <span class="incident-pill-count">(' + (inc.entry_count || 0) + ')</span>' +
                '<span class="incident-pill-edit" title="' + (T.incident_edit || 'Edit') + '">&#9998;</span>';
            pill.onclick = function(e) {
                if (e.target.closest('.incident-pill-edit')) { e.stopPropagation(); openIncidentModal(inc.id); return; }
                filterByIncident(inc.id);
            };
            bar.appendChild(pill);
        });

        // "+" add pill
        var addPill = document.createElement('button');
        addPill.className = 'incident-pill incident-pill-add';
        addPill.innerHTML = '+';
        addPill.title = T.incident_new || 'New Incident';
        addPill.onclick = function() { openIncidentModal(); };
        bar.appendChild(addPill);
    }

    function filterByIncident(incidentId) {
        _activeIncidentFilter = incidentId;
        renderIncidentBar(_incidentsData);
        renderIncidentSummary(incidentId);
        loadJournal();
    }

    function renderIncidentSummary(incidentId) {
        var el = document.getElementById('incident-summary');
        if (!el) return;
        if (!incidentId || incidentId === 0) {
            el.style.display = 'none';
            el.innerHTML = '';
            return;
        }
        var inc = null;
        for (var i = 0; i < _incidentsData.length; i++) {
            if (_incidentsData[i].id === incidentId) { inc = _incidentsData[i]; break; }
        }
        if (!inc) { el.style.display = 'none'; return; }

        var statusLabel = T['incident_status_' + inc.status] || inc.status;
        var statusClass = 'incident-summary-status-' + inc.status;
        var dateRange = '';
        if (inc.start_date) {
            dateRange = formatDateDE(inc.start_date);
            if (inc.end_date) dateRange += ' \u2013 ' + formatDateDE(inc.end_date);
            else dateRange += ' \u2013 ' + (T.incident_status_open || 'ongoing').toLowerCase();
        }

        var html = '<div class="incident-summary-header">';
        html += '<div class="incident-summary-title">' + escapeHtml(inc.name) + '</div>';
        html += '<span class="incident-summary-badge ' + statusClass + '">' + statusLabel + '</span>';
        if (dateRange) html += '<span class="incident-summary-date">' + dateRange + '</span>';
        html += '<span class="incident-summary-count">' + (inc.entry_count || 0) + ' ' + (T.incident_entry_count || 'Entries') + '</span>';
        html += '<button class="incident-summary-edit" onclick="openIncidentModal(' + inc.id + ')" title="' + (T.incident_edit || 'Edit') + '">&#9998;</button>';
        html += '<button class="incident-summary-timeline-btn" onclick="openIncidentTimeline(' + inc.id + ')">' + (T.incident_view_timeline || 'View Timeline') + '</button>';
        html += '</div>';
        if (inc.description) {
            var desc = inc.description.length > 200 ? inc.description.substring(0, 200) + '\u2026' : inc.description;
            html += '<div class="incident-summary-desc">' + escapeHtml(desc) + '</div>';
        }
        el.innerHTML = html;
        el.style.display = '';
    }

    /* ── Incident Timeline ── */
    var _timelineActive = false;
    var _timelineChartInstance = null;

    window.openIncidentTimeline = function(incidentId) {
        // Hide journal UI elements
        var tableCard = document.getElementById('journal-table-card');
        var searchWrap = document.getElementById('journal-search-wrap');
        var bulkBar = document.getElementById('journal-bulk-bar');
        var empty = document.getElementById('journal-empty');
        var deleteAllBtn = document.getElementById('btn-delete-all-entries');
        if (tableCard) tableCard.style.display = 'none';
        if (searchWrap) searchWrap.style.display = 'none';
        if (bulkBar) bulkBar.style.display = 'none';
        if (empty) empty.style.display = 'none';
        if (deleteAllBtn) deleteAllBtn.style.display = 'none';

        // Show timeline container with loading state
        var timelineView = document.getElementById('incident-timeline-view');
        timelineView.style.display = '';
        var header = document.getElementById('incident-timeline-header');
        header.innerHTML = '<div class="spinner" style="margin:20px auto;"></div>';

        _timelineActive = true;

        fetch('/api/incidents/' + incidentId + '/timeline')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.error) {
                    header.innerHTML = '<div class="incident-timeline-empty">' + escapeHtml(data.error) + '</div>';
                    return;
                }
                renderIncidentTimeline(data);
            })
            .catch(function() {
                header.innerHTML = '<div class="incident-timeline-empty">' + (T.network_error || 'Error') + '</div>';
            });
    };

    window.closeIncidentTimeline = function() {
        var timelineView = document.getElementById('incident-timeline-view');
        timelineView.style.display = 'none';
        _timelineActive = false;

        // Destroy chart to free memory
        if (_timelineChartInstance) {
            _timelineChartInstance = null;
        }

        // Re-show journal
        loadJournal();
    };

    window.downloadIncidentPdf = function(incidentId, incidentName) {
        var btn = document.querySelector('.incident-timeline-pdf-btn');
        var origHtml = btn ? btn.innerHTML : '';
        if (btn) { btn.disabled = true; btn.textContent = '\u23F3'; }
        fetch('/api/incidents/' + incidentId + '/report')
            .then(function(r) {
                if (!r.ok) throw new Error('Failed');
                return r.blob();
            })
            .then(function(blob) {
                var a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'DOCSight_Beschwerde_' + incidentName.replace(/[^a-zA-Z0-9]/g, '_') + '_' + new Date().toISOString().slice(0, 10) + '.pdf';
                a.click();
                URL.revokeObjectURL(a.href);
            })
            .catch(function() {
                alert(T.network_error || 'Error generating report');
            })
            .finally(function() {
                if (btn) { btn.disabled = false; btn.innerHTML = origHtml; }
            });
    };

    function renderIncidentTimeline(data) {
        var inc = data.incident;
        var entries = data.entries || [];
        var timeline = data.timeline || [];
        var bnetz = data.bnetz || [];

        // ── 1. Header Card ──
        var header = document.getElementById('incident-timeline-header');
        var statusLabel = T['incident_status_' + inc.status] || inc.status;
        var statusClass = 'incident-summary-status-' + inc.status;

        var dateRange = '';
        var durationText = '';
        if (inc.start_date) {
            dateRange = formatDateDE(inc.start_date);
            if (inc.end_date) {
                dateRange += ' \u2013 ' + formatDateDE(inc.end_date);
                var d1 = new Date(inc.start_date), d2 = new Date(inc.end_date);
                var diffDays = Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24));
                durationText = diffDays + ' ' + (T.incident_duration_days || 'days');
            } else {
                dateRange += ' \u2013 ' + (T.incident_duration_ongoing || 'ongoing');
            }
        }

        var hHtml = '<div class="incident-timeline-header-title">';
        hHtml += escapeHtml(inc.name);
        hHtml += ' <span class="incident-summary-badge ' + statusClass + '">' + statusLabel + '</span>';
        hHtml += '</div>';
        hHtml += '<div class="incident-timeline-meta">';
        if (dateRange) {
            hHtml += '<span class="incident-timeline-meta-item">';
            hHtml += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>';
            hHtml += dateRange;
            hHtml += '</span>';
        }
        if (durationText) {
            hHtml += '<span class="incident-timeline-meta-item">';
            hHtml += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>';
            hHtml += durationText;
            hHtml += '</span>';
        }
        hHtml += '<span class="incident-timeline-meta-item">';
        hHtml += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>';
        hHtml += entries.length + ' ' + (T.incident_entry_count || 'Entries');
        hHtml += '</span>';
        hHtml += '</div>';
        if (inc.description) {
            hHtml += '<div class="incident-timeline-desc">' + escapeHtml(inc.description) + '</div>';
        }
        hHtml += '<button class="incident-timeline-pdf-btn" onclick="downloadIncidentPdf(' + inc.id + ', \'' + escapeHtml(inc.name).replace(/'/g, "\\'") + '\')">';
        hHtml += '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> ';
        hHtml += (T.incident_download_pdf || 'Download PDF Report');
        hHtml += '</button>';
        header.innerHTML = hHtml;

        // ── 2. Journal Entries as Cards ──
        var entriesDiv = document.getElementById('incident-timeline-entries');
        if (entries.length === 0) {
            entriesDiv.style.display = 'none';
        } else {
            entriesDiv.style.display = '';
            var eHtml = '<div class="incident-timeline-section-title">';
            eHtml += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V5a2 2 0 00-2-2z"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>';
            eHtml += (T.incident_journal_entries || 'Journal Entries');
            eHtml += '</div>';
            eHtml += '<div class="incident-timeline-entries-grid">';
            entries.forEach(function(entry) {
                var icon = _getEntryIcon(entry);
                eHtml += '<div class="incident-timeline-entry" onclick="openEntryModal(' + entry.id + ')">';
                eHtml += '<div class="incident-timeline-entry-icon">' + icon + '</div>';
                eHtml += '<div class="incident-timeline-entry-body">';
                eHtml += '<div class="incident-timeline-entry-date">' + formatDateDE(entry.date) + '</div>';
                eHtml += '<div class="incident-timeline-entry-title">' + escapeHtml(entry.title) + '</div>';
                if (entry.description) {
                    var desc = entry.description.length > 120 ? entry.description.substring(0, 120) + '\u2026' : entry.description;
                    eHtml += '<div class="incident-timeline-entry-desc">' + escapeHtml(desc) + '</div>';
                }
                if (entry.attachment_count) {
                    eHtml += '<div class="incident-timeline-entry-att">\uD83D\uDCCE ' + entry.attachment_count + '</div>';
                }
                eHtml += '</div></div>';
            });
            eHtml += '</div>';
            entriesDiv.innerHTML = eHtml;
        }

        // ── 3. Signal Timeline Chart ──
        var chartCard = document.getElementById('incident-timeline-chart-card');
        if (timeline.length === 0) {
            chartCard.querySelector('.incident-timeline-chart-wrap').innerHTML =
                '<div class="incident-timeline-empty">' + (T.timeline_no_data || 'No signal data for this period') + '</div>';
        } else {
            chartCard.querySelector('.incident-timeline-chart-wrap').innerHTML =
                '<canvas id="incident-timeline-canvas"></canvas>';
            _renderTimelineChart(timeline);
        }

        // ── 4. Signal Timeline Table ──
        var signalsDiv = document.getElementById('incident-timeline-signals');
        if (timeline.length === 0) {
            signalsDiv.style.display = 'none';
        } else {
            signalsDiv.style.display = '';
            _renderTimelineTable(timeline);
        }

        // ── 5. BNetzA Section ──
        var bnetzDiv = document.getElementById('incident-timeline-bnetz');
        if (bnetz.length === 0) {
            bnetzDiv.style.display = 'none';
        } else {
            bnetzDiv.style.display = '';
            var bHtml = '<div class="incident-timeline-section-title">';
            bHtml += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>';
            bHtml += (T.incident_bnetz_measurements || 'BNetzA Measurements');
            bHtml += '</div>';
            bnetz.forEach(function(m) {
                var hasDeviation = m.verdict_download === 'deviation' || m.verdict_upload === 'deviation';
                var verdictText = hasDeviation ? (T.bnetz_verdict_deviation || 'Deviation') : (T.bnetz_verdict_ok || 'OK');
                var verdictClass = hasDeviation ? 'val-crit' : 'val-good';
                bHtml += '<div class="incident-timeline-bnetz-item">';
                bHtml += '<span>' + formatDateDE(m.date) + '</span>';
                bHtml += '<span>\u2193 ' + (m.download_measured_avg || 0).toFixed(1) + ' / ' + (m.download_max_tariff || 0).toFixed(0) + ' Mbps</span>';
                bHtml += '<span>\u2191 ' + (m.upload_measured_avg || 0).toFixed(1) + ' / ' + (m.upload_max_tariff || 0).toFixed(0) + ' Mbps</span>';
                bHtml += '<span class="incident-timeline-bnetz-verdict ' + verdictClass + '">' + verdictText + '</span>';
                bHtml += '</div>';
            });
            bnetzDiv.innerHTML = bHtml;
        }

        // Re-initialize Lucide icons
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function _getEntryIcon(entry) {
        // Try to find icon from label
        if (entry.icon) {
            for (var i = 0; i < INCIDENT_ICONS.length; i++) {
                if (INCIDENT_ICONS[i].label === entry.icon) return INCIDENT_ICONS[i].icon;
            }
        }
        // Auto-detect from title
        var title = (entry.title || '').toLowerCase();
        for (var i = 0; i < INCIDENT_ICONS.length; i++) {
            for (var j = 0; j < INCIDENT_ICONS[i].keys.length; j++) {
                if (title.indexOf(INCIDENT_ICONS[i].keys[j]) !== -1) return INCIDENT_ICONS[i].icon;
            }
        }
        // Default icon
        return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>';
    }

    function _renderTimelineChart(data) {
        var canvas = document.getElementById('incident-timeline-canvas');
        if (!canvas) return;
        var ctx = canvas.getContext('2d');
        var dpr = window.devicePixelRatio || 1;
        var rect = canvas.parentElement.getBoundingClientRect();
        var W = rect.width;
        var H = 280;
        canvas.width = W * dpr;
        canvas.height = H * dpr;
        canvas.style.width = W + 'px';
        canvas.style.height = H + 'px';
        ctx.scale(dpr, dpr);
        ctx.clearRect(0, 0, W, H);

        var pad = { top: 20, right: 60, bottom: 40, left: 60 };
        var plotW = W - pad.left - pad.right;
        var plotH = H - pad.top - pad.bottom;

        var modem = data.filter(function(d) { return d.source === 'modem'; });
        var speedtest = data.filter(function(d) { return d.source === 'speedtest'; });
        var events = data.filter(function(d) { return d.source === 'event'; });

        if (modem.length === 0 && speedtest.length === 0) {
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted').trim() || '#888';
            ctx.font = '13px system-ui, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(T.timeline_no_data || 'No signal data', W / 2, H / 2);
            return;
        }

        // Time range
        var allTs = data.map(function(d) { return new Date(d.timestamp).getTime(); });
        var tMin = Math.min.apply(null, allTs);
        var tMax = Math.max.apply(null, allTs);
        if (tMin === tMax) tMax = tMin + 86400000;

        function xScale(ts) { return pad.left + (ts - tMin) / (tMax - tMin) * plotW; }

        // SNR axis
        var snrValues = modem.map(function(d) { return d.ds_snr_min || 0; }).filter(function(v) { return v > 0; });
        var snrMin = snrValues.length ? Math.floor(Math.min.apply(null, snrValues) - 2) : 20;
        var snrMax = snrValues.length ? Math.ceil(Math.max.apply(null, snrValues) + 2) : 45;
        function ySnr(v) { return pad.top + plotH - (v - snrMin) / (snrMax - snrMin) * plotH; }

        // Speed axis (right)
        var dlValues = speedtest.map(function(d) { return d.download_mbps || 0; });
        var speedMax = dlValues.length ? Math.ceil(Math.max.apply(null, dlValues) * 1.1) : 500;
        if (speedMax < 10) speedMax = 100;
        function yDl(v) { return pad.top + plotH - v / speedMax * plotH; }

        var style = getComputedStyle(document.documentElement);
        var textColor = style.getPropertyValue('--muted').trim() || '#888';
        var gridColor = style.getPropertyValue('--input-border').trim() || '#333';
        var goodColor = style.getPropertyValue('--good').trim() || '#4caf50';
        var warnColor = style.getPropertyValue('--warn').trim() || '#ff9800';
        var critColor = style.getPropertyValue('--crit').trim() || '#f44336';
        var accentColor = style.getPropertyValue('--accent').trim() || '#a855f7';
        var uploadColor = '#06b6d4';

        // Grid
        ctx.strokeStyle = gridColor;
        ctx.lineWidth = 0.5;
        ctx.setLineDash([2, 4]);
        for (var s = Math.ceil(snrMin); s <= snrMax; s += 5) {
            var y = ySnr(s);
            ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + plotW, y); ctx.stroke();
        }
        ctx.setLineDash([]);

        // Time axis labels
        ctx.fillStyle = textColor;
        ctx.font = '10px system-ui, sans-serif';
        ctx.textAlign = 'center';
        var tRange = tMax - tMin;
        var labelCount = Math.min(8, Math.floor(plotW / 80));
        for (var i = 0; i <= labelCount; i++) {
            var t = tMin + tRange * i / labelCount;
            var d = new Date(t);
            var label;
            if (tRange > 172800000) { // > 2 days
                label = (d.getMonth() + 1) + '/' + d.getDate() + ' ' + String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
            } else {
                label = String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
            }
            ctx.fillText(label, xScale(t), H - pad.bottom + 18);
        }

        // Left axis labels (SNR)
        if (modem.length > 0) {
            ctx.textAlign = 'right';
            ctx.fillStyle = accentColor;
            for (var s = Math.ceil(snrMin); s <= snrMax; s += 5) {
                ctx.fillText(s + ' dB', pad.left - 6, ySnr(s) + 3);
            }
        }

        // Right axis labels (Speed)
        if (speedtest.length > 0) {
            ctx.textAlign = 'left';
            ctx.fillStyle = goodColor;
            var speedStep = speedMax > 400 ? 100 : speedMax > 200 ? 50 : 25;
            for (var v = 0; v <= speedMax; v += speedStep) {
                ctx.fillText(v + ' Mbps', pad.left + plotW + 6, yDl(v) + 3);
            }
        }

        // SNR line (modem)
        if (modem.length > 1) {
            var sorted = modem.slice().sort(function(a, b) {
                return new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime();
            });
            ctx.strokeStyle = accentColor;
            ctx.lineWidth = 2;
            ctx.beginPath();
            sorted.forEach(function(d, i) {
                var x = xScale(new Date(d.timestamp).getTime());
                var y = ySnr(d.ds_snr_min || snrMin);
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            });
            ctx.stroke();
        }

        // Speed dots
        speedtest.forEach(function(d) {
            var x = xScale(new Date(d.timestamp).getTime());
            // Download dot
            ctx.fillStyle = goodColor;
            ctx.beginPath();
            ctx.arc(x, yDl(d.download_mbps || 0), 4, 0, Math.PI * 2);
            ctx.fill();
            // Upload dot (smaller)
            ctx.fillStyle = uploadColor;
            ctx.beginPath();
            ctx.arc(x, yDl(d.upload_mbps || 0), 3, 0, Math.PI * 2);
            ctx.fill();
        });

        // Event markers
        events.forEach(function(d) {
            var x = xScale(new Date(d.timestamp).getTime());
            var col = d.severity === 'critical' ? critColor : d.severity === 'warning' ? warnColor : textColor;
            ctx.strokeStyle = col;
            ctx.lineWidth = 1;
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.moveTo(x, pad.top);
            ctx.lineTo(x, pad.top + plotH);
            ctx.stroke();
            ctx.setLineDash([]);
            // Triangle marker
            ctx.fillStyle = col;
            ctx.beginPath();
            ctx.moveTo(x, pad.top - 2);
            ctx.lineTo(x - 4, pad.top - 8);
            ctx.lineTo(x + 4, pad.top - 8);
            ctx.closePath();
            ctx.fill();
        });

        // Legend
        var legendY = H - 6;
        ctx.font = '10px system-ui, sans-serif';
        ctx.textAlign = 'left';
        var lx = pad.left;
        if (modem.length > 0) {
            ctx.fillStyle = accentColor;
            ctx.fillRect(lx, legendY - 6, 12, 3);
            ctx.fillStyle = textColor;
            ctx.fillText('SNR', lx + 16, legendY);
            lx += 50;
        }
        if (speedtest.length > 0) {
            ctx.fillStyle = goodColor;
            ctx.beginPath(); ctx.arc(lx + 4, legendY - 4, 3, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = textColor;
            ctx.fillText('DL', lx + 12, legendY);
            lx += 36;
            ctx.fillStyle = uploadColor;
            ctx.beginPath(); ctx.arc(lx + 4, legendY - 4, 3, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = textColor;
            ctx.fillText('UL', lx + 12, legendY);
            lx += 36;
        }
        if (events.length > 0) {
            ctx.fillStyle = warnColor;
            ctx.beginPath();
            ctx.moveTo(lx + 4, legendY - 2);
            ctx.lineTo(lx, legendY - 8);
            ctx.lineTo(lx + 8, legendY - 8);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = textColor;
            ctx.fillText(T.timeline_source_event || 'Event', lx + 12, legendY);
        }
    }

    function _renderTimelineTable(data) {
        var div = document.getElementById('incident-timeline-signals');

        var healthLabels = {
            good: T.health_good || 'Good',
            marginal: T.health_marginal || 'Marginal',
            poor: T.health_poor || 'Poor',
            critical: T.health_critical || 'Critical'
        };

        var tHtml = '<div class="incident-timeline-section-title">';
        tHtml += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
        tHtml += (T.correlation_timeline || 'Unified Timeline');
        tHtml += '</div>';
        tHtml += '<table><thead><tr>';
        tHtml += '<th>' + (T.timestamp || 'Timestamp') + '</th>';
        tHtml += '<th>Source</th>';
        tHtml += '<th>Details</th>';
        tHtml += '</tr></thead><tbody>';

        // Show newest first, limit to 200
        var sorted = data.slice().reverse();
        var modemTransitions = {};
        var lastHealth = null;
        var chrono = data.slice().sort(function(a, b) {
            return new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime();
        });
        for (var i = 0; i < chrono.length; i++) {
            if (chrono[i].source !== 'modem') continue;
            var h = chrono[i].health || 'unknown';
            if (h !== lastHealth) { modemTransitions[chrono[i].timestamp] = true; lastHealth = h; }
        }

        var count = 0;
        for (var i = 0; i < sorted.length && count < 200; i++) {
            var e = sorted[i];
            if (e.source === 'modem' && !modemTransitions[e.timestamp]) continue;

            var ts = escapeHtml(e.timestamp.replace('T', ' '));
            var srcBadge = '';
            var details = '';

            if (e.source === 'modem') {
                srcBadge = '<span class="timeline-source-badge timeline-source-badge-modem">' + (T.timeline_source_modem || 'Modem') + '</span>';
                var hLabel = healthLabels[e.health] || e.health;
                details = '<span class="st-health-badge health-' + (e.health || 'unknown') + '">' + hLabel + '</span>';
                details += ' SNR ' + (e.ds_snr_min != null ? e.ds_snr_min + ' dB' : '-');
                details += ' | Power ' + (e.ds_power_avg != null ? e.ds_power_avg + ' dBmV' : '-');
            } else if (e.source === 'speedtest') {
                srcBadge = '<span class="timeline-source-badge timeline-source-badge-speedtest">' + (T.timeline_source_speedtest || 'Speedtest') + '</span>';
                details = (e.download_mbps ? e.download_mbps.toFixed(1) + ' / ' + (e.upload_mbps || 0).toFixed(1) + ' Mbps' : '');
                if (e.ping_ms) details += ' | Ping ' + e.ping_ms + ' ms';
            } else if (e.source === 'event') {
                srcBadge = '<span class="timeline-source-badge timeline-source-badge-event">' + (T.timeline_source_event || 'Event') + '</span>';
                details = escapeHtml(e.message || '');
            }

            tHtml += '<tr><td style="white-space:nowrap;font-size:0.82em;">' + ts + '</td>';
            tHtml += '<td>' + srcBadge + '</td>';
            tHtml += '<td style="font-size:0.85em;">' + details + '</td></tr>';
            count++;
        }

        tHtml += '</tbody></table>';
        div.innerHTML = tHtml;
    }

    function renderContainerIconPicker(selectedLabel) {
        var picker = document.getElementById('incident-container-icon-picker');
        var hiddenInput = document.getElementById('incident-container-icon-value');
        picker.innerHTML = '';
        var noneBtn = document.createElement('button');
        noneBtn.type = 'button';
        noneBtn.className = 'icon-pick' + (!selectedLabel ? ' active' : '');
        noneBtn.title = T.icon_auto || 'Auto';
        noneBtn.innerHTML = '<span style="font-size:14px;color:var(--muted);">' + (T.icon_auto || 'auto').toLowerCase() + '</span>';
        noneBtn.onclick = function() {
            hiddenInput.value = '';
            picker.querySelectorAll('.icon-pick').forEach(function(b) { b.classList.remove('active'); });
            noneBtn.classList.add('active');
        };
        picker.appendChild(noneBtn);
        INCIDENT_ICONS.forEach(function(entry) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'icon-pick' + (selectedLabel === entry.label ? ' active' : '');
            btn.title = T['icon_' + entry.label] || entry.label;
            btn.innerHTML = entry.icon;
            btn.onclick = function() {
                hiddenInput.value = entry.label;
                picker.querySelectorAll('.icon-pick').forEach(function(b) { b.classList.remove('active'); });
                btn.classList.add('active');
            };
            picker.appendChild(btn);
        });
    }

    function openIncidentModal(incidentId) {
        var modal = document.getElementById('incident-container-modal');
        var titleEl = document.getElementById('incident-container-modal-title');
        var idEl = document.getElementById('incident-container-id');
        var nameEl = document.getElementById('incident-container-name');
        var statusEl = document.getElementById('incident-container-status');
        var startEl = document.getElementById('incident-container-start');
        var endEl = document.getElementById('incident-container-end');
        var descEl = document.getElementById('incident-container-desc');
        var iconVal = document.getElementById('incident-container-icon-value');
        var deleteBtn = document.getElementById('incident-container-delete-btn');
        var countSection = document.getElementById('incident-container-entry-count-section');
        var countEl = document.getElementById('incident-container-entry-count');

        if (incidentId) {
            titleEl.textContent = T.incident_edit || 'Edit Incident';
            deleteBtn.style.display = '';
            fetch('/api/incidents/' + incidentId)
                .then(function(r) { return r.json(); })
                .then(function(inc) {
                    idEl.value = inc.id;
                    nameEl.value = inc.name;
                    statusEl.value = inc.status;
                    startEl.value = inc.start_date || '';
                    endEl.value = inc.end_date || '';
                    descEl.value = inc.description || '';
                    iconVal.value = inc.icon || '';
                    renderContainerIconPicker(inc.icon || '');
                    if (inc.entry_count !== undefined) {
                        countEl.textContent = inc.entry_count;
                        countSection.style.display = '';
                    } else {
                        countSection.style.display = 'none';
                    }
                    modal.classList.add('open');
                });
        } else {
            titleEl.textContent = T.incident_new || 'New Incident';
            idEl.value = '';
            nameEl.value = '';
            statusEl.value = 'open';
            startEl.value = todayStr();
            endEl.value = '';
            descEl.value = '';
            iconVal.value = '';
            renderContainerIconPicker('');
            deleteBtn.style.display = 'none';
            countSection.style.display = 'none';
            modal.classList.add('open');
        }
    }

    function closeIncidentModal() {
        document.getElementById('incident-container-modal').classList.remove('open');
    }

    function saveIncident() {
        var idEl = document.getElementById('incident-container-id');
        var nameVal = document.getElementById('incident-container-name').value.trim();
        var statusVal = document.getElementById('incident-container-status').value;
        var startVal = document.getElementById('incident-container-start').value;
        var endVal = document.getElementById('incident-container-end').value;
        var descVal = document.getElementById('incident-container-desc').value.trim();
        var iconVal = document.getElementById('incident-container-icon-value').value || '';
        var incidentId = idEl.value;

        if (!nameVal) {
            showToast((T.incident_name || 'Name') + ' required', 'error');
            return;
        }

        var payload = JSON.stringify({name: nameVal, description: descVal, status: statusVal, start_date: startVal, end_date: endVal, icon: iconVal});
        var url = incidentId ? '/api/incidents/' + incidentId : '/api/incidents';
        var method = incidentId ? 'PUT' : 'POST';

        fetch(url, {method: method, headers: {'Content-Type': 'application/json'}, body: payload})
            .then(function(r) { return r.json().then(function(d) { return {status: r.status, data: d}; }); })
            .then(function(res) {
                if (res.status >= 400) {
                    showToast(res.data.error || 'Error', 'error');
                    return;
                }
                closeIncidentModal();
                loadIncidents();
                loadJournal();
            })
            .catch(function() { showToast(T.network_error || 'Error', 'error'); });
    }

    function deleteIncident() {
        var incidentId = document.getElementById('incident-container-id').value;
        if (!incidentId) return;
        if (!confirm(T.incident_delete_confirm || 'Delete this incident? Entries will become unassigned.')) return;
        fetch('/api/incidents/' + incidentId, {method: 'DELETE'})
            .then(function(r) { return r.json(); })
            .then(function() {
                closeIncidentModal();
                _activeIncidentFilter = null;
                loadIncidents();
                loadJournal();
            })
            .catch(function() { showToast(T.network_error || 'Error', 'error'); });
    }

    /* ── Bulk Selection & Assignment ── */

    function toggleBulkMode() {
        if (_bulkMode) {
            exitBulkMode();
        } else {
            _bulkMode = true;
            var label = document.getElementById('btn-bulk-toggle-label');
            var btn = document.getElementById('btn-bulk-toggle');
            label.textContent = T.bulk_cancel || 'Cancel';
            btn.classList.add('btn-bulk-active');
            // Insert checkbox header column
            var headRow = document.getElementById('journal-thead-row');
            var th = document.createElement('th');
            th.className = 'journal-check-col';
            th.style.width = '36px';
            th.innerHTML = '<input type="checkbox" id="journal-select-all" onclick="toggleSelectAll(this)" title="' + (T.bulk_select_all || 'Select All') + '">';
            headRow.insertBefore(th, headRow.firstChild);
            // Re-render table with checkboxes
            if (_journalAllData) renderJournalTable(_journalAllData, _journalSearchQuery);
        }
    }

    function exitBulkMode() {
        _bulkMode = false;
        _selectedEntryIds = [];
        var label = document.getElementById('btn-bulk-toggle-label');
        var btn = document.getElementById('btn-bulk-toggle');
        if (label) label.textContent = T.bulk_select || 'Select';
        if (btn) btn.classList.remove('btn-bulk-active');
        // Remove checkbox header column
        var headRow = document.getElementById('journal-thead-row');
        var checkTh = headRow.querySelector('.journal-check-col');
        if (checkTh) headRow.removeChild(checkTh);
        // Re-render table without checkboxes
        var bulkBar = document.getElementById('journal-bulk-bar');
        if (bulkBar) bulkBar.style.display = 'none';
        if (_journalAllData) renderJournalTable(_journalAllData, _journalSearchQuery);
    }

    function toggleEntrySelection(checkbox, entryId) {
        var idx = _selectedEntryIds.indexOf(entryId);
        if (checkbox.checked && idx === -1) {
            _selectedEntryIds.push(entryId);
        } else if (!checkbox.checked && idx !== -1) {
            _selectedEntryIds.splice(idx, 1);
        }
        var row = checkbox.closest('tr');
        if (row) row.classList.toggle('journal-row-selected', checkbox.checked);
        updateBulkBar();
    }

    function toggleSelectAll(masterCheckbox) {
        var checkboxes = document.querySelectorAll('.journal-row-check');
        _selectedEntryIds = [];
        for (var i = 0; i < checkboxes.length; i++) {
            checkboxes[i].checked = masterCheckbox.checked;
            var row = checkboxes[i].closest('tr');
            if (row) row.classList.toggle('journal-row-selected', masterCheckbox.checked);
            if (masterCheckbox.checked) {
                _selectedEntryIds.push(parseInt(checkboxes[i].getAttribute('data-entry-id')));
            }
        }
        updateBulkBar();
    }

    function clearBulkSelection() {
        _selectedEntryIds = [];
        var checkboxes = document.querySelectorAll('.journal-row-check');
        for (var i = 0; i < checkboxes.length; i++) {
            checkboxes[i].checked = false;
            var row = checkboxes[i].closest('tr');
            if (row) row.classList.remove('journal-row-selected');
        }
        var master = document.getElementById('journal-select-all');
        if (master) master.checked = false;
        updateBulkBar();
    }

    function updateBulkBar() {
        var bar = document.getElementById('journal-bulk-bar');
        var count = _selectedEntryIds.length;
        if (count === 0) {
            bar.style.display = 'none';
            return;
        }
        bar.style.display = '';
        var countEl = document.getElementById('journal-bulk-count');
        countEl.textContent = count + ' ' + (count === 1 ? (T.entry_selected || 'entry selected') : (T.entries_selected || 'entries selected'));
        populateBulkIncidentSelect();
    }

    function populateBulkIncidentSelect() {
        var sel = document.getElementById('journal-bulk-incident-select');
        var prev = sel.value;
        sel.innerHTML = '<option value="" disabled selected>' + (T.incident_assign || 'Assign to Incident') + '…</option>';
        _incidentsData.forEach(function(inc) {
            var opt = document.createElement('option');
            opt.value = inc.id;
            opt.textContent = inc.name + ' (' + (T['incident_status_' + inc.status] || inc.status) + ')';
            sel.appendChild(opt);
        });
        if (prev) sel.value = prev;
    }

    function bulkAssign() {
        var sel = document.getElementById('journal-bulk-incident-select');
        var incidentId = sel.value;
        if (!incidentId) {
            showToast(T.bulk_select_incident || 'Select an incident first', 'warning');
            return;
        }
        if (_selectedEntryIds.length === 0) return;
        fetch('/api/incidents/' + incidentId + '/assign', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({entry_ids: _selectedEntryIds})
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            showToast((data.updated || 0) + ' ' + (T.entries_assigned || 'entries assigned'), 'success');
            exitBulkMode();
            loadIncidents();
            loadJournal();
        })
        .catch(function() { showToast(T.network_error || 'Error', 'error'); });
    }

    function bulkUnassign() {
        if (_selectedEntryIds.length === 0) return;
        fetch('/api/journal/unassign', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({entry_ids: _selectedEntryIds})
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            showToast((data.updated || 0) + ' ' + (T.entries_unassigned || 'entries unassigned'), 'success');
            exitBulkMode();
            loadIncidents();
            loadJournal();
        })
        .catch(function() { showToast(T.network_error || 'Error', 'error'); });
    }

    /* ── Export Dropdown ── */
    function toggleExportDropdown(e) {
        e.stopPropagation();
        var dd = document.getElementById('journal-export-dropdown');
        dd.classList.toggle('open');
    }
    function exportJournal(fmt) {
        var dd = document.getElementById('journal-export-dropdown');
        dd.classList.remove('open');
        var url = '/api/journal/export?format=' + fmt;
        if (_activeIncidentFilter !== null && _activeIncidentFilter > 0) {
            url += '&incident_id=' + _activeIncidentFilter;
        }
        window.location.href = url;
    }
    document.addEventListener('click', function() {
        var dd = document.getElementById('journal-export-dropdown');
        if (dd) dd.classList.remove('open');
    });

    /* Expose Journal functions for HTML onclick/onchange handlers */
    window.openEntryModal = openEntryModal;
    window.closeEntryModal = closeEntryModal;
    window.saveEntry = saveEntry;
    window.deleteEntry = deleteEntry;
    window.deleteAttachment = deleteAttachment;
    window.handleEntryFileUpload = handleEntryFileUpload;
    window.loadJournal = loadJournal;
    window.openImportModal = openImportModal;
    window.closeImportModal = closeImportModal;
    window.handleImportFile = handleImportFile;
    window.confirmImport = confirmImport;
    window.toggleImportAll = toggleImportAll;
    window.fixImportDate = fixImportDate;
    window.deleteAllEntries = deleteAllEntries;
    window.clearJournalSearch = clearJournalSearch;
    window.loadIncidents = loadIncidents;
    window.openIncidentModal = openIncidentModal;
    window.closeIncidentModal = closeIncidentModal;
    window.saveIncident = saveIncident;
    window.deleteIncident = deleteIncident;
    window.filterByIncident = filterByIncident;
    window.toggleBulkMode = toggleBulkMode;
    window.toggleEntrySelection = toggleEntrySelection;
    window.toggleSelectAll = toggleSelectAll;
    window.clearBulkSelection = clearBulkSelection;
    window.bulkAssign = bulkAssign;
    window.bulkUnassign = bulkUnassign;
    window.toggleExportDropdown = toggleExportDropdown;
    window.exportJournal = exportJournal;

    /* ── Journal Search ── */
    function clearJournalSearch() {
        var input = document.getElementById('journal-search-input');
        input.value = '';
        _journalSearchQuery = '';
        document.getElementById('journal-search-clear').style.display = 'none';
        document.getElementById('journal-search-count').textContent = '';
        loadJournal();
    }

    (function() {
        var input = document.getElementById('journal-search-input');
        if (!input) return;
        input.addEventListener('input', function() {
            var val = input.value.trim();
            var clearBtn = document.getElementById('journal-search-clear');
            clearBtn.style.display = val ? '' : 'none';
            if (_journalSearchTimer) clearTimeout(_journalSearchTimer);
            _journalSearchTimer = setTimeout(function() {
                _journalSearchQuery = val;
                if (val.length === 0) {
                    loadJournal();
                } else if (val.length >= 2) {
                    loadJournal(val);
                }
            }, 300);
        });
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                clearJournalSearch();
                input.blur();
            }
        });
    })();

})();

/* ── Export for LLM ── */
function exportForLLM() {
    var modal = document.getElementById('export-modal');
    var textarea = document.getElementById('export-text');
    var modeEl = document.querySelector('input[name="export-mode"]:checked');
    var mode = modeEl ? modeEl.value : 'full';
    textarea.value = T.export_no_data;
    modal.classList.add('open');
    fetch('/api/export?mode=' + mode)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.text) {
                textarea.value = data.text;
            } else if (data.error) {
                textarea.value = data.error;
            }
        })
        .catch(function() {
            textarea.value = 'Error loading export data.';
        });
}
function closeExportModal() {
    document.getElementById('export-modal').classList.remove('open');
}
function openBqmSetupModal() {
    document.getElementById('bqm-setup-modal').classList.add('open');
}
function closeBqmSetupModal() {
    document.getElementById('bqm-setup-modal').classList.remove('open');
}
function openReportModal() {
    document.getElementById('report-modal').classList.add('open');
    closeSidebar();
}
function closeReportModal() {
    document.getElementById('report-modal').classList.remove('open');
    // Reset to step 1
    document.getElementById('report-step1').style.display = '';
    document.getElementById('report-step2').style.display = 'none';
    document.getElementById('report-generate-btn').style.display = '';
    document.getElementById('report-copy-btn').style.display = 'none';
    document.getElementById('report-pdf-btn').style.display = 'none';
    // Reset BNetzA complaint source
    var bnetzIdField = document.getElementById('report-bnetz-id');
    if (bnetzIdField) bnetzIdField.value = '';
}
function generateComplaint() {
    var days = document.getElementById('report-days').value;
    var lang = document.getElementById('report-lang').value;
    var name = encodeURIComponent(document.getElementById('report-name').value);
    var number = encodeURIComponent(document.getElementById('report-number').value);
    var address = encodeURIComponent(document.getElementById('report-address').value);
    var includeBnetz = document.getElementById('report-include-bnetz');
    var bnetzParam = (includeBnetz && includeBnetz.checked) ? '&include_bnetz=true' : '';
    var bnetzIdField = document.getElementById('report-bnetz-id');
    if (bnetzIdField && bnetzIdField.value) {
        bnetzParam = '&bnetz_id=' + bnetzIdField.value;
    }
    var btn = document.getElementById('report-generate-btn');
    btn.disabled = true;
    btn.textContent = '...';
    fetch('/api/complaint?days=' + days + '&lang=' + lang + '&name=' + name + '&number=' + number + '&address=' + address + bnetzParam)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            document.getElementById('report-complaint-text').value = data.text;
            document.getElementById('report-step1').style.display = 'none';
            document.getElementById('report-step2').style.display = 'block';
            document.getElementById('report-generate-btn').style.display = 'none';
            document.getElementById('report-copy-btn').style.display = '';
            document.getElementById('report-pdf-btn').style.display = '';
        })
        .catch(function(e) { alert('Error: ' + e); })
        .finally(function() { btn.disabled = false; btn.textContent = '\u270E Generate Letter'; });
}
function generateBnetzComplaint(bnetzId) {
    var bnetzIdField = document.getElementById('report-bnetz-id');
    if (bnetzIdField) bnetzIdField.value = bnetzId;
    var checkbox = document.getElementById('report-include-bnetz');
    if (checkbox) checkbox.checked = true;
    openReportModal();
}
function copyComplaint() {
    var textarea = document.getElementById('report-complaint-text');
    var btn = document.getElementById('report-copy-btn');
    textarea.select();
    textarea.setSelectionRange(0, textarea.value.length);
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textarea.value).then(function() {
            var orig = btn.innerHTML;
            btn.innerHTML = '&#10003; Copied!';
            setTimeout(function() { btn.innerHTML = orig; }, 2000);
        });
    } else {
        document.execCommand('copy');
    }
}
function downloadReport() {
    var days = document.getElementById('report-days').value;
    var lang = document.getElementById('report-lang').value;
    window.location.href = '/api/report?days=' + days + '&lang=' + lang;
}
function copyExport() {
    var textarea = document.getElementById('export-text');
    var btn = document.getElementById('export-copy-btn');
    textarea.select();
    textarea.setSelectionRange(0, textarea.value.length);
    var ok = false;
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textarea.value).then(function() {
            btn.textContent = T.copied;
            setTimeout(function() { btn.textContent = T.copy_clipboard; }, 2000);
        }).catch(function() {
            fallbackCopy(textarea, btn, T);
        });
    } else {
        fallbackCopy(textarea, btn, T);
    }
}
function fallbackCopy(textarea, btn, T) {
    try {
        document.execCommand('copy');
        btn.textContent = T.copied;
        setTimeout(function() { btn.textContent = T.copy_clipboard; }, 2000);
    } catch(e) {
        btn.textContent = 'Select All + Ctrl+C';
        setTimeout(function() { btn.textContent = T.copy_clipboard; }, 3000);
    }
}
function toggleCard(el) {
    el.classList.toggle('open');
}
function openSmokepingSetupModal() {
    document.getElementById('smokeping-setup-modal').classList.add('open');
}
function closeSmokepingSetupModal() {
    document.getElementById('smokeping-setup-modal').classList.remove('open');
}
function openSpeedtestSetupModal() {
    document.getElementById('speedtest-setup-modal').classList.add('open');
}
function closeSpeedtestSetupModal() {
    document.getElementById('speedtest-setup-modal').classList.remove('open');
}
var _speedtestRawData = [];
var _speedtestAllData = [];
var _speedtestVisible = 50;
var _speedtestSortCol = 'timestamp';
var _speedtestSortDir = 'desc';

function formatSpeedtestTimestamp(ts) {
    if (!ts) return '';
    var d = new Date(ts);
    if (isNaN(d.getTime())) return ts;
    var dd = String(d.getDate()).padStart(2, '0');
    var mm = String(d.getMonth() + 1).padStart(2, '0');
    var yyyy = d.getFullYear();
    var hh = String(d.getHours()).padStart(2, '0');
    var min = String(d.getMinutes()).padStart(2, '0');
    return dd + '.' + mm + '.' + yyyy + ' ' + hh + ':' + min;
}

function loadSpeedtestHistory() {
    var tbody = document.getElementById('speedtest-tbody');
    var table = document.getElementById('speedtest-table');
    var noData = document.getElementById('speedtest-no-data');
    var loading = document.getElementById('speedtest-loading');
    var moreWrap = document.getElementById('speedtest-show-more');
    if (!tbody || !table || !noData) return;
    tbody.innerHTML = '';
    table.style.display = 'none';
    noData.style.display = 'none';
    if (loading) loading.style.display = '';
    if (moreWrap) moreWrap.style.display = 'none';
    _speedtestRawData = [];
    _speedtestAllData = [];
    _speedtestVisible = 50;
    fetch('/api/speedtest?count=2000')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (loading) loading.style.display = 'none';
            if (!data || data.length === 0) {
                noData.textContent = T.speedtest_no_data || 'No speedtest data.';
                noData.style.display = 'block';
                return;
            }
            _speedtestRawData = data;
            filterSpeedtestData();
        })
        .catch(function() {
            if (loading) loading.style.display = 'none';
            noData.textContent = T.network_error || 'Error';
            noData.style.display = 'block';
        });
}

function filterSpeedtestData() {
    var days = getPillValue('speedtest-tabs') || '7';
    var table = document.getElementById('speedtest-table');
    var noData = document.getElementById('speedtest-no-data');
    _speedtestVisible = 50;
    if (days === 'all') {
        _speedtestAllData = _speedtestRawData.slice();
    } else {
        var cutoff = new Date(Date.now() - parseInt(days) * 86400000);
        _speedtestAllData = _speedtestRawData.filter(function(r) {
            return new Date(r.timestamp) >= cutoff;
        });
    }
    sortSpeedtestData();
    if (_speedtestAllData.length === 0) {
        if (table) table.style.display = 'none';
        if (noData) {
            noData.textContent = T.speedtest_no_data || 'No speedtest data.';
            noData.style.display = 'block';
        }
        var cc = document.getElementById('speedtest-chart-container');
        if (cc) cc.style.display = 'none';
    } else {
        if (table) table.style.display = '';
        if (noData) noData.style.display = 'none';
        renderSpeedtestRows();
        renderSpeedtestChart();
    }
}

function sortSpeedtestData() {
    var col = _speedtestSortCol;
    var dir = _speedtestSortDir === 'asc' ? 1 : -1;
    _speedtestAllData.sort(function(a, b) {
        var va = a[col], vb = b[col];
        if (col === 'timestamp') {
            va = new Date(va || 0).getTime();
            vb = new Date(vb || 0).getTime();
        } else {
            va = parseFloat(va) || 0;
            vb = parseFloat(vb) || 0;
        }
        if (va < vb) return -1 * dir;
        if (va > vb) return 1 * dir;
        return 0;
    });
}

function handleSpeedtestSort(col) {
    if (_speedtestSortCol === col) {
        _speedtestSortDir = _speedtestSortDir === 'asc' ? 'desc' : 'asc';
    } else {
        _speedtestSortCol = col;
        _speedtestSortDir = col === 'timestamp' ? 'desc' : 'asc';
    }
    var ths = document.querySelectorAll('#speedtest-table thead th');
    ths.forEach(function(th) {
        var indicator = th.querySelector('.sort-indicator');
        if (indicator) {
            if (th.getAttribute('data-col') === col) {
                indicator.textContent = _speedtestSortDir === 'asc' ? '▲' : '▼';
            } else {
                indicator.textContent = '';
            }
        }
    });
    sortSpeedtestData();
    _speedtestVisible = 50;
    renderSpeedtestRows();
    renderSpeedtestChart();
}

function computeMedian(arr) {
    if (arr.length === 0) return 0;
    var sorted = arr.slice().sort(function(a, b) { return a - b; });
    var mid = Math.floor(sorted.length / 2);
    return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
}

function renderSpeedtestRows() {
    var tbody = document.getElementById('speedtest-tbody');
    var moreWrap = document.getElementById('speedtest-show-more');
    var moreBtn = document.getElementById('speedtest-more-btn');
    if (!tbody) return;
    tbody.innerHTML = '';
    var downloads = [], uploads = [];
    for (var j = 0; j < _speedtestAllData.length; j++) {
        var d = _speedtestAllData[j];
        if (d.download_mbps != null) downloads.push(parseFloat(d.download_mbps) || 0);
        if (d.upload_mbps != null) uploads.push(parseFloat(d.upload_mbps) || 0);
    }
    var medianDl = computeMedian(downloads);
    var medianUl = computeMedian(uploads);
    var show = Math.min(_speedtestVisible, _speedtestAllData.length);
    for (var i = 0; i < show; i++) {
        var r = _speedtestAllData[i];
        var dlVal = parseFloat(r.download_mbps) || 0;
        var ulVal = parseFloat(r.upload_mbps) || 0;
        var pingVal = parseFloat(r.ping_ms) || 0;
        var jitterVal = parseFloat(r.jitter_ms) || 0;
        var dlClass = (medianDl > 0 && dlVal < medianDl * 0.8) ? ' class="val-bad"' : '';
        var ulClass = (medianUl > 0 && ulVal < medianUl * 0.8) ? ' class="val-bad"' : '';
        var pingClass = pingVal > 50 ? ' class="val-warn"' : '';
        var jitterClass = jitterVal > 20 ? ' class="val-warn"' : '';
        var tr = document.createElement('tr');
        var serverCell = r.server_id
            ? '<td title="' + escapeHtml(r.server_name || '') + '">#' + r.server_id + '</td>'
            : '<td></td>';
        tr.innerHTML = '<td class="st-expand-col"><button class="st-expand-btn" data-id="' + r.id + '" onclick="toggleSpeedtestSignal(this)">&#9654;</button></td>'
            + '<td>' + escapeHtml(formatSpeedtestTimestamp(r.timestamp)) + '</td>'
            + serverCell
            + '<td><strong' + dlClass + '>' + escapeHtml(r.download_human || (r.download_mbps + ' Mbps')) + '</strong></td>'
            + '<td><strong' + ulClass + '>' + escapeHtml(r.upload_human || (r.upload_mbps + ' Mbps')) + '</strong></td>'
            + '<td' + pingClass + '>' + r.ping_ms + ' ms</td>'
            + '<td' + jitterClass + '>' + r.jitter_ms + ' ms</td>'
            + '<td>' + (r.packet_loss_pct > 0 ? '<span class="val-warn">' + r.packet_loss_pct + '%</span>' : '0%') + '</td>';
        tbody.appendChild(tr);
    }
    if (moreWrap && moreBtn) {
        if (_speedtestAllData.length > _speedtestVisible) {
            moreWrap.style.display = '';
            moreBtn.textContent = (T.show_more || 'Show more') + ' (' + (_speedtestAllData.length - _speedtestVisible) + ')';
        } else {
            moreWrap.style.display = 'none';
        }
    }
}

function toggleSpeedtestSignal(btn) {
    var id = btn.getAttribute('data-id');
    var parentRow = btn.closest('tr');
    var detailRow = parentRow.nextElementSibling;
    // If detail row exists and belongs to this entry, toggle it
    if (detailRow && detailRow.classList.contains('st-signal-row')) {
        detailRow.remove();
        btn.classList.remove('open');
        return;
    }
    // Create detail row and fetch data
    btn.classList.add('open');
    var newRow = document.createElement('tr');
    newRow.className = 'st-signal-row';
    var cols = parentRow.children.length;
    var td = document.createElement('td');
    td.colSpan = cols;
    td.innerHTML = '<div class="st-signal-detail"><span class="st-sig-no-data" style="text-align:center;">...</span></div>';
    newRow.appendChild(td);
    parentRow.after(newRow);
    fetch('/api/speedtest/' + id + '/signal')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var container = newRow.querySelector('.st-signal-detail');
            if (!data.found) {
                container.innerHTML = '<span class="st-sig-no-data">' + escapeHtml(data.message || T.signal_no_snapshot) + '</span>';
                return;
            }
            var healthClass = 'health-' + (data.health === 'good' ? 'good' : data.health === 'marginal' ? 'marginal' : 'poor');
            var healthLabel = data.health === 'good' ? (T.health_good || 'Good')
                : data.health === 'marginal' ? (T.health_marginal || 'Marginal')
                : (T.health_poor || 'Poor');
            var html = '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_health || 'Health') + '</span>'
                + '<span class="st-health-badge ' + healthClass + '">' + escapeHtml(healthLabel) + '</span></div>'
                + '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_ds_power || 'DS Power') + '</span>'
                + '<span class="st-sig-value">' + data.ds_power_min + ' / ' + data.ds_power_avg + ' / ' + data.ds_power_max + ' dBmV</span></div>'
                + '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_ds_snr || 'DS SNR') + '</span>'
                + '<span class="st-sig-value">' + data.ds_snr_min + ' / ' + data.ds_snr_avg + ' dB</span></div>'
                + '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_us_power || 'US Power') + '</span>'
                + '<span class="st-sig-value">' + data.us_power_min + ' / ' + data.us_power_avg + ' / ' + data.us_power_max + ' dBmV</span></div>'
                + '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_errors || 'Errors') + '</span>'
                + '<span class="st-sig-value">' + (data.ds_correctable_errors || 0).toLocaleString() + ' ' + (T.signal_corr || 'corr.') + ' / '
                + (data.ds_uncorrectable_errors || 0).toLocaleString() + ' ' + (T.signal_uncorr || 'uncorr.') + '</span></div>'
                + '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_ds_channels || 'DS') + ' / ' + (T.signal_us_channels || 'US') + '</span>'
                + '<span class="st-sig-value">' + (data.ds_total || 0) + ' / ' + (data.us_total || 0) + '</span></div>';
            if (data.us_channels && data.us_channels.length > 0) {
                html += '<div class="st-us-mods"><span class="st-sig-label">' + (T.signal_us_modulation || 'US Modulation') + ': </span>';
                for (var c = 0; c < data.us_channels.length; c++) {
                    var ch = data.us_channels[c];
                    html += '<span>Ch' + (ch.channel_id || c) + ': ' + escapeHtml(ch.modulation || '?') + '</span>';
                }
                html += '</div>';
            }
            html += '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_snapshot_time || 'Snapshot') + '</span>'
                + '<span class="st-sig-value" style="font-size:0.85em; color:var(--muted);">' + escapeHtml(data.snapshot_timestamp || '') + '</span></div>';
            container.innerHTML = html;
        })
        .catch(function() {
            var container = newRow.querySelector('.st-signal-detail');
            if (container) container.innerHTML = '<span class="st-sig-no-data">Error loading signal data</span>';
        });
}

function renderSpeedtestChart() {
    var container = document.getElementById('speedtest-chart-container');
    var canvas = document.getElementById('speedtest-chart');
    if (!container || !canvas) return;
    // Sort data chronologically for chart (oldest first)
    var data = _speedtestAllData.slice().sort(function(a, b) {
        return new Date(a.timestamp) - new Date(b.timestamp);
    });
    if (data.length < 2) { container.style.display = 'none'; return; }
    container.style.display = '';
    var wrap = canvas.parentElement;
    var dpr = window.devicePixelRatio || 1;
    var w = wrap.clientWidth;
    var h = canvas.clientHeight || 250;
    canvas.width = w * dpr;
    canvas.height = h * dpr;
    var ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);
    // Padding
    var padL = 60, padR = 60, padT = 20, padB = 30;
    var cw = w - padL - padR;
    var ch = h - padT - padB;
    // Extract data arrays
    var dls = [], uls = [], pings = [], times = [];
    for (var i = 0; i < data.length; i++) {
        dls.push(parseFloat(data[i].download_mbps) || 0);
        uls.push(parseFloat(data[i].upload_mbps) || 0);
        pings.push(parseFloat(data[i].ping_ms) || 0);
        times.push(new Date(data[i].timestamp));
    }
    // Scales
    var maxSpeed = Math.max.apply(null, dls.concat(uls)) * 1.1 || 1;
    var maxPing = Math.max.apply(null, pings) * 1.1 || 1;
    var medianDl = computeMedian(dls);
    var threshold = medianDl * 0.8;
    function xPos(idx) { return padL + (idx / (data.length - 1)) * cw; }
    function ySpeed(v) { return padT + ch - (v / maxSpeed) * ch; }
    function yPing(v) { return padT + ch - (v / maxPing) * ch; }
    // Clear
    ctx.clearRect(0, 0, w, h);
    // Background zones (green/red tint per segment)
    for (var i = 0; i < data.length - 1; i++) {
        var x1 = xPos(i), x2 = xPos(i + 1);
        var isHealthy = dls[i] >= threshold && dls[i + 1] >= threshold;
        ctx.fillStyle = isHealthy ? 'rgba(34,197,94,0.06)' : 'rgba(239,68,68,0.06)';
        ctx.fillRect(x1, padT, x2 - x1, ch);
    }
    // Grid lines + left Y axis labels (speed)
    var cs = getComputedStyle(document.documentElement);
    var mutedColor = cs.getPropertyValue('--muted').trim() || '#888';
    ctx.strokeStyle = 'rgba(255,255,255,0.07)';
    ctx.lineWidth = 1;
    ctx.font = '11px monospace';
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    var gridLines = 5;
    for (var g = 0; g <= gridLines; g++) {
        var gy = padT + (g / gridLines) * ch;
        var speedVal = maxSpeed - (g / gridLines) * maxSpeed;
        var pingVal = maxPing - (g / gridLines) * maxPing;
        ctx.beginPath();
        ctx.moveTo(padL, gy);
        ctx.lineTo(w - padR, gy);
        ctx.stroke();
        ctx.fillStyle = mutedColor;
        ctx.textAlign = 'right';
        ctx.fillText(speedVal.toFixed(0), padL - 6, gy);
        ctx.textAlign = 'left';
        ctx.fillText(pingVal.toFixed(0), w - padR + 6, gy);
    }
    ctx.fillStyle = mutedColor;
    ctx.font = '10px monospace';
    ctx.textAlign = 'center';
    ctx.save();
    ctx.translate(12, padT + ch / 2);
    ctx.rotate(-Math.PI / 2);
    ctx.fillText('Mbps', 0, 0);
    ctx.restore();
    ctx.save();
    ctx.translate(w - 10, padT + ch / 2);
    ctx.rotate(Math.PI / 2);
    ctx.fillText('ms', 0, 0);
    ctx.restore();
    // X axis labels (timestamps)
    ctx.fillStyle = mutedColor;
    ctx.font = '10px monospace';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    var labelCount = Math.min(6, data.length);
    for (var li = 0; li < labelCount; li++) {
        var idx = Math.round(li * (data.length - 1) / (labelCount - 1));
        var t = times[idx];
        var label = String(t.getDate()).padStart(2, '0') + '.' + String(t.getMonth() + 1).padStart(2, '0') + ' ' + String(t.getHours()).padStart(2, '0') + ':' + String(t.getMinutes()).padStart(2, '0');
        ctx.fillText(label, xPos(idx), padT + ch + 6);
    }
    // Threshold line (dashed red)
    ctx.setLineDash([6, 4]);
    ctx.strokeStyle = 'rgba(239,68,68,0.6)';
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    var threshY = ySpeed(threshold);
    ctx.moveTo(padL, threshY);
    ctx.lineTo(w - padR, threshY);
    ctx.stroke();
    ctx.setLineDash([]);
    // Helper: draw filled line with gradient (Phase 4.2)
    function drawLine(values, yFn, color, gradientColors) {
        // Filled area with gradient
        ctx.beginPath();
        ctx.moveTo(xPos(0), padT + ch);
        for (var i = 0; i < values.length; i++) {
            ctx.lineTo(xPos(i), yFn(values[i]));
        }
        ctx.lineTo(xPos(values.length - 1), padT + ch);
        ctx.closePath();
        
        // Create gradient if provided
        if (gradientColors && gradientColors.length === 2) {
            var gradient = ctx.createLinearGradient(0, padT, 0, padT + ch);
            gradient.addColorStop(0, gradientColors[0]);
            gradient.addColorStop(1, gradientColors[1]);
            ctx.fillStyle = gradient;
        } else {
            ctx.fillStyle = gradientColors;
        }
        ctx.fill();
        
        // Line with smooth curves
        ctx.beginPath();
        for (var i = 0; i < values.length; i++) {
            if (i === 0) {
                ctx.moveTo(xPos(i), yFn(values[i]));
            } else {
                // Smooth curve approximation using quadratic curves
                var prevX = xPos(i - 1);
                var prevY = yFn(values[i - 1]);
                var currX = xPos(i);
                var currY = yFn(values[i]);
                var cpX = (prevX + currX) / 2;
                var cpY = (prevY + currY) / 2;
                ctx.quadraticCurveTo(prevX, prevY, cpX, cpY);
                if (i === values.length - 1) {
                    ctx.lineTo(currX, currY);
                }
            }
        }
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.stroke();
    }
    
    // Phase 4.2: Purple gradient for download, green for upload, amber line for ping
    drawLine(uls, ySpeed, '#22c55e', ['rgba(34,197,94,0.3)', 'rgba(34,197,94,0)']);
    drawLine(dls, ySpeed, '#a855f7', ['rgba(168,85,247,0.3)', 'rgba(168,85,247,0)']);
    drawLine(pings, yPing, '#f59e0b', 'rgba(245,158,11,0.10)');
    // Hover interaction
    var tooltip = document.getElementById('speedtest-chart-tooltip');
    // Move tooltip to body so it's never clipped
    if (tooltip.parentElement !== document.body) document.body.appendChild(tooltip);
    tooltip.style.position = 'fixed';
    function onMouseMove(e) {
        var rect = canvas.getBoundingClientRect();
        var scaleX = w / rect.width;
        var scaleY = h / rect.height;
        var mx = (e.clientX - rect.left) * scaleX;
        var my = (e.clientY - rect.top) * scaleY;
        if (mx < padL || mx > w - padR || my < padT || my > padT + ch) {
            tooltip.style.display = 'none'; return;
        }
        var ratio = (mx - padL) / cw;
        var idx = Math.round(ratio * (data.length - 1));
        if (idx < 0) idx = 0;
        if (idx >= data.length) idx = data.length - 1;
        tooltip.style.display = 'block';
        tooltip.innerHTML = '<strong>' + formatSpeedtestTimestamp(data[idx].timestamp) + '</strong><br>'
            + '<span style="color:#a855f7">&#9660;</span> DL: ' + dls[idx].toFixed(2) + ' Mbps<br>'
            + '<span style="color:#22c55e">&#9650;</span> UL: ' + uls[idx].toFixed(2) + ' Mbps<br>'
            + '<span style="color:#f59e0b">&#9679;</span> Ping: ' + pings[idx].toFixed(1) + ' ms';
        tooltip.style.left = (e.clientX + 14) + 'px';
        tooltip.style.top = (e.clientY - 10) + 'px';
    }
    function onMouseLeave() { tooltip.style.display = 'none'; }
    if (canvas._chartMoveHandler) canvas.removeEventListener('mousemove', canvas._chartMoveHandler);
    if (canvas._chartLeaveHandler) canvas.removeEventListener('mouseleave', canvas._chartLeaveHandler);
    canvas._chartMoveHandler = onMouseMove;
    canvas._chartLeaveHandler = onMouseLeave;
    canvas.addEventListener('mousemove', onMouseMove);
    canvas.addEventListener('mouseleave', onMouseLeave);
}
window.addEventListener('resize', function() {
    if (_speedtestAllData.length >= 2) renderSpeedtestChart();
    
    // Clean up sidebar state on resize
    if (isMobile()) {
        // On mobile, remove .collapsed if it exists (from desktop state)
        sidebar.classList.remove('collapsed');
        // Also close mobile sidebar on resize to avoid weird states
        closeMobileSidebar();
    } else {
        // On desktop, remove mobile-specific classes
        sidebar.classList.remove('mobile-open');
        sidebarBackdrop.classList.remove('active');
    }
});

function showMoreSpeedtest() {
    _speedtestVisible += 50;
    renderSpeedtestRows();
}

(function() {
    var ths = document.querySelectorAll('#speedtest-table thead th[data-col]');
    ths.forEach(function(th) {
        th.addEventListener('click', function() {
            handleSpeedtestSort(th.getAttribute('data-col'));
        });
    });
})();

function escapeHtml(str) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
}

/* ═══ Correlation Analysis ═══ */
var _correlationData = [];
var _correlationChart = null;
var _corrVisible = { snr: true, txPower: true, dsPower: true, download: true, upload: true, events: false, errors: true, poorSignal: true, temperature: true };
var _corrWeatherData = [];
var _corrChartState = null; // Stores scales/data for tooltip lookups
var _corrZoom = null; // { tMin, tMax } when zoomed in
// Event type sub-filter: operational events hidden by default
var _corrEventFilter = {};
var _OPERATIONAL_EVENTS = { monitoring_started: true, monitoring_stopped: true };
function _corrFilteredEvents(events) {
    if (!_corrVisible.events) return [];
    return events.filter(function(e) {
        var t = e.event_type || 'unknown';
        if (!(t in _corrEventFilter)) _corrEventFilter[t] = !_OPERATIONAL_EVENTS[t];
        return _corrEventFilter[t];
    });
}

// Re-render chart on container resize
(function() {
    var resizeTimer;
    var observer = new ResizeObserver(function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            if (_correlationData && _correlationData.length > 0) {
                renderCorrelationChart(_correlationData);
            }
        }, 150);
    });
    document.addEventListener('DOMContentLoaded', function() {
        var wrap = document.getElementById('correlation-chart');
        if (wrap && wrap.parentElement) observer.observe(wrap.parentElement);
    });
})();

function loadCorrelationData() {
    var hours = getPillValue('correlation-tabs');

    var loading = document.getElementById('correlation-loading');
    var noData = document.getElementById('correlation-no-data');
    var chartContainer = document.getElementById('correlation-chart-container');
    var tableCard = document.getElementById('correlation-table-card');
    loading.style.display = 'flex';
    noData.style.display = 'none';
    chartContainer.style.display = 'none';
    tableCard.style.display = 'none';

    /* Calculate time range for weather fetch */
    var now = new Date();
    var wEnd = now.toISOString().replace('T', ' ').substring(0, 19) + 'Z';
    var wStart = new Date(now.getTime() - parseInt(hours) * 3600000).toISOString().replace('T', ' ').substring(0, 19) + 'Z';
    var weatherUrl = '/api/weather/range?start=' + encodeURIComponent(wStart) + '&end=' + encodeURIComponent(wEnd);

    Promise.all([
        fetch('/api/correlation?hours=' + hours + '&sources=modem,speedtest,events').then(function(r) { return r.json(); }),
        fetch(weatherUrl).then(function(r) { return r.json(); }).catch(function() { return []; })
    ]).then(function(results) {
            var data = results[0];
            _corrWeatherData = results[1] || [];
            loading.style.display = 'none';
            _correlationData = data;
            if (!data || data.length === 0) {
                noData.textContent = T.correlation_no_data;
                noData.style.display = 'block';
                return;
            }
            chartContainer.style.display = 'block';
            tableCard.style.display = 'block';
            renderCorrelationChart(data);
            renderCorrelationTable(data);
        })
        .catch(function() {
            loading.style.display = 'none';
            noData.textContent = T.correlation_no_data;
            noData.style.display = 'block';
        });
}

function renderCorrelationChart(data) {
    var canvas = document.getElementById('correlation-chart');
    var ctx = canvas.getContext('2d');
    var dpr = window.devicePixelRatio || 1;
    var rect = canvas.parentElement.getBoundingClientRect();
    var W = rect.width;
    var H = 280;
    canvas.width = W * dpr;
    canvas.height = H * dpr;
    canvas.style.width = W + 'px';
    canvas.style.height = H + 'px';
    ctx.scale(dpr, dpr);
    ctx.clearRect(0, 0, W, H);

    // Setup overlay canvas to match main canvas
    var overlay = document.getElementById('correlation-overlay');
    overlay.width = W * dpr;
    overlay.height = H * dpr;
    overlay.style.width = W + 'px';
    overlay.style.height = H + 'px';
    var octx = overlay.getContext('2d');
    octx.scale(dpr, dpr);
    octx.clearRect(0, 0, W, H);

    var pad = { top: 20, right: 60, bottom: 40, left: 60 };
    var plotW = W - pad.left - pad.right;
    var plotH = H - pad.top - pad.bottom;

    var modem = data.filter(function(d) { return d.source === 'modem'; });
    var speedtest = data.filter(function(d) { return d.source === 'speedtest'; });
    var events = data.filter(function(d) { return d.source === 'event'; });

    if (modem.length === 0 && speedtest.length === 0) {
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted').trim() || '#888';
        ctx.font = '13px system-ui, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(T.correlation_no_data, W / 2, H / 2);
        return;
    }

    // Time range (with zoom support)
    var allTs = data.map(function(d) { return new Date(d.timestamp).getTime(); });
    var tMinFull = Math.min.apply(null, allTs);
    var tMaxFull = Math.max.apply(null, allTs);
    if (tMinFull === tMaxFull) { tMaxFull = tMinFull + 3600000; }
    var tMin = _corrZoom ? _corrZoom.tMin : tMinFull;
    var tMax = _corrZoom ? _corrZoom.tMax : tMaxFull;

    function xScale(ts) { return pad.left + (ts - tMin) / (tMax - tMin) * plotW; }

    // SNR axis (left, for modem SNR)
    var snrValues = modem.map(function(d) { return d.ds_snr_min || 0; }).filter(function(v) { return v > 0; });
    var snrMin = snrValues.length ? Math.floor(Math.min.apply(null, snrValues) - 2) : 20;
    var snrMax = snrValues.length ? Math.ceil(Math.max.apply(null, snrValues) + 2) : 45;
    function ySnr(v) { return pad.top + plotH - (v - snrMin) / (snrMax - snrMin) * plotH; }

    // Speed axis (right, for speedtest download/upload)
    var dlValues = speedtest.map(function(d) { return d.download_mbps || 0; });
    var ulValues = speedtest.map(function(d) { return d.upload_mbps || 0; });
    var speedMax = dlValues.length ? Math.ceil(Math.max.apply(null, dlValues) * 1.1) : 500;
    var dlMax = speedMax;
    var dlMin = 0;
    function yDl(v) { return pad.top + plotH - (v - dlMin) / (dlMax - dlMin) * plotH; }
    // TX Power axis (shares left side, separate scale)
    var txValues = modem.map(function(d) { return d.us_power_avg || 0; }).filter(function(v) { return v > 0; });
    var txMin = txValues.length ? Math.floor(Math.min.apply(null, txValues) - 2) : 30;
    var txMax = txValues.length ? Math.ceil(Math.max.apply(null, txValues) + 2) : 55;
    function yTx(v) { return pad.top + plotH - (v - txMin) / (txMax - txMin) * plotH; }

    // DS Power axis (separate scale)
    var dsPowerValues = modem.map(function(d) { return d.ds_power_avg || 0; }).filter(function(v) { return v !== 0; });
    var dsPowerMin = dsPowerValues.length ? Math.floor(Math.min.apply(null, dsPowerValues) - 2) : -10;
    var dsPowerMax = dsPowerValues.length ? Math.ceil(Math.max.apply(null, dsPowerValues) + 2) : 15;
    function yDsPower(v) { return pad.top + plotH - (v - dsPowerMin) / (dsPowerMax - dsPowerMin) * plotH; }

    // Uncorrectable errors (spike height relative to plotH)
    var errorValues = modem.map(function(d) { return d.ds_uncorrectable_errors || 0; });
    var errorMax = errorValues.length ? Math.max.apply(null, errorValues) : 0;

    // Temperature axis (separate scale, dashed line)
    var weather = _corrWeatherData || [];
    var tempValues = weather.map(function(d) { return d.temperature; }).filter(function(v) { return v != null; });
    var tempMin = tempValues.length ? Math.floor(Math.min.apply(null, tempValues) - 2) : -10;
    var tempMax = tempValues.length ? Math.ceil(Math.max.apply(null, tempValues) + 2) : 40;
    function yTemp(v) { return pad.top + plotH - (v - tempMin) / (tempMax - tempMin) * plotH; }

    var uploadColor = '#06b6d4'; // cyan
    var snrColor = 'rgba(168,85,247,1)'; // purple
    var txColor = '#f59e0b'; // amber/orange
    var dsPowerColor = '#ec4899'; // pink
    var errorColor = 'rgba(239,68,68,0.6)'; // red semi-transparent
    var tempColor = '#f97316'; // orange

    var style = getComputedStyle(document.documentElement);
    var textColor = style.getPropertyValue('--muted').trim() || '#888';
    var gridColor = style.getPropertyValue('--input-border').trim() || '#333';
    var goodColor = style.getPropertyValue('--good').trim() || '#4caf50';
    var warnColor = style.getPropertyValue('--warn').trim() || '#ff9800';
    var critColor = style.getPropertyValue('--crit').trim() || '#f44336';
    var accentColor = style.getPropertyValue('--accent').trim() || '#2196f3';

    // Store chart state for tooltip lookups
    var sortedSpeedtest = speedtest.slice().sort(function(a, b) {
        return new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime();
    });
    _corrChartState = {
        pad: pad, plotW: plotW, plotH: plotH, W: W, H: H,
        tMin: tMin, tMax: tMax, tMinFull: tMinFull, tMaxFull: tMaxFull,
        snrMin: snrMin, snrMax: snrMax, txMin: txMin, txMax: txMax,
        dsPowerMin: dsPowerMin, dsPowerMax: dsPowerMax, errorMax: errorMax,
        tempMin: tempMin, tempMax: tempMax,
        dlMin: dlMin, dlMax: dlMax,
        modem: modem, speedtest: sortedSpeedtest, events: events, data: data,
        weather: weather,
        xScale: xScale, ySnr: ySnr, yTx: yTx, yDsPower: yDsPower, yDl: yDl, yTemp: yTemp,
        colors: { snr: snrColor, txPower: txColor, dsPower: dsPowerColor, download: goodColor, upload: uploadColor, event: warnColor, errors: errorColor, temperature: tempColor, text: textColor, grid: gridColor },
        dpr: dpr
    };

    // Grid lines
    ctx.strokeStyle = gridColor;
    ctx.lineWidth = 0.5;
    ctx.setLineDash([2, 4]);
    for (var s = Math.ceil(snrMin); s <= snrMax; s += 5) {
        var y = ySnr(s);
        ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + plotW, y); ctx.stroke();
    }
    ctx.setLineDash([]);

    // Time axis labels
    ctx.fillStyle = textColor;
    ctx.font = '10px system-ui, sans-serif';
    ctx.textAlign = 'center';
    var labelCount = Math.min(8, Math.floor(plotW / 80));
    for (var i = 0; i <= labelCount; i++) {
        var t = tMin + (tMax - tMin) * i / labelCount;
        var d = new Date(t);
        var hours = getPillValue('correlation-tabs');
        var label;
        if (parseInt(hours) > 48) {
            label = (d.getMonth() + 1) + '/' + d.getDate() + ' ' + String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
        } else {
            label = String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
        }
        ctx.fillText(label, xScale(t), H - pad.bottom + 18);
    }

    // Left axis labels (SNR) — only if SNR visible
    if (_corrVisible.snr && modem.length > 0) {
        ctx.textAlign = 'right';
        ctx.fillStyle = accentColor;
        for (var s = Math.ceil(snrMin); s <= snrMax; s += 5) {
            ctx.fillText(s + ' dB', pad.left - 6, ySnr(s) + 3);
        }
        ctx.save();
        ctx.translate(12, pad.top + plotH / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.textAlign = 'center';
        ctx.font = '11px system-ui, sans-serif';
        ctx.fillText('SNR (dB)', 0, 0);
        ctx.restore();
    }

    // Right axis labels (Speed) — only if download or upload visible
    if ((_corrVisible.download || _corrVisible.upload) && speedtest.length > 0) {
        ctx.textAlign = 'left';
        ctx.fillStyle = goodColor;
        var dlStep = Math.max(1, Math.ceil(dlMax / 5 / 50) * 50);
        for (var v = 0; v <= dlMax; v += dlStep) {
            ctx.fillText(v + ' Mbps', pad.left + plotW + 6, yDl(v) + 3);
        }
        ctx.save();
        ctx.translate(W - 8, pad.top + plotH / 2);
        ctx.rotate(Math.PI / 2);
        ctx.textAlign = 'center';
        ctx.font = '11px system-ui, sans-serif';
        ctx.fillText('Mbps', 0, 0);
        ctx.restore();
    }

    // Draw modem SNR line with gradient fill
    if (_corrVisible.snr && modem.length > 1) {
        var gradient = ctx.createLinearGradient(0, pad.top, 0, pad.top + plotH);
        gradient.addColorStop(0, 'rgba(168,85,247,0.3)');
        gradient.addColorStop(1, 'rgba(168,85,247,0)');
        ctx.beginPath();
        ctx.moveTo(xScale(new Date(modem[0].timestamp).getTime()), pad.top + plotH);
        for (var i = 0; i < modem.length; i++) {
            var x = xScale(new Date(modem[i].timestamp).getTime());
            var y = ySnr(modem[i].ds_snr_min || snrMin);
            ctx.lineTo(x, y);
        }
        ctx.lineTo(xScale(new Date(modem[modem.length - 1].timestamp).getTime()), pad.top + plotH);
        ctx.closePath();
        ctx.fillStyle = gradient;
        ctx.fill();
        ctx.beginPath();
        for (var i = 0; i < modem.length; i++) {
            var x = xScale(new Date(modem[i].timestamp).getTime());
            var y = ySnr(modem[i].ds_snr_min || snrMin);
            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                var x0 = xScale(new Date(modem[i - 1].timestamp).getTime());
                var y0 = ySnr(modem[i - 1].ds_snr_min || snrMin);
                var cpx = x0 + (x - x0) * 0.4;
                ctx.bezierCurveTo(cpx, y0, x - (x - x0) * 0.4, y, x, y);
            }
        }
        ctx.strokeStyle = snrColor;
        ctx.lineWidth = 2;
        ctx.stroke();
    }

    // Draw upstream TX power line
    if (_corrVisible.txPower && modem.length > 1 && txValues.length > 0) {
        ctx.beginPath();
        for (var i = 0; i < modem.length; i++) {
            var txVal = modem[i].us_power_avg;
            if (!txVal) continue;
            var x = xScale(new Date(modem[i].timestamp).getTime());
            var y = yTx(txVal);
            if (ctx._txStarted) {
                var x0 = ctx._txLastX;
                var y0 = ctx._txLastY;
                var cpx = x0 + (x - x0) * 0.4;
                ctx.bezierCurveTo(cpx, y0, x - (x - x0) * 0.4, y, x, y);
            } else {
                ctx.moveTo(x, y);
                ctx._txStarted = true;
            }
            ctx._txLastX = x;
            ctx._txLastY = y;
        }
        delete ctx._txStarted;
        delete ctx._txLastX;
        delete ctx._txLastY;
        ctx.strokeStyle = txColor;
        ctx.lineWidth = 2;
        ctx.setLineDash([6, 3]);
        ctx.stroke();
        ctx.setLineDash([]);
    }

    // Draw DS Power line (dotted pink)
    if (_corrVisible.dsPower && modem.length > 1 && dsPowerValues.length > 0) {
        ctx.beginPath();
        var dsStarted = false;
        for (var i = 0; i < modem.length; i++) {
            var dsVal = modem[i].ds_power_avg;
            if (dsVal == null) continue;
            var x = xScale(new Date(modem[i].timestamp).getTime());
            var y = yDsPower(dsVal);
            if (!dsStarted) {
                ctx.moveTo(x, y);
                dsStarted = true;
            } else {
                ctx.lineTo(x, y);
            }
        }
        ctx.strokeStyle = dsPowerColor;
        ctx.lineWidth = 1.5;
        ctx.setLineDash([2, 3]);
        ctx.stroke();
        ctx.setLineDash([]);
    }

    // Draw uncorrectable error spikes (red bars from bottom)
    if (_corrVisible.errors && errorMax > 0) {
        var spikeMaxH = plotH * 0.3; // max 30% of plot height
        for (var i = 0; i < modem.length; i++) {
            var errVal = modem[i].ds_uncorrectable_errors || 0;
            if (errVal === 0) continue;
            var x = xScale(new Date(modem[i].timestamp).getTime());
            var spikeH = (errVal / errorMax) * spikeMaxH;
            if (spikeH < 2) spikeH = 2;
            ctx.fillStyle = errorColor;
            ctx.fillRect(x - 1.5, pad.top + plotH - spikeH, 3, spikeH);
        }
    }

    // Draw modem health background bands
    if (_corrVisible.poorSignal) {
        for (var i = 0; i < modem.length; i++) {
            var x1 = xScale(new Date(modem[i].timestamp).getTime());
            var x2 = i < modem.length - 1 ? xScale(new Date(modem[i + 1].timestamp).getTime()) : x1 + 2;
            var h = modem[i].health;
            if (h === 'poor' || h === 'critical') {
                ctx.fillStyle = 'rgba(244,67,54,0.08)';
            } else if (h === 'marginal') {
                ctx.fillStyle = 'rgba(255,152,0,0.06)';
            } else {
                continue;
            }
            ctx.fillRect(x1, pad.top, x2 - x1, plotH);
        }
    }

    // Draw speedtest lines
    if (sortedSpeedtest.length > 1) {
        // Download line with gradient fill
        if (_corrVisible.download) {
            var dlGrad = ctx.createLinearGradient(0, pad.top, 0, pad.top + plotH);
            dlGrad.addColorStop(0, 'rgba(76,175,80,0.2)');
            dlGrad.addColorStop(1, 'rgba(76,175,80,0)');
            ctx.beginPath();
            ctx.moveTo(xScale(new Date(sortedSpeedtest[0].timestamp).getTime()), pad.top + plotH);
            for (var i = 0; i < sortedSpeedtest.length; i++) {
                var x = xScale(new Date(sortedSpeedtest[i].timestamp).getTime());
                var y = yDl(sortedSpeedtest[i].download_mbps || 0);
                ctx.lineTo(x, y);
            }
            ctx.lineTo(xScale(new Date(sortedSpeedtest[sortedSpeedtest.length - 1].timestamp).getTime()), pad.top + plotH);
            ctx.closePath();
            ctx.fillStyle = dlGrad;
            ctx.fill();
            ctx.beginPath();
            for (var i = 0; i < sortedSpeedtest.length; i++) {
                var x = xScale(new Date(sortedSpeedtest[i].timestamp).getTime());
                var y = yDl(sortedSpeedtest[i].download_mbps || 0);
                if (i === 0) { ctx.moveTo(x, y); }
                else {
                    var x0 = xScale(new Date(sortedSpeedtest[i - 1].timestamp).getTime());
                    var y0 = yDl(sortedSpeedtest[i - 1].download_mbps || 0);
                    var cpx = x0 + (x - x0) * 0.4;
                    ctx.bezierCurveTo(cpx, y0, x - (x - x0) * 0.4, y, x, y);
                }
            }
            ctx.strokeStyle = goodColor;
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // Upload line
        if (_corrVisible.upload) {
            ctx.beginPath();
            for (var i = 0; i < sortedSpeedtest.length; i++) {
                var x = xScale(new Date(sortedSpeedtest[i].timestamp).getTime());
                var y = yDl(sortedSpeedtest[i].upload_mbps || 0);
                if (i === 0) { ctx.moveTo(x, y); }
                else {
                    var x0 = xScale(new Date(sortedSpeedtest[i - 1].timestamp).getTime());
                    var y0 = yDl(sortedSpeedtest[i - 1].upload_mbps || 0);
                    var cpx = x0 + (x - x0) * 0.4;
                    ctx.bezierCurveTo(cpx, y0, x - (x - x0) * 0.4, y, x, y);
                }
            }
            ctx.strokeStyle = uploadColor;
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // Data point dots
        for (var i = 0; i < sortedSpeedtest.length; i++) {
            var x = xScale(new Date(sortedSpeedtest[i].timestamp).getTime());
            if (_corrVisible.download) {
                ctx.beginPath();
                ctx.arc(x, yDl(sortedSpeedtest[i].download_mbps || 0), 3, 0, Math.PI * 2);
                ctx.fillStyle = goodColor;
                ctx.fill();
            }
            if (_corrVisible.upload) {
                ctx.beginPath();
                ctx.arc(x, yDl(sortedSpeedtest[i].upload_mbps || 0), 3, 0, Math.PI * 2);
                ctx.fillStyle = uploadColor;
                ctx.fill();
            }
        }
    } else if (sortedSpeedtest.length === 1) {
        var x = xScale(new Date(sortedSpeedtest[0].timestamp).getTime());
        if (_corrVisible.download) {
            ctx.beginPath();
            ctx.arc(x, yDl(sortedSpeedtest[0].download_mbps || 0), 5, 0, Math.PI * 2);
            ctx.fillStyle = goodColor;
            ctx.fill();
        }
        if (_corrVisible.upload) {
            ctx.beginPath();
            ctx.arc(x, yDl(sortedSpeedtest[0].upload_mbps || 0), 5, 0, Math.PI * 2);
            ctx.fillStyle = uploadColor;
            ctx.fill();
        }
    }

    // Draw event markers (vertical dashed lines)
    var filteredEvents = _corrFilteredEvents(events);
    if (_corrVisible.events && filteredEvents.length > 0) {
        for (var i = 0; i < filteredEvents.length; i++) {
            var x = xScale(new Date(filteredEvents[i].timestamp).getTime());
            var sev = filteredEvents[i].severity;
            ctx.strokeStyle = sev === 'critical' ? critColor : sev === 'warning' ? warnColor : textColor;
            ctx.lineWidth = 1;
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.moveTo(x, pad.top);
            ctx.lineTo(x, pad.top + plotH);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = ctx.strokeStyle;
            ctx.beginPath();
            ctx.moveTo(x, pad.top);
            ctx.lineTo(x - 4, pad.top - 8);
            ctx.lineTo(x + 4, pad.top - 8);
            ctx.closePath();
            ctx.fill();
        }
    }

    // Temperature line (dashed)
    if (_corrVisible.temperature && weather.length > 1) {
        ctx.beginPath();
        var started = false;
        for (var i = 0; i < weather.length; i++) {
            if (weather[i].temperature == null) continue;
            var x = xScale(new Date(weather[i].timestamp).getTime());
            var y = yTemp(weather[i].temperature);
            if (!started) { ctx.moveTo(x, y); started = true; }
            else {
                var x0 = xScale(new Date(weather[i - 1].timestamp).getTime());
                var y0 = yTemp(weather[i - 1].temperature);
                var cpx = x0 + (x - x0) * 0.4;
                ctx.bezierCurveTo(cpx, y0, x - (x - x0) * 0.4, y, x, y);
            }
        }
        ctx.strokeStyle = tempColor;
        ctx.lineWidth = 1.5;
        ctx.setLineDash([5, 3]);
        ctx.stroke();
        ctx.setLineDash([]);
    }

    // Interactive Legend
    var legend = document.getElementById('correlation-legend');
    var legendItems = [];
    if (modem.length > 0) {
        legendItems.push({ metric: 'snr', color: snrColor, label: '&#9644; SNR (dB)' });
        if (txValues.length > 0) {
            legendItems.push({ metric: 'txPower', color: txColor, label: '&#9476; TX Power (dBmV)' });
        }
        if (dsPowerValues.length > 0) {
            legendItems.push({ metric: 'dsPower', color: dsPowerColor, label: '&#183;&#183; DS Power (dBmV)' });
        }
        if (errorMax > 0) {
            legendItems.push({ metric: 'errors', color: 'rgba(239,68,68,0.8)', label: '&#9612; Errors' });
        }
    }
    if (speedtest.length > 0) {
        legendItems.push({ metric: 'download', color: goodColor, label: '&#9644; Download (Mbps)' });
        legendItems.push({ metric: 'upload', color: uploadColor, label: '&#9644; Upload (Mbps)' });
    }
    if (events.length > 0) {
        // Populate _corrEventFilter for all event types in current data
        var eventTypes = {};
        for (var i = 0; i < events.length; i++) {
            var et = events[i].event_type || 'unknown';
            eventTypes[et] = (eventTypes[et] || 0) + 1;
            if (!(et in _corrEventFilter)) _corrEventFilter[et] = !_OPERATIONAL_EVENTS[et];
        }
        legendItems.push({ metric: 'events', color: warnColor, label: '&#9650; Events', eventTypes: eventTypes });
    }
    if (weather.length > 0) {
        legendItems.push({ metric: 'temperature', color: tempColor, label: '- - ' + (T.temperature || 'Temperature') + ' (°C)' });
    }
    legend.innerHTML = legendItems.map(function(item) {
        var cls = _corrVisible[item.metric] ? '' : ' disabled';
        if (item.metric === 'events') {
            var filterCount = 0, totalTypes = 0;
            for (var et in item.eventTypes) { totalTypes++; if (_corrEventFilter[et]) filterCount++; }
            var filterBadge = filterCount < totalTypes ? ' <span style="font-size:0.7em;opacity:0.7;">(' + filterCount + '/' + totalTypes + ')</span>' : '';
            return '<span data-metric="events" class="' + cls + '" title="Klicken zum Ein-/Ausblenden" style="color:' + item.color + '; position:relative;">' + item.label + filterBadge +
                ' <span class="corr-event-filter-btn" title="Event-Filter" style="cursor:pointer; font-size:0.75em; opacity:0.6; margin-left:2px;">&#9881;</span></span>';
        }
        return '<span data-metric="' + item.metric + '" class="' + cls + '" title="Klicken zum Ein-/Ausblenden" style="color:' + item.color + ';">' + item.label + '</span>';
    }).join('') + '<span data-metric="poorSignal" class="' + (_corrVisible.poorSignal ? '' : 'disabled') + '" title="Klicken zum Ein-/Ausblenden" style="background:rgba(244,67,54,0.15); padding:1px 6px; border-radius:3px; font-size:0.8em; color:#f44336;">Poor Signal</span>';

    // Event filter popover
    var filterBtn = legend.querySelector('.corr-event-filter-btn');
    if (filterBtn) {
        filterBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            var existing = document.getElementById('corr-event-popover');
            if (existing) { existing.remove(); return; }
            var pop = document.createElement('div');
            pop.id = 'corr-event-popover';
            pop.style.cssText = 'position:absolute; z-index:100; background:var(--bg,#1f2937); border:1px solid var(--card-border,rgba(255,255,255,0.08)); border-radius:8px; padding:8px 12px; min-width:180px; box-shadow:0 4px 16px rgba(0,0,0,0.4); font-size:0.85em;';
            var typeLabel = {
                health_change: T.event_type_health_change || 'Health Change',
                power_change: T.event_type_power_change || 'Power Change',
                snr_change: T.event_type_snr_change || 'SNR Change',
                channel_change: T.event_type_channel_change || 'Channel Change',
                modulation_change: T.event_type_modulation_change || 'Modulation Change',
                error_spike: T.event_type_error_spike || 'Error Spike',
                monitoring_started: T.event_type_monitoring_started || 'Monitoring Started',
                monitoring_stopped: T.event_type_monitoring_stopped || 'Monitoring Stopped'
            };
            var html = '<div style="font-weight:600; margin-bottom:6px; color:var(--text,#f0f0f0);">' + (T.event_filter_title || 'Event Types') + '</div>';
            var sortedTypes = Object.keys(eventTypes).sort();
            for (var si = 0; si < sortedTypes.length; si++) {
                var et = sortedTypes[si];
                var checked = _corrEventFilter[et] ? ' checked' : '';
                var label = typeLabel[et] || et.replace(/_/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); });
                html += '<label style="display:flex; align-items:center; gap:6px; padding:3px 0; cursor:pointer; color:var(--text-secondary,#9ca3af);">' +
                    '<input type="checkbox" data-event-type="' + et + '"' + checked + ' style="accent-color:' + warnColor + ';"> ' +
                    label + ' <span style="opacity:0.5; font-size:0.85em;">(' + eventTypes[et] + ')</span></label>';
            }
            pop.innerHTML = html;
            this.parentElement.appendChild(pop);
            pop.querySelectorAll('input[data-event-type]').forEach(function(cb) {
                cb.addEventListener('change', function() {
                    _corrEventFilter[this.getAttribute('data-event-type')] = this.checked;
                    renderCorrelationChart(data);
                });
            });
            // Close on outside click
            setTimeout(function() {
                document.addEventListener('click', function closePopover(ev) {
                    if (!pop.contains(ev.target) && ev.target !== filterBtn) {
                        pop.remove();
                        document.removeEventListener('click', closePopover);
                    }
                });
            }, 0);
        });
    }

    // Legend click handlers
    var legendSpans = legend.querySelectorAll('span[data-metric]');
    for (var li = 0; li < legendSpans.length; li++) {
        legendSpans[li].addEventListener('click', function(e) {
            if (e.target.classList.contains('corr-event-filter-btn')) return;
            var metric = this.getAttribute('data-metric');
            // Prevent disabling all metrics
            var visibleCount = 0;
            for (var k in _corrVisible) { if (_corrVisible[k]) visibleCount++; }
            if (_corrVisible[metric] && visibleCount <= 1) return;
            _corrVisible[metric] = !_corrVisible[metric];
            renderCorrelationChart(data);
        });
    }

    // Show/hide zoom reset button
    var zoomBtn = document.getElementById('correlation-zoom-reset');
    if (zoomBtn) zoomBtn.style.display = _corrZoom ? 'block' : 'none';

    // Setup tooltip interaction on overlay canvas
    _setupCorrelationTooltip(overlay, octx);
}

function _corrResetZoom() {
    _corrZoom = null;
    if (_correlationData && _correlationData.length > 0) {
        renderCorrelationChart(_correlationData);
    }
}

function _setupCorrelationTooltip(overlay, octx) {
    var tooltip = document.getElementById('correlation-tooltip');

    // Remove old listeners by replacing the overlay node
    var newOverlay = overlay.cloneNode(true);
    overlay.parentNode.replaceChild(newOverlay, overlay);
    var newOctx = newOverlay.getContext('2d');
    var st = _corrChartState;
    if (!st) return;
    newOctx.setTransform(st.dpr, 0, 0, st.dpr, 0, 0);

    // Drag-zoom state
    var dragStart = null; // mouseX where drag started

    newOverlay.addEventListener('mousedown', function(e) {
        if (!_corrChartState) return;
        var st = _corrChartState;
        var rect = newOverlay.getBoundingClientRect();
        var mouseX = e.clientX - rect.left;
        if (mouseX >= st.pad.left && mouseX <= st.pad.left + st.plotW) {
            dragStart = mouseX;
        }
    });

    newOverlay.addEventListener('mouseup', function(e) {
        if (!_corrChartState || dragStart === null) return;
        var st = _corrChartState;
        var rect = newOverlay.getBoundingClientRect();
        var mouseX = e.clientX - rect.left;
        var minDrag = 20; // minimum drag distance in px
        if (Math.abs(mouseX - dragStart) > minDrag) {
            var x1 = Math.max(st.pad.left, Math.min(dragStart, mouseX));
            var x2 = Math.min(st.pad.left + st.plotW, Math.max(dragStart, mouseX));
            var t1 = st.tMin + (x1 - st.pad.left) / st.plotW * (st.tMax - st.tMin);
            var t2 = st.tMin + (x2 - st.pad.left) / st.plotW * (st.tMax - st.tMin);
            _corrZoom = { tMin: t1, tMax: t2 };
            dragStart = null;
            renderCorrelationChart(st.data);
            return;
        }
        dragStart = null;
    });

    newOverlay.addEventListener('mousemove', function(e) {
        if (!_corrChartState) return;
        var st = _corrChartState;
        var rect = newOverlay.getBoundingClientRect();
        var mouseX = e.clientX - rect.left;
        var mouseY = e.clientY - rect.top;

        // Draw drag selection overlay
        if (dragStart !== null) {
            newOctx.clearRect(0, 0, st.W, st.H);
            var x1 = Math.max(st.pad.left, Math.min(dragStart, mouseX));
            var x2 = Math.min(st.pad.left + st.plotW, Math.max(dragStart, mouseX));
            newOctx.fillStyle = 'rgba(168,85,247,0.15)';
            newOctx.fillRect(x1, st.pad.top, x2 - x1, st.plotH);
            newOctx.strokeStyle = 'rgba(168,85,247,0.5)';
            newOctx.lineWidth = 1;
            newOctx.strokeRect(x1, st.pad.top, x2 - x1, st.plotH);
            tooltip.style.display = 'none';
            return;
        }

        // Only interact within plot area
        if (mouseX < st.pad.left || mouseX > st.pad.left + st.plotW || mouseY < st.pad.top || mouseY > st.pad.top + st.plotH) {
            newOctx.clearRect(0, 0, st.W, st.H);
            tooltip.style.display = 'none';
            return;
        }

        // Convert mouseX to timestamp
        var tHover = st.tMin + (mouseX - st.pad.left) / st.plotW * (st.tMax - st.tMin);

        // Find nearest modem point
        var nearestModem = null;
        if (st.modem.length > 0 && _corrVisible.snr) {
            var bestDist = Infinity;
            for (var i = 0; i < st.modem.length; i++) {
                var ts = new Date(st.modem[i].timestamp).getTime();
                var dist = Math.abs(ts - tHover);
                if (dist < bestDist) { bestDist = dist; nearestModem = st.modem[i]; }
            }
        }

        // Find nearest speedtest point
        var nearestSpeed = null;
        if (st.speedtest.length > 0 && (_corrVisible.download || _corrVisible.upload)) {
            var bestDist = Infinity;
            for (var i = 0; i < st.speedtest.length; i++) {
                var ts = new Date(st.speedtest[i].timestamp).getTime();
                var dist = Math.abs(ts - tHover);
                if (dist < bestDist) { bestDist = dist; nearestSpeed = st.speedtest[i]; }
            }
        }

        // Find nearest event (respecting type filter)
        var nearestEvent = null;
        var visibleEvents = _corrFilteredEvents(st.events);
        if (visibleEvents.length > 0) {
            var bestDist = Infinity;
            for (var i = 0; i < visibleEvents.length; i++) {
                var ts = new Date(visibleEvents[i].timestamp).getTime();
                var dist = Math.abs(ts - tHover);
                if (dist < bestDist) { bestDist = dist; nearestEvent = visibleEvents[i]; }
            }
        }

        // Find nearest weather point
        var nearestWeather = null;
        if (st.weather && st.weather.length > 0 && _corrVisible.temperature) {
            var bestDist = Infinity;
            for (var i = 0; i < st.weather.length; i++) {
                var ts = new Date(st.weather[i].timestamp).getTime();
                var dist = Math.abs(ts - tHover);
                if (dist < bestDist) { bestDist = dist; nearestWeather = st.weather[i]; }
            }
        }

        // Draw crosshair on overlay
        newOctx.clearRect(0, 0, st.W, st.H);
        newOctx.strokeStyle = 'rgba(255,255,255,0.25)';
        newOctx.lineWidth = 1;
        newOctx.setLineDash([4, 4]);
        newOctx.beginPath();
        newOctx.moveTo(mouseX, st.pad.top);
        newOctx.lineTo(mouseX, st.pad.top + st.plotH);
        newOctx.stroke();
        newOctx.setLineDash([]);

        // Draw highlight dots at nearest data points
        if (nearestModem && _corrVisible.snr) {
            var dx = st.xScale(new Date(nearestModem.timestamp).getTime());
            var dy = st.ySnr(nearestModem.ds_snr_min || st.snrMin);
            newOctx.beginPath();
            newOctx.arc(dx, dy, 5, 0, Math.PI * 2);
            newOctx.fillStyle = st.colors.snr;
            newOctx.fill();
            newOctx.strokeStyle = '#fff';
            newOctx.lineWidth = 2;
            newOctx.stroke();
        }
        if (nearestModem && _corrVisible.txPower && nearestModem.us_power_avg) {
            var dx = st.xScale(new Date(nearestModem.timestamp).getTime());
            var dy = st.yTx(nearestModem.us_power_avg);
            newOctx.beginPath();
            newOctx.arc(dx, dy, 5, 0, Math.PI * 2);
            newOctx.fillStyle = st.colors.txPower;
            newOctx.fill();
            newOctx.strokeStyle = '#fff';
            newOctx.lineWidth = 2;
            newOctx.stroke();
        }
        if (nearestModem && _corrVisible.dsPower && nearestModem.ds_power_avg != null) {
            var dx = st.xScale(new Date(nearestModem.timestamp).getTime());
            var dy = st.yDsPower(nearestModem.ds_power_avg);
            newOctx.beginPath();
            newOctx.arc(dx, dy, 5, 0, Math.PI * 2);
            newOctx.fillStyle = st.colors.dsPower;
            newOctx.fill();
            newOctx.strokeStyle = '#fff';
            newOctx.lineWidth = 2;
            newOctx.stroke();
        }
        if (nearestSpeed) {
            if (_corrVisible.download) {
                var dx = st.xScale(new Date(nearestSpeed.timestamp).getTime());
                var dy = st.yDl(nearestSpeed.download_mbps || 0);
                newOctx.beginPath();
                newOctx.arc(dx, dy, 5, 0, Math.PI * 2);
                newOctx.fillStyle = st.colors.download;
                newOctx.fill();
                newOctx.strokeStyle = '#fff';
                newOctx.lineWidth = 2;
                newOctx.stroke();
            }
            if (_corrVisible.upload) {
                var dx = st.xScale(new Date(nearestSpeed.timestamp).getTime());
                var dy = st.yDl(nearestSpeed.upload_mbps || 0);
                newOctx.beginPath();
                newOctx.arc(dx, dy, 5, 0, Math.PI * 2);
                newOctx.fillStyle = st.colors.upload;
                newOctx.fill();
                newOctx.strokeStyle = '#fff';
                newOctx.lineWidth = 2;
                newOctx.stroke();
            }
        }

        // Draw temperature highlight dot
        if (nearestWeather && _corrVisible.temperature && nearestWeather.temperature != null) {
            var dx = st.xScale(new Date(nearestWeather.timestamp).getTime());
            var dy = st.yTemp(nearestWeather.temperature);
            newOctx.beginPath();
            newOctx.arc(dx, dy, 5, 0, Math.PI * 2);
            newOctx.fillStyle = st.colors.temperature;
            newOctx.fill();
            newOctx.strokeStyle = '#fff';
            newOctx.lineWidth = 2;
            newOctx.stroke();
        }

        // Build tooltip content
        var html = '';
        // Use the closest data point's timestamp as the display time
        var displayTs = tHover;
        if (nearestModem) displayTs = new Date(nearestModem.timestamp).getTime();
        if (nearestSpeed) {
            var spTs = new Date(nearestSpeed.timestamp).getTime();
            if (!nearestModem || Math.abs(spTs - tHover) < Math.abs(new Date(nearestModem.timestamp).getTime() - tHover)) {
                displayTs = spTs;
            }
        }
        var dDate = new Date(displayTs);
        var timeStr = String(dDate.getHours()).padStart(2, '0') + ':' + String(dDate.getMinutes()).padStart(2, '0') + ':' + String(dDate.getSeconds()).padStart(2, '0');
        var dateStr = dDate.getFullYear() + '-' + String(dDate.getMonth() + 1).padStart(2, '0') + '-' + String(dDate.getDate()).padStart(2, '0');
        html += '<div class="tt-time">' + dateStr + ' ' + timeStr + '</div>';

        if (nearestModem && _corrVisible.snr) {
            html += '<div class="tt-row"><span class="tt-dot" style="background:' + st.colors.snr + ';"></span> SNR: ' + (nearestModem.ds_snr_min || 0).toFixed(1) + ' dB</div>';
        }
        if (nearestModem && _corrVisible.txPower && nearestModem.us_power_avg) {
            html += '<div class="tt-row"><span class="tt-dot" style="background:' + st.colors.txPower + ';"></span> TX Power: ' + nearestModem.us_power_avg.toFixed(1) + ' dBmV</div>';
        }
        if (nearestModem && _corrVisible.dsPower && nearestModem.ds_power_avg != null) {
            html += '<div class="tt-row"><span class="tt-dot" style="background:' + st.colors.dsPower + ';"></span> DS Power: ' + nearestModem.ds_power_avg.toFixed(1) + ' dBmV</div>';
        }
        if (nearestModem && _corrVisible.errors && (nearestModem.ds_uncorrectable_errors || 0) > 0) {
            html += '<div class="tt-row"><span class="tt-dot" style="background:' + st.colors.errors + ';"></span> Errors: ' + nearestModem.ds_uncorrectable_errors.toLocaleString() + '</div>';
        }
        if (nearestSpeed && _corrVisible.download) {
            html += '<div class="tt-row"><span class="tt-dot" style="background:' + st.colors.download + ';"></span> Download: ' + (nearestSpeed.download_mbps || 0).toFixed(1) + ' Mbps</div>';
        }
        if (nearestSpeed && _corrVisible.upload) {
            html += '<div class="tt-row"><span class="tt-dot" style="background:' + st.colors.upload + ';"></span> Upload: ' + (nearestSpeed.upload_mbps || 0).toFixed(1) + ' Mbps</div>';
        }
        if (nearestEvent && _corrVisible.events) {
            html += '<div class="tt-row"><span class="tt-dot" style="background:' + st.colors.event + ';"></span> Event: ' + (nearestEvent.message || nearestEvent.severity || '') + '</div>';
        }
        if (nearestWeather && _corrVisible.temperature && nearestWeather.temperature != null) {
            html += '<div class="tt-row"><span class="tt-dot" style="background:' + st.colors.temperature + ';"></span> ' + (T.temperature || 'Temperature') + ': ' + nearestWeather.temperature.toFixed(1) + ' \u00B0C</div>';
        }

        tooltip.innerHTML = html;
        tooltip.style.display = 'block';

        // Position tooltip — flip to left side if near right edge
        var ttW = tooltip.offsetWidth;
        var ttH = tooltip.offsetHeight;
        var ttX = mouseX + 12;
        var ttY = mouseY - ttH / 2;
        if (ttX + ttW > st.W - 10) {
            ttX = mouseX - ttW - 12;
        }
        if (ttY < 0) ttY = 4;
        if (ttY + ttH > st.H) ttY = st.H - ttH - 4;
        tooltip.style.left = ttX + 'px';
        tooltip.style.top = ttY + 'px';

        // Highlight corresponding table rows
        _corrHighlightTableRows(nearestModem, nearestSpeed, nearestEvent);
    });

    newOverlay.addEventListener('mouseleave', function() {
        dragStart = null;
        if (!_corrChartState) return;
        var st = _corrChartState;
        newOctx.clearRect(0, 0, st.W, st.H);
        tooltip.style.display = 'none';
        _corrClearTableHighlight();
    });
}

// Highlight matching table rows when hovering on chart
function _corrHighlightTableRows(modemPt, speedPt, eventPt) {
    _corrClearTableHighlight();
    var tbody = document.getElementById('correlation-tbody');
    if (!tbody) return;
    var rows = tbody.querySelectorAll('tr[data-ts]');
    var timestamps = [];
    if (modemPt) timestamps.push(modemPt.timestamp);
    if (speedPt) timestamps.push(speedPt.timestamp);
    if (eventPt) timestamps.push(eventPt.timestamp);
    if (timestamps.length === 0) return;
    var wrap = document.getElementById('correlation-table-wrap');
    var firstMatch = null;
    for (var i = 0; i < rows.length; i++) {
        var rowTs = rows[i].getAttribute('data-ts');
        if (timestamps.indexOf(rowTs) !== -1) {
            rows[i].classList.add('corr-highlight');
            if (!firstMatch) firstMatch = rows[i];
        }
    }
    // Scroll first highlighted row into view within the table wrapper
    if (firstMatch && wrap) {
        var wrapRect = wrap.getBoundingClientRect();
        var rowRect = firstMatch.getBoundingClientRect();
        var thead = wrap.querySelector('thead');
        var theadH = thead ? thead.offsetHeight : 0;
        // Check if row is outside visible area of the wrapper
        if (rowRect.top < wrapRect.top + theadH || rowRect.bottom > wrapRect.bottom) {
            var scrollTarget = rowRect.top - wrapRect.top + wrap.scrollTop - theadH - 8;
            wrap.scrollTo({ top: scrollTarget, behavior: 'smooth' });
        }
    }
}

function _corrClearTableHighlight() {
    var highlighted = document.querySelectorAll('#correlation-tbody tr.corr-highlight');
    for (var i = 0; i < highlighted.length; i++) {
        highlighted[i].classList.remove('corr-highlight');
    }
}

// Draw highlight on chart overlay when hovering a table row
function _corrHighlightFromTable(timestamp, source) {
    var overlay = document.getElementById('correlation-overlay');
    if (!overlay || !_corrChartState) return;
    var octx = overlay.getContext('2d');
    var st = _corrChartState;
    octx.setTransform(st.dpr, 0, 0, st.dpr, 0, 0);
    octx.clearRect(0, 0, st.W, st.H);

    var ts = new Date(timestamp).getTime();
    var x = st.xScale(ts);

    // Draw crosshair
    octx.strokeStyle = 'rgba(255,255,255,0.3)';
    octx.lineWidth = 1;
    octx.setLineDash([4, 4]);
    octx.beginPath();
    octx.moveTo(x, st.pad.top);
    octx.lineTo(x, st.pad.top + st.plotH);
    octx.stroke();
    octx.setLineDash([]);

    // Draw highlight dot based on source
    if (source === 'modem') {
        for (var i = 0; i < st.modem.length; i++) {
            if (st.modem[i].timestamp === timestamp) {
                if (_corrVisible.snr) {
                    var dy = st.ySnr(st.modem[i].ds_snr_min || st.snrMin);
                    octx.beginPath();
                    octx.arc(x, dy, 6, 0, Math.PI * 2);
                    octx.fillStyle = st.colors.snr;
                    octx.fill();
                    octx.strokeStyle = '#fff';
                    octx.lineWidth = 2;
                    octx.stroke();
                }
                if (_corrVisible.txPower && st.modem[i].us_power_avg) {
                    var dy = st.yTx(st.modem[i].us_power_avg);
                    octx.beginPath();
                    octx.arc(x, dy, 6, 0, Math.PI * 2);
                    octx.fillStyle = st.colors.txPower;
                    octx.fill();
                    octx.strokeStyle = '#fff';
                    octx.lineWidth = 2;
                    octx.stroke();
                }
                break;
            }
        }
    } else if (source === 'speedtest') {
        for (var i = 0; i < st.speedtest.length; i++) {
            if (st.speedtest[i].timestamp === timestamp) {
                if (_corrVisible.download) {
                    var dy = st.yDl(st.speedtest[i].download_mbps || 0);
                    octx.beginPath();
                    octx.arc(x, dy, 6, 0, Math.PI * 2);
                    octx.fillStyle = st.colors.download;
                    octx.fill();
                    octx.strokeStyle = '#fff';
                    octx.lineWidth = 2;
                    octx.stroke();
                }
                if (_corrVisible.upload) {
                    var dy = st.yDl(st.speedtest[i].upload_mbps || 0);
                    octx.beginPath();
                    octx.arc(x, dy, 6, 0, Math.PI * 2);
                    octx.fillStyle = st.colors.upload;
                    octx.fill();
                    octx.strokeStyle = '#fff';
                    octx.lineWidth = 2;
                    octx.stroke();
                }
                break;
            }
        }
    } else if (source === 'event' && _corrVisible.events) {
        octx.strokeStyle = st.colors.event;
        octx.lineWidth = 2;
        octx.setLineDash([3, 3]);
        octx.beginPath();
        octx.moveTo(x, st.pad.top);
        octx.lineTo(x, st.pad.top + st.plotH);
        octx.stroke();
        octx.setLineDash([]);
    }
}

function _corrClearChartHighlight() {
    var overlay = document.getElementById('correlation-overlay');
    if (!overlay || !_corrChartState) return;
    var octx = overlay.getContext('2d');
    var st = _corrChartState;
    octx.setTransform(st.dpr, 0, 0, st.dpr, 0, 0);
    octx.clearRect(0, 0, st.W, st.H);
}

function _corrExportPNG() {
    var canvas = document.getElementById('correlation-chart');
    if (!canvas) return;
    var link = document.createElement('a');
    link.download = 'correlation-chart-' + new Date().toISOString().slice(0, 10) + '.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
}

function _corrExportCSV() {
    if (!_correlationData || _correlationData.length === 0) return;
    var headers = ['timestamp', 'source', 'health', 'ds_snr_min', 'ds_power_avg', 'us_power_avg', 'ds_uncorrectable_errors', 'download_mbps', 'upload_mbps', 'ping_ms', 'severity', 'message'];
    var rows = [headers.join(',')];
    for (var i = 0; i < _correlationData.length; i++) {
        var d = _correlationData[i];
        var row = headers.map(function(h) {
            var v = d[h];
            if (v == null) return '';
            if (typeof v === 'string' && (v.indexOf(',') !== -1 || v.indexOf('"') !== -1)) {
                return '"' + v.replace(/"/g, '""') + '"';
            }
            return v;
        });
        rows.push(row.join(','));
    }
    var blob = new Blob([rows.join('\n')], { type: 'text/csv' });
    var link = document.createElement('a');
    link.download = 'correlation-data-' + new Date().toISOString().slice(0, 10) + '.csv';
    link.href = URL.createObjectURL(blob);
    link.click();
    URL.revokeObjectURL(link.href);
}

function renderCorrelationTable(data) {
    var tbody = document.getElementById('correlation-tbody');
    tbody.innerHTML = '';

    // Show newest first in table
    var sorted = data.slice().reverse();

    var healthLabels = {
        good: T.health_good,
        marginal: T.health_marginal,
        poor: T.health_poor,
        critical: T.health_critical
    };
    var sevLabels = {
        info: T.event_severity_info,
        warning: T.event_severity_warning,
        critical: T.event_severity_critical
    };
    var typeLabels = {
        health_change: T.event_type_health_change,
        power_change: T.event_type_power_change,
        snr_change: T.event_type_snr_change,
        channel_change: T.event_type_channel_change,
        modulation_change: T.event_type_modulation_change,
        error_spike: T.event_type_error_spike
    };

    // Pre-filter modem entries: only show health transitions (not repeated same-status)
    // Data is chronological, sorted is reversed (newest first)
    var chronological = data.slice().sort(function(a, b) {
        return new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime();
    });
    var modemTransitionTs = {};
    var lastModemHealth = null;
    for (var i = 0; i < chronological.length; i++) {
        if (chronological[i].source !== 'modem') continue;
        var h = chronological[i].health || 'unknown';
        if (h !== lastModemHealth) {
            modemTransitionTs[chronological[i].timestamp] = true;
            lastModemHealth = h;
        }
    }

    var sorted = data.slice().reverse();
    var maxRows = 200;
    var count = 0;
    for (var i = 0; i < sorted.length && count < maxRows; i++) {
        var e = sorted[i];

        // Skip modem entries that are not health transitions
        if (e.source === 'modem' && !modemTransitionTs[e.timestamp]) continue;

        var tr = document.createElement('tr');
        tr.setAttribute('data-ts', e.timestamp);
        tr.setAttribute('data-src', e.source);
        var ts = escapeHtml(e.timestamp.replace('T', ' '));
        var src = e.source;
        var msg = '';
        var details = '';

        if (src === 'modem') {
            var h = e.health || 'unknown';
            var badge = '<span class="st-health-badge health-' + h + '">' + (healthLabels[h] || h) + '</span>';
            src = '<span style="color:var(--accent);">Modem</span>';
            msg = badge;
            details = 'SNR ' + (e.ds_snr_min != null ? e.ds_snr_min + ' dB' : '') +
                      ' | Power ' + (e.ds_power_avg != null ? e.ds_power_avg + ' dBmV' : '') +
                      ' | TX ' + (e.us_power_avg != null ? e.us_power_avg + ' dBmV' : '') +
                      ' | Errors ' + (e.ds_uncorrectable_errors || 0);
        } else if (src === 'speedtest') {
            src = '<span style="color:var(--good);">Speedtest</span>';
            msg = (e.download_mbps ? e.download_mbps.toFixed(1) + ' / ' + (e.upload_mbps || 0).toFixed(1) + ' Mbps' : '');
            var mhBadge = '';
            if (e.modem_health) {
                mhBadge = ' <span class="st-health-badge health-' + e.modem_health + '" style="font-size:0.75em;">'
                    + (healthLabels[e.modem_health] || e.modem_health) + '</span>';
            }
            details = 'Ping ' + (e.ping_ms || '') + ' ms | Jitter ' + (e.jitter_ms || '') + ' ms' + mhBadge;
        } else if (src === 'event') {
            var sevColor = e.severity === 'critical' ? 'var(--crit)' : e.severity === 'warning' ? 'var(--warn)' : 'var(--muted)';
            src = '<span style="color:' + sevColor + ';">' + (sevLabels[e.severity] || e.severity) + '</span>';
            msg = escapeHtml(e.message || '');
            details = typeLabels[e.event_type] || e.event_type || '';
        }

        tr.innerHTML = '<td style="white-space:nowrap; font-size:0.82em;">' + ts + '</td>'
            + '<td>' + src + '</td>'
            + '<td>' + msg + '</td>'
            + '<td style="font-size:0.82em; color:var(--muted);">' + details + '</td>';
        tr.addEventListener('mouseenter', function() {
            var rowTs = this.getAttribute('data-ts');
            var rowSrc = this.getAttribute('data-src');
            _corrHighlightFromTable(rowTs, rowSrc);
        });
        tr.addEventListener('mouseleave', function() {
            _corrClearChartHighlight();
        });
        tbody.appendChild(tr);
        count++;
    }
}

</script>

<script>
  // Initialize Lucide icons after DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();
  });
</script>
</body>
</html>
