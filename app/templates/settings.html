<!DOCTYPE html>
<html lang="{{ lang }}" data-theme="{{ theme }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DOCSight - {{ t.settings }}</title>
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg">
    <link rel="icon" type="image/png" href="/static/icon.png">
    <link rel="apple-touch-icon" href="/static/icon.png">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#a855f7">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/settings.css">
    {% for mod in modules if mod.has_css %}
    <link rel="stylesheet" href="/modules/{{ mod.id }}/static/style.css">
    {% endfor %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@0.575.0/dist/umd/lucide.min.js"
            integrity="sha384-GzE8qT1LzDfRNjtvLN/dXDLPlJOB3BBom3Twb9/RwHkXCgNl6OU1pBxM9397HWGU"
            crossorigin="anonymous"></script>
</head>
<body>

<div class="error-msg" id="global-error"></div>
<div class="toast" id="toast"></div>

<div class="settings-layout">
    <!-- ═══ Desktop Sidebar (≥768px) ═══ -->
    <nav class="settings-sidebar" id="settings-sidebar">
        <div class="settings-sidebar-header">
            <a href="/">
                <span class="icon"><i data-lucide="arrow-left"></i></span>
                DOCSight
            </a>
        </div>

        <div class="settings-sidebar-title">{{ t.settings }}</div>

        <div class="settings-sidebar-nav">
            <div class="settings-section-label">Connection</div>
            <a class="settings-nav-link active" data-section="modem" onclick="switchSection('modem')">
                <span class="icon"><i data-lucide="radio"></i></span>
                {{ t.step_modem }}
            </a>

            <div class="settings-section-label">Configuration</div>
            <a class="settings-nav-link" data-section="general" onclick="switchSection('general')">
                <span class="icon"><i data-lucide="settings"></i></span>
                {{ t.step_general }}
            </a>
            <a class="settings-nav-link" data-section="backup" onclick="switchSection('backup')">
                <span class="icon"><i data-lucide="hard-drive-download"></i></span>
                {{ t.backup_title }}
            </a>

            <div class="settings-section-label">Integrations</div>
            <a class="settings-nav-link" data-section="notifications" onclick="switchSection('notifications')">
                <span class="icon"><i data-lucide="bell"></i></span>
                Notifications
                <span class="status-dot" id="dot-notifications"></span>
            </a>
            <a class="settings-nav-link" data-section="speedtest" onclick="switchSection('speedtest')">
                <span class="icon"><i data-lucide="gauge"></i></span>
                Speedtest
                <span class="status-dot" id="dot-speedtest"></span>
            </a>
            <a class="settings-nav-link" data-section="bqm" onclick="switchSection('bqm')">
                <span class="icon"><i data-lucide="activity"></i></span>
                BQM
                <span class="status-dot" id="dot-bqm"></span>
            </a>
            <a class="settings-nav-link" data-section="bnetz" onclick="switchSection('bnetz')">
                <span class="icon"><i data-lucide="file-check"></i></span>
                BNetzA
                <span class="status-dot" id="dot-bnetz"></span>
            </a>
            <a class="settings-nav-link" data-section="smokeping" onclick="switchSection('smokeping')">
                <span class="icon"><i data-lucide="wifi"></i></span>
                Smokeping
                <span class="status-dot" id="dot-smokeping"></span>
            </a>
            <a class="settings-nav-link" data-section="weather" onclick="switchSection('weather')">
                <span class="icon"><i data-lucide="thermometer"></i></span>
                {{ t.weather_title }}
                <span class="status-dot" id="dot-weather"></span>
            </a>
            <a class="settings-nav-link" data-section="mqtt" onclick="switchSection('mqtt')">
                <span class="icon"><i data-lucide="radio-tower"></i></span>
                MQTT
                <span class="status-dot" id="dot-mqtt"></span>
            </a>

            {% set settings_modules = [] %}
            {% for mod in modules if mod.template_paths.get('settings') %}
                {% if settings_modules.append(mod) %}{% endif %}
            {% endfor %}
            {% if settings_modules %}
            <div class="settings-section-label">{{ t.settings_extensions }}</div>
            {% for mod in settings_modules|sort(attribute='menu.order') %}
            <a class="settings-nav-link" data-section="mod-{{ mod.id|replace('.', '_') }}" onclick="switchSection('mod-{{ mod.id|replace('.', '_') }}')">
                <span class="icon"><i data-lucide="{{ mod.menu.get('icon', 'puzzle') }}"></i></span>
                {{ t.get(mod.menu.label_key, mod.name) }}
            </a>
            {% endfor %}
            {% endif %}

            <div class="settings-sidebar-divider"></div>

            <a class="settings-nav-link" data-section="appearance" onclick="switchSection('appearance')">
                <span class="icon"><i data-lucide="palette"></i></span>
                {{ t.appearance }}
            </a>

            <div class="settings-section-label">Project</div>
            <a class="settings-nav-link" data-section="support" onclick="switchSection('support')">
                <span class="icon"><i data-lucide="heart-handshake"></i></span>
                Support DOCSight
            </a>
        </div>

        <div class="settings-sidebar-footer">
            <div class="dark-mode-toggle">
                <span class="dark-mode-label">
                    <i data-lucide="moon"></i>
                    {{ t.dark_mode }}
                </span>
                <label class="toggle-switch">
                    <input type="checkbox" id="theme-check" {% if theme == 'dark' %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </nav>

    <!-- ═══ Mobile List (<768px, initial view) ═══ -->
    <div class="settings-mobile-list">
        <div class="settings-mobile-list-header">
            <a href="/">
                <i data-lucide="arrow-left"></i>
                DOCSight
            </a>
        </div>
        <div class="settings-mobile-list-nav">
            <div class="mobile-section-label">Connection</div>
            <a class="mobile-nav-item" onclick="switchSection('modem')">
                <span class="icon"><i data-lucide="radio"></i></span>
                <span class="mobile-nav-label">{{ t.step_modem }}</span>
                <span class="mobile-nav-chevron"><i data-lucide="chevron-right"></i></span>
            </a>

            <div class="mobile-section-label">Configuration</div>
            <a class="mobile-nav-item" onclick="switchSection('general')">
                <span class="icon"><i data-lucide="settings"></i></span>
                <span class="mobile-nav-label">{{ t.step_general }}</span>
                <span class="mobile-nav-chevron"><i data-lucide="chevron-right"></i></span>
            </a>
            <a class="mobile-nav-item" onclick="switchSection('backup')">
                <span class="icon"><i data-lucide="hard-drive-download"></i></span>
                <span class="mobile-nav-label">{{ t.backup_title }}</span>
                <span class="mobile-nav-chevron"><i data-lucide="chevron-right"></i></span>
            </a>

            <div class="mobile-section-label">Integrations</div>
            <a class="mobile-nav-item" onclick="switchSection('notifications')">
                <span class="icon"><i data-lucide="bell"></i></span>
                <span class="mobile-nav-label">Notifications</span>
                <span class="mobile-nav-dot" id="mdot-notifications"></span>
                <span class="mobile-nav-chevron"><i data-lucide="chevron-right"></i></span>
            </a>
            <a class="mobile-nav-item" onclick="switchSection('speedtest')">
                <span class="icon"><i data-lucide="gauge"></i></span>
                <span class="mobile-nav-label">Speedtest</span>
                <span class="mobile-nav-dot" id="mdot-speedtest"></span>
                <span class="mobile-nav-chevron"><i data-lucide="chevron-right"></i></span>
            </a>
            <a class="mobile-nav-item" onclick="switchSection('bqm')">
                <span class="icon"><i data-lucide="activity"></i></span>
                <span class="mobile-nav-label">BQM</span>
                <span class="mobile-nav-dot" id="mdot-bqm"></span>
                <span class="mobile-nav-chevron"><i data-lucide="chevron-right"></i></span>
            </a>
            <a class="mobile-nav-item" onclick="switchSection('bnetz')">
                <span class="icon"><i data-lucide="file-check"></i></span>
                <span class="mobile-nav-label">BNetzA</span>
                <span class="mobile-nav-dot" id="mdot-bnetz"></span>
                <span class="mobile-nav-chevron"><i data-lucide="chevron-right"></i></span>
            </a>
            <a class="mobile-nav-item" onclick="switchSection('smokeping')">
                <span class="icon"><i data-lucide="wifi"></i></span>
                <span class="mobile-nav-label">Smokeping</span>
                <span class="mobile-nav-dot" id="mdot-smokeping"></span>
                <span class="mobile-nav-chevron"><i data-lucide="chevron-right"></i></span>
            </a>
            <a class="mobile-nav-item" onclick="switchSection('weather')">
                <span class="icon"><i data-lucide="thermometer"></i></span>
                <span class="mobile-nav-label">{{ t.weather_title }}</span>
                <span class="mobile-nav-dot" id="mdot-weather"></span>
                <span class="mobile-nav-chevron"><i data-lucide="chevron-right"></i></span>
            </a>
            <a class="mobile-nav-item" onclick="switchSection('mqtt')">
                <span class="icon"><i data-lucide="radio-tower"></i></span>
                <span class="mobile-nav-label">MQTT</span>
                <span class="mobile-nav-dot" id="mdot-mqtt"></span>
                <span class="mobile-nav-chevron"><i data-lucide="chevron-right"></i></span>
            </a>

            {% if settings_modules %}
            <div class="mobile-section-label">{{ t.settings_extensions }}</div>
            {% for mod in settings_modules|sort(attribute='menu.order') %}
            <a class="mobile-nav-item" onclick="switchSection('mod-{{ mod.id|replace('.', '_') }}')">
                <span class="icon"><i data-lucide="{{ mod.menu.get('icon', 'puzzle') }}"></i></span>
                <span class="mobile-nav-label">{{ t.get(mod.menu.label_key, mod.name) }}</span>
                <span class="mobile-nav-chevron"><i data-lucide="chevron-right"></i></span>
            </a>
            {% endfor %}
            {% endif %}

            <div class="mobile-section-label">Appearance</div>
            <a class="mobile-nav-item" onclick="switchSection('appearance')">
                <span class="icon"><i data-lucide="palette"></i></span>
                <span class="mobile-nav-label">{{ t.appearance }}</span>
                <span class="mobile-nav-chevron"><i data-lucide="chevron-right"></i></span>
            </a>

            <div class="mobile-section-label">Project</div>
            <a class="mobile-nav-item" onclick="switchSection('support')">
                <span class="icon"><i data-lucide="heart-handshake"></i></span>
                <span class="mobile-nav-label">Support DOCSight</span>
                <span class="mobile-nav-chevron"><i data-lucide="chevron-right"></i></span>
            </a>
        </div>
        <div class="settings-mobile-list-footer">
            <div class="dark-mode-toggle">
                <span class="dark-mode-label">
                    <i data-lucide="moon"></i>
                    {{ t.dark_mode }}
                </span>
                <label class="toggle-switch">
                    <input type="checkbox" id="theme-check-mobile" {% if theme == 'dark' %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- ═══ Mobile Backdrop (legacy) ═══ -->
    <div class="sidebar-backdrop" id="sidebar-backdrop"></div>

    <!-- ═══ Main Content ═══ -->
    <div class="settings-main">
        <div class="settings-topbar">
            <button class="settings-back-btn" onclick="backToList()" title="Back">
                <i data-lucide="arrow-left"></i>
            </button>
            <span class="settings-topbar-title" id="topbar-title">{{ t.step_modem }}</span>
        </div>

        <form id="settings-form" autocomplete="off">
            <div class="settings-content">

                {% if demo_mode %}
                <!-- ═══ Demo Mode Migration Banner ═══ -->
                <div class="settings-card" style="border-color: var(--warn); background: rgba(234, 179, 8, 0.08);" id="demo-migrate-banner">
                    <div class="settings-card-header" style="border-bottom-color: rgba(234, 179, 8, 0.2);">
                        <div class="settings-card-icon" style="background: rgba(234, 179, 8, 0.15); color: var(--warn);">
                            <i data-lucide="flask-conical"></i>
                        </div>
                        <div>
                            <div class="settings-card-title">{{ t.demo_migrate_title }}</div>
                            <div class="settings-card-desc">{{ t.demo_migrate_desc }}</div>
                        </div>
                    </div>
                    <div class="btn-row">
                        <button type="button" class="btn btn-secondary" style="border-color: var(--warn); color: var(--warn);" onclick="migrateToLive()">
                            <i data-lucide="arrow-right-circle" style="width:16px;height:16px;"></i>
                            {{ t.demo_migrate_button }}
                        </button>
                    </div>
                    <div class="test-result" id="migrate-result"></div>
                </div>
                {% endif %}

                {% include 'settings/modem.html' %}
                {% include 'settings/general.html' %}
                {% include 'settings/backup.html' %}
                {% include 'settings/notifications.html' %}
                {% include 'settings/speedtest.html' %}
                {% include 'settings/bqm.html' %}
                {% include 'settings/bnetz.html' %}
                {% include 'settings/smokeping.html' %}
                {% include 'settings/weather.html' %}
                {% include 'settings/mqtt.html' %}
                {% include 'settings/appearance.html' %}
                {% include 'settings/support.html' %}

                {# ── Module Settings Panels ── #}
                {% for mod in modules if mod.template_paths.get('settings') %}
                {% include mod.template_paths['settings'] %}
                {% endfor %}

            </div>

            <div class="settings-save-footer" id="settings-save-footer">
                <button type="submit" class="btn btn-primary">{{ t.save }}</button>
            </div>
        </form>
    </div>
</div>

<script>
var T = {{ t|tojson }};
var SECTION_TITLES = {
    modem: T.step_modem || 'Modem',
    general: T.step_general || 'General',
    backup: T.backup_title || 'Backup',
    notifications: 'Notifications',
    speedtest: 'Speedtest Tracker',
    bqm: 'ThinkBroadband BQM',
    bnetz: T.bnetz_watcher_title || 'BNetzA',
    smokeping: 'Smokeping',
    weather: T.weather_title || 'Weather',
    mqtt: T.mqtt_broker || 'MQTT',
    appearance: T.appearance || 'Appearance',
    support: 'Support DOCSight'
};
var serverOffsetMin = {{ server_tz_offset }};
var serverTz = '{{ server_tz }}';
var currentLang = '{{ lang }}';
var currentTz = '{{ config.timezone|default("", true) }}';
try { var savedCooldowns = JSON.parse('{{ config.notify_cooldowns|default("{}")|e }}'); } catch(e) { var savedCooldowns = {}; }
</script>
<script src="/static/js/settings.js"></script>
{% for mod in modules if mod.has_js %}
<script src="/modules/{{ mod.id }}/static/main.js"></script>
{% endfor %}

</body>
</html>
