<!DOCTYPE html>
<html lang="{{ lang }}" data-theme="{{ theme }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DOCSight - {{ t.settings }}</title>
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg">
    <link rel="icon" type="image/png" href="/static/icon.png">
    <link rel="apple-touch-icon" href="/static/icon.png">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#7c3aed">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/settings.css">
    {% for mod in modules if mod.has_css %}
    <link rel="stylesheet" href="/modules/{{ mod.id }}/static/style.css">
    {% endfor %}
    <script src="https://unpkg.com/lucide@0.575.0/dist/umd/lucide.min.js"
            integrity="sha384-GzE8qT1LzDfRNjtvLN/dXDLPlJOB3BBom3Twb9/RwHkXCgNl6OU1pBxM9397HWGU"
            crossorigin="anonymous"></script>
</head>
<body>

<div class="mesh-bg"></div>
<div class="error-msg" id="global-error"></div>
<div class="toast" id="toast"></div>

<div class="settings-layout">
    <!-- ═══ Sidebar ═══ -->
    <nav class="sidebar" id="settings-sidebar">
        <a href="/" class="sidebar-header">
            <div class="sidebar-logo">
                <i data-lucide="activity"></i>
            </div>
            <div>
                <div class="sidebar-title">DOCSight</div>
                <div class="sidebar-subtitle">{{ t.settings }}</div>
            </div>
        </a>

        <!-- Core Settings -->
        <div class="nav-group">
            <div class="nav-group-label">{{ t.get('core', 'Core') }}</div>
            <button class="nav-item active" data-section="connection" onclick="switchSection('connection')">
                <i data-lucide="radio" class="nav-icon"></i>
                {{ t.step_modem }}
            </button>
            <button class="nav-item" data-section="system" onclick="switchSection('system')">
                <i data-lucide="settings" class="nav-icon"></i>
                {{ t.get('system', 'System') }}
            </button>
            <button class="nav-item" data-section="notifications" onclick="switchSection('notifications')">
                <i data-lucide="bell" class="nav-icon"></i>
                {{ t.get('notifications', 'Notifications') }}
            </button>
            <button class="nav-item" data-section="appearance" onclick="switchSection('appearance')">
                <i data-lucide="palette" class="nav-icon"></i>
                {{ t.appearance }}
            </button>
            <button class="nav-item" data-section="security" onclick="switchSection('security')">
                <i data-lucide="shield" class="nav-icon"></i>
                {{ t.get('security', 'Security') }}
            </button>
        </div>

        <!-- Module Settings (dynamic) -->
        {% set settings_modules = [] %}
        {% for mod in modules if mod.template_paths.get('settings') %}
            {% if settings_modules.append(mod) %}{% endif %}
        {% endfor %}
        {% if settings_modules %}
        <div class="nav-separator"></div>
        <div class="nav-group">
            <div class="nav-group-label">{{ t.modules|default('Modules') }}</div>
            {% for mod in settings_modules|sort(attribute='menu.order') %}
            <button class="nav-item" data-section="mod-{{ mod.id|replace('.', '_') }}" onclick="switchSection('mod-{{ mod.id|replace('.', '_') }}')">
                <i data-lucide="{{ mod.menu.get('icon', 'puzzle') }}" class="nav-icon"></i>
                {{ t.get(mod.menu.label_key, mod.name) }}
                <span class="nav-badge {{ 'success' if mod.enabled else 'info' }}">{{ 'ON' if mod.enabled else 'OFF' }}</span>
            </button>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Module Store -->
        <div class="nav-separator"></div>
        <div class="nav-group">
            <button class="nav-item" data-section="modules" onclick="switchSection('modules')">
                <i data-lucide="package" class="nav-icon"></i>
                {{ t.modules_title|default('Module Store') }}
            </button>
        </div>

        <!-- Support (bottom) -->
        <div style="margin-top: auto;">
            <div class="nav-separator"></div>
            <button class="nav-item" data-section="support" onclick="switchSection('support')">
                <i data-lucide="heart-handshake" class="nav-icon"></i>
                Support DOCSight
            </button>
        </div>
    </nav>

    <!-- ═══ Sidebar Backdrop (mobile) ═══ -->
    <div class="sidebar-backdrop" id="sidebar-backdrop" onclick="closeMobileSidebar()"></div>

    <!-- ═══ Main Content ═══ -->
    <div class="main-content">
        <!-- Mobile header (visible < 768px) -->
        <div class="mobile-header">
            <button class="mobile-menu-btn" onclick="openMobileSidebar()">
                <i data-lucide="menu"></i>
            </button>
            <span class="page-title" style="font-size: 1.1rem;" id="mobile-title">{{ t.step_modem }}</span>
        </div>

        <form id="settings-form" autocomplete="off">
            {% if demo_mode %}
            <!-- ═══ Demo Mode Migration Banner ═══ -->
            <div class="settings-card glass" style="border-color: rgba(245,158,11,0.3);" id="demo-migrate-banner">
                <div class="card-header">
                    <div class="card-title-group">
                        <div class="card-icon amber">
                            <i data-lucide="flask-conical"></i>
                        </div>
                        <div>
                            <div class="card-title">{{ t.demo_migrate_title }}</div>
                            <div class="card-subtitle">{{ t.demo_migrate_desc }}</div>
                        </div>
                    </div>
                </div>
                <div class="btn-row">
                    <button type="button" class="btn btn-ghost" style="border-color: var(--warning); color: var(--warning);" onclick="migrateToLive()">
                        <i data-lucide="arrow-right-circle" style="width:16px;height:16px;"></i>
                        {{ t.demo_migrate_button }}
                    </button>
                </div>
                <div class="test-result" id="migrate-result"></div>
            </div>
            {% endif %}

            {% include 'settings/connection.html' %}
            {% include 'settings/system.html' %}
            {% include 'settings/notifications.html' %}
            {% include 'settings/appearance.html' %}
            {% include 'settings/security.html' %}
            {% include 'settings/modules.html' %}
            {% include 'settings/support.html' %}

            {# ── Module Settings Panels ── #}
            {% for mod in modules if mod.template_paths.get('settings') %}
            {% include mod.template_paths['settings'] %}
            {% endfor %}

            <!-- ═══ Save Footer ═══ -->
            <div class="save-footer" id="save-footer">
                <div class="unsaved-hint">
                    <span class="unsaved-dot"></span>
                    {{ t.get('unsaved_changes', 'Unsaved changes') }}
                </div>
                <button type="submit" class="btn btn-primary">
                    <i data-lucide="save" style="width:16px;height:16px;"></i>
                    {{ t.save }}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
var T = {{ t|tojson }};
var SECTION_TITLES = {
    connection: T.step_modem || 'Connection',
    system: T.get ? (T.get('system') || 'System') : 'System',
    notifications: T.get ? (T.get('notifications') || 'Notifications') : 'Notifications',
    appearance: T.appearance || 'Appearance',
    security: T.get ? (T.get('security') || 'Security') : 'Security',
    modules: T.modules_title || 'Module Store',
    support: 'Support DOCSight'
};
{% for mod in modules if mod.template_paths.get('settings') %}
SECTION_TITLES['mod-' + '{{ mod.id }}'.replace(/\./g, '_')] = T['{{ mod.menu.label_key }}'] || '{{ mod.name }}';
{% endfor %}
var serverOffsetMin = {{ server_tz_offset }};
var serverTz = '{{ server_tz }}';
var currentLang = '{{ lang }}';
var currentTz = '{{ config.timezone|default("", true) }}';
try { var savedCooldowns = JSON.parse('{{ config.notify_cooldowns|default("{}")|e }}'); } catch(e) { var savedCooldowns = {}; }
</script>
<script src="/static/js/settings.js"></script>
{% for mod in modules if mod.has_js %}
<script src="/modules/{{ mod.id }}/static/main.js"></script>
{% endfor %}

</body>
</html>
