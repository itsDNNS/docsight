<!DOCTYPE html>
<html lang="{{ lang }}" data-theme="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DOCSight - {{ t.initial_setup }}</title>
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg">
    <link rel="icon" type="image/png" href="/static/icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        /* Setup-specific styles using v2 design language */
        body {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
        .setup-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
        }
        .setup-title {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent) 0%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        .setup-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* ‚îÄ‚îÄ Language/Theme Controls ‚îÄ‚îÄ */
        .controls-bar {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-bottom: 24px;
        }
        .control-btn {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-md);
            padding: 8px 16px;
            color: var(--text);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        .control-btn:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        /* ‚îÄ‚îÄ Stepper (v2 Purple Style) ‚îÄ‚îÄ */
        .stepper {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 40px;
            padding: 0 20px;
        }
        .stepper-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            position: relative;
            flex: 1;
            max-width: 200px;
        }
        .stepper-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
            border: 2px solid var(--card-border);
            background: var(--card-bg);
            color: var(--text-secondary);
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
        }
        .stepper-step.active .stepper-circle {
            background: linear-gradient(135deg, var(--accent) 0%, #ec4899 100%);
            border-color: transparent;
            color: #fff;
            box-shadow: 0 4px 12px rgba(168,85,247,0.4);
        }
        .stepper-step.done .stepper-circle {
            background: var(--accent);
            border-color: transparent;
            color: #fff;
        }
        .stepper-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
            text-align: center;
        }
        .stepper-step.active .stepper-label {
            color: var(--accent);
            font-weight: 600;
        }
        .stepper-line {
            height: 2px;
            background: var(--card-border);
            flex: 1;
            position: relative;
            top: -20px;
            margin: 0 -10px;
        }
        .stepper-step.done + .stepper-line {
            background: var(--accent);
        }

        /* ‚îÄ‚îÄ Content Cards ‚îÄ‚îÄ */
        .step-content {
            display: none;
        }
        .step-content.active {
            display: block;
            animation: fadeInUp 0.3s ease-out;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .setup-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 28px;
            margin-bottom: 20px;
            border: 1px solid var(--card-border);
            transition: all 0.2s;
        }
        .setup-card:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 16px rgba(168,85,247,0.12);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--card-border);
        }
        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            background: rgba(168,85,247,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text);
        }
        .card-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* ‚îÄ‚îÄ Form Elements ‚îÄ‚îÄ */
        .form-row {
            margin-bottom: 20px;
        }
        .form-row label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }
        .form-row input,
        .form-row select {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--input-border);
            border-radius: var(--radius-sm);
            padding: 12px 16px;
            color: var(--text);
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.2s;
        }
        .form-row input:focus,
        .form-row select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(168,85,247,0.1);
        }
        .form-row input[type="password"] {
            font-family: monospace;
        }

        /* ‚îÄ‚îÄ Info Box ‚îÄ‚îÄ */
        .info-box {
            background: rgba(168,85,247,0.08);
            border: 1px solid rgba(168,85,247,0.2);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .info-box strong {
            color: var(--accent);
        }

        /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 28px;
        }
        .btn {
            padding: 12px 28px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-family: inherit;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, #ec4899 100%);
            color: #fff;
            box-shadow: 0 4px 12px rgba(168,85,247,0.3);
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(168,85,247,0.4);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--card-border);
        }
        .btn-secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        .btn-test {
            background: rgba(76,175,80,0.15);
            color: #4caf50;
            border: 1px solid rgba(76,175,80,0.3);
        }
        .btn-test:hover {
            background: rgba(76,175,80,0.25);
        }

        /* ‚îÄ‚îÄ Test Result ‚îÄ‚îÄ */
        .test-result {
            margin-top: 16px;
            padding: 14px;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            display: none;
        }
        .test-result.success {
            background: rgba(76,175,80,0.15);
            border: 1px solid rgba(76,175,80,0.3);
            color: #4caf50;
        }
        .test-result.error {
            background: rgba(244,67,54,0.15);
            border: 1px solid rgba(244,67,54,0.3);
            color: #f44336;
        }

        /* ‚îÄ‚îÄ Mobile Responsive ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            .setup-title { font-size: 1.5rem; }
            .stepper { padding: 0; }
            .stepper-circle { width: 40px; height: 40px; font-size: 0.95rem; }
            .stepper-label { font-size: 0.75rem; }
            .setup-card { padding: 20px; }
            .button-group { flex-direction: column; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>

<!-- Controls Bar -->
<div class="controls-bar">
    <select class="control-btn" id="lang-select" onchange="location.href='?lang='+this.value">
        {% for code, name in languages.items() %}
        <option value="{{ code }}" {% if code == lang %}selected{% endif %}>{{ lang_flags.get(code, '') }} {{ name }}</option>
        {% endfor %}
    </select>
    <button class="control-btn" onclick="toggleTheme()">üåì Theme</button>
</div>

<!-- Header -->
<div class="setup-header">
    <h1 class="setup-title">{{ t.initial_setup }}</h1>
    <p class="setup-subtitle">{{ t.setup_welcome|default('Configure your DOCSight instance') }}</p>
</div>

<!-- Start Choice -->
<div id="setup-start" class="step-content active">
    <div class="setup-card" style="text-align:center;padding:40px 28px;">
        <div style="font-size:2.5rem;margin-bottom:16px;">üöÄ</div>
        <div class="card-title" style="font-size:1.25rem;margin-bottom:8px;">{{ t.setup_start_title|default('How would you like to start?') }}</div>
        <div class="card-desc" style="margin-bottom:32px;">{{ t.setup_start_desc|default('Set up a new instance or restore from a previous backup.') }}</div>
        <div style="display:flex;gap:16px;justify-content:center;flex-wrap:wrap;">
            <button type="button" class="btn btn-primary" onclick="startFreshSetup()" style="min-width:200px;">
                ‚öôÔ∏è {{ t.setup_fresh|default('New Setup') }}
            </button>
            <button type="button" class="btn btn-secondary" onclick="startRestore()" style="min-width:200px;">
                üì¶ {{ t.setup_restore|default('Restore from Backup') }}
            </button>
        </div>
    </div>
</div>

<!-- Restore UI -->
<div id="restore-section" style="display:none;">
    <div class="setup-card">
        <div class="card-header">
            <div class="card-icon">üì¶</div>
            <div>
                <div class="card-title">{{ t.restore_title|default('Restore from Backup') }}</div>
                <div class="card-desc">{{ t.restore_desc|default('Upload a DOCSight backup file to restore your data.') }}</div>
            </div>
        </div>

        <div class="form-row">
            <label for="restore-file">{{ t.restore_select_file|default('Select backup file (.tar.gz)') }}</label>
            <input type="file" id="restore-file" accept=".tar.gz,.gz" style="padding:10px;" onchange="validateRestoreFile()">
        </div>

        <div id="restore-meta" style="display:none;">
            <div class="info-box" id="restore-meta-info"></div>
            <button type="button" class="btn btn-primary" onclick="doRestore()" id="restore-confirm-btn">
                üì¶ {{ t.restore_confirm|default('Restore Backup') }}
            </button>
        </div>

        <div class="test-result" id="restore-result"></div>

        <div class="button-group" style="margin-top:20px;">
            <button type="button" class="btn btn-secondary" onclick="backToStart()">
                ‚Üê {{ t.back|default('Back') }}
            </button>
        </div>
    </div>
</div>

<!-- Stepper -->
<div class="stepper" id="setup-stepper" style="display:none;">
    <div class="stepper-step active" data-step="1">
        <div class="stepper-circle">1</div>
        <span class="stepper-label">{{ t.modem_connection|default('Modem') }}</span>
    </div>
    <div class="stepper-line"></div>
    <div class="stepper-step" data-step="2">
        <div class="stepper-circle">2</div>
        <span class="stepper-label">{{ t.settings|default('Settings') }}</span>
    </div>
    <div class="stepper-line"></div>
    <div class="stepper-step" data-step="3">
        <div class="stepper-circle">3</div>
        <span class="stepper-label">{{ t.review|default('Review') }}</span>
    </div>
</div>

<form id="setup-form" method="POST" action="/api/config" style="display:none;">

<!-- Step 1: Modem Connection -->
<div class="step-content active" data-step="1">
    <div class="setup-card">
        <div class="card-header">
            <div class="card-icon">üì°</div>
            <div>
                <div class="card-title">{{ t.modem_connection }}</div>
                <div class="card-desc">{{ t.modem_connection_desc|default('Configure your cable modem connection') }}</div>
            </div>
        </div>

        <div class="form-row">
            <label for="modem_type">{{ t.modem_type }}</label>
            <select id="modem_type" name="modem_type" required>
                {% for key, name in modem_types %}
                <option value="{{ key }}" {% if config.modem_type == key %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-row">
            <label for="modem_url">{{ t.modem_url }}</label>
            <input type="text" id="modem_url" name="modem_url" 
                   value="{{ config.modem_url or 'http://192.168.178.1' }}" 
                   placeholder="http://192.168.178.1" required>
        </div>

        <div class="form-row">
            <label for="modem_user">{{ t.username }}</label>
            <input type="text" id="modem_user" name="modem_user" 
                   value="{{ config.modem_user or '' }}" 
                   placeholder="admin">
        </div>

        <div class="form-row">
            <label for="modem_password">{{ t.password }}</label>
            <input type="password" id="modem_password" name="modem_password" 
                   value="{{ config.modem_password or '' }}" 
                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>

        <button type="button" class="btn btn-test" onclick="testConnection()">
            üîå {{ t.test_connection }}
        </button>
        <div class="test-result" id="test-result"></div>

        <div class="button-group">
            <button type="button" class="btn btn-primary" onclick="nextStep(2)">
                {{ t.next|default('Next') }} ‚Üí
            </button>
        </div>
    </div>
</div>

<!-- Step 2: Settings -->
<div class="step-content" data-step="2">
    <div class="setup-card">
        <div class="card-header">
            <div class="card-icon">‚öôÔ∏è</div>
            <div>
                <div class="card-title">{{ t.general_settings }}</div>
                <div class="card-desc">{{ t.general_settings_desc|default('Configure polling and display options') }}</div>
            </div>
        </div>

        <div class="form-row">
            <label for="poll_interval">{{ t.poll_interval }} ({{ t.minutes }})</label>
            <input type="number" id="poll_interval" name="poll_interval" 
                   min="{{ poll_min }}" max="{{ poll_max }}" 
                   value="{{ config.poll_interval or 5 }}" required>
            <small style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 4px; display: block;">
                {{ t.poll_interval_desc|default('How often to fetch DOCSIS data (min: ' + poll_min|string + ', max: ' + poll_max|string + ')') }}
            </small>
        </div>

        <div class="form-row">
            <label for="timezone">{{ t.timezone }}</label>
            <select id="timezone" name="timezone" required>
                {% for tz in timezones %}
                <option value="{{ tz }}" {% if (config.timezone or iana_tz) == tz %}selected{% endif %}>{{ tz }}</option>
                {% endfor %}
            </select>
            <small style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 4px; display: block;">
                {{ t.timezone_hint }}
            </small>
        </div>

        <div class="button-group">
            <button type="button" class="btn btn-secondary" onclick="prevStep(1)">
                ‚Üê {{ t.back|default('Back') }}
            </button>
            <button type="button" class="btn btn-primary" onclick="nextStep(3)">
                {{ t.next|default('Next') }} ‚Üí
            </button>
        </div>
    </div>
</div>

<!-- Step 3: Review -->
<div class="step-content" data-step="3">
    <div class="setup-card">
        <div class="card-header">
            <div class="card-icon">‚úì</div>
            <div>
                <div class="card-title">{{ t.review_settings|default('Review & Complete') }}</div>
                <div class="card-desc">{{ t.review_settings_desc|default('Review your configuration and complete setup') }}</div>
            </div>
        </div>

        <div class="info-box">
            <strong>{{ t.modem_connection }}:</strong><br>
            <span id="review-modem-type"></span> @ <span id="review-modem-url"></span><br><br>
            <strong>{{ t.poll_interval }}:</strong> <span id="review-poll"></span> {{ t.minutes }}<br>
            <strong>{{ t.timezone }}:</strong> <span id="review-tz"></span>
        </div>

        <div class="button-group">
            <button type="button" class="btn btn-secondary" onclick="prevStep(2)">
                ‚Üê {{ t.back|default('Back') }}
            </button>
            <button type="submit" class="btn btn-primary" id="submit-btn">
                ‚úì {{ t.complete_setup|default('Complete Setup') }}
            </button>
        </div>
    </div>
</div>

</form>

<script>
let currentStep = 1;

function nextStep(step) {
    // Hide current
    document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.stepper-step').forEach(el => el.classList.remove('active'));
    
    // Mark previous as done
    for(let i = 1; i < step; i++) {
        document.querySelector(`.stepper-step[data-step="${i}"]`).classList.add('done');
    }
    
    // Show new
    document.querySelector(`.step-content[data-step="${step}"]`).classList.add('active');
    document.querySelector(`.stepper-step[data-step="${step}"]`).classList.add('active');
    
    // Update review if step 3
    if(step === 3) {
        updateReview();
    }
    
    currentStep = step;
    window.scrollTo({top: 0, behavior: 'smooth'});
}

function prevStep(step) {
    nextStep(step);
}

function updateReview() {
    const modemType = document.getElementById('modem_type');
    const selectedOption = modemType.options[modemType.selectedIndex].text;
    
    document.getElementById('review-modem-type').textContent = selectedOption;
    document.getElementById('review-modem-url').textContent = document.getElementById('modem_url').value;
    document.getElementById('review-poll').textContent = document.getElementById('poll_interval').value;
    document.getElementById('review-tz').textContent = document.getElementById('timezone').value;
}

async function testConnection() {
    const btn = event.target;
    const resultDiv = document.getElementById('test-result');
    
    btn.disabled = true;
    btn.textContent = '‚è≥ {{ t.testing|default("Testing...") }}';
    resultDiv.style.display = 'none';
    
    try {
        const data = {
            modem_type: document.getElementById('modem_type').value,
            modem_url: document.getElementById('modem_url').value,
            modem_user: document.getElementById('modem_user').value,
            modem_password: document.getElementById('modem_password').value
        };
        
        const response = await fetch('/api/test-modem', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if(result.success) {
            resultDiv.className = 'test-result success';
            resultDiv.textContent = '‚úì ' + (result.message || '{{ t.connection_successful|default("Connection successful!") }}');
        } else {
            resultDiv.className = 'test-result error';
            resultDiv.textContent = '‚úó ' + (result.error || '{{ t.connection_failed|default("Connection failed") }}');
        }
        resultDiv.style.display = 'block';
    } catch(err) {
        resultDiv.className = 'test-result error';
        resultDiv.textContent = '‚úó {{ t.connection_error|default("Network error") }}: ' + err.message;
        resultDiv.style.display = 'block';
    }
    
    btn.disabled = false;
    btn.textContent = 'üîå {{ t.test_connection }}';
}

// Form submission
document.getElementById('setup-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('submit-btn');
    btn.disabled = true;
    btn.textContent = '‚è≥ {{ t.saving|default("Saving...") }}';
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    try {
        const response = await fetch('/api/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if(response.ok) {
            window.location.href = '/';
        } else {
            alert('{{ t.setup_failed|default("Setup failed. Please try again.") }}');
            btn.disabled = false;
            btn.textContent = '‚úì {{ t.complete_setup|default("Complete Setup") }}';
        }
    } catch(err) {
        alert('{{ t.setup_error|default("Error") }}: ' + err.message);
        btn.disabled = false;
        btn.textContent = '‚úì {{ t.complete_setup|default("Complete Setup") }}';
    }
});

// Theme toggle
function toggleTheme() {
    const html = document.documentElement;
    const current = html.getAttribute('data-theme') || 'dark';
    const next = current === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
}

// Load theme preference
(function() {
    const saved = localStorage.getItem('theme');
    if(saved) {
        document.documentElement.setAttribute('data-theme', saved);
    }
})();

// Username field toggle and modem defaults
function toggleUsernameField() {
    const modemType = document.getElementById('modem_type').value;
    const usernameField = document.getElementById('modem_user');
    const urlField = document.getElementById('modem_url');

    if(modemType === 'ultrahub7') {
        usernameField.disabled = true;
        usernameField.value = '';
        usernameField.placeholder = '{{ t.not_required|default("Not required for this modem") }}';
        usernameField.style.opacity = '0.5';
        usernameField.style.cursor = 'not-allowed';
    } else {
        usernameField.disabled = false;
        usernameField.style.opacity = '1';
        usernameField.style.cursor = 'text';
        if(modemType === 'vodafone_station') {
            if(!urlField.value || urlField.value === 'http://192.168.178.1') {
                urlField.value = 'http://192.168.0.1';
            }
            if(!usernameField.value) {
                usernameField.value = 'admin';
            }
            usernameField.placeholder = 'admin';
        } else if(modemType === 'tc4400') {
            if(!urlField.value || urlField.value === 'http://192.168.178.1') {
                urlField.value = 'http://192.168.100.1';
            }
            if(!usernameField.value) {
                usernameField.value = 'admin';
            }
            usernameField.placeholder = 'admin';
        } else if(modemType === 'cm3500') {
            if(!urlField.value || urlField.value === 'http://192.168.178.1') {
                urlField.value = 'https://192.168.100.1';
            }
            if(!usernameField.value) {
                usernameField.value = 'admin';
            }
            usernameField.placeholder = 'admin';
        } else {
            usernameField.placeholder = 'admin';
        }
    }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    toggleUsernameField();
    document.getElementById('modem_type').addEventListener('change', toggleUsernameField);
});

/* ‚îÄ‚îÄ Setup Start Choice ‚îÄ‚îÄ */
function startFreshSetup() {
    document.getElementById('setup-start').style.display = 'none';
    document.getElementById('setup-stepper').style.display = '';
    document.getElementById('setup-form').style.display = '';
}

function startRestore() {
    document.getElementById('setup-start').style.display = 'none';
    document.getElementById('restore-section').style.display = '';
}

function backToStart() {
    document.getElementById('restore-section').style.display = 'none';
    document.getElementById('setup-stepper').style.display = 'none';
    document.getElementById('setup-form').style.display = 'none';
    document.getElementById('setup-start').style.display = '';
    // Reset restore state
    document.getElementById('restore-file').value = '';
    document.getElementById('restore-meta').style.display = 'none';
    document.getElementById('restore-result').style.display = 'none';
}

/* ‚îÄ‚îÄ Restore Flow ‚îÄ‚îÄ */
var T_setup = {
    validating: '{{ t.restore_validating|default("Validating...")|e }}',
    restoring: '{{ t.restore_restoring|default("Restoring...")|e }}',
    success: '{{ t.restore_success|default("Restore complete! Redirecting...")|e }}',
    version: '{{ t.restore_version|default("Version")|e }}',
    date: '{{ t.restore_date|default("Date")|e }}',
    tables: '{{ t.restore_tables|default("Tables")|e }}',
    network_error: '{{ t.network_error|default("Network error")|e }}'
};

async function validateRestoreFile() {
    var fileInput = document.getElementById('restore-file');
    var metaDiv = document.getElementById('restore-meta');
    var resultDiv = document.getElementById('restore-result');
    metaDiv.style.display = 'none';
    resultDiv.style.display = 'none';

    if (!fileInput.files.length) return;

    resultDiv.className = 'test-result';
    resultDiv.style.display = 'block';
    resultDiv.style.background = 'rgba(168,85,247,0.08)';
    resultDiv.style.border = '1px solid rgba(168,85,247,0.2)';
    resultDiv.style.color = 'var(--text-secondary)';
    resultDiv.textContent = '‚è≥ ' + T_setup.validating;

    var formData = new FormData();
    formData.append('file', fileInput.files[0]);

    try {
        var response = await fetch('/api/restore/validate', { method: 'POST', body: formData });
        var res = await response.json();

        if (res.valid) {
            resultDiv.style.display = 'none';
            var meta = res.meta;
            var date = meta.timestamp ? new Date(meta.timestamp).toLocaleString() : '?';
            var tables = '';
            if (meta.tables) {
                var tkeys = Object.keys(meta.tables);
                tables = tkeys.map(function(k) { return k + ': ' + meta.tables[k]; }).join(', ');
            }
            var info = document.getElementById('restore-meta-info');
            info.innerHTML = '<strong>' + T_setup.version + ':</strong> ' + (meta.app_version || '?') +
                '<br><strong>' + T_setup.date + ':</strong> ' + date +
                (tables ? '<br><strong>' + T_setup.tables + ':</strong> ' + tables : '');
            metaDiv.style.display = '';
        } else {
            resultDiv.className = 'test-result error';
            resultDiv.style.background = '';
            resultDiv.style.border = '';
            resultDiv.style.color = '';
            resultDiv.textContent = '‚úó ' + (res.error || 'Invalid backup file');
        }
    } catch(err) {
        resultDiv.className = 'test-result error';
        resultDiv.style.background = '';
        resultDiv.style.border = '';
        resultDiv.style.color = '';
        resultDiv.textContent = '‚úó ' + T_setup.network_error + ': ' + err.message;
    }
}

async function doRestore() {
    var fileInput = document.getElementById('restore-file');
    var btn = document.getElementById('restore-confirm-btn');
    var resultDiv = document.getElementById('restore-result');

    if (!fileInput.files.length) return;

    btn.disabled = true;
    resultDiv.className = 'test-result';
    resultDiv.style.display = 'block';
    resultDiv.style.background = 'rgba(168,85,247,0.08)';
    resultDiv.style.border = '1px solid rgba(168,85,247,0.2)';
    resultDiv.style.color = 'var(--text-secondary)';
    resultDiv.textContent = '‚è≥ ' + T_setup.restoring;

    var formData = new FormData();
    formData.append('file', fileInput.files[0]);

    try {
        var response = await fetch('/api/restore', { method: 'POST', body: formData });
        var res = await response.json();

        if (res.success) {
            resultDiv.className = 'test-result success';
            resultDiv.style.background = '';
            resultDiv.style.border = '';
            resultDiv.style.color = '';
            resultDiv.textContent = '‚úì ' + T_setup.success;
            if (res.configured) {
                setTimeout(function() { window.location.href = '/'; }, 2000);
            } else {
                // Data restored but modem not configured yet -- show setup stepper
                setTimeout(function() {
                    document.getElementById('restore-section').style.display = 'none';
                    document.getElementById('setup-stepper').style.display = '';
                    document.getElementById('setup-form').style.display = '';
                }, 2000);
            }
        } else {
            resultDiv.className = 'test-result error';
            resultDiv.style.background = '';
            resultDiv.style.border = '';
            resultDiv.style.color = '';
            resultDiv.textContent = '‚úó ' + (res.error || 'Restore failed');
            btn.disabled = false;
        }
    } catch(err) {
        resultDiv.className = 'test-result error';
        resultDiv.style.background = '';
        resultDiv.style.border = '';
        resultDiv.style.color = '';
        resultDiv.textContent = '‚úó ' + T_setup.network_error + ': ' + err.message;
        btn.disabled = false;
    }
}
</script>

</body>
</html>
